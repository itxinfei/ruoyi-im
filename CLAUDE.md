# CLAUDE.md

æœ¬æ–‡ä»¶ä¸º Claude Code (claude.ai/code) æä¾›é¡¹ç›®æŒ‡å¯¼ï¼Œæ‰€æœ‰å¯¹è¯ä½¿ç”¨ä¸­æ–‡ã€‚



éµå¾ªã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹ï¼Œä½¿ç”¨ JDK 1.8ã€‚
ä»…å…è®¸ç”Ÿæˆ Java + Vue å·¥ç¨‹ä»£ç ã€‚

ã€å¼ºåˆ¶è¦æ±‚ã€‘
- ä¸­æ–‡å›ç­”ï¼Œå…ˆæŸ¥åæ”¹ï¼Œé¿å…é‡å¤åˆ›å»ºï¼Œå…ˆæŸ¥æ˜¯å¦æœ‰å·²æœ‰çš„ä»£ç ï¼Œæœ‰åˆ™ç›´æ¥ä¿®æ”¹ï¼Œæ²¡æœ‰åˆ™åˆ›å»ºæ–°çš„ä»£ç ã€‚
- ä¸¥æ ¼åˆ†å±‚ï¼ˆcontroller / service / mapperï¼‰ï¼Œç¦æ­¢è·¨å±‚è°ƒç”¨
- ç¦æ­¢ä½¿ç”¨ Java 9+ è¯­æ³•æˆ–æ¿€è¿›å†™æ³•
- æ‰€æœ‰ç±»ã€public æ–¹æ³•ã€æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å¿…é¡»æœ‰ä¸­æ–‡æ³¨é‡Š
- å‘½åå¿…é¡»æ¸…æ™°ï¼Œç¦æ­¢ dataã€infoã€tempã€objã€handleã€process
- ç¦æ­¢ç‚«æŠ€å¼ Stream / lambdaï¼Œå¤æ‚é€»è¾‘å¿…é¡»å¯æ–­ç‚¹è°ƒè¯•
- common åŒ…ä¸ºå—æ§åŒºåŸŸï¼Œç¦æ­¢å †æ”¾ä¸šåŠ¡ä»£ç 
- ä»£ç å¿…é¡»å¯ç»´æŠ¤ã€å¯äºŒæ¬¡ä¿®æ”¹

ã€å¤±è´¥æ¡ä»¶ã€‘
å¦‚å‡ºç°åˆ†å±‚è¿ä¾‹ã€å‘½åä¸è§„èŒƒã€ç¼ºå°‘æ³¨é‡Šï¼Œ
æœ¬æ¬¡ä»£ç è§†ä¸ºä¸åˆæ ¼ï¼Œå¿…é¡»é‡å†™ã€‚


## 3.1 åç«¯æŠ€æœ¯æ ˆ

- æ ¸å¿ƒæ¡†æ¶ï¼šSpring Boot 2.7

- ORM æ¡†æ¶ï¼šMyBatis Plusï¼ˆç®€åŒ–æ•°æ®åº“æ“ä½œï¼‰

- é€šä¿¡æŠ€æœ¯ï¼šWebSocketï¼ˆå®æ—¶æ¶ˆæ¯æ¨é€ï¼‰ã€Nettyï¼ˆé«˜æ€§èƒ½ç½‘ç»œé€šä¿¡ï¼‰

- ç¼“å­˜ä¸­é—´ä»¶ï¼šRedis 3.0+ï¼ˆç”¨æˆ·çŠ¶æ€ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ã€åœ¨çº¿çŠ¶æ€å­˜å‚¨ï¼‰

- æ•°æ®åº“ï¼šMySQL 5.7.44ï¼ˆæ•°æ®æŒä¹…åŒ–ï¼‰

- å®‰å…¨æ¡†æ¶ï¼šSpring Securityï¼ˆå¤ç”¨ RuoYi æƒé™è®¤è¯ï¼‰

- æ–‡ä»¶å­˜å‚¨ï¼šæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ˆåŸºç¡€ç‰ˆï¼‰

- æ—¥å¿—æ¡†æ¶ï¼šSLF4J + Logbackï¼ˆæ—¥å¿—è®°å½•ä¸å®¡è®¡ï¼‰

- å·¥å…·ï¼šhutoolï¼ˆæ—¥æœŸæ—¶é—´å¤„ç†ã€åŠ å¯†è§£å¯†ã€æ–‡ä»¶æ“ä½œç­‰ï¼‰Lombok

## 3.2 å‰ç«¯æŠ€æœ¯æ ˆ

- æ ¸å¿ƒæ¡†æ¶ï¼šVue 3

- æ„å»ºå·¥å…·ï¼šViteï¼ˆå¿«é€Ÿæ„å»ºä¸çƒ­æ›´æ–°ï¼‰

- UI ç»„ä»¶åº“ï¼šElement Plus

- çŠ¶æ€ç®¡ç†ï¼šVuexï¼ˆå…¨å±€çŠ¶æ€ç®¡ç†ï¼‰

- ç½‘ç»œè¯·æ±‚ï¼šAxiosï¼ˆHTTP è¯·æ±‚ï¼‰ã€WebSocket APIï¼ˆå®æ—¶æ¶ˆæ¯ï¼‰

- æ–‡ä»¶ä¸Šä¼ ï¼švue-upload-componentï¼ˆå¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ ï¼‰

- å¯Œæ–‡æœ¬ç¼–è¾‘ï¼šwangeditorï¼ˆæ”¯æŒæ¶ˆæ¯æ ¼å¼åŒ–ï¼‰

## 3.3 ä¸­é—´ä»¶ä¸ä¾èµ–

- Redisï¼šç”¨äºç¼“å­˜ç”¨æˆ· Tokenã€åœ¨çº¿çŠ¶æ€ã€æœªè¯»æ¶ˆæ¯è®¡æ•°ã€æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¼‚æ­¥æ¶ˆæ¯æ¨é€ï¼‰

- Nginxï¼šå‰ç«¯é™æ€èµ„æºéƒ¨ç½²ã€åå‘ä»£ç†åç«¯æ¥å£ã€WebSocket è¿æ¥è½¬å‘

## é¡¹ç›®æ¦‚è¿°

RuoYi-IM æ˜¯ä¸€ä¸ªå…¨æ ˆä¼ä¸šçº§å³æ—¶é€šè®¯ç³»ç»Ÿï¼š
- **åç«¯**: Java 8, Spring Boot 2.7, WebSocket, MyBatis Plus, MySQL, Redis
- **å‰ç«¯**: Vue 3 (Composition API), Vite, Element Plus, Vuex, Vue Router
- **ç®¡ç†åå°**: RuoYi v4.8.0ï¼Œä½¿ç”¨ Thymeleaf å’Œ Shiro

## é¡¹ç›®ç»“æ„

```
im/
â”œâ”€â”€ ruoyi-im-api/          # æ ¸å¿ƒAPIæœåŠ¡ (Spring Boot, ç«¯å£ 8080)
â”‚   â””â”€â”€ src/main/java/com/ruoyi/im/
â”‚       â”œâ”€â”€ controller/    # REST API æ¥å£
â”‚       â”œâ”€â”€ service/       # ä¸šåŠ¡é€»è¾‘
â”‚       â”œâ”€â”€ mapper/        # MyBatis-Plus æ•°æ®è®¿é—®å±‚
â”‚       â”œâ”€â”€ domain/        # å®ä½“ç±»
â”‚       â”œâ”€â”€ dto/           # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚       â”œâ”€â”€ vo/            # è§†å›¾å¯¹è±¡
â”‚       â”œâ”€â”€ config/        # Spring é…ç½® (WebSocket, Security, Redis)
â”‚       â”œâ”€â”€ websocket/     # WebSocket ç«¯ç‚¹
â”‚       â”œâ”€â”€ utils/         # å·¥å…·ç±»
â”‚       â””â”€â”€ ImApplication.java  # ä¸»å…¥å£
â”œâ”€â”€ ruoyi-im-web/          # å‰ç«¯èŠå¤©ç•Œé¢ (Vue 3 + Vite, ç«¯å£ 3000)
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ api/           # API å®¢æˆ·ç«¯è°ƒç”¨
â”‚       â”œâ”€â”€ components/    # Vue ç»„ä»¶
â”‚       â”œâ”€â”€ composables/   # ç»„åˆå¼å‡½æ•°
â”‚       â”œâ”€â”€ views/         # é¡µé¢è§†å›¾
â”‚       â”œâ”€â”€ store/         # Vuex çŠ¶æ€ç®¡ç†
â”‚       â”œâ”€â”€ router/        # Vue Router é…ç½®
â”‚       â”œâ”€â”€ utils/         # å·¥å…·å‡½æ•°
â”‚       â””â”€â”€ main.js        # Vue åº”ç”¨å…¥å£
â”œâ”€â”€ ruoyi-im-admin/        # ç®¡ç†åå° (RuoYi æ¡†æ¶, ç«¯å£ 8081)
â”œâ”€â”€ sql/                   # æ•°æ®åº“ç»“æ„æ–‡ä»¶
â”œâ”€â”€ docs/                  # é¡¹ç›®æ–‡æ¡£
â””â”€â”€ pom.xml               # çˆ¶çº§ Maven POM
```

## å¼€å‘å‘½ä»¤

### å‰ç«¯ (ruoyi-im-web)
```bash
cd ruoyi-im-web
npm install              # å®‰è£…ä¾èµ–
npm run dev             # å¯åŠ¨å¼€å‘æœåŠ¡å™¨ (ç«¯å£ 3000)
npm run build           # ç”Ÿäº§ç¯å¢ƒæ„å»º
```

### åç«¯ (ruoyi-im-api)
```bash
cd ruoyi-im-api
mvn clean package       # æ„å»º JAR æ–‡ä»¶
# è¿è¡Œ ImApplication.java çš„ main æ–¹æ³•å¯åŠ¨æœåŠ¡å™¨ (ç«¯å£ 8080)
```

## IM ç³»ç»Ÿæ¶æ„

### æ¶ˆæ¯å‘é€æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     WebSocket      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚         â”‚
â”‚  å‰ç«¯   â”‚                      â”‚  åç«¯   â”‚
â”‚         â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     å®æ—¶æ¨é€         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                               â”‚
     â”‚ 1. ç”¨æˆ·å‘é€æ¶ˆæ¯               â”‚
     â”‚                               â”‚
     â”œâ”€> ä¹è§‚UIæ›´æ–° (ç«‹å³æ˜¾ç¤º)        â”‚
     â”‚                               â”‚
     â”œâ”€> WebSocket.send()            â”‚
     â”‚                               â”‚
     â”‚                          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
     â”‚                          â”‚ä¿å­˜åˆ°DB  â”‚
     â”‚                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                               â”‚
     â”‚                          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
     â”‚                          â”‚æ¨é€ç»™å…¶ä»– â”‚
     â”‚                          â”‚æˆå‘˜(WS)  â”‚
     â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‚¹**ï¼š
- å‰ç«¯ä¼˜å…ˆä½¿ç”¨ WebSocket å‘é€ï¼Œå¤±è´¥æ—¶é™çº§åˆ° REST API
- é‡‡ç”¨ä¹è§‚ UI æ›´æ–°ï¼Œå‘é€åç«‹å³æ˜¾ç¤ºæ¶ˆæ¯
- åç«¯ä¿å­˜æ¶ˆæ¯åé€šè¿‡ WebSocket æ¨é€ç»™å…¶ä»–ä¼šè¯æˆå‘˜ï¼ˆä¸æ¨é€ç»™å‘é€è€…è‡ªå·±ï¼‰

### æ¶ˆæ¯æ¥æ”¶æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Vuex Store                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  messageList: {                      â”‚   â”‚
â”‚  â”‚    sessionId1: [msg1, msg2, ...],   â”‚   â”‚
â”‚  â”‚    sessionId2: [msg3, msg4, ...]    â”‚   â”‚
â”‚  â”‚  }                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–²
                    â”‚ WebSocket.onmessage
                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          WebSocket å®¢æˆ·ç«¯                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                           â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚ åç«¯   â”‚                  â”‚  Redis  â”‚
â”‚WebSocketâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Pub/Sub â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ æ¶ˆæ¯å¹¿æ’­
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¼šè¯æˆå‘˜è¡¨  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¼šè¯ç®¡ç†

**ä¼šè¯ç±»å‹**ï¼š
- `PRIVATE` - ç§èŠä¼šè¯ï¼ˆä¸€å¯¹ä¸€ï¼‰
- `GROUP` - ç¾¤èŠä¼šè¯

**ä¼šè¯æˆå‘˜è¡¨ (im_conversation_member)**ï¼š
- å­˜å‚¨ç”¨æˆ·ä¸ä¼šè¯çš„å…³ç³»
- è®°å½•æœªè¯»æ•°ã€ç½®é¡¶ã€å…æ‰“æ‰°ç­‰çŠ¶æ€
- å”¯ä¸€çº¦æŸï¼š`(conversation_id, user_id)`

**å»é‡æœºåˆ¶**ï¼š
- åç«¯ `getUserConversations()` æŒ‰ `peerUserId` å»é‡ç§èŠä¼šè¯
- å‰ç«¯ Vuex `SET_SESSIONS` åŒé‡å»é‡ï¼ˆæŒ‰ id å’Œ peerIdï¼‰

### åœ¨çº¿çŠ¶æ€ç®¡ç†

**WebSocket å¿ƒè·³æœºåˆ¶**ï¼š
- å‰ç«¯æ¯ 30 ç§’å‘é€ `ping` æ¶ˆæ¯
- åç«¯å“åº” `pong` æ¶ˆæ¯
- è¿æ¥æ–­å¼€æ—¶è‡ªåŠ¨é‡è¿ï¼ˆæŒ‡æ•°é€€é¿ï¼‰

**åœ¨çº¿çŠ¶æ€**ï¼š
- è¿æ¥ WebSocket = åœ¨çº¿
- æ–­å¼€ WebSocket = ç¦»çº¿
- æœ€ååœ¨çº¿æ—¶é—´å­˜å‚¨åœ¨ `im_user.last_online_time`

## æ ¸å¿ƒæ¨¡å—è¯´æ˜

### åç«¯ Controller

| Controller | è·¯å¾„ | åŠŸèƒ½ |
|-----------|------|------|
| `ImMessageController` | `/api/im/message` | æ¶ˆæ¯å‘é€ã€æŸ¥è¯¢ã€æ’¤å›ã€ç¼–è¾‘ |
| `ImConversationController` | `/api/im/conversation` | ä¼šè¯ç®¡ç† |
| `ImContactController` | `/api/im/contact` | å¥½å‹/è”ç³»äººç®¡ç† |
| `ImUserController` | `/api/im/user` | ç”¨æˆ·ç®¡ç† |
| `ImGroupController` | `/api/im/group` | ç¾¤ç»„ç®¡ç† |
| `ImSessionController` | `/api/im/session` | ä¼šè¯åˆ—è¡¨ |

### åç«¯ Service

| Service | åŠŸèƒ½ |
|---------|------|
| `ImMessageService` | æ¶ˆæ¯ä¸šåŠ¡é€»è¾‘ |
| `ImConversationService` | ä¼šè¯ä¸šåŠ¡é€»è¾‘ |
| `ImFriendService` | å¥½å‹å…³ç³»ç®¡ç† |
| `ImGroupService` | ç¾¤ç»„ç®¡ç† |
| `ImUserService` | ç”¨æˆ·ç®¡ç† |

### å‰ç«¯ Vuex Store

| Module | State | åŠŸèƒ½ |
|--------|-------|------|
| `im` | `sessions`, `messageList`, `currentSession` | ä¼šè¯å’Œæ¶ˆæ¯ç®¡ç† |
| `user` | `userInfo`, `token` | ç”¨æˆ·è®¤è¯ä¿¡æ¯ |
| `websocket` | `isConnected` | WebSocket è¿æ¥çŠ¶æ€ |

### WebSocket æ¶ˆæ¯ç±»å‹

| ç±»å‹ | æ–¹å‘ | è¯´æ˜ |
|------|------|------|
| `auth` | å®¢æˆ·ç«¯â†’æœåŠ¡ç«¯ | è®¤è¯ |
| `message` | åŒå‘ | èŠå¤©æ¶ˆæ¯ |
| `ping/pong` | åŒå‘ | å¿ƒè·³ |
| `read` | å®¢æˆ·ç«¯â†’æœåŠ¡ç«¯ | å·²è¯»å›æ‰§ |
| `typing` | å®¢æˆ·ç«¯â†’æœåŠ¡ç«¯ | è¾“å…¥çŠ¶æ€ |

## æ•°æ®åº“è®¾è®¡

### æ ¸å¿ƒè¡¨ç»“æ„

**im_conversation (ä¼šè¯è¡¨)**
```sql
id              BIGINT          ä¸»é”®
type            VARCHAR(20)     ç±»å‹: PRIVATE/GROUP
target_id       BIGINT          ç›®æ ‡ID (ç§èŠ=å¯¹æ–¹ç”¨æˆ·ID, ç¾¤èŠ=ç¾¤ç»„ID)
name            VARCHAR(100)    ä¼šè¯åç§°
last_message_id BIGINT          æœ€åæ¶ˆæ¯ID
last_message_time DATETIME      æœ€åæ¶ˆæ¯æ—¶é—´
```

**im_conversation_member (ä¼šè¯æˆå‘˜è¡¨)**
```sql
conversation_id BIGINT          ä¼šè¯ID
user_id         BIGINT          ç”¨æˆ·ID
role            VARCHAR(20)     è§’è‰²: OWNER/MEMBER
unread_count    INT             æœªè¯»æ•°
is_pinned       TINYINT         æ˜¯å¦ç½®é¡¶
is_muted        TINYINT         æ˜¯å¦å…æ‰“æ‰°
last_read_message_id BIGINT     æœ€åå·²è¯»æ¶ˆæ¯ID
-- å”¯ä¸€çº¦æŸ: uk_conversation_user (conversation_id, user_id)
```

**im_message (æ¶ˆæ¯è¡¨)**
```sql
id                  BIGINT      ä¸»é”®
conversation_id     BIGINT      ä¼šè¯ID
sender_id           BIGINT      å‘é€è€…ID
message_type        VARCHAR(20) æ¶ˆæ¯ç±»å‹: TEXT/IMAGE/FILE/VOICE/VIDEO
content             TEXT        æ¶ˆæ¯å†…å®¹ (JSONæ ¼å¼)
reply_to_message_id BIGINT      å›å¤çš„æ¶ˆæ¯ID
forward_from_message_id BIGINT  è½¬å‘æ¥æºæ¶ˆæ¯ID
is_revoked          TINYINT     æ˜¯å¦æ’¤å›
is_edited           TINYINT     æ˜¯å¦å·²ç¼–è¾‘
is_deleted          TINYINT     æ˜¯å¦åˆ é™¤
```

**im_friend (å¥½å‹å…³ç³»è¡¨)**
```sql
id              BIGINT      ä¸»é”®
user_id         BIGINT      ç”¨æˆ·ID
friend_id       BIGINT      å¥½å‹ID
remark          VARCHAR(100) å¤‡æ³¨
group_name      VARCHAR(50) åˆ†ç»„åç§°
is_deleted      TINYINT     æ˜¯å¦åˆ é™¤ (è½¯åˆ é™¤)
```

### å­—æ®µå‘½åè§„èŒƒ

- æ•°æ®åº“: `snake_case` (å¦‚: `conversation_id`)
- Java Entity: `camelCase` (å¦‚: `conversationId`)
- å‰ç«¯ API: `camelCase` (å¦‚: `conversationId`)
- å‰ç«¯ç»„ä»¶: æ··åˆä½¿ç”¨ `sessionId` å’Œ `conversationId` (éœ€è¦ç»Ÿä¸€)

## å·²çŸ¥é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 1. ä¼šè¯é‡å¤é—®é¢˜

**é—®é¢˜**: åŒä¸€å¯¹ç”¨æˆ·ä¹‹é—´å¯èƒ½å­˜åœ¨å¤šæ¡ä¼šè¯è®°å½•

**è§£å†³æ–¹æ¡ˆ**:
- åç«¯: `ImConversationServiceImpl.getUserConversations()` æŒ‰ `peerUserId` å»é‡
- å‰ç«¯: Vuex `SET_SESSIONS` mutation åŒé‡å»é‡

### 2. å¥½å‹é‡å¤é—®é¢˜

**é—®é¢˜**: å¥½å‹å…³ç³»è¡¨ä¸­å¯èƒ½å­˜åœ¨é‡å¤è®°å½•

**è§£å†³æ–¹æ¡ˆ**:
- SQL: `ImFriendMapper.xml` ä½¿ç”¨å­æŸ¥è¯¢å»é‡
- Service: `handleFriendRequest()` æ£€æŸ¥å·²å­˜åœ¨å…³ç³»
- å‰ç«¯: `loadFriends()` æŒ‰ `friendId` å»é‡

### 3. æ¶ˆæ¯é‡å¤å‘é€

**é—®é¢˜**: WebSocket å’Œ REST API å¹¶è¡Œå‘é€å¯èƒ½å¯¼è‡´é‡å¤

**è§£å†³æ–¹æ¡ˆ**:
- å‰ç«¯: ç»Ÿä¸€ä½¿ç”¨ WebSocket å‘é€ï¼Œå¤±è´¥æ—¶é™çº§åˆ° REST API
- åç«¯: åªé€šè¿‡ WebSocket ç«¯ç‚¹å¹¿æ’­æ¶ˆæ¯

### 4. å­—æ®µå‘½åä¸ä¸€è‡´

**é—®é¢˜**: `sessionId` vs `conversationId` æ··ç”¨

**è§£å†³æ–¹æ¡ˆ**:
- ç»Ÿä¸€ä½¿ç”¨ `conversationId` è¡¨ç¤ºä¼šè¯ID
- å‰ç«¯ç»„ä»¶ä¸­åšå…¼å®¹å¤„ç†

## é‡è¦çº¦æŸ

### æ•°æ®åº“å­—æ®µå˜æ›´è§„åˆ™
âš ï¸ **æ•°æ®åº“ç»“æ„æ˜¯å•ä¸€äº‹å®æ¥æºï¼Œä»»ä½•å­—æ®µå˜æ›´å¿…é¡»å…ˆç¡®è®¤æ•°æ®åº“è¡¨ç»“æ„**

1. ä¿®æ”¹è¡¨ç»“æ„å‰ï¼Œå¿…é¡»å…ˆæŸ¥çœ‹æ•°æ®åº“è¡¨ç»“æ„
2. å˜æ›´æ•°æ®åº“åï¼Œéœ€è¦åŒæ­¥æ›´æ–°:
   - Entity å®ä½“ç±» (`domain/*.java`)
   - Mapper XML (`resources/mapper/*.xml`)
   - API æ¥å£è¿”å›å­—æ®µ
3. æ‰€æœ‰å­—æ®µå‘½åéµå¾ª: æ•°æ®åº“ `snake_case` â†” Java `camelCase` è‡ªåŠ¨è½¬æ¢

### ä»£ç è§„èŒƒ
- Entity ç±»ä½¿ç”¨ Lombok æ³¨è§£
- é¿å…ä½¿ç”¨ `select *`
- WebSocket æ¶ˆæ¯ä½¿ç”¨ç»Ÿä¸€æ ¼å¼
- å‰ç«¯ä½¿ç”¨ Composition API å’Œ `<script setup>` è¯­æ³•

## å‰ç«¯æ¶æ„è¯¦ç»†è¯´æ˜

### ç›®å½•ç»“æ„

```
ruoyi-im-web/src/
â”œâ”€â”€ api/                    # API å®¢æˆ·ç«¯
â”‚   â””â”€â”€ im/
â”‚       â”œâ”€â”€ message.js      # æ¶ˆæ¯ API (å‘é€ã€æŸ¥è¯¢ã€æ’¤å›ã€è½¬å‘ç­‰)
â”‚       â”œâ”€â”€ conversation.js # ä¼šè¯ API
â”‚       â”œâ”€â”€ session.js      # ä¼šè¯ API (å…¼å®¹å±‚ï¼Œé‡å®šå‘åˆ° conversation)
â”‚       â”œâ”€â”€ contact.js      # è”ç³»äºº/å¥½å‹ API
â”‚       â”œâ”€â”€ group.js        # ç¾¤ç»„ API
â”‚       â”œâ”€â”€ file.js         # æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½ API
â”‚       â””â”€â”€ ...
â”œâ”€â”€ views/im/
â”‚   â”œâ”€â”€ ImChatLayoutOptimized.vue  # ä¸»èŠå¤©ç•Œé¢ (ç»¼åˆå¸ƒå±€)
â”‚   â”œâ”€â”€ chat/ChatContainer.vue     # èŠå¤©å®¹å™¨ç»„ä»¶
â”‚   â”œâ”€â”€ contacts/                  # è”ç³»äººæ¨¡å—
â”‚   â”œâ”€â”€ group/                     # ç¾¤ç»„æ¨¡å—
â”‚   â”œâ”€â”€ email/                     # é‚®ç®±æ¨¡å—
â”‚   â””â”€â”€ workbench/                 # å·¥ä½œå°æ¨¡å—
â”œâ”€â”€ store/modules/
â”‚   â””â”€â”€ im.js              # IM çŠ¶æ€ç®¡ç† (ä¼šè¯ã€æ¶ˆæ¯ã€è”ç³»äºº)
â”œâ”€â”€ composables/
â”‚   â””â”€â”€ useImWebSocket.js  # WebSocket ç»„åˆå¼å‡½æ•°
â”œâ”€â”€ utils/websocket/
â”‚   â”œâ”€â”€ imWebSocket.js     # WebSocket å•ä¾‹å®ç°
â”‚   â””â”€â”€ WebSocketManager.js # WebSocket ç®¡ç†å™¨
â””â”€â”€ utils/im-user.js       # ç”¨æˆ·ä¿¡æ¯å·¥å…·å‡½æ•°
```

### æ ¸å¿ƒç»„ä»¶è¯´æ˜

**ImChatLayoutOptimized.vue** - ä¸»èŠå¤©ç•Œé¢
- é’‰é’‰é£æ ¼çš„å®Œæ•´ IM ç•Œé¢
- åŒ…å«ï¼šæ¶ˆæ¯ã€è”ç³»äººã€å·¥ä½œå°ã€é‚®ç®±å››å¤§æ¨¡å—
- æ”¯æŒç§èŠã€ç¾¤èŠã€æ–‡ä»¶å‘é€ã€è¯­éŸ³æ¶ˆæ¯ç­‰åŠŸèƒ½

**ChatContainer.vue** - èŠå¤©å®¹å™¨
- è½»é‡çº§èŠå¤©ç»„ä»¶
- æ¶ˆæ¯åˆ—è¡¨æ¸²æŸ“
- è¾“å…¥æ¡†å’Œæ¶ˆæ¯å‘é€

### Vuex Store (im.js)

**State**:
```javascript
{
  currentSession: null,      // å½“å‰ä¼šè¯
  sessions: [],              // ä¼šè¯åˆ—è¡¨
  messageList: {},           // æ¶ˆæ¯åˆ—è¡¨ { sessionId: [messages] }
  unreadCount: 0,            // æœªè¯»æ¶ˆæ¯æ€»æ•°
  onlineStatus: {},          // åœ¨çº¿çŠ¶æ€æ˜ å°„
  pendingMessages: {},       // å¾…å‘é€æ¶ˆæ¯
  wsConnected: false,        // WebSocket è¿æ¥çŠ¶æ€
  contacts: [],              // è”ç³»äººåˆ—è¡¨
  groups: [],                // ç¾¤ç»„åˆ—è¡¨
  files: [],                 // æ–‡ä»¶åˆ—è¡¨
  messageIdSet: {},          // æ¶ˆæ¯IDé›†åˆï¼ˆå»é‡ï¼‰
}
```

**ä¸»è¦ Actions**:
- `loadSessions()` - åŠ è½½ä¼šè¯åˆ—è¡¨
- `switchSession(session)` - åˆ‡æ¢ä¼šè¯
- `loadMessages({ sessionId, lastId, pageSize })` - åŠ è½½æ¶ˆæ¯
- `sendMessage({ sessionId, type, content })` - å‘é€æ¶ˆæ¯
- `receiveMessage(message)` - æ¥æ”¶æ¶ˆæ¯
- `loadContacts()` - åŠ è½½è”ç³»äºº
- `loadGroups()` - åŠ è½½ç¾¤ç»„

### WebSocket è¿æ¥

**è¿æ¥æµç¨‹**:
1. ç”¨æˆ·ç™»å½•åè·å– token
2. è°ƒç”¨ `useImWebSocket().connect(token)`
3. å»ºç«‹ WebSocket è¿æ¥: `ws://localhost:8080/ws/im?token=xxx`
4. å‘é€è®¤è¯æ¶ˆæ¯
5. å¼€å§‹å¿ƒè·³ (30ç§’é—´éš”)

**æ¶ˆæ¯å‘é€æ ¼å¼**:
```javascript
{
  type: 'message',
  payload: {
    conversationId: 123,
    messageType: 'TEXT',
    content: 'æ¶ˆæ¯å†…å®¹',
    clientMsgId: 'å®¢æˆ·ç«¯æ¶ˆæ¯ID'
  }
}
```

**æ¶ˆæ¯æ¥æ”¶å¤„ç†**:
1. WebSocket æ¥æ”¶æ¶ˆæ¯
2. è§¦å‘ `im/receiveMessage` action
3. æ¶ˆæ¯æ·»åŠ åˆ° `messageList`
4. æ›´æ–°ä¼šè¯çš„ `lastMessage`

### å¼€å‘æ³¨æ„äº‹é¡¹

1. **å­—æ®µæ˜ å°„**: å‰ç«¯å†…éƒ¨ç»Ÿä¸€ä½¿ç”¨ `sessionId`ï¼Œä¸åç«¯äº¤äº’æ—¶è½¬æ¢ä¸º `conversationId`

2. **æ¶ˆæ¯å»é‡**: ä½¿ç”¨ `clientMsgId` æˆ–æ¶ˆæ¯IDç”Ÿæˆå”¯ä¸€keyï¼Œé¿å…é‡å¤æ˜¾ç¤º

3. **ä¹è§‚æ›´æ–°**: å‘é€æ¶ˆæ¯åç«‹å³æ˜¾ç¤ºï¼Œåç«¯è¿”å›åæ›´æ–°çŠ¶æ€

4. **é™çº§ç­–ç•¥**: WebSocket æ–­å¼€æ—¶è‡ªåŠ¨ä½¿ç”¨ REST API å‘é€æ¶ˆæ¯

5. **ç¼“å­˜æœºåˆ¶**: æ¶ˆæ¯åˆ—è¡¨ç¼“å­˜åˆ° localStorageï¼Œæ¯æ¬¡ä¼šè¯ä¿ç•™æœ€è¿‘100æ¡

## æœ€è¿‘ä¿®å¤è®°å½•

### 2025-01-13 - æ¶æ„çº§æ€§èƒ½ä¼˜åŒ–ä¸é—®é¢˜ä¿®å¤

#### 1. ç™»å½•æ€§èƒ½ä¼˜åŒ– âš¡
**é—®é¢˜**: ç™»å½•åä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰æ•°æ®ï¼ˆä¼šè¯åˆ—è¡¨ã€å¥½å‹åˆ—è¡¨ã€ç»„ç»‡æ¶æ„ç­‰ï¼‰ï¼Œå¯¼è‡´é¡µé¢é•¿æ—¶é—´å¡é¡¿

**è§£å†³æ–¹æ¡ˆ**: å®ç°æ¸è¿›å¼åŠ è½½ç­–ç•¥ï¼ˆä¸‰é˜¶æ®µåŠ è½½ï¼‰
```
ç¬¬ä¸€é˜¶æ®µï¼ˆç«‹å³ï¼‰: WebSocketè¿æ¥ + æœ€è¿‘ä¼šè¯ï¼ˆ20æ¡ï¼‰
ç¬¬äºŒé˜¶æ®µï¼ˆ100msåï¼‰: å®Œæ•´ä¼šè¯åˆ—è¡¨ + å¥½å‹åˆ—è¡¨
ç¬¬ä¸‰é˜¶æ®µï¼ˆ500msåï¼‰: å¥½å‹è¯·æ±‚ + ç»„ç»‡æ¶æ„ + ç¦»çº¿æ¶ˆæ¯
```

**ä¿®æ”¹æ–‡ä»¶**:
- `ruoyi-im-web/src/views/im/ImChatLayoutOptimized.vue` - æ¸è¿›å¼åˆå§‹åŒ–é€»è¾‘
- æ–°å¢ `loadRecentSessionsOnly()` å¿«é€ŸåŠ è½½æ–¹æ³•

#### 2. WebSocketè®¤è¯ä¿®å¤ ğŸ”§
**é—®é¢˜**: æå››è´¦å·å‘é€æ¶ˆæ¯æ—¶æŠ¥é”™"å‘é€è€…ä¸å­˜åœ¨"

**æ ¹å› **: WebSocketè¿æ¥æ—¶æ— æ³•è·å–æ­£ç¡®çš„userIdï¼Œä½¿ç”¨äº†é»˜è®¤å€¼1L

**è§£å†³æ–¹æ¡ˆ**:
- ç§»é™¤é»˜è®¤userIdé€»è¾‘ï¼Œæ”¹ç”¨æœªè®¤è¯çŠ¶æ€æ ‡è®°(-1)
- å¢åŠ ç”¨æˆ·å­˜åœ¨æ€§éªŒè¯
- ä¿®å¤handleAuthMessageæ–¹æ³•çš„userIdæ›´æ–°é€»è¾‘
- ä¿®å¤onCloseå’ŒonErrorå¤„ç†æœªè®¤è¯ä¼šè¯

**ä¿®æ”¹æ–‡ä»¶**: `ruoyi-im-api/src/main/java/com/ruoyi/im/websocket/ImWebSocketEndpoint.java`

#### 3. å¥½å‹å…³ç³»æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ– ğŸš€
**é—®é¢˜**: N+1æŸ¥è¯¢é—®é¢˜ï¼Œæ¯ä¸ªå¥½å‹å•ç‹¬æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆ100ä¸ªå¥½å‹=100æ¬¡æŸ¥è¯¢ï¼‰

**è§£å†³æ–¹æ¡ˆ**: å®ç°æ‰¹é‡æŸ¥è¯¢
- æ–°å¢ `batchGetUsers()` æ–¹æ³•
- ä¼˜å…ˆä½¿ç”¨æ‰¹é‡æŸ¥è¯¢ï¼Œå›é€€åˆ°é€ä¸ªæŸ¥è¯¢
- ä¼˜åŒ– `getFriendList()` å’Œ `getGroupedFriendList()`

**ä¿®æ”¹æ–‡ä»¶**: `ruoyi-im-api/src/main/java/com/ruoyi/im/service/impl/ImFriendServiceImpl.java`

#### 4. Vuex Storeä¿®å¤
**é—®é¢˜**: sendMessage actionä½¿ç”¨æœªå®šä¹‰çš„state.ws

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨å¯¼å…¥çš„imWebSocketå•ä¾‹å®ä¾‹

**ä¿®æ”¹æ–‡ä»¶**: `ruoyi-im-web/src/store/modules/im.js`

### é¡¹ç›®å½“å‰çŠ¶æ€

**åç«¯ (ruoyi-im-api)**
- 40+ REST API æ§åˆ¶å™¨å®Œæ•´å®ç°
- WebSocket ç«¯ç‚¹: `/ws/im`
- æ”¯æŒæ¶ˆæ¯ã€è”ç³»äººã€ç¾¤ç»„ã€æ–‡ä»¶ã€DINGã€å®¡æ‰¹ã€è€ƒå‹¤ã€æ—¥ç¨‹ç­‰

**å‰ç«¯ (ruoyi-im-web)**
- 40+ è§†å›¾ç»„ä»¶å®Œæ•´
- WebSocket è‡ªåŠ¨é‡è¿ã€å¿ƒè·³æ£€æµ‹
- é’‰é’‰é£æ ¼UIç•Œé¢
- æ„å»ºæˆåŠŸï¼Œæ— é”™è¯¯

## TODO (å¾…å®Œå–„åŠŸèƒ½)

- [ ] è§†é¢‘é€šè¯åŠŸèƒ½ (WebRTC)
- [ ] è¯­éŸ³é€šè¯åŠŸèƒ½
- [ ] æ¶ˆæ¯åŠ å¯†ç«¯åˆ°ç«¯
- [ ] ç¾¤ç»„@æ‰€æœ‰äººåŠŸèƒ½å®Œå–„
- [ ] æ¶ˆæ¯æœç´¢åŠŸèƒ½
- [ ] æ–‡ä»¶é¢„è§ˆåŠŸèƒ½å¢å¼º
