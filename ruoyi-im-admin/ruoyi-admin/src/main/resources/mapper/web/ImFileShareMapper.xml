<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.web.mapper.ImFileShareMapper">

    <resultMap type="com.ruoyi.web.domain.ImFileShare" id="ImFileShareResult">
        <id property="id" column="id"/>
        <result property="fileId" column="file_id"/>
        <result property="fileName" column="file_name"/>
        <result property="fileSize" column="file_size"/>
        <result property="sharerId" column="sharer_id"/>
        <result property="sharerName" column="sharer_name"/>
        <result property="receiverIds" column="receiver_ids"/>
        <result property="receiverNames" column="receiver_names"/>
        <result property="permission" column="permission"/>
        <result property="accessPassword" column="access_password"/>
        <result property="allowDownload" column="allow_download"/>
        <result property="allowPreview" column="allow_preview"/>
        <result property="expireTime" column="expire_time"/>
        <result property="accessCount" column="access_count"/>
        <result property="downloadCount" column="download_count"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <sql id="selectImFileShareVo">
        SELECT s.id, s.file_id, s.sharer_id, s.receiver_ids, s.permission,
               s.access_password, s.allow_download, s.allow_preview,
               s.expire_time, s.access_count, s.download_count,
               s.create_time, s.update_time,
               f.file_name, f.file_size,
               u.username as sharer_name
        FROM im_file_share s
        LEFT JOIN im_file f ON s.file_id = f.id
        LEFT JOIN im_user u ON s.sharer_id = u.id
    </sql>

    <select id="selectImFileShareById" parameterType="Long" resultMap="ImFileShareResult">
        <include refid="selectImFileShareVo"/>
        WHERE s.id = #{id}
    </select>

    <select id="selectImFileShareList" parameterType="com.ruoyi.web.domain.ImFileShare" resultMap="ImFileShareResult">
        <include refid="selectImFileShareVo"/>
        <where>
            <if test="sharerId != null">and s.sharer_id = #{sharerId}</if>
            <if test="sharerName != null and sharerName != ''">and u.username like concat('%', #{sharerName}, '%')</if>
            <if test="fileName != null and fileName != ''">and f.file_name like concat('%', #{fileName}, '%')</if>
            <if test="permission != null">and s.permission = #{permission}</if>
            <if test="params.beginTime != null and params.beginTime != ''">
                AND date_format(s.expire_time,'%Y-%m-%d') &gt;= date_format(#{params.beginTime},'%Y-%m-%d')
            </if>
            <if test="params.endTime != null and params.endTime != ''">
                AND date_format(s.expire_time,'%Y-%m-%d') &lt;= date_format(#{params.endTime},'%Y-%m-%d')
            </if>
        </where>
        ORDER BY s.create_time DESC
    </select>

    <select id="selectSharesBySharerId" parameterType="Long" resultMap="ImFileShareResult">
        <include refid="selectImFileShareVo"/>
        WHERE s.sharer_id = #{sharerId}
        ORDER BY s.create_time DESC
    </select>

    <select id="selectExpiredShares" resultMap="ImFileShareResult">
        <include refid="selectImFileShareVo"/>
        WHERE s.expire_time &lt; NOW()
        ORDER BY s.expire_time ASC
    </select>

    <insert id="insertImFileShare" parameterType="com.ruoyi.web.domain.ImFileShare" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO im_file_share
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="fileId != null">file_id,</if>
            <if test="sharerId != null">sharer_id,</if>
            <if test="receiverIds != null">receiver_ids,</if>
            <if test="permission != null">permission,</if>
            <if test="accessPassword != null">access_password,</if>
            <if test="allowDownload != null">allow_download,</if>
            <if test="allowPreview != null">allow_preview,</if>
            <if test="expireTime != null">expire_time,</if>
            <if test="createTime != null">create_time,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="fileId != null">#{fileId},</if>
            <if test="sharerId != null">#{sharerId},</if>
            <if test="receiverIds != null">#{receiverIds},</if>
            <if test="permission != null">#{permission},</if>
            <if test="accessPassword != null">#{access_password},</if>
            <if test="allowDownload != null">#{allow_download},</if>
            <if test="allowPreview != null">#{allow_preview},</if>
            <if test="expireTime != null">#{expire_time},</if>
            <if test="createTime != null">#{createTime},</if>
        </trim>
    </insert>

    <update id="updateImFileShare" parameterType="com.ruoyi.web.domain.ImFileShare">
        UPDATE im_file_share
        <trim prefix="SET" suffixOverrides=",">
            <if test="receiverIds != null">receiver_ids = #{receiverIds},</if>
            <if test="permission != null">permission = #{permission},</if>
            <if test="accessPassword != null">access_password = #{accessPassword},</if>
            <if test="allowDownload != null">allow_download = #{allowDownload},</if>
            <if test="allowPreview != null">allow_preview = #{allowPreview},</if>
            <if test="expireTime != null">expire_time = #{expireTime},</if>
        </trim>
        WHERE id = #{id}
    </update>

    <update id="incrementAccessCount" parameterType="Long">
        UPDATE im_file_share
        SET access_count = access_count + 1
        WHERE id = #{id}
    </update>

    <update id="incrementDownloadCount" parameterType="Long">
        UPDATE im_file_share
        SET download_count = download_count + 1
        WHERE id = #{id}
    </update>

    <delete id="deleteImFileShareById" parameterType="Long">
        DELETE FROM im_file_share WHERE id = #{id}
    </delete>

    <delete id="deleteImFileShareByIds" parameterType="Long[]">
        DELETE FROM im_file_share WHERE id IN
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 获取文件分享统计数据 -->
    <select id="getFileShareStatistics" resultType="map">
        SELECT
            (SELECT COUNT(*) FROM im_file_share) AS totalCount,
            (SELECT COUNT(*) FROM im_file_share WHERE permission = 1) AS publicCount,
            (SELECT COUNT(*) FROM im_file_share WHERE permission = 2) AS specificCount,
            (SELECT COUNT(*) FROM im_file_share WHERE permission = 3) AS passwordCount,
            (SELECT COUNT(*) FROM im_file_share WHERE allow_download = 1) AS allowDownloadCount,
            (SELECT SUM(access_count) FROM im_file_share) AS totalAccessCount,
            (SELECT SUM(download_count) FROM im_file_share) AS totalDownloadCount,
            (SELECT COUNT(*) FROM im_file_share WHERE expire_time &lt; NOW()) AS expiredCount
    </select>

    <!-- 清理过期分享 -->
    <delete id="cleanExpiredShares">
        DELETE FROM im_file_share
        WHERE expire_time &lt; NOW()
    </delete>

</mapper>
