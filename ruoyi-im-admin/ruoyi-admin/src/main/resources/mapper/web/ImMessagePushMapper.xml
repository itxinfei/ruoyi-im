<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.web.mapper.ImMessagePushMapper">
    
    <select id="getOnlineUserCount" resultType="java.lang.Integer">
        select count(*) from im_user where status = 'online'
    </select>

    <select id="getOnlineUserIds" resultType="java.lang.Long">
        select id from im_user where status = 'online'
    </select>

    <select id="isUserOnline" parameterType="Long" resultType="java.lang.Boolean">
        select case when count(*) > 0 then true else false end
        from im_user
        where id = #{userId} and status = 'online'
    </select>

    <update id="disconnectUser" parameterType="Long">
        update im_user set status = 'offline' where id = #{userId}
    </update>

    <!-- 发送消息给用户 - 这里需要根据实际推送机制实现 -->
    <update id="sendMessageToUser">
        <!-- 实际实现需要调用WebSocket或其他推送服务 -->
        update im_message set status = 'delivered' 
        where id = (select max(id) from im_message where sender_id = 0)
    </update>

    <update id="broadcastMessage">
        <!-- 实际实现需要调用广播推送服务 -->
        update im_system_notification set is_read = 0 where 1=0
    </update>
</mapper>
