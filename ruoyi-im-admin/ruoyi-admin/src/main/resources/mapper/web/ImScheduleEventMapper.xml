<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.web.mapper.ImScheduleEventMapper">

    <resultMap type="com.ruoyi.web.domain.ImScheduleEvent" id="ImScheduleEventResult">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="username" column="username"/>
        <result property="nickname" column="nickname"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="location" column="location"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
        <result property="isAllDay" column="is_all_day"/>
        <result property="recurrenceType" column="recurrence_type"/>
        <result property="recurrenceEndDate" column="recurrence_end_date"/>
        <result property="recurrenceInterval" column="recurrence_interval"/>
        <result property="recurrenceDays" column="recurrence_days"/>
        <result property="color" column="color"/>
        <result property="visibility" column="visibility"/>
        <result property="status" column="status"/>
        <result property="reminderMinutes" column="reminder_minutes"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <sql id="selectImScheduleEventVo">
        SELECT e.id, e.user_id, e.title, e.description, e.location,
               e.start_time, e.end_time, e.is_all_day, e.recurrence_type,
               e.recurrence_end_date, e.recurrence_interval, e.recurrence_days,
               e.color, e.visibility, e.status, e.reminder_minutes,
               e.create_time, e.update_time,
               u.username, u.nickname
        FROM im_schedule_event e
        LEFT JOIN im_user u ON e.user_id = u.id
    </sql>

    <select id="selectImScheduleEventById" parameterType="Long" resultMap="ImScheduleEventResult">
        <include refid="selectImScheduleEventVo"/>
        WHERE e.id = #{id}
    </select>

    <select id="selectImScheduleEventList" parameterType="com.ruoyi.web.domain.ImScheduleEvent" resultMap="ImScheduleEventResult">
        <include refid="selectImScheduleEventVo"/>
        <where>
            <if test="userId != null">and e.user_id = #{userId}</if>
            <if test="username != null and username != ''">and u.username like concat('%', #{username}, '%')</if>
            <if test="nickname != null and nickname != ''">and u.nickname like concat('%', #{nickname}, '%')</if>
            <if test="title != null and title != ''">and e.title like concat('%', #{title}, '%')</if>
            <if test="location != null and location != ''">and e.location like concat('%', #{location}, '%')</if>
            <if test="status != null and status != ''">and e.status = #{status}</if>
            <if test="visibility != null and visibility != ''">and e.visibility = #{visibility}</if>
            <if test="recurrenceType != null and recurrenceType != ''">and e.recurrence_type = #{recurrenceType}</if>
            <if test="params.beginTime != null and params.beginTime != ''">
                AND e.start_time &gt;= #{params.beginTime}
            </if>
            <if test="params.endTime != null and params.endTime != ''">
                AND e.end_time &lt;= #{params.endTime}
            </if>
        </where>
        ORDER BY e.start_time ASC
    </select>

    <select id="selectEventsByUserId" parameterType="Long" resultMap="ImScheduleEventResult">
        <include refid="selectImScheduleEventVo"/>
        WHERE e.user_id = #{userId}
        AND e.status IN ('SCHEDULED', 'COMPLETED')
        ORDER BY e.start_time ASC
    </select>

    <select id="selectEventsByTimeRange" resultMap="ImScheduleEventResult">
        <include refid="selectImScheduleEventVo"/>
        WHERE e.user_id = #{userId}
        AND e.status = 'SCHEDULED'
        AND e.start_time &gt;= #{startTime}
        AND e.end_time &lt;= #{endTime}
        ORDER BY e.start_time ASC
    </select>

    <select id="selectUpcomingEvents" resultMap="ImScheduleEventResult">
        <include refid="selectImScheduleEventVo"/>
        WHERE e.user_id = #{userId}
        AND e.status = 'SCHEDULED'
        AND e.start_time &gt; NOW()
        AND e.start_time &lt;= DATE_ADD(NOW(), INTERVAL #{hours} HOUR)
        ORDER BY e.start_time ASC
    </select>

    <select id="selectTodayEvents" parameterType="Long" resultMap="ImScheduleEventResult">
        <include refid="selectImScheduleEventVo"/>
        WHERE e.user_id = #{userId}
        AND e.status = 'SCHEDULED'
        AND DATE(e.start_time) = CURDATE()
        ORDER BY e.start_time ASC
    </select>

    <insert id="insertImScheduleEvent" parameterType="com.ruoyi.web.domain.ImScheduleEvent" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO im_schedule_event
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="userId != null">user_id,</if>
            <if test="title != null">title,</if>
            <if test="description != null">description,</if>
            <if test="location != null">location,</if>
            <if test="startTime != null">start_time,</if>
            <if test="endTime != null">end_time,</if>
            <if test="isAllDay != null">is_all_day,</if>
            <if test="recurrenceType != null">recurrence_type,</if>
            <if test="recurrenceEndDate != null">recurrence_end_date,</if>
            <if test="recurrenceInterval != null">recurrence_interval,</if>
            <if test="recurrenceDays != null">recurrence_days,</if>
            <if test="color != null">color,</if>
            <if test="visibility != null">visibility,</if>
            <if test="status != null">status,</if>
            <if test="reminderMinutes != null">reminder_minutes,</if>
            <if test="createTime != null">create_time,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="userId != null">#{userId},</if>
            <if test="title != null">#{title},</if>
            <if test="description != null">#{description},</if>
            <if test="location != null">#{location},</if>
            <if test="startTime != null">#{startTime},</if>
            <if test="endTime != null">#{endTime},</if>
            <if test="isAllDay != null">#{isAllDay},</if>
            <if test="recurrenceType != null">#{recurrenceType},</if>
            <if test="recurrenceEndDate != null">#{recurrenceEndDate},</if>
            <if test="recurrenceInterval != null">#{recurrenceInterval},</if>
            <if test="recurrenceDays != null">#{recurrenceDays},</if>
            <if test="color != null">#{color},</if>
            <if test="visibility != null">#{visibility},</if>
            <if test="status != null">#{status},</if>
            <if test="reminderMinutes != null">#{reminderMinutes},</if>
            <if test="createTime != null">#{createTime},</if>
        </trim>
    </insert>

    <update id="updateImScheduleEvent" parameterType="com.ruoyi.web.domain.ImScheduleEvent">
        UPDATE im_schedule_event
        <trim prefix="SET" suffixOverrides=",">
            <if test="title != null">title = #{title},</if>
            <if test="description != null">description = #{description},</if>
            <if test="location != null">location = #{location},</if>
            <if test="startTime != null">start_time = #{startTime},</if>
            <if test="endTime != null">end_time = #{endTime},</if>
            <if test="isAllDay != null">is_all_day = #{isAllDay},</if>
            <if test="recurrenceType != null">recurrence_type = #{recurrenceType},</if>
            <if test="recurrenceEndDate != null">recurrence_end_date = #{recurrenceEndDate},</if>
            <if test="recurrenceInterval != null">recurrence_interval = #{recurrenceInterval},</if>
            <if test="recurrenceDays != null">recurrence_days = #{recurrenceDays},</if>
            <if test="color != null">color = #{color},</if>
            <if test="visibility != null">visibility = #{visibility},</if>
            <if test="status != null">status = #{status},</if>
            <if test="reminderMinutes != null">reminder_minutes = #{reminderMinutes},</if>
        </trim>
        WHERE id = #{id}
    </update>

    <update id="updateEventStatus">
        UPDATE im_schedule_event
        SET status = #{status}, update_time = NOW()
        WHERE id = #{id}
    </update>

    <delete id="deleteImScheduleEventById" parameterType="Long">
        DELETE FROM im_schedule_event WHERE id = #{id}
    </delete>

    <delete id="deleteImScheduleEventByIds" parameterType="Long[]">
        DELETE FROM im_schedule_event WHERE id IN
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 获取日程统计数据 -->
    <select id="getEventStatistics" resultType="map">
        SELECT
            (SELECT COUNT(*) FROM im_schedule_event) AS totalCount,
            (SELECT COUNT(*) FROM im_schedule_event WHERE status = 'SCHEDULED') AS scheduledCount,
            (SELECT COUNT(*) FROM im_schedule_event WHERE status = 'COMPLETED') AS completedCount,
            (SELECT COUNT(*) FROM im_schedule_event WHERE status = 'CANCELLED') AS cancelledCount,
            (SELECT COUNT(*) FROM im_schedule_event WHERE DATE(start_time) = CURDATE()) AS todayCount,
            (SELECT COUNT(*) FROM im_schedule_event WHERE recurrence_type IS NOT NULL AND recurrence_type != 'NONE') AS recurringCount
    </select>

</mapper>
