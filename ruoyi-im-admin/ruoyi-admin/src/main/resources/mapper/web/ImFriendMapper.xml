<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.web.mapper.ImFriendMapper">

    <resultMap type="com.ruoyi.web.domain.ImFriend" id="ImFriendResult">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="friendId" column="friend_id"/>
        <result property="remark" column="remark"/>
        <result property="groupName" column="group_name"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="deletedTime" column="deleted_time"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <!-- 关联字段 -->
        <result property="friendUsername" column="friend_username"/>
        <result property="friendNickname" column="friend_nickname"/>
        <result property="friendAvatar" column="friend_avatar"/>
        <result property="friendMobile" column="friend_mobile"/>
        <result property="friendStatus" column="friend_status"/>
        <result property="userName" column="user_name"/>
    </resultMap>

    <sql id="selectImFriendVo">
        select f.id, f.user_id, f.friend_id, f.remark, f.group_name,
               f.is_deleted, f.deleted_time, f.create_time, f.update_time
        from im_friend f
    </sql>

    <sql id="selectImFriendWithUserVo">
        select f.id, f.user_id, f.friend_id, f.remark, f.group_name,
               f.is_deleted, f.deleted_time, f.create_time, f.update_time,
               u1.username as user_name,
               u2.username as friend_username, u2.nickname as friend_nickname,
               u2.avatar as friend_avatar, u2.mobile as friend_mobile, u2.status as friend_status
        from im_friend f
        left join im_user u1 on f.user_id = u1.id
        left join im_user u2 on f.friend_id = u2.id
    </sql>

    <select id="selectImFriendById" parameterType="Long" resultMap="ImFriendResult">
        <include refid="selectImFriendWithUserVo"/>
        where f.id = #{id}
    </select>

    <select id="selectImFriendList" parameterType="com.ruoyi.web.domain.ImFriend" resultMap="ImFriendResult">
        <include refid="selectImFriendWithUserVo"/>
        <where>
            f.is_deleted = 0
            <if test="userId != null">and f.user_id = #{userId}</if>
            <if test="friendId != null">and f.friend_id = #{friendId}</if>
            <if test="groupName != null and groupName != ''">and f.group_name = #{groupName}</if>
            <if test="remark != null and remark != ''">and f.remark like concat('%', #{remark}, '%')</if>
        </where>
        order by f.create_time desc
    </select>

    <select id="selectFriendsByUserId" parameterType="Long" resultMap="ImFriendResult">
        <include refid="selectImFriendWithUserVo"/>
        where f.user_id = #{userId} and f.is_deleted = 0
        order by f.group_name asc, f.create_time desc
    </select>

    <select id="selectFriendGroups" parameterType="Long" resultType="java.lang.String">
        select distinct group_name from im_friend
        where user_id = #{userId} and is_deleted = 0 and group_name is not null
        order by group_name asc
    </select>

    <select id="checkFriendExists" parameterType="map" resultType="java.lang.Integer">
        select count(*) from im_friend
        where user_id = #{userId} and friend_id = #{friendId} and is_deleted = 0
    </select>

    <select id="selectFriendByUserAndFriend" parameterType="map" resultMap="ImFriendResult">
        <include refid="selectImFriendWithUserVo"/>
        where f.user_id = #{userId} and f.friend_id = #{friendId} and f.is_deleted = 0
    </select>

    <insert id="insertImFriend" parameterType="com.ruoyi.web.domain.ImFriend" useGeneratedKeys="true" keyProperty="id">
        insert into im_friend
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="userId != null">user_id,</if>
            <if test="friendId != null">friend_id,</if>
            <if test="remark != null">remark,</if>
            <if test="groupName != null">group_name,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateTime != null">update_time,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="userId != null">#{userId},</if>
            <if test="friendId != null">#{friendId},</if>
            <if test="remark != null">#{remark},</if>
            <if test="groupName != null">#{groupName},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateTime != null">#{updateTime},</if>
        </trim>
    </insert>

    <update id="updateImFriend" parameterType="com.ruoyi.web.domain.ImFriend">
        update im_friend
        <trim prefix="SET" suffixOverrides=",">
            <if test="remark != null">remark = #{remark},</if>
            <if test="groupName != null">group_name = #{groupName},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </trim>
        where id = #{id}
    </update>

    <update id="deleteImFriendById" parameterType="Long">
        update im_friend set is_deleted = 1, deleted_time = now() where id = #{id}
    </update>

    <update id="deleteImFriendByIds" parameterType="Long[]">
        update im_friend set is_deleted = 1, deleted_time = now() where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <update id="deleteFriendByUserAndFriend" parameterType="map">
        update im_friend set is_deleted = 1, deleted_time = now()
        where user_id = #{userId} and friend_id = #{friendId}
    </update>

    <!-- 统计好友关系总数 -->
    <select id="countTotalFriends" resultType="java.lang.Integer">
        select count(*) from im_friend where is_deleted = 0
    </select>

    <!-- 统计今日新增好友数 -->
    <select id="countTodayAddedFriends" resultType="java.lang.Integer">
        select count(*) from im_friend
        where is_deleted = 0 and DATE(create_time) = CURDATE()
    </select>

    <!-- 统计待处理好友申请数 -->
    <select id="countPendingRequests" resultType="java.lang.Integer">
        select count(*) from im_friend_request
        where status = 'PENDING'
    </select>

    <!-- 查询所有好友分组（去重） -->
    <select id="selectDistinctGroups" resultType="java.lang.String">
        select distinct group_name from im_friend
        where is_deleted = 0 and group_name is not null and group_name != ''
        order by group_name asc
    </select>

    <!-- 查询两个用户之间是否存在好友关系 -->
    <select id="selectFriendByUsers" parameterType="map" resultMap="ImFriendResult">
        <include refid="selectImFriendWithUserVo"/>
        where f.user_id = #{userId} and f.friend_id = #{friendId} and f.is_deleted = 0
    </select>

</mapper>
