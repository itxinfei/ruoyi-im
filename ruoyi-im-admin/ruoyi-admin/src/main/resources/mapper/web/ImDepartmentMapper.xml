<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.web.mapper.ImDepartmentMapper">

    <resultMap type="com.ruoyi.web.domain.ImDepartment" id="ImDepartmentResult">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="parentId" column="parent_id"/>
        <result property="parentName" column="parent_name"/>
        <result property="ancestors" column="ancestors"/>
        <result property="orderNum" column="order_num"/>
        <result property="leaderId" column="leader_id"/>
        <result property="leaderName" column="leader_name"/>
        <result property="phone" column="phone"/>
        <result property="email" column="email"/>
        <result property="status" column="status"/>
        <result property="delFlag" column="del_flag"/>
        <result property="remark" column="remark"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <sql id="selectImDepartmentVo">
        SELECT d.id, d.name, d.parent_id, d.ancestors, d.order_num, d.leader_id,
               d.phone, d.email, d.status, d.del_flag, d.remark,
               d.create_time, d.update_time,
               p.name as parent_name,
               l.nickname as leader_name
        FROM im_department d
        LEFT JOIN im_department p ON d.parent_id = p.id
        LEFT JOIN im_user l ON d.leader_id = l.id
    </sql>

    <select id="selectImDepartmentById" parameterType="Long" resultMap="ImDepartmentResult">
        <include refid="selectImDepartmentVo"/>
        WHERE d.id = #{id}
        AND d.del_flag = 0
    </select>

    <select id="selectImDepartmentList" parameterType="com.ruoyi.web.domain.ImDepartment" resultMap="ImDepartmentResult">
        <include refid="selectImDepartmentVo"/>
        <where>
            d.del_flag = 0
            <if test="name != null and name != ''">and d.name like concat('%', #{name}, '%')</if>
            <if test="status != null">and d.status = #{status}</if>
            <if test="parentId != null">and d.parent_id = #{parentId}</if>
            <if test="params.beginTime != null and params.beginTime != ''">
                AND date_format(d.create_time,'%Y-%m-%d') &gt;= date_format(#{params.beginTime},'%Y-%m-%d')
            </if>
            <if test="params.endTime != null and params.endTime != ''">
                AND date_format(d.create_time,'%Y-%m-%d') &lt;= date_format(#{params.endTime},'%Y-%m-%d')
            </if>
        </where>
        ORDER BY d.parent_id, d.order_num
    </select>

    <select id="selectImDepartmentTree" parameterType="com.ruoyi.web.domain.ImDepartment" resultMap="ImDepartmentResult">
        <include refid="selectImDepartmentVo"/>
        <where>
            d.del_flag = 0
            <if test="name != null and name != ''">and d.name like concat('%', #{name}, '%')</if>
            <if test="status != null">and d.status = #{status}</if>
        </where>
        ORDER BY d.parent_id, d.order_num
    </select>

    <select id="selectChildrenByParentId" parameterType="Long" resultMap="ImDepartmentResult">
        <include refid="selectImDepartmentVo"/>
        WHERE d.parent_id = #{parentId}
        AND d.del_flag = 0
        ORDER BY d.order_num
    </select>

    <insert id="insertImDepartment" parameterType="com.ruoyi.web.domain.ImDepartment" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO im_department
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="name != null">name,</if>
            <if test="parentId != null">parent_id,</if>
            <if test="ancestors != null">ancestors,</if>
            <if test="orderNum != null">order_num,</if>
            <if test="leaderId != null">leader_id,</if>
            <if test="phone != null">phone,</if>
            <if test="email != null">email,</if>
            <if test="status != null">status,</if>
            <if test="remark != null">remark,</if>
            <if test="createTime != null">create_time,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="name != null">#{name},</if>
            <if test="parentId != null">#{parentId},</if>
            <if test="ancestors != null">#{ancestors},</if>
            <if test="orderNum != null">#{orderNum},</if>
            <if test="leaderId != null">#{leaderId},</if>
            <if test="phone != null">#{phone},</if>
            <if test="email != null">#{email},</if>
            <if test="status != null">#{status},</if>
            <if test="remark != null">#{remark},</if>
            <if test="createTime != null">#{createTime},</if>
        </trim>
    </insert>

    <update id="updateImDepartment" parameterType="com.ruoyi.web.domain.ImDepartment">
        UPDATE im_department
        <trim prefix="SET" suffixOverrides=",">
            <if test="name != null">name = #{name},</if>
            <if test="parentId != null">parent_id = #{parentId},</if>
            <if test="ancestors != null">ancestors = #{ancestors},</if>
            <if test="orderNum != null">order_num = #{orderNum},</if>
            <if test="leaderId != null">leader_id = #{leaderId},</if>
            <if test="phone != null">phone = #{phone},</if>
            <if test="email != null">email = #{email},</if>
            <if test="status != null">status = #{status},</if>
            <if test="remark != null">remark = #{remark},</if>
        </trim>
        WHERE id = #{id}
    </update>

    <update id="updateDepartmentStatus">
        UPDATE im_department
        SET status = #{status}
        WHERE id = #{id}
    </update>

    <delete id="deleteImDepartmentById" parameterType="Long">
        UPDATE im_department SET del_flag = 1 WHERE id = #{id}
    </delete>

    <delete id="deleteImDepartmentByIds" parameterType="Long[]">
        UPDATE im_department SET del_flag = 1 WHERE id IN
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <select id="checkHasChildren" parameterType="Long" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM im_department
        WHERE parent_id = #{id}
        AND del_flag = 0
    </select>

    <!-- 获取部门统计数据 -->
    <select id="getDepartmentStatistics" resultType="map">
        SELECT
            (SELECT COUNT(*) FROM im_department WHERE del_flag = 0) AS totalCount,
            (SELECT COUNT(*) FROM im_department WHERE del_flag = 0 AND status = 0) AS activeCount,
            (SELECT COUNT(*) FROM im_department WHERE del_flag = 0 AND status = 1) AS disabledCount,
            (SELECT COUNT(*) FROM im_department WHERE del_flag = 0 AND parent_id = 0) AS rootCount
    </select>

</mapper>
