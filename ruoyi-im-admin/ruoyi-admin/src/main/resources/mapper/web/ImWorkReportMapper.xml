<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.web.mapper.ImWorkReportMapper">

    <resultMap type="com.ruoyi.web.domain.ImWorkReport" id="ImWorkReportResult">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="username" column="username"/>
        <result property="nickname" column="nickname"/>
        <result property="reportType" column="report_type"/>
        <result property="reportDate" column="report_date"/>
        <result property="workContent" column="work_content"/>
        <result property="completionStatus" column="completion_status"/>
        <result property="tomorrowPlan" column="tomorrow_plan"/>
        <result property="issues" column="issues"/>
        <result property="attachments" column="attachments"/>
        <result property="workHours" column="work_hours"/>
        <result property="visibility" column="visibility"/>
        <result property="submitTime" column="submit_time"/>
        <result property="status" column="status"/>
        <result property="approverId" column="approver_id"/>
        <result property="approverName" column="approver_name"/>
        <result property="approveTime" column="approve_time"/>
        <result property="approveRemark" column="approve_remark"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <sql id="selectImWorkReportVo">
        SELECT r.id, r.user_id, r.report_type, r.report_date, r.work_content,
               r.completion_status, r.tomorrow_plan, r.issues, r.attachments,
               r.work_hours, r.visibility, r.submit_time, r.status,
               r.approver_id, r.approve_time, r.approve_remark,
               r.create_time, r.update_time,
               u.username, u.nickname,
               a.username as approver_name
        FROM im_work_report r
        LEFT JOIN im_user u ON r.user_id = u.id
        LEFT JOIN im_user a ON r.approver_id = a.id
    </sql>

    <select id="selectImWorkReportById" parameterType="Long" resultMap="ImWorkReportResult">
        <include refid="selectImWorkReportVo"/>
        WHERE r.id = #{id}
    </select>

    <select id="selectImWorkReportList" parameterType="com.ruoyi.web.domain.ImWorkReport" resultMap="ImWorkReportResult">
        <include refid="selectImWorkReportVo"/>
        <where>
            <if test="userId != null">and r.user_id = #{userId}</if>
            <if test="username != null and username != ''">and u.username like concat('%', #{username}, '%')</if>
            <if test="nickname != null and nickname != ''">and u.nickname like concat('%', #{nickname}, '%')</if>
            <if test="reportType != null and reportType != ''">and r.report_type = #{reportType}</if>
            <if test="status != null and status != ''">and r.status = #{status}</if>
            <if test="completionStatus != null and completionStatus != ''">and r.completion_status = #{completionStatus}</if>
            <if test="visibility != null and visibility != ''">and r.visibility = #{visibility}</if>
            <if test="params.beginTime != null and params.beginTime != ''">
                AND date_format(r.report_date,'%Y-%m-%d') &gt;= date_format(#{params.beginTime},'%Y-%m-%d')
            </if>
            <if test="params.endTime != null and params.endTime != ''">
                AND date_format(r.report_date,'%Y-%m-%d') &lt;= date_format(#{params.endTime},'%Y-%m-%d')
            </if>
        </where>
        ORDER BY r.submit_time DESC
    </select>

    <select id="selectReportsByUserId" parameterType="Long" resultMap="ImWorkReportResult">
        <include refid="selectImWorkReportVo"/>
        WHERE r.user_id = #{userId}
        ORDER BY r.submit_time DESC
    </select>

    <select id="selectReportsByDateRange" resultMap="ImWorkReportResult">
        <include refid="selectImWorkReportVo"/>
        WHERE r.report_date &gt;= #{startDate}
        AND r.report_date &lt;= #{endDate}
        ORDER BY r.submit_time DESC
    </select>

    <select id="selectPendingApprovalReports" resultMap="ImWorkReportResult">
        <include refid="selectImWorkReportVo"/>
        WHERE r.status = 'SUBMITTED'
        ORDER BY r.submit_time ASC
    </select>

    <insert id="insertImWorkReport" parameterType="com.ruoyi.web.domain.ImWorkReport" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO im_work_report
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="userId != null">user_id,</if>
            <if test="reportType != null">report_type,</if>
            <if test="reportDate != null">report_date,</if>
            <if test="workContent != null">work_content,</if>
            <if test="completionStatus != null">completion_status,</if>
            <if test="tomorrowPlan != null">tomorrow_plan,</if>
            <if test="issues != null">issues,</if>
            <if test="attachments != null">attachments,</if>
            <if test="workHours != null">work_hours,</if>
            <if test="visibility != null">visibility,</if>
            <if test="submitTime != null">submit_time,</if>
            <if test="status != null">status,</if>
            <if test="createTime != null">create_time,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="userId != null">#{userId},</if>
            <if test="reportType != null">#{reportType},</if>
            <if test="reportDate != null">#{reportDate},</if>
            <if test="workContent != null">#{workContent},</if>
            <if test="completionStatus != null">#{completionStatus},</if>
            <if test="tomorrowPlan != null">#{tomorrowPlan},</if>
            <if test="issues != null">#{issues},</if>
            <if test="attachments != null">#{attachments},</if>
            <if test="workHours != null">#{workHours},</if>
            <if test="visibility != null">#{visibility},</if>
            <if test="submitTime != null">#{submitTime},</if>
            <if test="status != null">#{status},</if>
            <if test="createTime != null">#{createTime},</if>
        </trim>
    </insert>

    <update id="updateImWorkReport" parameterType="com.ruoyi.web.domain.ImWorkReport">
        UPDATE im_work_report
        <trim prefix="SET" suffixOverrides=",">
            <if test="reportType != null">report_type = #{reportType},</if>
            <if test="reportDate != null">report_date = #{reportDate},</if>
            <if test="workContent != null">work_content = #{workContent},</if>
            <if test="completionStatus != null">completion_status = #{completionStatus},</if>
            <if test="tomorrowPlan != null">tomorrow_plan = #{tomorrowPlan},</if>
            <if test="issues != null">issues = #{issues},</if>
            <if test="attachments != null">attachments = #{attachments},</if>
            <if test="workHours != null">work_hours = #{workHours},</if>
            <if test="visibility != null">visibility = #{visibility},</if>
            <if test="submitTime != null">submit_time = #{submitTime},</if>
            <if test="status != null">status = #{status},</if>
        </trim>
        WHERE id = #{id}
    </update>

    <update id="updateReportStatus">
        UPDATE im_work_report
        SET status = #{status}, update_time = NOW()
        WHERE id = #{id}
    </update>

    <update id="approveReport">
        UPDATE im_work_report
        SET status = #{status},
            approver_id = #{approverId},
            approve_time = NOW(),
            approve_remark = #{remark},
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <delete id="deleteImWorkReportById" parameterType="Long">
        DELETE FROM im_work_report WHERE id = #{id}
    </delete>

    <delete id="deleteImWorkReportByIds" parameterType="Long[]">
        DELETE FROM im_work_report WHERE id IN
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 获取工作报告统计数据 -->
    <select id="getReportStatistics" resultType="map">
        SELECT
            (SELECT COUNT(*) FROM im_work_report) AS totalCount,
            (SELECT COUNT(*) FROM im_work_report WHERE report_type = 'DAILY') AS dailyCount,
            (SELECT COUNT(*) FROM im_work_report WHERE report_type = 'WEEKLY') AS weeklyCount,
            (SELECT COUNT(*) FROM im_work_report WHERE report_type = 'MONTHLY') AS monthlyCount,
            (SELECT COUNT(*) FROM im_work_report WHERE status = 'SUBMITTED') AS submittedCount,
            (SELECT COUNT(*) FROM im_work_report WHERE status = 'APPROVED') AS approvedCount,
            (SELECT COUNT(*) FROM im_work_report WHERE status = 'REJECTED') AS rejectedCount,
            (SELECT COUNT(*) FROM im_work_report WHERE DATE(report_date) = CURDATE()) AS todayCount
    </select>

    <!-- 按类型统计报告数量 -->
    <select id="countByReportType" resultType="map">
        SELECT report_type AS name, COUNT(*) AS count
        FROM im_work_report
        GROUP BY report_type
    </select>

</mapper>
