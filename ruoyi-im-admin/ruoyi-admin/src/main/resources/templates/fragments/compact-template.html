<!-- 紧凑页面头部模板 -->
<th:block th:fragment="compact-header(title, prefix)">
<div class="compact-container">
    <!-- 紧凑头部 -->
    <div class="compact-header">
        <h2 class="compact-title" th:text="${title}">标题</h2>
        <div class="compact-toolbar-right">
            <button class="btn btn-default compact-btn" th:if="${prefix} != null" th:onclick="'showBatchOperation(\'' + ${prefix} + '\')'">
                <i class="fa fa-list compact-icon"></i>批量操作
            </button>
            <button class="btn btn-primary compact-btn" onclick="$.operate.add()" shiro:hasPermission="${prefix}:add">
                <i class="fa fa-plus compact-icon"></i>新增
            </button>
        </div>
    </div>
</th:block>

<!-- 紧凑统计卡片模板 -->
<th:block th:fragment="compact-stats(items)">
<div class="compact-stats">
    <div th:each="item : ${items}" class="compact-stat-item" th:onclick="${item.click}">
        <div class="compact-stat-label">
            <i th:class="'fa ' + ${item.icon} + ' compact-icon'" th:style="'color: ' + ${item.color}"></i>
            <span th:text="${item.label}">标签</span>
        </div>
        <div class="compact-stat-value" th:id="${item.id}">-</div>
    </div>
</div>
</th:block>

<!-- 紧凑搜索栏模板 -->
<th:block th:fragment="compact-filter(formId, fields)">
<div class="compact-filter">
    <form th:id="${formId}">
        <div th:each="row : ${fields}" class="compact-filter-row">
            <div th:each="field : ${row}" class="compact-filter-item">
                <span class="compact-filter-label" th:text="${field.label}">标签</span>
                <th:block th:if="${field.type} == 'text'">
                    <input type="text" class="compact-filter-input" th:name="${field.name}" th:placeholder="${field.placeholder}" />
                </th:block>
                <th:block th:if="${field.type} == 'select'">
                    <select class="compact-filter-select" th:name="${field.name}">
                        <option value="">全部</option>
                        <option th:each="option : ${field.options}" th:value="${option.value}" th:text="${option.label}">选项</option>
                    </select>
                </th:block>
                <th:block th:if="${field.type} == 'date'">
                    <input type="text" class="compact-filter-input" th:name="${field.name}" th:placeholder="${field.placeholder}" />
                </th:block>
            </div>
        </div>
        <div class="compact-filter-row">
            <div class="compact-filter-item" style="flex: 0;">
                <button type="button" class="btn btn-default compact-filter-btn" onclick="resetSearch()">
                    <i class="fa fa-refresh"></i>
                </button>
                <button type="button" class="btn btn-primary compact-filter-btn" onclick="doSearch()">
                    <i class="fa fa-search"></i>
                </button>
            </div>
        </div>
    </form>
</div>
</th:block>

<!-- 紧凑表格卡片模板 -->
<th:block th:fragment="compact-table(toolbarPrefix)">
<div class="compact-table-card">
    <!-- 批量操作栏 -->
    <div class="compact-batch-toolbar" id="batchToolbar">
        <span class="compact-batch-info">已选 <span id="selectedCount">0</span> 项</span>
        <div class="compact-batch-actions">
            <button class="btn btn-success compact-btn" onclick="batchEnable()" shiro:hasPermission="${toolbarPrefix}:edit">
                <i class="fa fa-check compact-icon"></i>启用
            </button>
            <button class="btn btn-warning compact-btn" onclick="batchDisable()" shiro:hasPermission="${toolbarPrefix}:edit">
                <i class="fa fa-ban compact-icon"></i>停用
            </button>
            <button class="btn btn-danger compact-btn" onclick="batchDelete()" shiro:hasPermission="${toolbarPrefix}:remove">
                <i class="fa fa-trash compact-icon"></i>删除
            </button>
            <button class="btn btn-info compact-btn" onclick="batchExport()" shiro:hasPermission="${toolbarPrefix}:export">
                <i class="fa fa-download compact-icon"></i>导出
            </button>
        </div>
    </div>

    <!-- 工具栏 -->
    <div class="compact-toolbar">
        <div class="compact-toolbar-left">
            <button class="btn btn-primary compact-btn" onclick="$.operate.add()" shiro:hasPermission="${toolbarPrefix}:add">
                <i class="fa fa-plus compact-icon"></i>新增
            </button>
            <button class="btn btn-success compact-btn" onclick="showImportModal()" shiro:hasPermission="${toolbarPrefix}:import">
                <i class="fa fa-upload compact-icon"></i>导入
            </button>
            <div class="compact-divider"></div>
            <button class="btn btn-default compact-btn" onclick="refreshTable()">
                <i class="fa fa-refresh compact-icon"></i>刷新
            </button>
        </div>
        <div class="compact-toolbar-right">
            <button class="btn btn-info compact-btn" onclick="$.table.exportExcel()" shiro:hasPermission="${toolbarPrefix}:export">
                <i class="fa fa-download compact-icon"></i>导出
            </button>
            <button class="btn btn-default compact-btn" onclick="toggleColumns()">
                <i class="fa fa-columns compact-icon"></i>列
            </button>
            <select class="compact-filter-select" id="pageSizeSelect" onchange="changePageSize()">
                <option value="20">20条</option>
                <option value="50">50条</option>
                <option value="100">100条</option>
            </select>
        </div>
    </div>

    <!-- 表格 -->
    <table id="bootstrap-table"
           class="table table-condensed table-striped"
           data-mobile-responsive="true"
           data-pagination="true"
           data-page-list="[20,50,100]"
           data-page-size="20"
           data-side-pagination="server">
    </table>

    <!-- 紧凑分页 -->
    <div class="compact-pagination">
        <span class="compact-pagination-info" id="paginationInfo">显示 1-20 条，共 0 条</span>
        <div class="compact-pagination-btns" id="paginationBtns"></div>
    </div>
</div>
</div>
</th:block>

<!-- 紧凑页面底部模板 -->
<th:block th:fragment="compact-footer(prefix)">
</div>

<th:block th:include="include :: footer" />
<th:block th:include="include :: bootstrap-table-export-js" />
<script th:src="@{/js/im-common.js}"></script>
<script th:inline="javascript">
var editFlag = [[${@permission.hasPermi('${prefix}:edit')}]];
var removeFlag = [[${@permission.hasPermi('${prefix}:remove')}]];
var prefix = ctx + "${prefix}";

$(function () {
    loadStatistics();
    initTable();
});

function loadStatistics() {
    // 子页面实现
}

function initTable() {
    // 子页面实现
}

function doSearch() {
    $.table.search();
}

function resetSearch() {
    $('#' + prefix + '-form')[0].reset();
    $.table.search();
}

function refreshTable() {
    $.table.refresh();
    loadStatistics();
}

function batchEnable() {
    var ids = $.table.selectColumns("id");
    if (!ImCommon.validateBatchOperation(ids, 1)) return;
    $.modal.confirm("确定要批量启用选中的 " + ids.length + " 项吗？", function () {
        $.operate.post(prefix + "/batchChangeStatus", { ids: ids.join(","), status: 1 }, function (res) {
            if (res.code == 0) {
                $.table.refresh();
                loadStatistics();
            }
        });
    });
}

function batchDisable() {
    var ids = $.table.selectColumns("id");
    if (!ImCommon.validateBatchOperation(ids, 1)) return;
    $.modal.confirm("确定要批量停用选中的 " + ids.length + " 项吗？", function () {
        $.operate.post(prefix + "/batchChangeStatus", { ids: ids.join(","), status: 0 }, function (res) {
            if (res.code == 0) {
                $.table.refresh();
                loadStatistics();
            }
        });
    });
}

function batchDelete() {
    var ids = $.table.selectColumns("id");
    if (!ImCommon.validateBatchOperation(ids, 1)) return;
    $.modal.confirm("确定要删除选中的 " + ids.length + " 项吗？此操作不可恢复！", function () {
        $.operate.post(prefix + "/batchRemove", { ids: ids.join(",") }, function (res) {
            if (res.code == 0) {
                $.table.refresh();
                loadStatistics();
            }
        });
    });
}

function batchExport() {
    var ids = $.table.selectColumns("id");
    window.location.href = prefix + "/export?ids=" + ids.join(",");
}

function showImportModal() {
    $.modal.open("导入", prefix + "/import", 600, 400);
}

function showBatchOperation(modulePrefix) {
    $.modal.open("批量操作", ctx + modulePrefix + "/batch_operations", 700, 500);
}

function toggleColumns() {
    // 列设置功能
}

function changePageSize() {
    var pageSize = $('#pageSizeSelect').val();
    $('#bootstrap-table').bootstrapTable('refreshOptions', {
        pageSize: pageSize
    });
}

function updateBatchToolbar() {
    var selectedCount = $.table.selectColumns("id").length;
    $('#selectedCount').text(selectedCount);
    if (selectedCount > 0) {
        $('#batchToolbar').addClass('active');
    } else {
        $('#batchToolbar').removeClass('active');
    }
}

function updatePaginationInfo(data) {
    var total = data.total;
    var pageSize = $('#bootstrap-table').bootstrapTable('getOptions').pageSize;
    var pageNumber = $('#bootstrap-table').bootstrapTable('getOptions').pageNumber;
    var from = (pageNumber - 1) * pageSize + 1;
    var to = Math.min(pageNumber * pageSize, total);
    $('#paginationInfo').text('显示 ' + from + '-' + to + ' 条，共 ' + total + ' 条');
}

function updatePaginationBtns(data) {
    var total = data.total;
    var pageSize = $('#bootstrap-table').bootstrapTable('getOptions').pageSize;
    var pageNumber = $('#bootstrap-table').bootstrapTable('getOptions').pageNumber;
    var totalPages = Math.ceil(total / pageSize);

    var html = '';
    html += '<button class="compact-page-btn" onclick="goToPage(1)" ' + (pageNumber == 1 ? 'disabled' : '') + '><i class="fa fa-angle-double-left"></i></button>';
    html += '<button class="compact-page-btn" onclick="goToPage(' + (pageNumber - 1) + ')" ' + (pageNumber == 1 ? 'disabled' : '') + '><i class="fa fa-angle-left"></i></button>';

    var startPage = Math.max(1, pageNumber - 2);
    var endPage = Math.min(totalPages, pageNumber + 2);

    for (var i = startPage; i <= endPage; i++) {
        html += '<button class="compact-page-btn ' + (i == pageNumber ? 'active' : '') + '" onclick="goToPage(' + i + ')">' + i + '</button>';
    }

    html += '<button class="compact-page-btn" onclick="goToPage(' + (pageNumber + 1) + ')" ' + (pageNumber == totalPages ? 'disabled' : '') + '><i class="fa fa-angle-right"></i></button>';
    html += '<button class="compact-page-btn" onclick="goToPage(' + totalPages + ')" ' + (pageNumber == totalPages ? 'disabled' : '') + '><i class="fa fa-angle-double-right"></i></button>';

    $('#paginationBtns').html(html);
}

function goToPage(page) {
    $('#bootstrap-table').bootstrapTable('selectPage', page);
}
</script>
</body>
</html>
</th:block>
