<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>新增文件</title>
    <link href="/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}" rel="stylesheet"/>
    <link href="/ruoyi/css/ry-ui.css" th:href="@{/ruoyi/css/ry-ui.css}" rel="stylesheet"/>
</head>
<body class="white-bg">
    <form class="form-horizontal m" id="form-file-add" enctype="multipart/form-data">
        <div class="form-group">
            <label class="col-sm-3 control-label is-required">上传文件：</label>
            <div class="col-sm-8">
                <input type="file" name="file" class="form-control" id="fileInput" accept="*/*" required>
                <span class="help-block m-b-none"><i class="fa fa-info-circle"></i> 支持所有类型文件上传</span>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">文件名：</label>
            <div class="col-sm-8">
                <input name="fileName" placeholder="请输入文件名" class="form-control" type="text" id="fileName">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">文件类型：</label>
            <div class="col-sm-8">
                <select name="fileType" class="form-control" id="fileType">
                    <option value="image">图片</option>
                    <option value="video">视频</option>
                    <option value="document">文档</option>
                    <option value="audio">音频</option>
                    <option value="other">其他</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">上传者ID：</label>
            <div class="col-sm-8">
                <input name="uploaderId" placeholder="请输入上传者用户ID" class="form-control" type="number" value="1">
            </div>
        </div>
        <div class="form-group" id="fileInfo" style="display:none;">
            <label class="col-sm-3 control-label">文件信息：</label>
            <div class="col-sm-8">
                <div class="alert alert-info">
                    <p><strong>原始文件名：</strong><span id="originalName"></span></p>
                    <p><strong>文件大小：</strong><span id="fileSize"></span></p>
                    <p><strong>文件类型：</strong><span id="mimeType"></span></p>
                </div>
            </div>
        </div>
    </form>
    <div th:include="include :: footer"></div>
    <script th:inline="javascript"> var ctx = [[@{/}]]; </script>
    <script th:inline="javascript">
        var prefix = ctx + "im/file";
        
        // 监听文件选择
        document.getElementById('fileInput').addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').value = file.name;
                document.getElementById('originalName').textContent = file.name;
                document.getElementById('fileSize').textContent = formatFileSize(file.size);
                document.getElementById('mimeType').textContent = file.type || 'unknown';
                document.getElementById('fileInfo').style.display = 'block';
                
                // 自动设置文件类型
                var extension = file.name.split('.').pop().toLowerCase();
                var fileType = 'other';
                if (extension.match(/jpg|jpeg|png|gif|bmp|webp/)) {
                    fileType = 'image';
                } else if (extension.match(/mp4|avi|mov|wmv|flv|mkv/)) {
                    fileType = 'video';
                } else if (extension.match(/mp3|wav|flac|aac|ogg/)) {
                    fileType = 'audio';
                } else if (extension.match(/pdf|doc|docx|xls|xlsx|ppt|pptx|txt/)) {
                    fileType = 'document';
                }
                document.getElementById('fileType').value = fileType;
            }
        });
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            var k = 1024;
            var sizes = ['Bytes', 'KB', 'MB', 'GB'];
            var i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }

        function submitHandler() {
            var fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0) {
                $.modal.alertWarning("请选择要上传的文件");
                return;
            }
            
            var formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('uploaderId', $('input[name="uploaderId"]').val());
            
            $.modal.loading("正在上传中，请稍候...");
            $.ajax({
                url: prefix + "/upload",
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(result) {
                    if (result.code == 0) {
                        $.modal.closeLoading();
                        $.modal.msgSuccess("文件上传成功");
                        $.table.refresh();
                        parent.$.modal.close();
                    } else {
                        $.modal.closeLoading();
                        $.modal.alertError(result.msg);
                    }
                },
                error: function(xhr, status, error) {
                    $.modal.closeLoading();
                    $.modal.alertError("上传失败: " + error);
                }
            });
        }
    </script>
</body>
</html>
