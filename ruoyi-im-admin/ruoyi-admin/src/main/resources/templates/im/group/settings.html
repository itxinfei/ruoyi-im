<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>群组设置</title>
    <link href="/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}" rel="stylesheet"/>
    <link href="/css/font-awesome.min.css" th:href="@{/css/font-awesome.min.css}" rel="stylesheet"/>
    <link href="/css/style.css" th:href="@{/css/style.css}" rel="stylesheet"/>
    <style>
        .settings-container {
            max-width: 800px;
            margin: 20px auto;
        }
        .settings-section {
            background: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .settings-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        .settings-title i {
            margin-right: 8px;
            color: #337ab7;
        }
        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid #ddd;
            margin-right: 15px;
            object-fit: cover;
        }
        .radio-box label {
            margin-right: 15px;
        }
        .help-block {
            margin-top: 5px;
            color: #999;
        }
    </style>
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content">
        <div class="settings-container">
            <form class="form-horizontal" id="form-group-settings" th:object="${group}">
                <input name="id" th:field="*{id}" type="hidden">
                
                <!-- 基本信息 -->
                <div class="settings-section">
                    <div class="settings-title">
                        <i class="fa fa-info-circle"></i>基本信息
                    </div>
                    
                    <div class="form-group">
                        <label class="col-sm-3 control-label">群组头像：</label>
                        <div class="col-sm-9">
                            <div class="file-input">
                                <input id="avatarInput" name="avatar" type="hidden" th:field="*{avatar}">
                                <img id="avatarPreview" th:src="${group.avatar}" class="avatar-preview" src="/img/profile.jpg">
                                <button type="button" class="btn btn-sm btn-info" onclick="changeAvatar()">
                                    <i class="fa fa-upload"></i>更换头像
                                </button>
                            </div>
                            <span class="help-block">建议尺寸：200x200像素，支持JPG、PNG格式</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="col-sm-3 control-label is-required">群组名称：</label>
                        <div class="col-sm-9">
                            <input name="name" th:field="*{name}" class="form-control" type="text" required maxlength="50" placeholder="请输入群组名称">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="col-sm-3 control-label">群组简介：</label>
                        <div class="col-sm-9">
                            <textarea name="description" th:field="*{description}" class="form-control" rows="3" maxlength="200" placeholder="请输入群组简介"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- 成员管理 -->
                <div class="settings-section">
                    <div class="settings-title">
                        <i class="fa fa-users"></i>成员管理
                    </div>
                    
                    <div class="form-group">
                        <label class="col-sm-3 control-label">最大成员数：</label>
                        <div class="col-sm-9">
                            <input name="maxMembers" th:field="*{maxMembers}" class="form-control" type="number" min="2" max="500" placeholder="请输入最大成员数">
                            <span class="help-block">建议设置：普通群100人，大群500人</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="col-sm-3 control-label">入群验证：</label>
                        <div class="col-sm-9">
                            <select name="joinType" class="form-control">
                                <option value="0" th:field="*{joinType}">自由加入</option>
                                <option value="1" th:field="*{joinType}">需要验证</option>
                                <option value="2" th:field="*{joinType}">禁止加入</option>
                            </select>
                            <span class="help-block">自由加入：任何人都可以加入；需要验证：需要管理员审批；禁止加入：无法加入</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="col-sm-3 control-label">全员禁言：</label>
                        <div class="col-sm-9">
                            <div class="radio-box">
                                <input type="radio" name="allMuted" value="0" th:checked="${group.allMuted == 0}">
                                <label>否</label>
                            </div>
                            <div class="radio-box">
                                <input type="radio" name="allMuted" value="1" th:checked="${group.allMuted == 1}">
                                <label>是</label>
                            </div>
                            <span class="help-block">开启后，普通成员将无法发送消息</span>
                        </div>
                    </div>
                </div>
                
                <!-- 隐私设置 -->
                <div class="settings-section">
                    <div class="settings-title">
                        <i class="fa fa-lock"></i>隐私设置
                    </div>
                    
                    <div class="form-group">
                        <label class="col-sm-3 control-label">允许查看成员：</label>
                        <div class="col-sm-9">
                            <div class="radio-box">
                                <input type="radio" name="allowViewMembers" value="1" th:checked="${group.allowViewMembers == 1}">
                                <label>允许</label>
                            </div>
                            <div class="radio-box">
                                <input type="radio" name="allowViewMembers" value="0" th:checked="${group.allowViewMembers == 0}">
                                <label>禁止</label>
                            </div>
                            <span class="help-block">禁止后，非成员无法查看群组成员列表</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="col-sm-3 control-label">允许被搜索：</label>
                        <div class="col-sm-9">
                            <div class="radio-box">
                                <input type="radio" name="allowSearch" value="1" th:checked="${group.allowSearch == 1}">
                                <label>允许</label>
                            </div>
                            <div class="radio-box">
                                <input type="radio" name="allowSearch" value="0" th:checked="${group.allowSearch == 0}">
                                <label>禁止</label>
                            </div>
                            <span class="help-block">禁止后，用户无法通过搜索找到该群组</span>
                        </div>
                    </div>
                </div>
                
                <!-- 高级设置 -->
                <div class="settings-section">
                    <div class="settings-title">
                        <i class="fa fa-cog"></i>高级设置
                    </div>
                    
                    <div class="form-group">
                        <label class="col-sm-3 control-label">群组二维码：</label>
                        <div class="col-sm-9">
                            <button type="button" class="btn btn-sm btn-info" onclick="generateQrCode()">
                                <i class="fa fa-qrcode"></i>生成二维码
                            </button>
                            <span class="help-block">生成群组二维码，方便用户扫码加入</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="col-sm-3 control-label">群组公告：</label>
                        <div class="col-sm-9">
                            <button type="button" class="btn btn-sm btn-success" onclick="manageAnnouncement()">
                                <i class="fa fa-bullhorn"></i>管理公告
                            </button>
                            <span class="help-block">发布和管理群组公告</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="col-sm-3 control-label">转让群主：</label>
                        <div class="col-sm-9">
                            <button type="button" class="btn btn-sm btn-warning" onclick="transferOwnership()">
                                <i class="fa fa-exchange"></i>转让群主
                            </button>
                            <span class="help-block">将群主权限转让给其他管理员</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="col-sm-3 control-label">解散群组：</label>
                        <div class="col-sm-9">
                            <button type="button" class="btn btn-sm btn-danger" onclick="dismissGroup()">
                                <i class="fa fa-trash"></i>解散群组
                            </button>
                            <span class="help-block">解散后将无法恢复，所有成员将被移除</span>
                        </div>
                    </div>
                </div>
                
                <!-- 操作按钮 -->
                <div class="form-group">
                    <div class="col-sm-offset-3 col-sm-9">
                        <button type="button" class="btn btn-primary" onclick="saveSettings()">
                            <i class="fa fa-save"></i>保存设置
                        </button>
                        <button type="button" class="btn btn-default" onclick="$.modal.close()">
                            <i class="fa fa-reply"></i>返回
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <script th:inline="javascript">
        var prefix = ctx + "im/group";
        var groupId = [[${group.id}]];
        
        function changeAvatar() {
            $.modal.open("更换头像", ctx + "common/upload", '600', '400');
        }
        
        function generateQrCode() {
            $.modal.open("群组二维码", ctx + "im/group/qrcode/" + groupId, '400', '400');
        }
        
        function manageAnnouncement() {
            $.modal.open("群组公告", ctx + "im/group/announcement/group/" + groupId, '800', '600');
        }
        
        function transferOwnership() {
            $.modal.confirm("转让群主权限后，您将成为普通管理员，确定要转让吗？", function() {
                $.modal.open("选择新群主", ctx + "im/group/transfer/" + groupId, '600', '400');
            });
        }
        
        function dismissGroup() {
            $.modal.confirm("解散群组后将无法恢复，所有成员将被移除，确定要解散吗？", function() {
                $.ajax({
                    url: prefix + "/dismiss/" + groupId,
                    type: 'post',
                    success: function(result) {
                        if (result.code == 0) {
                            $.modal.msgSuccess("群组已解散");
                            $.modal.close();
                            parent.location.reload();
                        } else {
                            $.modal.alertError(result.msg || "解散失败");
                        }
                    }
                });
            });
        }
        
        function saveSettings() {
            if ($.validate.form()) {
                $.operate.save(prefix + "/edit", $('#form-group-settings').serialize());
            }
        }
        
        $("#form-group-settings").validate({
            focusCleanup: true
        });
    </script>
</body>
</html>
