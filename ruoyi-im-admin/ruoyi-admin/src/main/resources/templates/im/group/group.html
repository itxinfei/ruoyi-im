<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <th:block th:include="include :: header('群组管理')" />
    <link th:href="@{/css/im-admin.css}" rel="stylesheet" />
    <style>
        /* 引入紧凑布局样式 */
        @import url(../fragments/compact-style.css);
    </style>
</head>

<body class="gray-bg">
    <div class="compact-container">
        <!-- 头部 -->
        <div class="compact-header">
            <h2 class="compact-title">群组管理</h2>
            <div class="compact-toolbar-right">
                <button class="btn btn-default compact-btn" onclick="showBatchOperation()">
                    <i class="fa fa-list compact-icon"></i>批量操作
                </button>
                <button class="btn btn-primary compact-btn" onclick="$.operate.add()" shiro:hasPermission="im:group:add">
                    <i class="fa fa-plus compact-icon"></i>新增群组
                </button>
            </div>
        </div>

        <!-- 统计卡片 -->
        <div class="compact-stats">
            <div class="compact-stat-item" onclick="filterByStatus('')">
                <div class="compact-stat-label"><i class="fa fa-users compact-icon"></i>群组总数</div>
                <div class="compact-stat-value" id="totalCount">-</div>
            </div>
            <div class="compact-stat-item" onclick="filterByActive()">
                <div class="compact-stat-label"><i class="fa fa-comments compact-icon" style="color: #10b981;"></i>活跃群</div>
                <div class="compact-stat-value im-text-success" id="activeCount">-</div>
            </div>
            <div class="compact-stat-item" onclick="filterByMuted()">
                <div class="compact-stat-label"><i class="fa fa-ban compact-icon" style="color: #f59e0b;"></i>禁言群</div>
                <div class="compact-stat-value im-text-warning" id="mutedCount">-</div>
            </div>
            <div class="compact-stat-item" onclick="filterByLarge()">
                <div class="compact-stat-label"><i class="fa fa-group compact-icon" style="color: #ef4444;"></i>大群</div>
                <div class="compact-stat-value im-text-danger" id="largeCount">-</div>
            </div>
            <div class="compact-stat-item">
                <div class="compact-stat-label"><i class="fa fa-user-plus compact-icon"></i>今日新增</div>
                <div class="compact-stat-value" id="todayCreate">-</div>
            </div>
            <div class="compact-stat-item">
                <div class="compact-stat-label"><i class="fa fa-users compact-icon"></i>总成员数</div>
                <div class="compact-stat-value" id="totalMembers">-</div>
            </div>
        </div>

        <!-- 搜索栏 -->
        <div class="compact-filter">
            <form id="group-form">
                <div class="compact-filter-row">
                    <div class="compact-filter-item">
                        <span class="compact-filter-label">群名称</span>
                        <input type="text" class="compact-filter-input" name="name" placeholder="请输入群组名称" />
                    </div>
                    <div class="compact-filter-item">
                        <span class="compact-filter-label">群主ID</span>
                        <input type="text" class="compact-filter-input" name="ownerId" placeholder="群主ID/账号" />
                    </div>
                    <div class="compact-filter-item">
                        <span class="compact-filter-label">类型</span>
                        <select class="compact-filter-select" name="groupType">
                            <option value="">全部</option>
                            <option value="PUBLIC">公开群</option>
                            <option value="PRIVATE">私有群</option>
                        </select>
                    </div>
                    <div class="compact-filter-item">
                        <span class="compact-filter-label">禁言</span>
                        <select class="compact-filter-select" name="allMuted">
                            <option value="">全部</option>
                            <option value="0">否</option>
                            <option value="1">是</option>
                        </select>
                    </div>
                </div>
                <div class="compact-filter-row">
                    <div class="compact-filter-item">
                        <span class="compact-filter-label">成员数</span>
                        <input type="text" class="compact-filter-input" name="memberCount" placeholder="成员数范围，如: 10-50" />
                    </div>
                    <div class="compact-filter-item">
                        <span class="compact-filter-label">创建时间</span>
                        <input type="text" class="compact-filter-input" name="params[beginTime]" placeholder="开始" />
                    </div>
                    <div class="compact-filter-item">
                        <span class="compact-filter-label">~</span>
                        <input type="text" class="compact-filter-input" name="params[endTime]" placeholder="结束" />
                    </div>
                    <div class="compact-filter-item" style="flex: 0;">
                        <button type="button" class="btn btn-default compact-filter-btn" onclick="resetSearch()">
                            <i class="fa fa-refresh"></i>
                        </button>
                        <button type="button" class="btn btn-primary compact-filter-btn" onclick="doSearch()">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- 表格卡片 -->
        <div class="compact-table-card">
            <!-- 批量操作栏 -->
            <div class="compact-batch-toolbar" id="batchToolbar">
                <span class="compact-batch-info">已选 <span id="selectedCount">0</span> 项</span>
                <div class="compact-batch-actions">
                    <button class="btn btn-warning compact-btn" onclick="batchMute()" shiro:hasPermission="im:group:edit">
                        <i class="fa fa-ban compact-icon"></i>禁言
                    </button>
                    <button class="btn btn-success compact-btn" onclick="batchUnmute()" shiro:hasPermission="im:group:edit">
                        <i class="fa fa-unlock compact-icon"></i>解除禁言
                    </button>
                    <button class="btn btn-danger compact-btn" onclick="batchDelete()" shiro:hasPermission="im:group:remove">
                        <i class="fa fa-trash compact-icon"></i>解散
                    </button>
                </div>
            </div>

            <!-- 工具栏 -->
            <div class="compact-toolbar">
                <div class="compact-toolbar-left">
                    <button class="btn btn-primary compact-btn" onclick="$.operate.add()" shiro:hasPermission="im:group:add">
                        <i class="fa fa-plus compact-icon"></i>新增
                    </button>
                    <div class="compact-divider"></div>
                    <button class="btn btn-default compact-btn" onclick="refreshTable()">
                        <i class="fa fa-refresh compact-icon"></i>刷新
                    </button>
                </div>
                <div class="compact-toolbar-right">
                    <button class="btn btn-info compact-btn" onclick="$.table.exportExcel()" shiro:hasPermission="im:group:export">
                        <i class="fa fa-download compact-icon"></i>导出
                    </button>
                    <select class="compact-filter-select" id="pageSizeSelect" onchange="changePageSize()">
                        <option value="20">20条</option>
                        <option value="50">50条</option>
                        <option value="100">100条</option>
                    </select>
                </div>
            </div>

            <!-- 表格 -->
            <table id="bootstrap-table"
                   class="table table-condensed table-striped"
                   data-mobile-responsive="true"
                   data-pagination="true"
                   data-page-list="[20,50,100]"
                   data-page-size="20"
                   data-side-pagination="server">
            </table>

            <!-- 分页 -->
            <div class="compact-pagination">
                <span class="compact-pagination-info" id="paginationInfo">显示 1-20 条，共 0 条</span>
                <div class="compact-pagination-btns" id="paginationBtns"></div>
            </div>
        </div>
    </div>

    <th:block th:include="include :: footer" />
    <th:block th:include="include :: bootstrap-table-export-js" />
    <script th:src="@{/js/im-common.js}"></script>
    <script th:inline="javascript">
        var editFlag = [[${@permission.hasPermi('im:group:edit')}]];
        var removeFlag = [[${@permission.hasPermi('im:group:remove')}]];
        var prefix = ctx + "im/group";

        $(function () {
            loadStatistics();
            initTable();
        });

        function loadStatistics() {
            $.get(ctx + 'im/dashboard/group-statistics', function (res) {
                if (res.code === 0) {
                    $('#totalCount').text(res.data.totalGroups || 0);
                    $('#activeCount').text(res.data.activeGroups || 0);
                    $('#mutedCount').text(res.data.mutedGroups || 0);
                    $('#largeCount').text(res.data.largeGroups || 0);
                    $('#todayCreate').text(res.data.todayCreatedGroups || 0);
                    $('#totalMembers').text(res.data.totalGroupMembers || 0);
                }
            });
        }

        function initTable() {
            var options = {
                url: prefix + "/list",
                createUrl: prefix + "/add",
                updateUrl: prefix + "/edit/{id}",
                removeUrl: prefix + "/remove/{id}",
                exportUrl: prefix + "/export",
                sortName: "createTime",
                sortOrder: "desc",
                modalName: "群组",
                pageSize: 20,
                pageList: [20, 50, 100],
                columns: [{
                    checkbox: true,
                    width: '40'
                }, {
                    field: 'id',
                    title: 'ID',
                    width: '60'
                }, {
                    field: 'name',
                    title: '群名称',
                    width: '150',
                    formatter: function (value, row) {
                        return '<div class="compact-user-cell">' +
                            '<span class="compact-user-name">' + value + '</span>' +
                            '</div>';
                    }
                }, {
                    field: 'groupType',
                    title: '类型',
                    width: '70',
                    align: 'center',
                    formatter: function (value) {
                        if (value == 'PUBLIC') {
                            return '<span class="compact-badge compact-badge-primary">公开</span>';
                        }
                        return '<span class="compact-badge compact-badge-success">私有</span>';
                    }
                }, {
                    field: 'ownerName',
                    title: '群主',
                    width: '100',
                    formatter: function (value) {
                        return value || '-';
                    }
                }, {
                    field: 'memberCount',
                    title: '成员数',
                    width: '70',
                    align: 'center',
                    formatter: function (value) {
                        return value || 0;
                    }
                }, {
                    field: 'allMuted',
                    title: '禁言',
                    width: '60',
                    align: 'center',
                    formatter: function (value) {
                        if (value == 1) {
                            return '<span class="compact-status disabled"><span class="compact-status-dot"></span>禁言</span>';
                        }
                        return '<span class="compact-status online"><span class="compact-status-dot"></span>正常</span>';
                    }
                }, {
                    field: 'status',
                    title: '状态',
                    width: '60',
                    align: 'center',
                    formatter: function (value) {
                        if (value == 0) {
                            return '<span class="compact-status disabled">禁用</span>';
                        }
                        return '<span class="compact-status online">正常</span>';
                    }
                }, {
                    field: 'createTime',
                    title: '创建时间',
                    width: '140',
                    sortable: true,
                    formatter: function (value) {
                        return value ? value.substr(0, 16) : '-';
                    }
                }, {
                    title: '操作',
                    align: 'center',
                    width: '180',
                    formatter: function (value, row) {
                        var actions = [];
                        actions.push('<a class="btn btn-primary compact-btn-sm ' + editFlag + '" href="javascript:void(0)" onclick="$.operate.edit(\'' + row.id + '\')"><i class="fa fa-edit compact-icon"></i>编辑</a>');

                        if (row.allMuted == 0) {
                            actions.push('<a class="btn btn-warning compact-btn-sm ' + editFlag + '" href="javascript:void(0)" onclick="toggleMute(\'' + row.id + '\', 1)"><i class="fa fa-ban compact-icon"></i>禁言</a>');
                        } else {
                            actions.push('<a class="btn btn-success compact-btn-sm ' + editFlag + '" href="javascript:void(0)" onclick="toggleMute(\'' + row.id + '\', 0)"><i class="fa fa-unlock compact-icon"></i>解除</a>');
                        }

                        actions.push('<a class="btn btn-info compact-btn-sm ' + editFlag + '" href="javascript:void(0)" onclick="showMembers(\'' + row.id + '\')"><i class="fa fa-users compact-icon"></i>成员</a>');
                        actions.push('<a class="btn btn-danger compact-btn-sm ' + removeFlag + '" href="javascript:void(0)" onclick="$.operate.remove(\'' + row.id + '\')"><i class="fa fa-trash compact-icon"></i>解散</a>');

                        return actions.join('');
                    }
                }],
                onCheck: updateBatchToolbar,
                onUncheck: updateBatchToolbar,
                onCheckAll: updateBatchToolbar,
                onUncheckAll: updateBatchToolbar,
                onLoadSuccess: function (data) {
                    updatePaginationInfo(data);
                    updatePaginationBtns(data);
                },
                onPageChange: function (number, size) {
                    $('#pageSizeSelect').val(size);
                }
            };
            $.table.init(options);
        }

        function updateBatchToolbar() {
            var selectedCount = $.table.selectColumns("id").length;
            $('#selectedCount').text(selectedCount);
            $('#batchToolbar').toggleClass('active', selectedCount > 0);
        }

        function updatePaginationInfo(data) {
            var total = data.total;
            var pageSize = $('#bootstrap-table').bootstrapTable('getOptions').pageSize;
            var pageNumber = $('#bootstrap-table').bootstrapTable('getOptions').pageNumber;
            var from = (pageNumber - 1) * pageSize + 1;
            var to = Math.min(pageNumber * pageSize, total);
            $('#paginationInfo').text('显示 ' + from + '-' + to + ' 条，共 ' + total + ' 条');
        }

        function updatePaginationBtns(data) {
            var total = data.total;
            var pageSize = $('#bootstrap-table').bootstrapTable('getOptions').pageSize;
            var pageNumber = $('#bootstrap-table').bootstrapTable('getOptions').pageNumber;
            var totalPages = Math.ceil(total / pageSize);

            var html = '';
            html += '<button class="compact-page-btn" onclick="goToPage(1)" ' + (pageNumber == 1 ? 'disabled' : '') + '><i class="fa fa-angle-double-left"></i></button>';
            html += '<button class="compact-page-btn" onclick="goToPage(' + (pageNumber - 1) + ')" ' + (pageNumber == 1 ? 'disabled' : '') + '><i class="fa fa-angle-left"></i></button>';

            var startPage = Math.max(1, pageNumber - 2);
            var endPage = Math.min(totalPages, pageNumber + 2);

            for (var i = startPage; i <= endPage; i++) {
                html += '<button class="compact-page-btn ' + (i == pageNumber ? 'active' : '') + '" onclick="goToPage(' + i + ')">' + i + '</button>';
            }

            html += '<button class="compact-page-btn" onclick="goToPage(' + (pageNumber + 1) + ')" ' + (pageNumber == totalPages ? 'disabled' : '') + '><i class="fa fa-angle-right"></i></button>';
            html += '<button class="compact-page-btn" onclick="goToPage(' + totalPages + ')" ' + (pageNumber == totalPages ? 'disabled' : '') + '><i class="fa fa-angle-double-right"></i></button>';

            $('#paginationBtns').html(html);
        }

        function goToPage(page) {
            $('#bootstrap-table').bootstrapTable('selectPage', page);
        }

        function doSearch() {
            $.table.search();
        }

        function resetSearch() {
            $("#group-form")[0].reset();
            $.table.search();
        }

        function filterByStatus(status) {
            $('select[name="status"]').val(status);
            doSearch();
        }

        function filterByActive() {
            $('#group-form input[name="name"]').val('');
            doSearch();
        }

        function filterByMuted() {
            $('select[name="allMuted"]').val('1');
            doSearch();
        }

        function filterByLarge() {
            $('input[name="memberCount"]').val('100-');
            doSearch();
        }

        function toggleMute(id, muted) {
            var action = muted == 1 ? '禁言' : '解除禁言';
            $.modal.confirm("确定要" + action + "该群组吗？", function () {
                $.operate.post(prefix + "/toggleMute", { groupId: id, allMuted: muted }, function (res) {
                    if (res.code == 0) {
                        $.table.refresh();
                        loadStatistics();
                    }
                });
            });
        }

        function batchMute() {
            var ids = $.table.selectColumns("id");
            if (!ImCommon.validateBatchOperation(ids, 1)) return;
            $.modal.confirm("确定要批量禁言选中的 " + ids.length + " 个群组吗？", function () {
                $.operate.post(prefix + "/batchMute", { groupIds: ids.join(",") }, function (res) {
                    if (res.code == 0) {
                        $.table.refresh();
                        loadStatistics();
                    }
                });
            });
        }

        function batchUnmute() {
            var ids = $.table.selectColumns("id");
            if (!ImCommon.validateBatchOperation(ids, 1)) return;
            $.modal.confirm("确定要批量解除禁言选中的 " + ids.length + " 个群组吗？", function () {
                $.operate.post(prefix + "/batchUnmute", { groupIds: ids.join(",") }, function (res) {
                    if (res.code == 0) {
                        $.table.refresh();
                        loadStatistics();
                    }
                });
            });
        }

        function batchDelete() {
            var ids = $.table.selectColumns("id");
            if (!ImCommon.validateBatchOperation(ids, 1)) return;
            $.modal.confirm("确定要解散选中的 " + ids.length + " 个群组吗？此操作不可恢复！", function () {
                $.operate.post(prefix + "/batchRemove", { groupIds: ids.join(",") }, function (res) {
                    if (res.code == 0) {
                        $.table.refresh();
                        loadStatistics();
                    }
                });
            });
        }

        function showMembers(id) {
            $.modal.open("群组成员", prefix + "/members/" + id, 900, 600);
        }

        function refreshTable() {
            $.table.refresh();
            loadStatistics();
        }

        function changePageSize() {
            var pageSize = $('#pageSizeSelect').val();
            $('#bootstrap-table').bootstrapTable('refreshOptions', { pageSize: pageSize });
        }

        function showBatchOperation() {
            $.modal.open("批量操作", prefix + "/batch_operations", 700, 500);
        }

        $.operate.add = function (id) {
            $.modal.open("添加群组", $.operate.addUrl(id), 700, 500);
        };

        $.operate.edit = function (id) {
            $.modal.open("修改群组", $.operate.editUrl(id), 700, 500);
        };
    </script>
</body>
</html>
