<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>会话成员</title>
    <link href="/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}" rel="stylesheet"/>
    <link href="/css/font-awesome.min.css" th:href="@{/css/font-awesome.min.css}" rel="stylesheet"/>
    <link href="/ajax/libs/bootstrap-table/bootstrap-table.min.css" th:href="@{/ajax/libs/bootstrap-table/bootstrap-table.min.css}" rel="stylesheet"/>
    <link href="/css/style.css" th:href="@{/css/style.css}" rel="stylesheet"/>
    <style>
        .member-table { margin-top: 10px; }
        .member-avatar { width: 32px; height: 32px; border-radius: 50%; }
        .search-area { margin-bottom: 15px; }
    </style>
</head>
<body class="white-bg">
    <div class="container-div">
        <div class="row">
            <div class="col-sm-12">
                <div class="search-area">
                    <form id="member-form">
                        <div class="select-list">
                            <ul>
                                <li>
                                    用户ID：<input type="text" name="userId" id="userId" placeholder="用户ID"/>
                                </li>
                                <li>
                                    昵称：<input type="text" name="nickname" id="nickname" placeholder="昵称"/>
                                </li>
                                <li>
                                    角色：<select name="role" id="role">
                                        <option value="">全部</option>
                                        <option value="OWNER">群主</option>
                                        <option value="ADMIN">管理员</option>
                                        <option value="MEMBER">成员</option>
                                    </select>
                                </li>
                                <li>
                                    <a class="btn btn-primary btn-rounded btn-sm" onclick="searchMembers()"><i class="fa fa-search"></i>&nbsp;搜索</a>
                                    <a class="btn btn-warning btn-rounded btn-sm" onclick="resetSearch()"><i class="fa fa-refresh"></i>&nbsp;重置</a>
                                </li>
                            </ul>
                        </div>
                    </form>
                </div>
                <table id="member-table" data-mobile-responsive="true"></table>
            </div>
        </div>
    </div>
    <script th:inline="javascript">
        var ctx = [[@{/}]];
        var conversationId = [[${conversationId}]];
        var prefix = ctx + "im/session";
    </script>
    <script th:src="@{/js/jquery.min.js?v=3.6.3}"></script>
    <script th:src="@{/js/bootstrap.min.js?v=3.3.7}"></script>
    <script th:src="@{/ajax/libs/bootstrap-table/bootstrap-table.min.js?v=1.22.6}"></script>
    <script th:src="@{/ajax/libs/bootstrap-table/locale/bootstrap-table-zh-CN.min.js?v=1.22.6}"></script>
    <script th:src="@{/ajax/libs/validate/jquery.validate.min.js?v=1.21.0}"></script>
    <script th:src="@{/ajax/libs/blockUI/jquery.blockUI.js?v=2.70.0}"></script>
    <script th:src="@{/ajax/libs/layer/layer.min.js?v=3.7.0}"></script>
    <script th:src="@{/ruoyi/js/common.js?v=4.8.0}"></script>
    <script th:src="@{/ruoyi/js/ry-ui.js?v=4.8.0}"></script>
    <script th:inline="javascript">
        $(function() {
            loadMembers();
        });

        function loadMembers() {
            var params = {
                conversationId: conversationId,
                userId: $("#userId").val(),
                nickname: $("#nickname").val(),
                role: $("#role").val()
            };
            $.get(prefix + "/members/data", params, function(result) {
                if (result.code == 0) {
                    var members = result.rows || result.data || [];
                    renderTable(members);
                } else {
                    $.modal.alertError(result.msg || "加载失败");
                }
            }).fail(function() {
                $.modal.alertError("加载失败");
            });
        }

        function searchMembers() {
            loadMembers();
        }

        function resetSearch() {
            $("#userId").val("");
            $("#nickname").val("");
            $("#role").val("");
            loadMembers();
        }

        function renderTable(members) {
            $("#member-table").bootstrapTable('destroy');
            $("#member-table").bootstrapTable({
                data: members,
                pagination: false,
                columns: [{
                    field: 'userId',
                    title: '用户ID',
                    align: 'center',
                    width: '80px'
                }, {
                    field: 'userName',
                    title: '用户名',
                    align: 'center'
                }, {
                    field: 'nickname',
                    title: '昵称',
                    align: 'center',
                    formatter: function(value, row, index) {
                        return value || row.userName || '-';
                    }
                }, {
                    field: 'role',
                    title: '角色',
                    align: 'center',
                    formatter: function(value, row, index) {
                        if (value === 'OWNER') {
                            return '<span class="badge badge-danger">群主</span>';
                        } else if (value === 'ADMIN') {
                            return '<span class="badge badge-warning">管理员</span>';
                        } else {
                            return '<span class="badge badge-primary">成员</span>';
                        }
                    }
                }, {
                    field: 'unreadCount',
                    title: '未读数',
                    align: 'center',
                    width: '80px'
                }, {
                    field: 'isPinned',
                    title: '置顶',
                    align: 'center',
                    formatter: function(value, row, index) {
                        if (value == 1) {
                            return '<span class="badge badge-success">是</span>';
                        }
                        return '<span class="badge badge-default">否</span>';
                    }
                }, {
                    field: 'isMuted',
                    title: '免打扰',
                    align: 'center',
                    formatter: function(value, row, index) {
                        if (value == 1) {
                            return '<span class="badge badge-warning">是</span>';
                        }
                        return '<span class="badge badge-default">否</span>';
                    }
                }, {
                    field: 'createTime',
                    title: '加入时间',
                    align: 'center',
                    width: '160px'
                }]
            });
        }
    </script>
</body>
</html>
