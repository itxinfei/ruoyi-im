<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">

<head>
    <th:block th:include="include :: header('IM管理工作台')" />
    <script th:src="@{/ajax/libs/report/echarts/echarts-all.min.js}"></script>
    <link th:href="@{/css/im-admin.css}" rel="stylesheet" />
    <style>
        .workbench-wrapper {
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-header {
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
            margin: 0;
        }

        .page-desc {
            font-size: 13px;
            color: #6b7280;
            margin-top: 4px;
        }

        /* 这里的图表容器高度微调 */
        .im-chart-box {
            height: 320px;
            width: 100%;
        }

        .quick-link-card {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-link-card:hover {
            border-color: #2563eb;
            background: #f8fafc;
        }

        .quick-link-icon {
            width: 40px;
            height: 40px;
            background: #f1f5f9;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #475569;
        }

        .quick-link-info .title {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
        }

        .quick-link-info .desc {
            font-size: 12px;
            color: #94a3b8;
        }
    </style>
</head>

<body class="gray-bg">
    <div class="workbench-wrapper animated fadeIn">
        <!-- 1. 顶部标题与快速操作 -->
        <div class="page-header clearfix">
            <div class="pull-left">
                <h1 class="page-title">管理工作台</h1>
                <p class="page-desc">实时概览 IM 系统运行状况，快速处理管理任务。</p>
            </div>
            <div class="pull-right">
                <div class="btn-group-sm">
                    <button class="btn btn-default btn-outline" onclick="refreshAllData()">
                        <i class="fa fa-refresh"></i> 刷新数据
                    </button>
                    <button class="btn btn-primary" onclick="broadcastMsg()">
                        <i class="fa fa-send"></i> 系统公告
                    </button>
                </div>
            </div>
        </div>

        <!-- 2. 核心指标面板 (im-stat-group) -->
        <div class="im-stat-group">
            <div class="im-stat-item" onclick="openPage('im/user')">
                <div class="stat-header">
                    <span class="stat-label">总用户规模</span>
                    <div class="stat-icon-box"><i class="fa fa-users"></i></div>
                </div>
                <div class="stat-number" id="totalUsers">-</div>
                <div class="stat-footer">
                    <span class="trend-up" id="userTrend"><i class="fa fa-caret-up"></i> --</span>
                    <span class="text-muted">较昨日新增</span>
                </div>
            </div>
            <div class="im-stat-item" onclick="openPage('im/user?isOnline=1')">
                <div class="stat-header">
                    <span class="stat-label">当前活跃在线</span>
                    <div class="stat-icon-box" style="background: #ecfdf5; color: #10b981;"><i class="fa fa-circle"></i>
                    </div>
                </div>
                <div class="stat-number" id="onlineUsers">-</div>
                <div class="stat-footer">
                    <span class="dot dot-online"></span>
                    <span class="text-muted">实时在线连接</span>
                </div>
            </div>
            <div class="im-stat-item" onclick="openPage('im/group')">
                <div class="stat-header">
                    <span class="stat-label">群组与频道</span>
                    <div class="stat-icon-box" style="background: #fff7ed; color: #f59e0b;"><i
                            class="fa fa-comments"></i></div>
                </div>
                <div class="stat-number" id="totalGroups">-</div>
                <div class="stat-footer">
                    <span class="text-muted">包含私聊会话与公开群组</span>
                </div>
            </div>
            <div class="im-stat-item" onclick="openPage('im/message')">
                <div class="stat-header">
                    <span class="stat-label">今日消息流</span>
                    <div class="stat-icon-box" style="background: #fef2f2; color: #ef4444;"><i
                            class="fa fa-line-chart"></i></div>
                </div>
                <div class="stat-number" id="todayMessages">-</div>
                <div class="stat-footer">
                    <span class="text-muted" id="sensitiveCount">敏感词拦截: 0</span>
                </div>
            </div>
        </div>

        <!-- 3. 数据可视化与管理动态 -->
        <div class="row">
            <!-- 消息趋势图 -->
            <div class="col-md-8">
                <div class="im-board">
                    <div class="im-board-header">
                        <span class="im-board-title">通信活跃动向 (最近7天)</span>
                        <div class="im-badge badge-blue">数据实时更新</div>
                    </div>
                    <div class="im-board-content">
                        <div id="activityChart" class="im-chart-box"></div>
                    </div>
                </div>
            </div>
            <!-- 快速管理链接 -->
            <div class="col-md-4">
                <div class="im-board">
                    <div class="im-board-header">
                        <span class="im-board-title">快速管理</span>
                    </div>
                    <div class="im-board-content" style="padding: 10px 20px;">
                        <div class="row">
                            <div class="col-sm-12 m-b-10">
                                <div class="quick-link-card"
                                    onclick="$.modal.open('添加用户', ctx + 'im/user/add', 600, 400)">
                                    <div class="quick-link-icon"><i class="fa fa-user-plus"></i></div>
                                    <div class="quick-link-info">
                                        <div class="title">注册新用户</div>
                                        <div class="desc">手动为组织添加新成员</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-12 m-b-10">
                                <div class="quick-link-card"
                                    onclick="$.modal.open('批量导入', ctx + 'im/user/import', 500, 300)">
                                    <div class="quick-link-icon"><i class="fa fa-upload"></i></div>
                                    <div class="quick-link-info">
                                        <div class="title">成员批量导入</div>
                                        <div class="desc">通过 Excel 快速同步账号</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-12 m-b-10">
                                <div class="quick-link-card" onclick="openPage('im/sensitiveWord')">
                                    <div class="quick-link-icon"><i class="fa fa-shield"></i></div>
                                    <div class="quick-link-info">
                                        <div class="title">风控策略配置</div>
                                        <div class="desc">更新敏感词库与过滤等级</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-12">
                                <div class="quick-link-card" onclick="openPage('im/auditLog')">
                                    <div class="quick-link-icon"><i class="fa fa-history"></i></div>
                                    <div class="quick-link-info">
                                        <div class="title">管理审计日志</div>
                                        <div class="desc">回溯所有管理员操作行为</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 实时管理审计流 -->
            <div class="col-md-4">
                <div class="im-board">
                    <div class="im-board-header">
                        <span class="im-board-title">系统动态</span>
                        <a href="javascript:void(0)" class="text-xs text-primary">查看全部</a>
                    </div>
                    <div class="im-board-content">
                        <ul class="im-feed-list" id="auditFeed">
                            <li class="im-feed-item">
                                <div class="im-feed-icon text-success"><i class="fa fa-check-circle"></i></div>
                                <div class="im-feed-body">
                                    <b>System</b> 自动同步了第三方机构人员数据
                                </div>
                                <div class="im-feed-time">10:05</div>
                            </li>
                            <li class="im-feed-item">
                                <div class="im-feed-icon text-danger"><i class="fa fa-ban"></i></div>
                                <div class="im-feed-body">
                                    用户 <span class="text-primary">@admin</span> 禁用了违规账号 <b>test001</b>
                                </div>
                                <div class="im-feed-time">09:42</div>
                            </li>
                            <li class="im-feed-item">
                                <div class="im-feed-icon text-warning"><i class="fa fa-warning"></i></div>
                                <div class="im-feed-body">
                                    群组 <b>[技术交流群]</b> 已触发全员禁言策略
                                </div>
                                <div class="im-feed-time">昨天</div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- 用户活跃分布 -->
            <div class="col-md-4">
                <div class="im-board">
                    <div class="im-board-header">
                        <span class="im-board-title">消息形态分布</span>
                    </div>
                    <div class="im-board-content">
                        <div id="distributionChart" class="im-chart-box" style="height: 240px;"></div>
                    </div>
                </div>
            </div>
            <!-- 活跃排行 -->
            <div class="col-md-4">
                <div class="im-board">
                    <div class="im-board-header">
                        <span class="im-board-title">高频互动群组</span>
                    </div>
                    <div class="im-board-content">
                        <ul class="im-feed-list" id="topGroups">
                            <li style="text-align: center; color: #999; padding: 40px;">加载中...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block th:include="include :: footer" />
    <script th:src="@{/js/im-common.js}"></script>
    <script th:inline="javascript">
        var ctx = [[@{/}]];
        var charts = {};

        $(function () {
            initDashboard();
            $(window).resize(function () {
                Object.values(charts).forEach(c => c && c.resize());
            });
        });

        function initDashboard() {
            loadStatistics();
            initActivityChart();
            initDistributionChart();
            loadRankings();
        }

        function refreshAllData() {
            $.modal.msg("正在同步实时数据...", { icon: 16, time: 500 });
            initDashboard();
        }

        function loadStatistics() {
            ImCommon.get(ctx + 'im/dashboard/statistics', function (res) {
                if (res.code === 0) {
                    var d = res.data;
                    $('#totalUsers').text(ImCommon.formatNumber(d.totalUsers));
                    $('#onlineUsers').text(ImCommon.formatNumber(d.onlineUsers));
                    $('#totalGroups').text(ImCommon.formatNumber(d.totalGroups));
                    $('#todayMessages').text(ImCommon.formatNumber(d.todayMessages));

                    if (d.todayRegister > 0) {
                        $('#userTrend').html('<i class="fa fa-caret-up"></i> ' + d.todayRegister);
                    }
                    if (d.sensitiveMessages > 0) {
                        $('#sensitiveCount').html('敏感词拦截: <span class="text-danger">' + d.sensitiveMessages + '</span>');
                    }
                }
            });
        }

        function initActivityChart() {
            $.get(ctx + 'im/dashboard/trend', { type: 'message', days: 7 }, function (res) {
                if (res.code === 0) {
                    var chart = echarts.init(document.getElementById('activityChart'));
                    var option = {
                        tooltip: { trigger: 'axis', axisPointer: { type: 'none' } },
                        grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                        xAxis: {
                            type: 'category',
                            boundaryGap: false,
                            data: res.data.map(i => i.date),
                            axisLine: { lineStyle: { color: '#e2e8f0' } },
                            axisLabel: { color: '#6b7280' }
                        },
                        yAxis: {
                            type: 'value',
                            splitLine: { lineStyle: { type: 'dashed', color: '#f1f5f9' } },
                            axisLine: { show: false }
                        },
                        series: [{
                            name: '消息量',
                            type: 'line',
                            smooth: true,
                            showSymbol: false,
                            data: res.data.map(i => i.count),
                            lineStyle: { width: 3, color: '#2563eb' },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(37, 99, 235, 0.2)' },
                                    { offset: 1, color: 'rgba(37, 99, 235, 0)' }
                                ])
                            }
                        }]
                    };
                    chart.setOption(option);
                    charts['activity'] = chart;
                }
            });
        }

        function initDistributionChart() {
            $.get(ctx + 'im/dashboard/distribution', { type: 'msgType' }, function (res) {
                if (res.code === 0) {
                    var chart = echarts.init(document.getElementById('distributionChart'));
                    var option = {
                        tooltip: { trigger: 'item' },
                        legend: { bottom: '0', icon: 'circle' },
                        series: [{
                            type: 'pie',
                            radius: ['50%', '80%'],
                            center: ['50%', '42%'],
                            avoidLabelOverlap: false,
                            itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 },
                            label: { show: false },
                            data: res.data.map(i => ({ name: i.type, value: i.count })),
                            color: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#6366f1']
                        }]
                    };
                    chart.setOption(option);
                    charts['dist'] = chart;
                }
            });
        }

        function loadRankings() {
            $.get(ctx + 'im/dashboard/ranking', { type: 'groups', days: 7, limit: 5 }, function (res) {
                if (res.code === 0) {
                    var html = '';
                    res.data.forEach((item, idx) => {
                        html += '<li class="im-feed-item">';
                        html += '<div class="im-feed-icon">' + (idx + 1) + '</div>';
                        html += '<div class="im-feed-body">' + item.name + '</div>';
                        html += '<div class="im-badge badge-green">' + item.count + ' 互动</div>';
                        html += '</li>';
                    });
                    $('#topGroups').html(html || '<li style="text-align:center;padding:20px;color:#999;">暂无数据</li>');
                }
            });
        }

        function openPage(url) {
            $.modal.openTab("管理页面", ctx + url);
        }

        function broadcastMsg() {
            $.modal.open("发送系统公告", ctx + "im/message/add?broadcast=true", 700, 450);
        }
    </script>
</body>

</html>