<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">

<head>
    <th:block th:include="include :: header('IM用户管理')" />
    <link th:href="@{/css/im-admin.css}" rel="stylesheet" />
</head>

<body class="gray-bg">
    <div class="container-div">
        <div class="row pt-5">
            <div class="row pt-5">
                <!-- 1. 统计面板 (Premium Minimalist) -->
                <div class="col-sm-12">
                    <div class="im-stat-group">
                        <div class="im-stat-item" onclick="filterByStatus('')">
                            <div class="stat-header">
                                <span class="stat-label">用户总规模</span>
                                <div class="stat-icon-box"><i class="fa fa-users"></i></div>
                            </div>
                            <div class="stat-number" id="totalCount">-</div>
                            <div class="stat-footer text-muted">系统内存量账号总数</div>
                        </div>
                        <div class="im-stat-item" onclick="filterByOnline('1')">
                            <div class="stat-header">
                                <span class="stat-label">在线用户</span>
                                <div class="stat-icon-box" style="background: #ecfdf5; color: #10b981;"><i
                                        class="fa fa-circle"></i></div>
                            </div>
                            <div class="stat-number" id="onlineCount">-</div>
                            <div class="stat-footer text-muted">当前实时通信连接数</div>
                        </div>
                        <div class="im-stat-item" onclick="filterByOnline('0')">
                            <div class="stat-header">
                                <span class="stat-label">离线状态</span>
                                <div class="stat-icon-box" style="background: #f1f5f9; color: #64748b;"><i
                                        class="fa fa-toggle-off"></i></div>
                            </div>
                            <div class="stat-number" id="offlineCount">-</div>
                            <div class="stat-footer text-muted">非活跃离线用户</div>
                        </div>
                        <div class="im-stat-item" onclick="filterByStatus('0')">
                            <div class="stat-header">
                                <span class="stat-label">已停用/封禁</span>
                                <div class="stat-icon-box" style="background: #fef2f2; color: #ef4444;"><i
                                        class="fa fa-ban"></i></div>
                            </div>
                            <div class="stat-number" id="disabledCount">-</div>
                            <div class="stat-footer text-muted">因违规或行政操作禁用的账号</div>
                        </div>
                    </div>
                </div>

                <!-- 搜索区域 -->
                <div class="col-sm-12 search-collapse">
                    <form id="user-form">
                        <div class="select-list">
                            <ul>
                                <li>
                                    <label>用户名：</label><input type="text" name="username" placeholder="登录账号" />
                                </li>
                                <li>
                                    <label>昵称：</label><input type="text" name="nickname" placeholder="模糊搜索" />
                                </li>
                                <li>
                                    <label>状态：</label>
                                    <select name="status">
                                        <option value="">所有</option>
                                        <option value="1">正常</option>
                                        <option value="0">停用</option>
                                    </select>
                                </li>
                                <li>
                                    <label>在线：</label>
                                    <select name="isOnline">
                                        <option value="">所有</option>
                                        <option value="1">在线</option>
                                        <option value="0">离线</option>
                                    </select>
                                </li>
                                <li>
                                    <a class="btn btn-primary btn-rounded btn-sm" onclick="doSearch()"><i
                                            class="fa fa-search"></i> 搜索</a>
                                    <a class="btn btn-warning btn-rounded btn-sm" onclick="clearSearch()"><i
                                            class="fa fa-refresh"></i> 重置</a>
                                </li>
                            </ul>
                        </div>
                    </form>
                </div>

                <!-- 数据展示区域 -->
                <div class="col-sm-12 select-table table-striped">
                    <!-- 工具栏 -->
                    <div class="btn-group-sm" id="toolbar" role="group">
                        <a class="btn btn-success" onclick="addUser()" shiro:hasPermission="im:user:add">
                            <i class="fa fa-plus"></i> 新增
                        </a>
                        <a class="btn btn-primary single disabled" onclick="editUser()"
                            shiro:hasPermission="im:user:edit">
                            <i class="fa fa-edit"></i> 修改
                        </a>
                        <a class="btn btn-info single disabled" onclick="resetPwd()" shiro:hasPermission="im:user:edit">
                            <i class="fa fa-key"></i> 重置密码
                        </a>
                        <a class="btn btn-danger multiple disabled" onclick="$.operate.removeAll()"
                            shiro:hasPermission="im:user:remove">
                            <i class="fa fa-remove"></i> 删除
                        </a>
                    </div>

                    <table id="bootstrap-table" data-mobile-responsive="true"></table>
                </div>
            </div>
        </div>

        <th:block th:include="include :: footer" />
        <th:block th:include="include :: bootstrap-table-export-js" />
        <script th:src="@{/js/im-common.js?v=1.0.2}"></script>
        <script th:inline="javascript">
            var editFlag = [[${@permission.hasPermi('im:user:edit') }]];
            var removeFlag = [[${@permission.hasPermi('im:user:remove') }]];
            var prefix = ctx + "im/user";

            $(function () {
                // 初始化页面配置
                ImCommon.initPage({ tableId: '#bootstrap-table' });
                loadStatistics();

                var options = {
                    url: prefix + "/list",
                    createUrl: prefix + "/add",
                    updateUrl: prefix + "/edit/{id}",
                    removeUrl: prefix + "/remove/{id}",
                    exportUrl: prefix + "/export",
                    toolbar: "toolbar",
                    modalName: "用户",
                    sortName: "createTime",
                    sortOrder: "desc",
                    columns: [{
                        checkbox: true
                    }, {
                        field: 'avatar',
                        title: '头像',
                        align: 'center',
                        width: '60',
                        formatter: function (value, row, index) {
                            return ImCommon.formatCircleAvatar(value, 36);
                        }
                    }, {
                        field: 'username',
                        title: '登录账号',
                        sortable: true
                    }, {
                        field: 'nickname',
                        title: '昵称',
                        sortable: true
                    }, {
                        field: 'status',
                        title: '账号状态',
                        align: 'center',
                        width: '90',
                        formatter: function (value, row, index) {
                            var newStatus = value == 1 ? 0 : 1;
                            var statusText = value == 1 ? '正常' : '停用';
                            var labelClass = value == 1 ? 'label-primary' : 'label-danger';
                            return '<a href="javascript:void(0)" onclick="changeStatus(' + row.id + ', ' + newStatus + ')" ' +
                                'title="点击切换状态" class="label ' + labelClass + ' badge-pill" style="text-decoration:none;">' +
                                statusText + '</a>';
                        }
                    }, {
                        field: 'isOnline',
                        title: '在线状态',
                        align: 'center',
                        width: '90',
                        formatter: function (value, row, index) {
                            var dotClass = (value == 1) ? 'dot-online' : 'dot-offline';
                            var text = (value == 1) ? '在线' : '离线';
                            return '<span class="dot ' + dotClass + '"></span>' + text;
                        }
                    }, {
                        field: 'createTime',
                        title: '创建时间',
                        sortable: true,
                        width: '160',
                        formatter: function (value) {
                            return value ? value.substring(0, 16) : '-';
                        }
                    }, {
                        title: '操作',
                        align: 'center',
                        width: '180',
                        formatter: function (value, row, index) {
                            var actions = [];
                            actions.push('<a class="btn btn-success btn-xs ' + editFlag + '" href="javascript:void(0)" onclick="editUser(\'' + row.id + '\')"><i class="fa fa-edit"></i>修改</a>');
                            actions.push('<a class="btn btn-info btn-xs" href="javascript:void(0)" onclick="resetPasswordById(\'' + row.id + '\')"><i class="fa fa-key"></i>重置</a>');
                            actions.push('<a class="btn btn-danger btn-xs ' + removeFlag + '" href="javascript:void(0)" onclick="$.operate.remove(\'' + row.id + '\')"><i class="fa fa-remove"></i>删除</a>');
                            return actions.join(' ');
                        }
                    }]
                };
                $.table.init(options);

                // 按钮刷新监听
                $(document).off('click', "button[name='refresh']").on('click', "button[name='refresh']", function () {
                    $.table.refresh();
                    loadStatistics();
                });
            });

            function loadStatistics() {
                var $stats = $('.stat-number');
                $stats.html('<i class="fa fa-spinner fa-spin"></i>');
                ImCommon.get(prefix + "/statistics", function (data) {
                    $('#totalCount').text(data.totalCount || 0);
                    $('#onlineCount').text(data.onlineCount || 0);
                    $('#offlineCount').text(data.offlineCount || 0);
                    $('#disabledCount').text(data.disabledCount || 0);
                });
            }

            function filterByStatus(status) {
                $('select[name="status"]').val(status);
                doSearch();
            }

            function filterByOnline(isOnline) {
                $('select[name="isOnline"]').val(isOnline);
                doSearch();
            }

            function doSearch() {
                $.table.search();
            }

            function clearSearch() {
                $.form.reset();
                $.table.search();
            }

            function resetPwd() {
                var selectedId = $.table.selectFirstColumns();
                if ($.common.isEmpty(selectedId)) {
                    $.modal.alertWarning("请至少选择一条记录");
                    return;
                }
                resetPasswordById(selectedId);
            }

            function resetPasswordById(userId) {
                $.modal.open("重置密码", prefix + "/resetPassword/" + userId, 380, 260);
            }

            function addUser() {
                $.modal.open("添加用户", prefix + "/add", 620, 440);
            }

            function editUser(id) {
                var url = prefix + "/edit/";
                if ($.common.isNotEmpty(id)) {
                    url += id;
                } else {
                    var selectedId = $.table.selectFirstColumns();
                    if ($.common.isEmpty(selectedId)) {
                        $.modal.alertWarning("请选择要修改的数据");
                        return;
                    }
                    url += selectedId;
                }
                $.modal.open("修改用户", url, 550, 400);
            }

            function changeStatus(userId, status) {
                var msg = status == 1 ? "启用" : "停用";
                $.modal.confirm("确认要" + msg + "该用户吗？", function () {
                    $.ajax({
                        url: prefix + "/changeStatus",
                        type: "PUT",
                        contentType: "application/json",
                        data: JSON.stringify({ "id": userId, "status": status }),
                        success: function (result) {
                            if (result.code == 0) {
                                $.modal.msgSuccess(result.msg);
                                $.table.refresh();
                            } else {
                                $.modal.msgError(result.msg);
                            }
                        }
                    });
                });
            }
        </script>
</body>

</html>