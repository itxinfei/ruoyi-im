<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">

<head>
    <th:block th:include="include :: header('IM用户管理')" />
    <link th:href="@{/css/im-admin.css}" rel="stylesheet" />
    <style>
        /* 页面特定样式覆盖 */
        .user-list-page .im-stat-card {
            cursor: pointer;
        }
        .user-list-page .user-avatar-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .user-list-page .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .user-list-page .user-name {
            font-weight: 500;
            color: var(--im-text-primary);
        }
        .user-list-page .user-account {
            font-size: 12px;
            color: var(--im-text-tertiary);
        }
        /* 状态开关样式 */
        .status-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
        }
        .status-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .status-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #bfbfbf;
            transition: .3s;
            border-radius: 22px;
        }
        .status-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        .status-switch input:checked + .status-slider {
            background-color: #52c41a;
        }
        .status-switch input:checked + .status-slider:before {
            transform: translateX(22px);
        }
    </style>
</head>

<body class="gray-bg user-list-page">
    <div class="container-div">
        <div class="row">
            <!-- 统计卡片区域 -->
            <div class="col-sm-12">
                <div class="im-stats-row">
                    <!-- 用户总数 -->
                    <div class="im-stat-card" onclick="filterByStatus('')">
                        <div class="im-stat-card-header">
                            <span class="im-stat-card-label">用户总数</span>
                            <div class="im-stat-card-icon primary">
                                <i class="fa fa-users"></i>
                            </div>
                        </div>
                        <div class="im-stat-card-value" id="totalCount">-</div>
                        <div class="im-stat-card-footer">系统内全部账号</div>
                    </div>

                    <!-- 在线用户 -->
                    <div class="im-stat-card" onclick="filterByOnline('1')">
                        <div class="im-stat-card-header">
                            <span class="im-stat-card-label">在线用户</span>
                            <div class="im-stat-card-icon success">
                                <i class="fa fa-circle"></i>
                            </div>
                        </div>
                        <div class="im-stat-card-value im-text-success" id="onlineCount">-</div>
                        <div class="im-stat-card-footer">当前实时在线</div>
                    </div>

                    <!-- 离线用户 -->
                    <div class="im-stat-card" onclick="filterByOnline('0')">
                        <div class="im-stat-card-header">
                            <span class="im-stat-card-label">离线用户</span>
                            <div class="im-stat-card-icon warning">
                                <i class="fa fa-circle-o"></i>
                            </div>
                        </div>
                        <div class="im-stat-card-value im-text-tertiary" id="offlineCount">-</div>
                        <div class="im-stat-card-footer">非活跃状态</div>
                    </div>

                    <!-- 停用账号 -->
                    <div class="im-stat-card" onclick="filterByStatus('0')">
                        <div class="im-stat-card-header">
                            <span class="im-stat-card-label">停用账号</span>
                            <div class="im-stat-card-icon danger">
                                <i class="fa fa-ban"></i>
                            </div>
                        </div>
                        <div class="im-stat-card-value im-text-danger" id="disabledCount">-</div>
                        <div class="im-stat-card-footer">已封禁账号</div>
                    </div>
                </div>
            </div>

            <!-- 搜索区域 -->
            <div class="col-sm-12">
                <div class="im-search-panel">
                    <form id="user-form">
                        <div class="im-search-form">
                            <div class="im-search-item">
                                <span class="im-search-label">用户名</span>
                                <input type="text" name="username" class="im-search-input" placeholder="请输入用户名" />
                            </div>
                            <div class="im-search-item">
                                <span class="im-search-label">昵称</span>
                                <input type="text" name="nickname" class="im-search-input" placeholder="请输入昵称" />
                            </div>
                            <div class="im-search-item">
                                <span class="im-search-label">状态</span>
                                <select name="status" class="im-search-select">
                                    <option value="">全部</option>
                                    <option value="1">正常</option>
                                    <option value="0">停用</option>
                                </select>
                            </div>
                            <div class="im-search-item">
                                <span class="im-search-label">在线</span>
                                <select name="isOnline" class="im-search-select">
                                    <option value="">全部</option>
                                    <option value="1">在线</option>
                                    <option value="0">离线</option>
                                </select>
                            </div>
                            <div class="im-search-actions">
                                <button type="button" class="im-btn im-btn-primary" onclick="doSearch()">
                                    <i class="fa fa-search"></i> 搜索
                                </button>
                                <button type="button" class="im-btn im-btn-default" onclick="clearSearch()">
                                    <i class="fa fa-refresh"></i> 重置
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 工具栏 -->
            <div class="col-sm-12">
                <div class="im-toolbar">
                    <div class="im-toolbar-left">
                        <button type="button" class="im-btn im-btn-success" onclick="addUser()" shiro:hasPermission="im:user:add">
                            <i class="fa fa-plus"></i> 新增
                        </button>
                        <button type="button" class="im-btn im-btn-primary single disabled" onclick="editUser()" shiro:hasPermission="im:user:edit">
                            <i class="fa fa-edit"></i> 修改
                        </button>
                        <button type="button" class="im-btn im-btn-default single disabled" onclick="resetPwd()" shiro:hasPermission="im:user:edit">
                            <i class="fa fa-key"></i> 重置密码
                        </button>
                        <button type="button" class="im-btn im-btn-success multiple disabled" onclick="batchEnable()" shiro:hasPermission="im:user:edit">
                            <i class="fa fa-check"></i> 批量启用
                        </button>
                        <button type="button" class="im-btn im-btn-warning multiple disabled" onclick="batchDisable()" shiro:hasPermission="im:user:edit">
                            <i class="fa fa-ban"></i> 批量停用
                        </button>
                        <button type="button" class="im-btn im-btn-danger multiple disabled" onclick="$.operate.removeAll()" shiro:hasPermission="im:user:remove">
                            <i class="fa fa-remove"></i> 删除
                        </button>
                    </div>
                    <div class="im-toolbar-right">
                        <button type="button" class="im-btn im-btn-default" onclick="$.table.exportExcel()" shiro:hasPermission="im:user:export">
                            <i class="fa fa-download"></i> 导出
                        </button>
                    </div>
                </div>
            </div>

            <!-- 数据表格 -->
            <div class="col-sm-12 select-table table-striped">
                <table id="bootstrap-table" data-mobile-responsive="true"></table>
            </div>
        </div>
    </div>

    <th:block th:include="include :: footer" />
    <th:block th:include="include :: bootstrap-table-export-js" />
    <script th:src="@{/js/im-common.js?v=1.0.3}"></script>
    <script th:inline="javascript">
        var editFlag = [[${@permission.hasPermi('im:user:edit') }]];
        var removeFlag = [[${@permission.hasPermi('im:user:remove') }]];
        var prefix = ctx + "im/user";

        $(function () {
            // 初始加载统计数据
            loadStatistics();

            var options = {
                url: prefix + "/list",
                createUrl: prefix + "/add",
                updateUrl: prefix + "/edit/{id}",
                removeUrl: prefix + "/remove/{id}",
                exportUrl: prefix + "/export",
                toolbar: "toolbar",
                modalName: "用户",
                sortName: "createTime",
                sortOrder: "desc",
                columns: [{
                    checkbox: true
                }, {
                    field: 'avatar',
                    title: '头像',
                    align: 'center',
                    width: '60',
                    formatter: function (value, row, index) {
                        if (value) {
                            return '<div class="im-avatar im-avatar-md"><img src="' + value + '" style="width:100%;height:100%;object-fit:cover;" onerror="this.src=\'/img/profile.jpg\'"></div>';
                        }
                        return '<div class="im-avatar im-avatar-md"><i class="fa fa-user"></i></div>';
                    }
                }, {
                    field: 'username',
                    title: '登录账号',
                    sortable: true,
                    formatter: function (value, row, index) {
                        return '<span class="user-name">' + (value || '-') + '</span>';
                    }
                }, {
                    field: 'nickname',
                    title: '昵称',
                    sortable: true,
                    formatter: function (value, row, index) {
                        var avatar = row.avatar ? '<img src="' + row.avatar + '" class="im-avatar im-avatar-sm" style="margin-right:4px;" onerror="this.src=\'/img/profile.jpg\'">' : '<div class="im-avatar im-avatar-sm" style="margin-right:4px;"><i class="fa fa-user"></i></div>';
                        return '<div class="user-info">' + avatar + '<span>' + (value || row.username || '-') + '</span></div>';
                    }
                }, {
                    field: 'status',
                    title: '账号状态',
                    align: 'center',
                    width: '100',
                    formatter: function (value, row, index) {
                        return statusTools(row);
                    }
                }, {
                    field: 'isOnline',
                    title: '在线状态',
                    align: 'center',
                    width: '90',
                    formatter: function (value, row, index) {
                        if (value == 1) {
                            return '<span class="im-status-dot online">在线</span>';
                        }
                        return '<span class="im-status-dot offline">离线</span>';
                    }
                }, {
                    field: 'createTime',
                    title: '创建时间',
                    sortable: true,
                    width: '160',
                    formatter: function (value) {
                        return ImCommon.formatDateTime(value);
                    }
                }, {
                    title: '操作',
                    align: 'center',
                    width: '180',
                    formatter: function (value, row, index) {
                        var actions = [];
                        actions.push('<a class="btn btn-default btn-xs" href="javascript:void(0)" onclick="resetPasswordById(\'' + row.id + '\')" title="重置密码"><i class="fa fa-key"></i></a> ');
                        actions.push('<a class="btn btn-success btn-xs ' + editFlag + '" href="javascript:void(0)" onclick="editUserById(\'' + row.id + '\')" title="修改"><i class="fa fa-edit"></i></a> ');
                        actions.push('<a class="btn btn-danger btn-xs ' + removeFlag + '" href="javascript:void(0)" onclick="$.operate.remove(\'' + row.id + '\')" title="删除"><i class="fa fa-remove"></i></a> ');
                        return actions.join('');
                    }
                }]
            };
            $.table.init(options);

            // 按钮刷新监听
            $(document).off('click', "button[name='refresh']").on('click', "button[name='refresh']", function () {
                $.table.refresh();
                loadStatistics();
            });
        });

        /* 状态显示与切换 - 使用 Switch 风格 */
        function statusTools(row) {
            if (row.status == 1) { // 正常
                return '<label class="status-switch" title="点击停用">' +
                    '<input type="checkbox" checked onchange="changeStatus(\'' + row.id + '\', 0)">' +
                    '<span class="status-slider"></span>' +
                    '</label>';
            } else { // 停用
                return '<label class="status-switch" title="点击启用">' +
                    '<input type="checkbox" onchange="changeStatus(\'' + row.id + '\', 1)">' +
                    '<span class="status-slider"></span>' +
                    '</label>';
            }
        }

        /* 加载统计数据（带动画） */
        function loadStatistics() {
            // 使用 ImCommon 的缓存加载机制
            ImCommon.loadStatisticsWithCache(prefix + "/statistics", function (data) {
                // 使用动画更新数字
                ImCommon.animateStatistics({
                    '#totalCount': data.totalCount || 0,
                    '#onlineCount': data.onlineCount || 0,
                    '#offlineCount': data.offlineCount || 0,
                    '#disabledCount': data.disabledCount || 0
                });
            });
        }

        function filterByStatus(status) {
            $('select[name="status"]').val(status);
            doSearch();
            ImCommon.toast('已筛选状态: ' + (status === '' ? '所有' : (status === '1' ? '正常' : '停用')), 'info');
        }

        function filterByOnline(isOnline) {
            $('select[name="isOnline"]').val(isOnline);
            doSearch();
            ImCommon.toast('已筛选在线状态: ' + (isOnline === '' ? '所有' : (isOnline === '1' ? '在线' : '离线')), 'info');
        }

        function doSearch() {
            $.table.search();
            ImCommon.toast('搜索已更新', 'success', 1500);
        }

        function clearSearch() {
            $.form.reset();
            $.table.search();
            ImCommon.toast('筛选条件已重置', 'info');
        }

        function resetPwd(userId) {
            var targetId = userId;
            if ($.common.isEmpty(targetId) || (typeof targetId !== 'string' && typeof targetId !== 'number')) {
                var selectedId = $.table.selectFirstColumns();
                if ($.common.isEmpty(selectedId)) {
                    $.modal.alertWarning("请至少选择一条记录");
                    return;
                }
                targetId = selectedId;
            }
            $.modal.open("重置密码", prefix + "/resetPassword/" + targetId, 800, 600);
        }

        function resetPasswordById(userId) {
            resetPwd(userId);
        }

        function addUser() {
            $.modal.open("添加用户", prefix + "/add", 800, 600);
        }

        function editUser(id) {
            var url = prefix + "/edit/";
            if ($.common.isNotEmpty(id) && (typeof id === 'string' || typeof id === 'number')) {
                url += id;
            } else {
                var selectedId = $.table.selectFirstColumns();
                if ($.common.isEmpty(selectedId)) {
                    $.modal.alertWarning("请选择要修改的数据");
                    return;
                }
                url += selectedId;
            }
            $.modal.open("修改用户", url, 800, 600);
        }

        function editUserById(id) {
            editUser(id);
        }

        /* 单条状态修改 */
        function changeStatus(userId, status) {
            var msg = status == 1 ? "启用" : "停用";
            $.modal.confirm("确认要" + msg + "该用户吗？", function () {
                $.ajax({
                    url: prefix + "/changeStatus",
                    type: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({ "id": userId, "status": status }),
                    success: function (result) {
                        if (result.code == 0) {
                            ImCommon.toast(result.msg, 'success');
                            $.table.refresh();
                            loadStatistics();
                        } else {
                            $.modal.msgError(result.msg);
                            $.table.refresh();
                        }
                    }
                });
            }, function () {
                $.table.refresh();
            });
        }

        /* 批量启用 */
        function batchEnable() {
            var userIds = $.table.selectColumns("id");
            if (!ImCommon.validateBatchOperation(userIds, 1)) return;
            $.modal.confirm("确认要批量启用选中的 " + userIds.length + " 个用户吗？", function () {
                $.operate.post(prefix + "/batchUpdateStatus", { "userIds": userIds.join(","), "status": 1 }, function (result) {
                    ImCommon.toast('批量启用完成', 'success');
                    loadStatistics();
                });
            });
        }

        /* 批量停用 */
        function batchDisable() {
            var userIds = $.table.selectColumns("id");
            if (!ImCommon.validateBatchOperation(userIds, 1)) return;
            $.modal.confirm("确认要批量停用选中的 " + userIds.length + " 个用户吗？此操作将导致这些用户无法登录。", function () {
                $.operate.post(prefix + "/batchUpdateStatus", { "userIds": userIds.join(","), "status": 0 }, function (result) {
                    ImCommon.toast('批量停用完成', 'success');
                    loadStatistics();
                });
            });
        }

        // 覆盖默认的添加方法，使用合适的弹窗大小
        $.operate.add = function (id) {
            $.modal.open("添加" + $.table._option.modalName, $.operate.addUrl(id), 800, 600);
        };

        // 覆盖默认的编辑方法，使用合适的弹窗大小
        $.operate.edit = function (id) {
            $.modal.open("修改" + $.table._option.modalName, $.operate.editUrl(id), 800, 600);
        };
    </script>
</body>

</html>
