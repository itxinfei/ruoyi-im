<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <th:block th:include="include :: header('用户管理')" />
    <link th:href="@{/css/im-admin.css}" rel="stylesheet" />
    <style>
        /* 页面特定样式 */
        .wrapper-content {
            padding: 16px !important;
        }

        /* 统计卡片点击效果 */
        .im-stat-card.clickable {
            cursor: pointer;
        }

        .im-stat-card.clickable:active {
            transform: translateY(0);
        }

        /* 用户名样式 */
        .user-name-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-name-cell .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-name-cell .name-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            background: var(--im-primary-light);
            color: var(--im-primary);
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        /* 在线状态指示器 */
        .online-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 13px;
        }

        .online-indicator .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .online-indicator.online .dot {
            background: var(--im-success);
            box-shadow: 0 0 0 2px var(--im-success-bg);
        }

        .online-indicator.offline .dot {
            background: var(--im-text-quaternary);
        }

        /* 操作按钮组 */
        .action-buttons {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 2px 8px;
            font-size: 12px;
            border-radius: 4px;
            border: 1px solid transparent;
            cursor: pointer;
            transition: var(--im-transition);
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .action-btn-edit {
            background: var(--im-success-bg);
            color: var(--im-success);
        }

        .action-btn-edit:hover {
            background: var(--im-success);
            color: #fff;
        }

        .action-btn-disable {
            background: var(--im-warning-bg);
            color: var(--im-warning);
        }

        .action-btn-disable:hover {
            background: var(--im-warning);
            color: #fff;
        }

        .action-btn-enable {
            background: var(--im-success-bg);
            color: var(--im-success);
        }

        .action-btn-enable:hover {
            background: var(--im-success);
            color: #fff;
        }

        .action-btn-delete {
            background: var(--im-danger-bg);
            color: var(--im-danger);
        }

        .action-btn-delete:hover {
            background: var(--im-danger);
            color: #fff;
        }

        /* 表格样式优化 */
        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background: var(--im-bg-hover);
            font-weight: 600;
            color: var(--im-text-primary);
            border-bottom: 1px solid var(--im-border);
        }

        .table tbody tr {
            transition: var(--im-transition);
        }

        .table tbody tr:hover {
            background: var(--im-bg-hover);
        }

        /* 响应式表格容器 */
        .table-responsive {
            border-radius: var(--im-radius-md);
            overflow: hidden;
        }

        /* 搜索折叠面板 */
        .search-collapse {
            background: var(--im-bg-container);
            border-radius: var(--im-radius-md);
            padding: var(--im-spacing-md);
            margin-bottom: var(--im-spacing-md);
            box-shadow: var(--im-shadow-sm);
            border: 1px solid var(--im-border-light);
        }

        .select-list ul {
            display: flex;
            flex-wrap: wrap;
            gap: var(--im-spacing-md);
            list-style: none;
            margin: 0;
            padding: 0;
            align-items: center;
        }

        .select-list ul li {
            display: flex;
            align-items: center;
            gap: var(--im-spacing-sm);
        }

        .select-list .input-label {
            font-size: 14px;
            color: var(--im-text-secondary);
            font-weight: 500;
            white-space: nowrap;
        }

        .select-list input,
        .select-list select {
            height: 32px;
            padding: 4px 12px;
            border: 1px solid var(--im-border);
            border-radius: var(--im-radius-sm);
            font-size: 14px;
            min-width: 140px;
            transition: var(--im-transition);
        }

        .select-list input:focus,
        .select-list select:focus {
            outline: none;
            border-color: var(--im-primary);
            box-shadow: 0 0 0 2px var(--im-primary-light);
        }

        .select-list input::placeholder {
            color: var(--im-text-quaternary);
        }

        /* 按钮组样式优化 */
        .btn-group-sm .btn {
            height: 32px;
            padding: 4px 12px;
            font-size: 13px;
            border-radius: var(--im-radius-sm);
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: var(--im-transition);
        }

        .btn-group-sm .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--im-shadow-sm);
        }

        .btn-group-sm .btn:active {
            transform: translateY(0);
        }

        .btn-success {
            background: var(--im-success);
            border-color: var(--im-success);
        }

        .btn-primary {
            background: var(--im-primary);
            border-color: var(--im-primary);
        }

        .btn-danger {
            background: var(--im-danger);
            border-color: var(--im-danger);
        }

        .btn-info {
            background: var(--im-info);
            border-color: var(--im-info);
        }

        .btn-warning {
            background: var(--im-warning);
            border-color: var(--im-warning);
        }

        .btn-default {
            background: var(--im-bg-container);
            border-color: var(--im-border);
            color: var(--im-text-primary);
        }

        .btn-default:hover {
            border-color: var(--im-primary);
            color: var(--im-primary);
        }

        /* 统计卡片样式优化 */
        .ibox {
            margin-bottom: 0;
            background: var(--im-bg-container);
            border-radius: var(--im-radius-md);
            box-shadow: var(--im-shadow-sm);
            border: 1px solid var(--im-border-light);
            overflow: hidden;
        }

        .ibox-title {
            padding: 12px 16px;
            border-bottom: 1px solid var(--im-divider);
            background: var(--im-bg-hover);
        }

        .ibox-title h5 {
            margin: 0;
            font-size: 13px;
            font-weight: 600;
            color: var(--im-text-secondary);
        }

        .ibox-content {
            padding: var(--im-spacing-md);
            text-align: center;
            cursor: pointer;
            transition: var(--im-transition);
        }

        .ibox-content:hover {
            background: var(--im-bg-hover);
        }

        .ibox-content .no-margins {
            font-size: 28px;
            font-weight: 600;
            color: var(--im-text-primary);
            margin: 0;
        }

        .text-success {
            color: var(--im-success);
        }

        .text-danger {
            color: var(--im-danger);
        }

        .text-primary {
            color: var(--im-primary);
        }

        .text-muted {
            color: var(--im-text-tertiary);
        }

        /* 响应式优化 */
        @media (max-width: 768px) {
            .select-list ul {
                flex-direction: column;
                align-items: stretch;
            }

            .select-list ul li {
                flex-direction: column;
                align-items: stretch;
            }

            .select-list input,
            .select-list select {
                width: 100%;
                min-width: unset;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>

<body class="gray-bg">
    <div class="wrapper wrapper-content animated fadeInRight">
        <!-- 统计卡片区域 -->
        <div class="row" style="margin-bottom: var(--im-spacing-md);">
            <div class="col-sm-3">
                <div class="ibox">
                    <div class="ibox-title">
                        <h5><i class="fa fa-users" style="margin-right: 6px;"></i>用户总数</h5>
                    </div>
                    <div class="ibox-content" onclick="filterByStatus('')">
                        <h1 class="no-margins" id="totalCount">-</h1>
                        <small class="text-muted">全部用户</small>
                    </div>
                </div>
            </div>
            <div class="col-sm-3">
                <div class="ibox">
                    <div class="ibox-title">
                        <h5><i class="fa fa-circle text-success" style="margin-right: 6px; font-size: 10px;"></i>在线用户</h5>
                    </div>
                    <div class="ibox-content" onclick="filterByOnline('1')">
                        <h1 class="no-margins text-success" id="onlineCount">-</h1>
                        <small class="text-muted">当前在线</small>
                    </div>
                </div>
            </div>
            <div class="col-sm-3">
                <div class="ibox">
                    <div class="ibox-title">
                        <h5><i class="fa fa-ban text-danger" style="margin-right: 6px;"></i>停用账号</h5>
                    </div>
                    <div class="ibox-content" onclick="filterByStatus('0')">
                        <h1 class="no-margins text-danger" id="disabledCount">-</h1>
                        <small class="text-muted">已停用</small>
                    </div>
                </div>
            </div>
            <div class="col-sm-3">
                <div class="ibox">
                    <div class="ibox-title">
                        <h5><i class="fa fa-user-plus text-primary" style="margin-right: 6px;"></i>今日新增</h5>
                    </div>
                    <div class="ibox-content">
                        <h1 class="no-margins text-primary" id="todayRegister">-</h1>
                        <small class="text-muted">今日注册</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 搜索区域 -->
        <div class="row">
            <div class="col-sm-12 search-collapse">
                <form id="user-form">
                    <div class="select-list">
                        <ul>
                            <li>
                                <label class="input-label">用户名</label>
                                <input type="text" name="username" placeholder="请输入用户名" />
                            </li>
                            <li>
                                <label class="input-label">昵称</label>
                                <input type="text" name="nickname" placeholder="请输入昵称" />
                            </li>
                            <li>
                                <label class="input-label">手机号</label>
                                <input type="text" name="phone" placeholder="请输入手机号" />
                            </li>
                            <li>
                                <label class="input-label">状态</label>
                                <select name="status">
                                    <option value="">全部</option>
                                    <option value="1">正常</option>
                                    <option value="0">停用</option>
                                </select>
                            </li>
                            <li>
                                <label class="input-label">在线</label>
                                <select name="isOnline">
                                    <option value="">全部</option>
                                    <option value="1">在线</option>
                                    <option value="0">离线</option>
                                </select>
                            </li>
                            <li style="margin-left: auto;">
                                <a class="btn btn-primary btn-sm" onclick="$.table.search()">
                                    <i class="fa fa-search"></i>&nbsp;搜索
                                </a>
                                <a class="btn btn-default btn-sm" onclick="$.form.reset()">
                                    <i class="fa fa-refresh"></i>&nbsp;重置
                                </a>
                            </li>
                        </ul>
                    </div>
                </form>
            </div>
        </div>

        <!-- 表格区域 -->
        <div class="row">
            <div class="col-sm-12 select-table table-striped">
                <div class="btn-group-sm" id="toolbar" role="group" style="margin-bottom: var(--im-spacing-sm);">
                    <a class="btn btn-success" onclick="$.operate.add()" shiro:hasPermission="im:user:add">
                        <i class="fa fa-plus"></i> 新增
                    </a>
                    <a class="btn btn-primary single disabled" onclick="$.operate.edit()" shiro:hasPermission="im:user:edit">
                        <i class="fa fa-edit"></i> 修改
                    </a>
                    <a class="btn btn-danger multiple disabled" onclick="$.operate.removeAll()" shiro:hasPermission="im:user:remove">
                        <i class="fa fa-remove"></i> 删除
                    </a>
                    <a class="btn btn-info" onclick="showImportModal()" shiro:hasPermission="im:user:import">
                        <i class="fa fa-upload"></i> 导入
                    </a>
                    <a class="btn btn-warning multiple disabled" onclick="batchChangeStatus(1)" shiro:hasPermission="im:user:edit">
                        <i class="fa fa-check"></i> 批量启用
                    </a>
                    <a class="btn btn-warning multiple disabled" onclick="batchChangeStatus(0)" shiro:hasPermission="im:user:edit">
                        <i class="fa fa-ban"></i> 批量停用
                    </a>
                    <a class="btn btn-default" onclick="$.table.exportExcel()" shiro:hasPermission="im:user:export">
                        <i class="fa fa-download"></i> 导出
                    </a>
                </div>
                <div class="table-responsive">
                    <table id="bootstrap-table" data-mobile-responsive="true"></table>
                </div>
            </div>
        </div>
    </div>

    <th:block th:include="include :: footer" />
    <th:block th:include="include :: bootstrap-table-export-js" />
    <script th:src="@{/js/im-common.js}"></script>
    <script th:inline="javascript">
        var prefix = ctx + "im/user";
        var editFlag = [[${@permission.hasPermi('im:user:edit')}]];
        var removeFlag = [[${@permission.hasPermi('im:user:remove')}]];
        var resetPwdFlag = [[${@permission.hasPermi('im:user:resetPwd')}]];

        $(function () {
            loadStatistics();
            initTable();
        });

        function loadStatistics() {
            $.get(ctx + 'im/dashboard/user-statistics', function (res) {
                if (res.code === 0) {
                    $('#totalCount').text(res.data.totalUsers || 0);
                    $('#onlineCount').text(res.data.onlineUsers || 0);
                    $('#disabledCount').text(res.data.disabledUsers || 0);
                    $('#todayRegister').text(res.data.todayRegister || 0);
                }
            }).fail(function() {
                $('#totalCount').text('-');
                $('#onlineCount').text('-');
                $('#disabledCount').text('-');
                $('#todayRegister').text('-');
            });
        }

        function initTable() {
            var options = {
                url: prefix + "/list",
                createUrl: prefix + "/add",
                updateUrl: prefix + "/edit/{id}",
                removeUrl: prefix + "/remove/{id}",
                exportUrl: prefix + "/export",
                sortName: "createTime",
                sortOrder: "desc",
                modalName: "用户",
                columns: [{
                    checkbox: true
                }, {
                    field: 'id',
                    visible: false
                }, {
                    field: 'avatar',
                    title: '头像',
                    width: 80,
                    align: 'center',
                    formatter: function (value, row) {
                        var avatar = value || '/img/profile.jpg';
                        var name = row.nickname || row.username || '用户';
                        return '<div class="user-name-cell">' +
                            '<img src="' + avatar + '" class="avatar" onerror="this.src=\'/img/profile.jpg\'" />' +
                            '<span class="name-badge">' + (row.username || '') + '</span>' +
                            '</div>';
                    }
                }, {
                    field: 'nickname',
                    title: '昵称',
                    width: 120,
                    formatter: function (value, row) {
                        return value || '<span class="text-muted">未设置</span>';
                    }
                }, {
                    field: 'departmentName',
                    title: '部门',
                    width: 120,
                    formatter: function (value) {
                        return value || '<span class="text-muted">-</span>';
                    }
                }, {
                    field: 'phone',
                    title: '手机号',
                    width: 120
                }, {
                    field: 'email',
                    title: '邮箱',
                    width: 180,
                    formatter: function (value) {
                        if (!value) return '<span class="text-muted">-</span>';
                        return '<span style="display:inline-block;max-width:170px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="' + value + '">' + value + '</span>';
                    }
                }, {
                    field: 'status',
                    title: '状态',
                    width: 80,
                    align: 'center',
                    formatter: function (value) {
                        if (value == 1) {
                            return '<span class="im-badge im-badge-success">正常</span>';
                        } else {
                            return '<span class="im-badge im-badge-danger">停用</span>';
                        }
                    }
                }, {
                    field: 'isOnline',
                    title: '在线状态',
                    width: 100,
                    align: 'center',
                    formatter: function (value) {
                        if (value == 1) {
                            return '<div class="online-indicator online"><span class="dot"></span>在线</div>';
                        } else {
                            return '<div class="online-indicator offline"><span class="dot"></span>离线</div>';
                        }
                    }
                }, {
                    field: 'lastLoginTime',
                    title: '最后登录',
                    width: 160,
                    sortable: true,
                    formatter: function (value) {
                        return value || '<span class="text-muted">从未登录</span>';
                    }
                }, {
                    field: 'createTime',
                    title: '注册时间',
                    width: 160,
                    sortable: true
                }, {
                    title: '操作',
                    align: 'center',
                    width: 180,
                    formatter: function (value, row) {
                        var actions = [];
                        actions.push('<a class="action-btn action-btn-edit" href="javascript:void(0)" onclick="$.operate.edit(\'' + row.id + '\')"><i class="fa fa-edit"></i>编辑</a> ');
                        if (row.status == 1) {
                            actions.push('<a class="action-btn action-btn-disable" href="javascript:void(0)" onclick="changeStatus(\'' + row.id + '\', 0)"><i class="fa fa-ban"></i>停用</a> ');
                        } else {
                            actions.push('<a class="action-btn action-btn-enable" href="javascript:void(0)" onclick="changeStatus(\'' + row.id + '\', 1)"><i class="fa fa-check"></i>启用</a> ');
                        }
                        actions.push('<a class="action-btn action-btn-delete" href="javascript:void(0)" onclick="$.operate.remove(\'' + row.id + '\')"><i class="fa fa-trash"></i>删除</a>');
                        return '<div class="action-buttons">' + actions.join('') + '</div>';
                    }
                }]
            };
            $.table.init(options);
        }

        function filterByStatus(status) {
            $('select[name="status"]').val(status);
            $.table.search();
        }

        function filterByOnline(online) {
            $('select[name="isOnline"]').val(online);
            $.table.search();
        }

        function changeStatus(id, status) {
            var action = status == 1 ? '启用' : '停用';
            $.modal.confirm("确定要" + action + "该用户吗？", function () {
                $.operate.post(prefix + "/changeStatus", { userId: id, status: status }, function (res) {
                    if (res.code == 0) {
                        $.table.refresh();
                        loadStatistics();
                    }
                });
            });
        }

        function batchChangeStatus(status) {
            var rows = $.table.selectFirstColumns();
            if (rows.length == 0) {
                $.modal.alertWarning("请至少选择一条记录");
                return;
            }
            var action = status == 1 ? '启用' : '停用';
            $.modal.confirm("确定要批量" + action + "吗？", function () {
                var ids = rows.join();
                $.operate.post(prefix + "/batchUpdateStatus", { userIds: ids, status: status }, function (res) {
                    if (res.code == 0) {
                        $.table.refresh();
                        loadStatistics();
                    }
                });
            });
        }

        function showImportModal() {
            $.modal.open("导入用户", prefix + "/import", 600, 400);
        }
    </script>
</body>
</html>
