<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: header('新增IM用户')" />
    <th:block th:include="include :: bootstrap-fileinput-css"/>
    <style>
        /* 大厂表单设计规范 */
        :root {
            --primary-color: #1890ff;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --danger-color: #ff4d4f;
            --text-primary: #262626;
            --text-secondary: #595959;
            --text-tertiary: #8c8c8c;
            --border-color: #d9d9d9;
            --border-light: #e8e8e8;
            --bg-light: #fafafa;
            --bg-card: #ffffff;
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
        }

        body { background: #f5f7fa !important; }
        .ibox-content {
            background: #fff;
            border-radius: var(--radius-lg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            padding: 28px !important;
            max-width: 100%;
            margin: 0;
        }

        /* 表单标题 */
        .form-header { margin-bottom: 24px; }
        .form-title { font-size: 18px; font-weight: 500; color: var(--text-primary); }
        .form-desc { font-size: 13px; color: var(--text-tertiary); margin-top: 4px; }

        /* 表单分组 */
        .form-section { margin-bottom: 24px; }
        .form-section-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            padding-bottom: 8px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .form-section-title i { color: var(--primary-color); }

        .form-group { margin-bottom: 16px; }
        .form-group:last-child { margin-bottom: 0; }

        .control-label {
            font-size: 13px;
            font-weight: 400;
            color: var(--text-secondary);
            padding-top: 6px;
            margin-bottom: 4px;
        }
        .control-label.required::before { content: '*'; color: var(--danger-color); margin-right: 4px; }

        .form-control {
            height: 36px;
            padding: 0 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 13px;
            transition: all 0.2s;
        }
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(24,144,255,0.1);
            outline: none;
        }
        .form-control::placeholder { color: #bfbfbf; }
        textarea.form-control { height: auto; min-height: 80px; resize: vertical; }

        /* 必填/错误/成功状态 */
        .form-control.is-invalid { border-color: var(--danger-color); }
        .form-control.is-valid { border-color: var(--success-color); }

        /* 帮助文本 */
        .help-text { font-size: 12px; color: var(--text-tertiary); margin-top: 4px; }
        .help-text i { margin-right: 4px; }

        /* 输入组 */
        .input-group .input-group-addon {
            width: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-light);
            border: 1px solid var(--border-color);
            border-left: none;
            cursor: pointer;
            color: var(--text-tertiary);
            transition: all 0.2s;
        }
        .input-group-addon:hover { background: #e6e6e6; color: var(--text-primary); }
        .input-group .form-control { border-top-right-radius: 0; border-bottom-right-radius: 0; }

        /* 密码强度 */
        .strength-bar { height: 3px; background: var(--border-light); border-radius: 2px; overflow: hidden; margin-top: 6px; }
        .strength-fill { height: 100%; width: 0; transition: width 0.3s; }
        .strength-fill.weak { width: 33%; background: var(--danger-color); }
        .strength-fill.medium { width: 66%; background: var(--warning-color); }
        .strength-fill.strong { width: 100%; background: var(--success-color); }
        .strength-text { font-size: 12px; color: var(--text-tertiary); margin-top: 4px; }

        /* 单选框 */
        .radio-group { display: flex; gap: 20px; }
        .radio-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
        }
        .radio-label input { margin: 0; }

        /* 头像选择区 */
        .avatar-section {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            align-items: flex-start;
        }
        .avatar-form { flex: 1; }

        .avatar-preview-box {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            border: 2px dashed var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-light);
            overflow: hidden;
            flex-shrink: 0;
        }
        .avatar-preview-box img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-preview-box i { font-size: 28px; color: var(--text-tertiary); }

        .avatar-options {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }
        .avatar-option {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .avatar-option:hover { transform: scale(1.1); }
        .avatar-option.selected { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(24,144,255,0.2); }

        .avatar-label { font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; }
        .avatar-upload { font-size: 13px; color: var(--primary-color); cursor: pointer; }

        /* 按钮区 */
        .form-actions {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        .btn {
            height: 36px;
            padding: 0 20px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 400;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--primary-color); border-color: var(--primary-color); color: #fff; }
        .btn-primary:hover { background: #40a9ff; border-color: #40a9ff; }
        .btn-default { background: #fff; border-color: var(--border-color); color: var(--text-primary); }
        .btn-default:hover { border-color: var(--primary-color); color: var(--primary-color); }

        @media (max-width: 600px) {
            .avatar-section { flex-direction: column; }
            .avatar-preview-box { margin: 0 auto; }
        }
    </style>
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="ibox-content">
            <div class="form-header">
                <div class="form-title">新增用户</div>
                <div class="form-desc">填写以下信息创建新用户账号</div>
            </div>

            <form class="form-horizontal m" id="form-user-add">
                <input type="hidden" name="avatar" id="avatarInput">

                <!-- 头像选择 -->
                <div class="form-section">
                    <div class="avatar-section">
                        <div class="avatar-preview-box" id="avatarPreview">
                            <i class="fa fa-user"></i>
                        </div>
                        <div class="avatar-form">
                            <div class="avatar-label">选择头像</div>
                            <div class="avatar-options" id="defaultAvatars">
                                <div class="avatar-option selected" data-avatar="/profile/avatar/default1.png" style="background: linear-gradient(135deg, #667eea, #764ba2);"></div>
                                <div class="avatar-option" data-avatar="/profile/avatar/default2.png" style="background: linear-gradient(135deg, #f5576c, #f093fb);"></div>
                                <div class="avatar-option" data-avatar="/profile/avatar/default3.png" style="background: linear-gradient(135deg, #4facfe, #00f2fe);"></div>
                                <div class="avatar-option" data-avatar="/profile/avatar/default4.png" style="background: linear-gradient(135deg, #43e97b, #38f9d7);"></div>
                            </div>
                            <label class="avatar-upload" onclick="$('#avatarFile').click()">
                                <i class="fa fa-upload"></i> 上传自定义头像
                            </label>
                            <input type="file" id="avatarFile" class="file" style="display: none;" accept="image/png,image/jpeg,image/gif">
                        </div>
                    </div>
                </div>

                <!-- 账号信息 -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fa fa-user-circle"></i>账号信息
                    </div>

                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label class="control-label required">用户名</label>
                                <input name="username" class="form-control" placeholder="2-20个字符，支持字母、数字、下划线" id="username" required>
                                <div class="help-text"><i class="fa fa-info-circle"></i>用于登录系统，创建后不可修改</div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label class="control-label required">昵称</label>
                                <input name="nickname" class="form-control" placeholder="请输入用户昵称" id="nickname" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="control-label required">登录密码</label>
                        <div class="input-group" style="max-width: 300px;">
                            <input name="password" class="form-control" type="password" placeholder="请输入5-20个字符" id="password" required>
                            <span class="input-group-addon" onclick="togglePassword()">
                                <i class="fa fa-eye" id="password-eye"></i>
                            </span>
                        </div>
                        <div class="strength-bar"><div class="strength-fill" id="strength-fill"></div></div>
                        <div class="strength-text" id="strength-text">密码强度: 未设置</div>
                    </div>
                </div>

                <!-- 联系信息 -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fa fa-address-book"></i>联系信息
                    </div>

                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label class="control-label">手机号</label>
                                <input name="mobile" class="form-control" placeholder="请输入手机号码" id="mobile">
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label class="control-label">邮箱</label>
                                <input name="email" class="form-control" type="email" placeholder="请输入邮箱地址" id="email">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label class="control-label">性别</label>
                                <select name="gender" class="form-control">
                                    <option value="">请选择性别</option>
                                    <option th:each="dict : ${@dict.getType('sys_user_sex')}" th:text="${dict.dictLabel}" th:value="${dict.dictValue}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label class="control-label">账号状态</label>
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="status" value="1" checked> 正常
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="status" value="0"> 停用
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 按钮区 -->
                <div class="form-actions">
                    <button type="button" class="btn btn-default" onclick="$.modal.close()">取消</button>
                    <button type="submit" class="btn btn-primary">确定新增</button>
                </div>
            </form>
        </div>
    </div>

    <th:block th:include="include :: footer" />
    <th:block th:include="include :: bootstrap-fileinput-js"/>
    <script type="text/javascript">
        var prefix = ctx + "im/user";

        $(document).ready(function() {
            initAvatarSelect();
            initPasswordStrength();
            selectAvatar('/profile/avatar/default1.png');
        });

        $("#form-user-add").validate({
            focusCleanup: true,
            rules: {
                username: { required: true, minlength: 2, maxlength: 20, remote: { url: prefix + "/checkUsernameUnique", type: "post", dataType: "json", data: { "username": function() { return $.common.trim($("#username").val()); } } } },
                nickname: { required: true, minlength: 2, maxlength: 30 },
                password: { required: true, minlength: 5, maxlength: 20 },
                email: { email: true },
                mobile: { isPhone: true }
            },
            messages: { username: { required: "请输入用户名", remote: "用户名已存在" } }
        });

        function initPasswordStrength() {
            $("#password").on('input', function() {
                var val = $(this).val(), score = 0;
                if (val.length >= 8) score++;
                if (val.length >= 12) score++;
                if (/[a-z]/.test(val) && /[A-Z]/.test(val)) score++;
                if (/\d/.test(val)) score++;
                if (/[^a-zA-Z0-9]/.test(val)) score++;

                var $fill = $('#strength-fill'), $text = $('#strength-text');
                $fill.removeClass('weak medium strong');
                if (val.length == 0) { $text.text('密码强度: 未设置'); }
                else if (score <= 2) { $fill.addClass('weak'); $text.text('密码强度: 弱'); }
                else if (score <= 3) { $fill.addClass('medium'); $text.text('密码强度: 中'); }
                else { $fill.addClass('strong'); $text.text('密码强度: 强'); }
            });
        }

        function initAvatarSelect() {
            $('.avatar-option').on('click', function() {
                selectAvatar($(this).data('avatar'));
            });

            $("#avatarFile").fileinput({
                uploadUrl: ctx + 'common/upload',
                maxFileCount: 1, autoReplace: true,
                allowedFileExtensions: ["jpg", "png", "gif", "jpeg"], maxFileSize: 2048,
                showUpload: false, showCaption: false, dropZoneEnabled: false,
                showRemove: true, previewClass: 'file-preview-box'
            }).on('fileuploaded', function(e, data) {
                if (data.response && data.response.url) {
                    $('#avatarInput').val(data.response.url);
                    $('#avatarPreview').html('<img src="' + data.response.url + '">');
                    $('.avatar-option').removeClass('selected');
                }
            });
        }

        function selectAvatar(avatar) {
            $('#avatarInput').val(avatar);
            $('.avatar-option').removeClass('selected');
            var $sel = $('.avatar-option[data-avatar="' + avatar + '"]');
            if ($sel.length) {
                $sel.addClass('selected');
                $('#avatarPreview').html('<div style="width:100%;height:100%;background:' + $sel.css('background') + ';display:flex;align-items:center;justify-content:center;"><i class="fa fa-user" style="color:#fff;font-size:28px;"></i></div>');
            }
        }

        function togglePassword() {
            var $p = $('#password'), $i = $('#password-eye');
            if ($p.attr('type') == 'password') { $p.attr('type', 'text'); $i.removeClass('fa-eye').addClass('fa-eye-slash'); }
            else { $p.attr('type', 'password'); $i.removeClass('fa-eye-slash').addClass('fa-eye'); }
        }

        function submitHandler() {
            if (!$('#avatarInput').val()) { $.modal.msgWarning("请选择头像"); return; }
            if ($.validate.form()) { $.operate.save(prefix + "/add", $('#form-user-add').serialize()); }
        }
    </script>
</body>
</html>
