<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('新增IM用户')" />
    <th:block th:include="include :: bootstrap-fileinput-css"/>
    <style>
        .user-add-container {
            display: flex;
            gap: 16px;
        }

        .user-form-section {
            flex: 1;
        }

        .user-avatar-section {
            width: 200px;
            background: #f8f9fa;
            border-radius: 4px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            color: #495057;
            margin: 0 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
            width: 100%;
        }

        .form-section {
            margin-bottom: 16px;
        }

        .input-icon {
            position: relative;
        }
        .input-icon .form-control {
            padding-left: 36px;
        }
        .input-icon .field-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #adb5bd;
            font-size: 14px;
            pointer-events: none;
        }

        .avatar-preview {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            border: 2px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .avatar-preview .fa-user {
            font-size: 32px;
            color: #dee2e6;
        }

        .default-avatars {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .default-avatar-item {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            overflow: hidden;
            transition: border-color 0.15s, transform 0.15s;
        }
        .default-avatar-item:hover {
            transform: scale(1.1);
        }
        .default-avatar-item:focus {
            outline: 2px solid #337ab7;
            outline-offset: 2px;
        }
        .default-avatar-item.selected {
            border-color: #337ab7;
        }

        .field-feedback {
            font-size: 12px;
            margin-top: 4px;
            min-height: 17px;
        }
        .field-feedback.success { color: #28a745; }
        .field-feedback.error { color: #dc3545; }
        .field-feedback.info { color: #6c757d; }

        .password-strength {
            margin-top: 6px;
        }
        .strength-bar {
            height: 3px;
            background: #e9ecef;
            border-radius: 2px;
            overflow: hidden;
        }
        .strength-fill {
            height: 100%;
            width: 0;
            transition: width 0.2s ease;
        }
        .strength-fill.weak { width: 33%; background: #dc3545; }
        .strength-fill.medium { width: 66%; background: #ffc107; }
        .strength-fill.strong { width: 100%; background: #28a745; }
        .strength-text {
            font-size: 11px;
            margin-top: 3px;
            color: #6c757d;
        }

        .avatar-upload-btn {
            cursor: pointer;
        }
        .avatar-upload-btn:hover {
            background-color: #286090;
        }

        .toggle-password {
            cursor: pointer;
        }
        .toggle-password:hover {
            background-color: #e9ecef;
        }
    </style>
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <form class="form-horizontal m" id="form-user-add" aria-label="新增用户表单">
            <div class="user-add-container">
                <!-- 左侧表单区域 -->
                <div class="user-form-section">
                    <!-- 账号信息 -->
                    <div class="form-section">
                        <div class="section-title">账号信息</div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label is-required" for="username">登录账号</label>
                            <div class="col-sm-8">
                                <div class="input-icon">
                                    <input name="username" class="form-control" type="text"
                                           placeholder="2-20个字符" id="username" required
                                           aria-required="true" aria-describedby="username-feedback">
                                    <i class="fa fa-user field-icon" aria-hidden="true"></i>
                                </div>
                                <div class="field-feedback info" id="username-feedback" role="status" aria-live="polite">请输入登录账号</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label is-required" for="nickname">用户昵称</label>
                            <div class="col-sm-8">
                                <div class="input-icon">
                                    <input name="nickname" class="form-control" type="text"
                                           placeholder="请输入用户昵称" id="nickname" required
                                           aria-required="true" aria-describedby="nickname-feedback">
                                    <i class="fa fa-id-card field-icon" aria-hidden="true"></i>
                                </div>
                                <div class="field-feedback info" id="nickname-feedback" role="status" aria-live="polite">用户在系统中显示的名称</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label is-required" for="password">登录密码</label>
                            <div class="col-sm-8">
                                <div class="input-group">
                                    <span class="input-group-addon"><i class="fa fa-key" aria-hidden="true"></i></span>
                                    <input name="password" class="form-control" type="password"
                                           placeholder="5-20个字符" id="password" required
                                           aria-required="true" aria-describedby="password-feedback strength-text">
                                    <span class="input-group-addon toggle-password" onclick="togglePassword()"
                                          role="button" tabindex="0" aria-label="显示密码"
                                          onkeypress="if(event.key==='Enter')togglePassword()">
                                        <i class="fa fa-eye" id="password-eye" aria-hidden="true"></i>
                                    </span>
                                </div>
                                <div class="password-strength">
                                    <div class="strength-bar" aria-hidden="true">
                                        <div class="strength-fill" id="strength-fill"></div>
                                    </div>
                                    <div class="strength-text" id="strength-text" role="status" aria-live="polite">密码强度: 未设置</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 联系信息 -->
                    <div class="form-section">
                        <div class="section-title">联系信息</div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label" for="mobile">手机号码</label>
                            <div class="col-sm-8">
                                <div class="input-icon">
                                    <input name="mobile" class="form-control" type="text"
                                           placeholder="请输入手机号码" id="mobile"
                                           aria-describedby="mobile-feedback">
                                    <i class="fa fa-phone field-icon" aria-hidden="true"></i>
                                </div>
                                <div class="field-feedback info" id="mobile-feedback" role="status" aria-live="polite">用于接收系统通知</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label" for="email">邮箱</label>
                            <div class="col-sm-8">
                                <div class="input-icon">
                                    <input name="email" class="form-control" type="text"
                                           placeholder="请输入邮箱地址" id="email"
                                           aria-describedby="email-feedback">
                                    <i class="fa fa-envelope field-icon" aria-hidden="true"></i>
                                </div>
                                <div class="field-feedback info" id="email-feedback" role="status" aria-live="polite">用于接收邮件通知</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 control-label" for="gender">性别</label>
                            <div class="col-sm-8">
                                <select name="gender" class="form-control" id="gender">
                                    <option value="">请选择性别</option>
                                    <option th:each="dict : ${@dict.getType('sys_user_sex')}"
                                            th:text="${dict.dictLabel}" th:value="${dict.dictValue}"></option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右侧头像区域 -->
                <div class="user-avatar-section" aria-label="用户头像选择">
                    <div class="section-title">用户头像</div>

                    <div class="avatar-preview" id="avatarPreview" aria-hidden="true">
                        <i class="fa fa-user"></i>
                    </div>

                    <!-- 默认头像选择 -->
                    <div class="default-avatars" id="defaultAvatars" role="radiogroup" aria-label="选择默认头像">
                        <button type="button" class="default-avatar-item" data-avatar="/profile/avatar/default1.png"
                                aria-label="紫色头像" tabindex="0">
                            <div style="width:100%;height:100%;background:#667eea;display:flex;align-items:center;justify-content:center;">
                                <i class="fa fa-user" style="color:#fff;font-size:14px;"></i>
                            </div>
                        </button>
                        <button type="button" class="default-avatar-item" data-avatar="/profile/avatar/default2.png"
                                aria-label="粉色头像" tabindex="0">
                            <div style="width:100%;height:100%;background:#f5576c;display:flex;align-items:center;justify-content:center;">
                                <i class="fa fa-user" style="color:#fff;font-size:14px;"></i>
                            </div>
                        </button>
                        <button type="button" class="default-avatar-item" data-avatar="/profile/avatar/default3.png"
                                aria-label="蓝色头像" tabindex="0">
                            <div style="width:100%;height:100%;background:#00f2fe;display:flex;align-items:center;justify-content:center;">
                                <i class="fa fa-user" style="color:#fff;font-size:14px;"></i>
                            </div>
                        </button>
                        <button type="button" class="default-avatar-item" data-avatar="/profile/avatar/default4.png"
                                aria-label="绿色头像" tabindex="0">
                            <div style="width:100%;height:100%;background:#43e97b;display:flex;align-items:center;justify-content:center;">
                                <i class="fa fa-user" style="color:#fff;font-size:14px;"></i>
                            </div>
                        </button>
                    </div>

                    <div style="text-align: center; margin-bottom: 8px; color: #6c757d; font-size: 12px;">
                        或上传自定义头像
                    </div>

                    <input type="hidden" name="avatar" id="avatarInput" aria-label="已选择的头像路径">
                    <div class="file-loading">
                        <input class="form-control file-upload" id="avatar" name="file" type="file" style="display: none;"
                               accept="image/png,image/jpeg,image/gif" aria-label="上传头像文件">
                    </div>
                    <label for="avatar" class="btn btn-primary btn-sm avatar-upload-btn" tabindex="0">
                        <i class="fa fa-upload" aria-hidden="true"></i> 上传头像
                    </label>

                    <div style="margin-top: 16px; padding-top: 12px; border-top: 1px solid #dee2e6; width: 100%;">
                        <div style="font-size: 13px; margin-bottom: 8px; font-weight: 500;">账号状态</div>
                        <label class="radio-inline">
                            <input type="radio" name="status" value="0" checked> 正常
                        </label>
                        <label class="radio-inline">
                            <input type="radio" name="status" value="1"> 停用
                        </label>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <th:block th:include="include :: footer" />
    <th:block th:include="include :: bootstrap-fileinput-js"/>
    <script type="text/javascript">
        var prefix = ctx + "im/user";
        var usernameUnique = false;

        $(document).ready(function() {
            initDefaultAvatars();
            initAvatarUpload();
            initRealtimeValidation();
            selectDefaultAvatar('/profile/avatar/default1.png');
        });

        $("#form-user-add").validate({
            focusCleanup: true,
            rules: {
                username: {
                    required: true,
                    minlength: 2,
                    maxlength: 20,
                    remote: {
                        url: prefix + "/checkUsernameUnique",
                        type: "post",
                        dataType: "json",
                        data: { "username": function() { return $.common.trim($("#username").val()); } },
                        dataFilter: function(data, type) {
                            usernameUnique = $.validate.unique(data);
                            updateValidationUI('username', usernameUnique, usernameUnique ? "账号可用" : "账号已存在");
                            return usernameUnique;
                        }
                    }
                },
                nickname: { required: true, minlength: 2, maxlength: 30 },
                password: { required: true, minlength: 5, maxlength: 20 },
                email: { email: true },
                mobile: { isPhone: true }
            },
            messages: {
                username: { required: "请输入登录账号", remote: "账号已存在" },
                nickname: { required: "请输入用户昵称" },
                password: { required: "请输入登录密码" }
            }
        });

        function initRealtimeValidation() {
            $("#username").on('input blur', function() {
                var val = $(this).val();
                if (val.length > 0) {
                    if (val.length < 2) updateValidationUI('username', false, "账号长度至少2个字符");
                    else if (val.length > 20) updateValidationUI('username', false, "账号长度不能超过20个字符");
                    else if (!/^[a-zA-Z0-9_]+$/.test(val)) updateValidationUI('username', false, "账号只能包含字母、数字和下划线");
                    else updateValidationUI('username', true, "格式正确");
                } else resetValidationUI('username');
            });

            $("#nickname").on('input blur', function() {
                var val = $(this).val();
                if (val.length > 0) {
                    updateValidationUI('nickname', val.length >= 2, val.length >= 2 ? "格式正确" : "昵称长度至少2个字符");
                } else resetValidationUI('nickname');
            });

            $("#password").on('input', function() {
                var val = $(this).val();
                if (val.length > 0) {
                    if (val.length < 5) {
                        updateValidationUI('password', false, "密码长度至少5个字符");
                        updatePasswordStrength(0);
                    } else {
                        updateValidationUI('password', true, "格式正确");
                        updatePasswordStrength(calculatePasswordStrength(val));
                    }
                } else {
                    resetValidationUI('password');
                    updatePasswordStrength(0);
                }
            });

            $("#email").on('input blur', function() {
                var val = $(this).val();
                if (val.length > 0) {
                    var regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    updateValidationUI('email', regex.test(val), regex.test(val) ? "邮箱格式正确" : "请输入正确的邮箱格式");
                } else resetValidationUI('email');
            });

            $("#mobile").on('input blur', function() {
                var val = $(this).val();
                if (val.length > 0) {
                    var regex = /^1[3-9]\d{9}$/;
                    updateValidationUI('mobile', regex.test(val), regex.test(val) ? "手机号格式正确" : "请输入正确的手机号");
                } else resetValidationUI('mobile');
            });
        }

        function updateValidationUI(fieldId, isValid, message) {
            var $input = $('#' + fieldId);
            var $feedback = $('#' + fieldId + '-feedback');

            // 更新边框颜色
            $input.css('border-color', isValid ? '#28a745' : (isValid === false ? '#dc3545' : ''));

            // 更新反馈文字
            $feedback.removeClass('info success error').addClass(isValid ? 'success' : 'error').text(message);
        }

        function resetValidationUI(fieldId) {
            $('#' + fieldId).css('border-color', '');
            $('#' + fieldId + '-feedback').removeClass('success error').addClass('info');
            var msgs = { 'username': '请输入登录账号', 'nickname': '用户在系统中显示的名称', 'mobile': '用于接收系统通知', 'email': '用于接收邮件通知' };
            if (msgs[fieldId]) $('#' + fieldId + '-feedback').text(msgs[fieldId]);
        }

        function calculatePasswordStrength(password) {
            var score = 0;
            if (password.length >= 8) score++;
            if (password.length >= 12) score++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
            if (/\d/.test(password)) score++;
            if (/[^a-zA-Z0-9]/.test(password)) score++;
            return score;
        }

        function updatePasswordStrength(strength) {
            var $fill = $('#strength-fill');
            var $text = $('#strength-text');
            $fill.removeClass('weak medium strong');
            if (strength <= 1) $text.text('密码强度: 弱');
            else if (strength <= 3) { $fill.addClass('medium'); $text.text('密码强度: 中'); }
            else { $fill.addClass('strong'); $text.text('密码强度: 强'); }
        }

        function initDefaultAvatars() {
            $('.default-avatar-item').on('click', function() {
                selectDefaultAvatar($(this).data('avatar'));
            }).on('keypress', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    selectDefaultAvatar($(this).data('avatar'));
                }
            });
        }

        function selectDefaultAvatar(avatar) {
            $('#avatarInput').val(avatar);
            $('.default-avatar-item').removeClass('selected').attr('aria-selected', 'false');
            var $selected = $('.default-avatar-item[data-avatar="' + avatar + '"]');
            if ($selected.length > 0) {
                $selected.addClass('selected').attr('aria-selected', 'true');
                $('#avatarPreview').html($selected.find(' > div').clone());
            }
        }

        function initAvatarUpload() {
            $(".file-upload").fileinput({
                uploadUrl: ctx + 'common/upload',
                maxFileCount: 1,
                autoReplace: true,
                allowedFileExtensions: ["jpg", "png", "gif", "jpeg"],
                maxFileSize: 2048,
                showUpload: false,
                showCaption: false,
                browseClass: "btn btn-primary btn-sm",
                dropZoneEnabled: false
            }).on('fileuploaded', function (event, data, previewId, index) {
                if (data.response && data.response.url) {
                    $('#avatarInput').val(data.response.url);
                    $('#avatarPreview').html('<img src="' + data.response.url + '" alt="头像预览">');
                    $('.default-avatar-item').removeClass('selected').attr('aria-selected', 'false');
                }
            }).on('fileremoved', function (event, id, index) {
                $('#avatarInput').val('');
                $('#avatarPreview').html('<i class="fa fa-user"></i>');
            });
        }

        function togglePassword() {
            var $input = $('#password');
            var $eyeIcon = $('#password-eye');
            var $toggleBtn = $('.toggle-password');

            if ($input.attr('type') == 'password') {
                $input.attr('type', 'text');
                $eyeIcon.removeClass('fa-eye').addClass('fa-eye-slash');
                $toggleBtn.attr('aria-label', '隐藏密码');
            } else {
                $input.attr('type', 'password');
                $eyeIcon.removeClass('fa-eye-slash').addClass('fa-eye');
                $toggleBtn.attr('aria-label', '显示密码');
            }
        }

        function submitHandler() {
            if (!$('#avatarInput').val()) {
                $.modal.msgWarning("请选择用户头像");
                return;
            }
            if ($.validate.form()) {
                $.operate.save(prefix + "/add", $('#form-user-add').serialize());
            }
        }
    </script>
</body>
</html>
