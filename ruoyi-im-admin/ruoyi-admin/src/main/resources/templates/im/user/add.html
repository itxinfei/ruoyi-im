<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: header('新增IM用户')" />
    <th:block th:include="include :: bootstrap-fileinput-css"/>
    <link th:href="@{/css/im-admin.css}" rel="stylesheet" />
    <style>
        .im-form-container {
            display: flex;
            gap: var(--im-spacing-lg);
        }

        .im-form-main {
            flex: 1;
        }

        .im-form-sidebar {
            width: 220px;
            background: var(--im-bg-container);
            border-radius: var(--im-radius-md);
            padding: var(--im-spacing-md);
            border: 1px solid var(--im-border-light);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .im-form-section {
            margin-bottom: var(--im-spacing-lg);
        }

        .im-form-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--im-text-primary);
            margin: 0 0 var(--im-spacing-md) 0;
            padding-bottom: var(--im-spacing-sm);
            border-bottom: 2px solid var(--im-primary-light);
            display: flex;
            align-items: center;
            gap: var(--im-spacing-sm);
        }

        .im-form-section-title i {
            color: var(--im-primary);
        }

        .im-form-group {
            margin-bottom: var(--im-spacing-md);
        }

        .im-form-group label {
            display: block;
            margin-bottom: var(--im-spacing-xs);
            font-size: 13px;
            font-weight: 500;
            color: var(--im-text-secondary);
        }

        .im-form-group label.is-required::before {
            content: '*';
            color: var(--im-danger);
            margin-right: 4px;
        }

        .im-form-input,
        .im-form-select {
            width: 100%;
            height: 36px;
            padding: 6px 12px;
            border: 1px solid var(--im-border);
            border-radius: var(--im-radius-sm);
            font-size: 14px;
            color: var(--im-text-primary);
            transition: var(--im-transition);
        }

        .im-form-input:focus,
        .im-form-select:focus {
            outline: none;
            border-color: var(--im-primary);
            box-shadow: 0 0 0 2px var(--im-primary-light);
        }

        .im-form-input.is-valid {
            border-color: var(--im-success);
        }

        .im-form-input.is-invalid {
            border-color: var(--im-danger);
        }

        .im-form-feedback {
            font-size: 12px;
            margin-top: 4px;
            min-height: 16px;
        }

        .im-form-feedback.success {
            color: var(--im-success);
        }

        .im-form-feedback.error {
            color: var(--im-danger);
        }

        .im-form-feedback.info {
            color: var(--im-text-tertiary);
        }

        .im-input-group {
            display: flex;
            align-items: center;
        }

        .im-input-group .im-form-input {
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }

        .im-input-group-addon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 36px;
            background: var(--im-bg-hover);
            border: 1px solid var(--im-border);
            border-left: none;
            border-radius: 0 var(--im-radius-sm) var(--im-radius-sm) 0;
            cursor: pointer;
            color: var(--im-text-tertiary);
            transition: var(--im-transition);
        }

        .im-input-group-addon:hover {
            background: var(--im-bg-active);
            color: var(--im-primary);
        }

        /* 头像预览 */
        .im-avatar-preview {
            width: 88px;
            height: 88px;
            border-radius: var(--im-radius-full);
            border: 3px solid var(--im-border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--im-bg-hover);
            margin-bottom: var(--im-spacing-sm);
            overflow: hidden;
        }

        .im-avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .im-avatar-preview .fa-user {
            font-size: 36px;
            color: var(--im-text-quaternary);
        }

        /* 默认头像选择 */
        .im-default-avatars {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin-bottom: var(--im-spacing-sm);
            flex-wrap: wrap;
        }

        .im-default-avatar-item {
            width: 36px;
            height: 36px;
            border-radius: var(--im-radius-full);
            cursor: pointer;
            border: 2px solid transparent;
            overflow: hidden;
            transition: var(--im-transition);
        }

        .im-default-avatar-item:hover {
            transform: scale(1.1);
        }

        .im-default-avatar-item.selected {
            border-color: var(--im-primary);
            box-shadow: 0 0 0 2px var(--im-primary-light);
        }

        /* 密码强度 */
        .im-password-strength {
            margin-top: var(--im-spacing-sm);
        }

        .im-strength-bar {
            height: 4px;
            background: var(--im-divider);
            border-radius: 2px;
            overflow: hidden;
        }

        .im-strength-fill {
            height: 100%;
            width: 0;
            transition: width 0.3s ease;
        }

        .im-strength-fill.weak { width: 33%; background: var(--im-danger); }
        .im-strength-fill.medium { width: 66%; background: var(--im-warning); }
        .im-strength-fill.strong { width: 100%; background: var(--im-success); }

        .im-strength-text {
            font-size: 11px;
            margin-top: 4px;
            color: var(--im-text-tertiary);
        }

        /* 状态单选 */
        .im-status-radios {
            display: flex;
            gap: var(--im-spacing-md);
        }

        .im-radio-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--im-text-secondary);
            cursor: pointer;
        }

        .im-radio-label input[type="radio"] {
            margin: 0;
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .im-form-container {
                flex-direction: column-reverse;
            }

            .im-form-sidebar {
                width: 100%;
            }
        }
    </style>
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <form class="form-horizontal m" id="form-user-add">
            <div class="im-form-container">
                <!-- 左侧表单区域 -->
                <div class="im-form-main">
                    <!-- 账号信息 -->
                    <div class="im-form-section">
                        <h4 class="im-form-section-title">
                            <i class="fa fa-user-circle"></i>
                            账号信息
                        </h4>

                        <div class="im-form-group">
                            <label class="is-required" for="username">登录账号</label>
                            <input name="username" class="im-form-input" type="text"
                                   placeholder="请输入2-20个字符" id="username" required>
                            <div class="im-form-feedback info" id="username-feedback">用于登录系统的账号</div>
                        </div>

                        <div class="im-form-group">
                            <label class="is-required" for="nickname">用户昵称</label>
                            <input name="nickname" class="im-form-input" type="text"
                                   placeholder="请输入用户昵称" id="nickname" required>
                            <div class="im-form-feedback info" id="nickname-feedback">用户在系统中显示的名称</div>
                        </div>

                        <div class="im-form-group">
                            <label class="is-required" for="password">登录密码</label>
                            <div class="im-input-group">
                                <input name="password" class="im-form-input" type="password"
                                       placeholder="请输入5-20个字符" id="password" required>
                                <span class="im-input-group-addon" onclick="togglePassword()">
                                    <i class="fa fa-eye" id="password-eye"></i>
                                </span>
                            </div>
                            <div class="im-password-strength">
                                <div class="im-strength-bar">
                                    <div class="im-strength-fill" id="strength-fill"></div>
                                </div>
                                <div class="im-strength-text" id="strength-text">密码强度: 未设置</div>
                            </div>
                        </div>
                    </div>

                    <!-- 联系信息 -->
                    <div class="im-form-section">
                        <h4 class="im-form-section-title">
                            <i class="fa fa-address-book"></i>
                            联系信息
                        </h4>

                        <div class="im-form-group">
                            <label for="mobile">手机号码</label>
                            <input name="mobile" class="im-form-input" type="text"
                                   placeholder="请输入手机号码" id="mobile">
                            <div class="im-form-feedback info" id="mobile-feedback">用于接收系统通知</div>
                        </div>

                        <div class="im-form-group">
                            <label for="email">邮箱</label>
                            <input name="email" class="im-form-input" type="text"
                                   placeholder="请输入邮箱地址" id="email">
                            <div class="im-form-feedback info" id="email-feedback">用于接收邮件通知</div>
                        </div>

                        <div class="im-form-group">
                            <label for="gender">性别</label>
                            <select name="gender" class="im-form-select" id="gender">
                                <option value="">请选择性别</option>
                                <option th:each="dict : ${@dict.getType('sys_user_sex')}"
                                        th:text="${dict.dictLabel}" th:value="${dict.dictValue}"></option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 右侧头像区域 -->
                <div class="im-form-sidebar">
                    <div style="font-size: 14px; font-weight: 600; color: var(--im-text-primary); width: 100%; text-align: center; margin-bottom: var(--im-spacing-sm);">
                        用户头像
                    </div>

                    <div class="im-avatar-preview" id="avatarPreview">
                        <i class="fa fa-user"></i>
                    </div>

                    <!-- 默认头像选择 -->
                    <div class="im-default-avatars" id="defaultAvatars">
                        <button type="button" class="im-default-avatar-item" data-avatar="/profile/avatar/default1.png">
                            <div style="width:100%;height:100%;background:#667eea;display:flex;align-items:center;justify-content:center;">
                                <i class="fa fa-user" style="color:#fff;font-size:14px;"></i>
                            </div>
                        </button>
                        <button type="button" class="im-default-avatar-item" data-avatar="/profile/avatar/default2.png">
                            <div style="width:100%;height:100%;background:#f5576c;display:flex;align-items:center;justify-content:center;">
                                <i class="fa fa-user" style="color:#fff;font-size:14px;"></i>
                            </div>
                        </button>
                        <button type="button" class="im-default-avatar-item" data-avatar="/profile/avatar/default3.png">
                            <div style="width:100%;height:100%;background:#00f2fe;display:flex;align-items:center;justify-content:center;">
                                <i class="fa fa-user" style="color:#fff;font-size:14px;"></i>
                            </div>
                        </button>
                        <button type="button" class="im-default-avatar-item" data-avatar="/profile/avatar/default4.png">
                            <div style="width:100%;height:100%;background:#43e97b;display:flex;align-items:center;justify-content:center;">
                                <i class="fa fa-user" style="color:#fff;font-size:14px;"></i>
                            </div>
                        </button>
                    </div>

                    <div style="text-align: center; margin-bottom: var(--im-spacing-sm); color: var(--im-text-tertiary); font-size: 12px;">
                        或上传自定义头像
                    </div>

                    <input type="hidden" name="avatar" id="avatarInput">
                    <div class="file-loading">
                        <input class="form-control file-upload" id="avatar" name="file" type="file" style="display: none;"
                               accept="image/png,image/jpeg,image/gif">
                    </div>
                    <label for="avatar" class="im-btn im-btn-primary im-btn-sm" style="cursor: pointer;">
                        <i class="fa fa-upload"></i> 上传头像
                    </label>

                    <div style="margin-top: auto; padding-top: var(--im-spacing-md); border-top: 1px solid var(--im-divider); width: 100%;">
                        <div style="font-size: 13px; margin-bottom: var(--im-spacing-sm); font-weight: 500; color: var(--im-text-primary);">账号状态</div>
                        <div class="im-status-radios">
                            <label class="im-radio-label">
                                <input type="radio" name="status" value="1" checked> 正常
                            </label>
                            <label class="im-radio-label">
                                <input type="radio" name="status" value="0"> 停用
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <th:block th:include="include :: footer" />
    <th:block th:include="include :: bootstrap-fileinput-js"/>
    <script type="text/javascript">
        var prefix = ctx + "im/user";
        var usernameUnique = false;

        $(document).ready(function() {
            initDefaultAvatars();
            initAvatarUpload();
            initRealtimeValidation();
            selectDefaultAvatar('/profile/avatar/default1.png');
        });

        $("#form-user-add").validate({
            focusCleanup: true,
            rules: {
                username: {
                    required: true,
                    minlength: 2,
                    maxlength: 20,
                    remote: {
                        url: prefix + "/checkUsernameUnique",
                        type: "post",
                        dataType: "json",
                        data: { "username": function() { return $.common.trim($("#username").val()); } },
                        dataFilter: function(data, type) {
                            usernameUnique = $.validate.unique(data);
                            updateValidationUI('username', usernameUnique, usernameUnique ? "账号可用" : "账号已存在");
                            return usernameUnique;
                        }
                    }
                },
                nickname: { required: true, minlength: 2, maxlength: 30 },
                password: { required: true, minlength: 5, maxlength: 20 },
                email: { email: true },
                mobile: { isPhone: true }
            },
            messages: {
                username: { required: "请输入登录账号", remote: "账号已存在" },
                nickname: { required: "请输入用户昵称" },
                password: { required: "请输入登录密码" }
            }
        });

        function initRealtimeValidation() {
            $("#username").on('input blur', function() {
                var val = $(this).val();
                if (val.length > 0) {
                    if (val.length < 2) updateValidationUI('username', false, "账号长度至少2个字符");
                    else if (val.length > 20) updateValidationUI('username', false, "账号长度不能超过20个字符");
                    else if (!/^[a-zA-Z0-9_]+$/.test(val)) updateValidationUI('username', false, "账号只能包含字母、数字和下划线");
                    else updateValidationUI('username', true, "格式正确");
                } else resetValidationUI('username');
            });

            $("#nickname").on('input blur', function() {
                var val = $(this).val();
                if (val.length > 0) {
                    updateValidationUI('nickname', val.length >= 2, val.length >= 2 ? "格式正确" : "昵称长度至少2个字符");
                } else resetValidationUI('nickname');
            });

            $("#password").on('input', function() {
                var val = $(this).val();
                if (val.length > 0) {
                    if (val.length < 5) {
                        updateValidationUI('password', false, "密码长度至少5个字符");
                        updatePasswordStrength(0);
                    } else {
                        updateValidationUI('password', true, "格式正确");
                        updatePasswordStrength(calculatePasswordStrength(val));
                    }
                } else {
                    resetValidationUI('password');
                    updatePasswordStrength(0);
                }
            });

            $("#email").on('input blur', function() {
                var val = $(this).val();
                if (val.length > 0) {
                    var regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    updateValidationUI('email', regex.test(val), regex.test(val) ? "邮箱格式正确" : "请输入正确的邮箱格式");
                } else resetValidationUI('email');
            });

            $("#mobile").on('input blur', function() {
                var val = $(this).val();
                if (val.length > 0) {
                    var regex = /^1[3-9]\d{9}$/;
                    updateValidationUI('mobile', regex.test(val), regex.test(val) ? "手机号格式正确" : "请输入正确的手机号");
                } else resetValidationUI('mobile');
            });
        }

        function updateValidationUI(fieldId, isValid, message) {
            var $input = $('#' + fieldId);
            var $feedback = $('#' + fieldId + '-feedback');

            $input.removeClass('is-valid is-invalid').addClass(isValid ? 'is-valid' : 'is-invalid');
            $feedback.removeClass('info success error').addClass(isValid ? 'success' : 'error').text(message);
        }

        function resetValidationUI(fieldId) {
            $('#' + fieldId).removeClass('is-valid is-invalid');
            $('#' + fieldId + '-feedback').removeClass('success error').addClass('info');
            var msgs = { 'username': '用于登录系统的账号', 'nickname': '用户在系统中显示的名称', 'mobile': '用于接收系统通知', 'email': '用于接收邮件通知' };
            if (msgs[fieldId]) $('#' + fieldId + '-feedback').text(msgs[fieldId]);
        }

        function calculatePasswordStrength(password) {
            var score = 0;
            if (password.length >= 8) score++;
            if (password.length >= 12) score++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
            if (/\d/.test(password)) score++;
            if (/[^a-zA-Z0-9]/.test(password)) score++;
            return score;
        }

        function updatePasswordStrength(strength) {
            var $fill = $('#strength-fill');
            var $text = $('#strength-text');
            $fill.removeClass('weak medium strong');
            if (strength <= 1) $text.text('密码强度: 弱');
            else if (strength <= 3) { $fill.addClass('medium'); $text.text('密码强度: 中'); }
            else { $fill.addClass('strong'); $text.text('密码强度: 强'); }
        }

        function initDefaultAvatars() {
            $('.im-default-avatar-item').on('click', function() {
                selectDefaultAvatar($(this).data('avatar'));
            });
        }

        function selectDefaultAvatar(avatar) {
            $('#avatarInput').val(avatar);
            $('.im-default-avatar-item').removeClass('selected');
            var $selected = $('.im-default-avatar-item[data-avatar="' + avatar + '"]');
            if ($selected.length > 0) {
                $selected.addClass('selected');
                $('#avatarPreview').html($selected.find(' > div').clone());
            }
        }

        function initAvatarUpload() {
            $(".file-upload").fileinput({
                uploadUrl: ctx + 'common/upload',
                maxFileCount: 1,
                autoReplace: true,
                allowedFileExtensions: ["jpg", "png", "gif", "jpeg"],
                maxFileSize: 2048,
                showUpload: false,
                showCaption: false,
                browseClass: "btn btn-primary btn-sm",
                dropZoneEnabled: false
            }).on('fileuploaded', function (event, data, previewId, index) {
                if (data.response && data.response.url) {
                    $('#avatarInput').val(data.response.url);
                    $('#avatarPreview').html('<img src="' + data.response.url + '" alt="头像预览">');
                    $('.im-default-avatar-item').removeClass('selected');
                }
            }).on('fileremoved', function (event, id, index) {
                $('#avatarInput').val('');
                $('#avatarPreview').html('<i class="fa fa-user"></i>');
            });
        }

        function togglePassword() {
            var $input = $('#password');
            var $eyeIcon = $('#password-eye');
            if ($input.attr('type') == 'password') {
                $input.attr('type', 'text');
                $eyeIcon.removeClass('fa-eye').addClass('fa-eye-slash');
            } else {
                $input.attr('type', 'password');
                $eyeIcon.removeClass('fa-eye-slash').addClass('fa-eye');
            }
        }

        function submitHandler() {
            if (!$('#avatarInput').val()) {
                $.modal.msgWarning("请选择用户头像");
                return;
            }
            if ($.validate.form()) {
                $.operate.save(prefix + "/add", $('#form-user-add').serialize());
            }
        }
    </script>
</body>
</html>
