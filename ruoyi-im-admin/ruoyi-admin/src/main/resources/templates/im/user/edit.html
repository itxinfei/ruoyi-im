<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('修改IM用户')" />
    <th:block th:include="include :: bootstrap-fileinput-css"/>
    <style>
        .user-edit-container {
            display: flex;
            gap: 20px;
        }
        .user-edit-left {
            flex: 1;
        }
        .user-edit-right {
            width: 220px;
            background: #f8f9fa;
            border-radius: 4px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .avatar-section-title {
            font-size: 13px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 12px;
            width: 100%;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
        }
        .avatar-preview-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            overflow: hidden;
            margin-bottom: 12px;
        }
        .avatar-preview-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .avatar-preview-large .fa-user {
            font-size: 42px;
            color: #dee2e6;
        }
        .status-section {
            margin-top: auto;
            padding-top: 12px;
            border-top: 1px solid #dee2e6;
            width: 100%;
        }
    </style>
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <form class="form-horizontal m" id="form-user-edit" th:object="${user}">
            <input name="id" th:field="*{id}" type="hidden">
            <div class="user-edit-container">
                <!-- 左侧表单区域 -->
                <div class="user-edit-left">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">登录账号：</label>
                        <div class="col-sm-8">
                            <input name="username" th:field="*{username}" class="form-control" type="text" readonly style="background: #f5f5f5;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label is-required">用户昵称：</label>
                        <div class="col-sm-8">
                            <input name="nickname" th:field="*{nickname}" class="form-control" type="text" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">手机号码：</label>
                        <div class="col-sm-8">
                            <input name="mobile" th:field="*{mobile}" class="form-control" type="text" placeholder="请输入手机号码">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">邮箱：</label>
                        <div class="col-sm-8">
                            <input name="email" th:field="*{email}" class="form-control" type="text" placeholder="请输入邮箱地址">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">性别：</label>
                        <div class="col-sm-8">
                            <select name="gender" class="form-control" th:with="type=${@dict.getType('sys_user_sex')}">
                                <option value="">请选择性别</option>
                                <option th:each="dict : ${type}" th:text="${dict.dictLabel}" th:value="${dict.dictValue}" th:field="*{gender}"></option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 右侧头像和状态区域 -->
                <div class="user-edit-right">
                    <div class="avatar-section-title">用户头像</div>
                    <div class="avatar-preview-large" id="avatarPreview">
                        <i class="fa fa-user"></i>
                    </div>
                    <input type="hidden" name="avatar" th:field="*{avatar}">
                    <div class="file-loading">
                        <input class="form-control file-upload" id="avatar" name="file" type="file" style="display: none;">
                    </div>
                    <label for="avatar" class="btn btn-primary btn-sm">
                        <i class="fa fa-upload"></i> 更换头像
                    </label>

                    <div class="status-section">
                        <div style="font-size: 13px; margin-bottom: 8px; font-weight: 500;">账号状态</div>
                        <label class="radio-inline" style="margin-right: 12px;">
                            <input type="radio" th:id="${'status_1'}" name="status" value="1" th:field="*{status}"> 正常
                        </label>
                        <label class="radio-inline">
                            <input type="radio" th:id="${'status_0'}" name="status" value="0" th:field="*{status}"> 停用
                        </label>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <th:block th:include="include :: footer" />
    <th:block th:include="include :: bootstrap-fileinput-js"/>
    <script th:inline="javascript">
        var prefix = ctx + "im/user";
        var avatarUrl = [[${user.avatar}]];

        $("#form-user-edit").validate({
            focusCleanup: true,
            rules: {
                nickname: { required: true, minlength: 2, maxlength: 30 },
                email: { email: true },
                mobile: { isPhone: true }
            },
            messages: {
                nickname: { required: "请输入用户昵称" }
            }
        });

        function submitHandler() {
            if ($.validate.form()) {
                $.operate.save(prefix + "/edit", $('#form-user-edit').serialize());
            }
        }

        // 初始化头像显示
        function initAvatarDisplay() {
            if (avatarUrl && avatarUrl.length > 0) {
                var displayUrl = avatarUrl;
                if (avatarUrl.startsWith('/') && !avatarUrl.startsWith('//') && !avatarUrl.startsWith(ctx)) {
                    displayUrl = ctx + avatarUrl.substring(1);
                } else if (!avatarUrl.startsWith('http://') && !avatarUrl.startsWith('https://') && !avatarUrl.startsWith('/')) {
                    displayUrl = ctx + avatarUrl;
                }
                $('#avatarPreview').html('<img src="' + displayUrl + '" alt="头像">');
            }
        }
        initAvatarDisplay();

        // 头像上传组件初始化
        $(".file-upload").fileinput({
            uploadUrl: ctx + 'common/upload',
            maxFileCount: 1,
            autoReplace: true,
            showUpload: false,
            showCaption: false,
            browseClass: "btn btn-primary btn-sm",
            dropZoneEnabled: false,
            allowedFileExtensions: ["jpg", "png", "gif", "jpeg"],
            maxFileSize: 2048
        }).on('fileuploaded', function (event, data, previewId, index) {
            if (data.response && data.response.url) {
                $("input[name='avatar']").val(data.response.url);
                $('#avatarPreview').html('<img src="' + ctx + data.response.url + '" alt="头像">');
            }
        }).on('fileremoved', function (event, id, index) {
            $("input[name='avatar']").val('');
            $('#avatarPreview').html('<i class="fa fa-user"></i>');
        });
    </script>
</body>
</html>
