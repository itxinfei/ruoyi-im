<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: header('修改IM用户')" />
    <th:block th:include="include :: bootstrap-fileinput-css"/>
    <link th:href="@{/css/im-admin.css}" rel="stylesheet" />
    <style>
        .im-form-container {
            display: flex;
            gap: var(--im-spacing-lg);
        }

        .im-form-main {
            flex: 1;
        }

        .im-form-sidebar {
            width: 220px;
            background: var(--im-bg-container);
            border-radius: var(--im-radius-md);
            padding: var(--im-spacing-md);
            border: 1px solid var(--im-border-light);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .im-form-section {
            margin-bottom: var(--im-spacing-lg);
        }

        .im-form-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--im-text-primary);
            margin: 0 0 var(--im-spacing-md) 0;
            padding-bottom: var(--im-spacing-sm);
            border-bottom: 2px solid var(--im-primary-light);
            display: flex;
            align-items: center;
            gap: var(--im-spacing-sm);
        }

        .im-form-section-title i {
            color: var(--im-primary);
        }

        .im-form-group {
            margin-bottom: var(--im-spacing-md);
        }

        .im-form-group label {
            display: block;
            margin-bottom: var(--im-spacing-xs);
            font-size: 13px;
            font-weight: 500;
            color: var(--im-text-secondary);
        }

        .im-form-group label.is-required::before {
            content: '*';
            color: var(--im-danger);
            margin-right: 4px;
        }

        .im-form-input,
        .im-form-select {
            width: 100%;
            height: 36px;
            padding: 6px 12px;
            border: 1px solid var(--im-border);
            border-radius: var(--im-radius-sm);
            font-size: 14px;
            color: var(--im-text-primary);
            transition: var(--im-transition);
        }

        .im-form-input:focus,
        .im-form-select:focus {
            outline: none;
            border-color: var(--im-primary);
            box-shadow: 0 0 0 2px var(--im-primary-light);
        }

        .im-form-input[readonly] {
            background: var(--im-bg-hover);
            cursor: not-allowed;
            color: var(--im-text-tertiary);
        }

        /* 头像预览 */
        .im-avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: var(--im-radius-full);
            border: 3px solid var(--im-border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--im-bg-hover);
            margin-bottom: var(--im-spacing-sm);
            overflow: hidden;
        }

        .im-avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .im-avatar-preview .fa-user {
            font-size: 42px;
            color: var(--im-text-quaternary);
        }

        /* 状态单选 */
        .im-status-radios {
            display: flex;
            gap: var(--im-spacing-md);
        }

        .im-radio-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--im-text-secondary);
            cursor: pointer;
        }

        .im-radio-label input[type="radio"] {
            margin: 0;
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .im-form-container {
                flex-direction: column-reverse;
            }

            .im-form-sidebar {
                width: 100%;
            }
        }
    </style>
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <form class="form-horizontal m" id="form-user-edit" th:object="${user}">
            <input name="id" th:field="*{id}" type="hidden">
            <div class="im-form-container">
                <!-- 左侧表单区域 -->
                <div class="im-form-main">
                    <!-- 基本信息 -->
                    <div class="im-form-section">
                        <h4 class="im-form-section-title">
                            <i class="fa fa-user-circle"></i>
                            基本信息
                        </h4>

                        <div class="im-form-group">
                            <label for="username">登录账号</label>
                            <input name="username" th:field="*{username}" class="im-form-input" type="text" readonly>
                        </div>

                        <div class="im-form-group">
                            <label class="is-required" for="nickname">用户昵称</label>
                            <input name="nickname" th:field="*{nickname}" class="im-form-input" type="text" required>
                        </div>

                        <div class="im-form-group">
                            <label for="mobile">手机号码</label>
                            <input name="mobile" th:field="*{mobile}" class="im-form-input" type="text" placeholder="请输入手机号码">
                        </div>

                        <div class="im-form-group">
                            <label for="email">邮箱</label>
                            <input name="email" th:field="*{email}" class="im-form-input" type="text" placeholder="请输入邮箱地址">
                        </div>

                        <div class="im-form-group">
                            <label for="gender">性别</label>
                            <select name="gender" class="im-form-select" th:with="type=${@dict.getType('sys_user_sex')}">
                                <option value="">请选择性别</option>
                                <option th:each="dict : ${type}" th:text="${dict.dictLabel}" th:value="${dict.dictValue}" th:field="*{gender}"></option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 右侧头像和状态区域 -->
                <div class="im-form-sidebar">
                    <div style="font-size: 14px; font-weight: 600; color: var(--im-text-primary); width: 100%; text-align: center; margin-bottom: var(--im-spacing-sm);">
                        用户头像
                    </div>

                    <div class="im-avatar-preview" id="avatarPreview">
                        <i class="fa fa-user"></i>
                    </div>

                    <input type="hidden" name="avatar" th:field="*{avatar}">
                    <div class="file-loading">
                        <input class="form-control file-upload" id="avatar" name="file" type="file" style="display: none;">
                    </div>
                    <label for="avatar" class="im-btn im-btn-primary im-btn-sm" style="cursor: pointer; margin-bottom: auto;">
                        <i class="fa fa-upload"></i> 更换头像
                    </label>

                    <div style="margin-top: auto; padding-top: var(--im-spacing-md); border-top: 1px solid var(--im-divider); width: 100%;">
                        <div style="font-size: 13px; margin-bottom: var(--im-spacing-sm); font-weight: 500; color: var(--im-text-primary);">账号状态</div>
                        <div class="im-status-radios">
                            <label class="im-radio-label">
                                <input type="radio" name="status" value="1" th:field="*{status}"> 正常
                            </label>
                            <label class="im-radio-label">
                                <input type="radio" name="status" value="0" th:field="*{status}"> 停用
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <th:block th:include="include :: footer" />
    <th:block th:include="include :: bootstrap-fileinput-js"/>
    <script th:inline="javascript">
        var prefix = ctx + "im/user";
        var avatarUrl = [[${user.avatar}]];

        $("#form-user-edit").validate({
            focusCleanup: true,
            rules: {
                nickname: { required: true, minlength: 2, maxlength: 30 },
                email: { email: true },
                mobile: { isPhone: true }
            },
            messages: {
                nickname: { required: "请输入用户昵称" }
            }
        });

        function submitHandler() {
            if ($.validate.form()) {
                $.operate.save(prefix + "/edit", $('#form-user-edit').serialize());
            }
        }

        // 初始化头像显示
        function initAvatarDisplay() {
            if (avatarUrl && avatarUrl.length > 0) {
                var displayUrl = avatarUrl;
                if (avatarUrl.startsWith('/') && !avatarUrl.startsWith('//') && !avatarUrl.startsWith(ctx)) {
                    displayUrl = ctx + avatarUrl.substring(1);
                } else if (!avatarUrl.startsWith('http://') && !avatarUrl.startsWith('https://') && !avatarUrl.startsWith('/')) {
                    displayUrl = ctx + avatarUrl;
                }
                $('#avatarPreview').html('<img src="' + displayUrl + '" alt="头像">');
            }
        }
        initAvatarDisplay();

        // 头像上传组件初始化
        $(".file-upload").fileinput({
            uploadUrl: ctx + 'common/upload',
            maxFileCount: 1,
            autoReplace: true,
            showUpload: false,
            showCaption: false,
            browseClass: "btn btn-primary btn-sm",
            dropZoneEnabled: false,
            allowedFileExtensions: ["jpg", "png", "gif", "jpeg"],
            maxFileSize: 2048
        }).on('fileuploaded', function (event, data, previewId, index) {
            if (data.response && data.response.url) {
                $("input[name='avatar']").val(data.response.url);
                $('#avatarPreview').html('<img src="' + ctx + data.response.url + '" alt="头像">');
            }
        }).on('fileremoved', function (event, id, index) {
            $("input[name='avatar']").val('');
            $('#avatarPreview').html('<i class="fa fa-user"></i>');
        });
    </script>
</body>
</html>
