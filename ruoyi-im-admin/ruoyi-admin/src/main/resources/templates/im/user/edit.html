<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: header('修改IM用户')" />
    <th:block th:include="include :: bootstrap-fileinput-css"/>
    <style>
        :root {
            --primary-color: #1890ff;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --danger-color: #ff4d4f;
            --text-primary: #262626;
            --text-secondary: #595959;
            --text-tertiary: #8c8c8c;
            --border-color: #d9d9d9;
            --border-light: #e8e8e8;
            --bg-light: #fafafa;
            --bg-card: #ffffff;
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
        }

        body { background: #f5f7fa !important; }
        .ibox-content {
            background: #fff;
            border-radius: var(--radius-lg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            padding: 28px !important;
            max-width: 100%;
            margin: 0;
        }

        .form-header { margin-bottom: 24px; }
        .form-title { font-size: 18px; font-weight: 500; color: var(--text-primary); }
        .form-desc { font-size: 13px; color: var(--text-tertiary); margin-top: 4px; }

        .form-section { margin-bottom: 24px; }
        .form-section-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            padding-bottom: 8px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .form-section-title i { color: var(--primary-color); }

        .form-group { margin-bottom: 16px; }
        .form-group:last-child { margin-bottom: 0; }

        .control-label {
            font-size: 13px;
            font-weight: 400;
            color: var(--text-secondary);
            padding-top: 6px;
            margin-bottom: 4px;
        }
        .control-label.required::before { content: '*'; color: var(--danger-color); margin-right: 4px; }

        .form-control {
            height: 36px;
            padding: 0 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 13px;
            transition: all 0.2s;
        }
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(24,144,255,0.1);
            outline: none;
        }
        .form-control[readonly] {
            background: var(--bg-light);
            cursor: not-allowed;
            color: var(--text-tertiary);
        }

        .help-text { font-size: 12px; color: var(--text-tertiary); margin-top: 4px; }

        .radio-group { display: flex; gap: 20px; }
        .radio-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
        }
        .radio-label input { margin: 0; }

        .avatar-section {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            align-items: flex-start;
        }
        .avatar-form { flex: 1; }

        .avatar-preview-box {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            border: 2px dashed var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-light);
            overflow: hidden;
            flex-shrink: 0;
        }
        .avatar-preview-box img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-preview-box i { font-size: 28px; color: var(--text-tertiary); }

        .avatar-label { font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; }
        .avatar-upload { font-size: 13px; color: var(--primary-color); cursor: pointer; }

        .form-actions {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border-light);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        .btn {
            height: 36px;
            padding: 0 20px;
            border-radius: var(--radius-sm);
            font-size: 14px;
            font-weight: 400;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--primary-color); border-color: var(--primary-color); color: #fff; }
        .btn-primary:hover { background: #40a9ff; border-color: #40a9ff; }
        .btn-default { background: #fff; border-color: var(--border-color); color: var(--text-primary); }
        .btn-default:hover { border-color: var(--primary-color); color: var(--primary-color); }

        @media (max-width: 600px) {
            .avatar-section { flex-direction: column; }
            .avatar-preview-box { margin: 0 auto; }
        }
    </style>
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight">
        <div class="ibox-content">
            <div class="form-header">
                <div class="form-title">编辑用户</div>
                <div class="form-desc">修改用户基本信息</div>
            </div>

            <form class="form-horizontal m" id="form-user-edit" th:object="${user}">
                <input name="id" th:field="*{id}" type="hidden">
                <input type="hidden" name="avatar" th:field="*{avatar}" id="avatarInput">

                <!-- 头像 -->
                <div class="form-section">
                    <div class="avatar-section">
                        <div class="avatar-preview-box" id="avatarPreview">
                            <i class="fa fa-user"></i>
                        </div>
                        <div class="avatar-form">
                            <div class="avatar-label">用户头像</div>
                            <label class="avatar-upload" onclick="$('#avatarFile').click()">
                                <i class="fa fa-upload"></i> 更换头像
                            </label>
                            <input type="file" id="avatarFile" class="file" style="display: none;" accept="image/png,image/jpeg,image/gif">
                        </div>
                    </div>
                </div>

                <!-- 基本信息 -->
                <div class="form-section">
                    <div class="form-section-title">
                        <i class="fa fa-user-circle"></i>基本信息
                    </div>

                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label class="control-label">用户名</label>
                                <input name="username" th:field="*{username}" class="form-control" readonly>
                                <div class="help-text">用户名不可修改</div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label class="control-label required">昵称</label>
                                <input name="nickname" th:field="*{nickname}" class="form-control" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label class="control-label">手机号</label>
                                <input name="mobile" th:field="*{mobile}" class="form-control">
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label class="control-label">邮箱</label>
                                <input name="email" th:field="*{email}" class="form-control" type="email">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label class="control-label">性别</label>
                                <select name="gender" class="form-control" th:with="type=${@dict.getType('sys_user_sex')}">
                                    <option value="">请选择性别</option>
                                    <option th:each="dict : ${type}" th:text="${dict.dictLabel}" th:value="${dict.dictValue}" th:field="*{gender}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label class="control-label">账号状态</label>
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="status" value="1" th:field="*{status}"> 正常
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="status" value="0" th:field="*{status}"> 停用
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 按钮区 -->
                <div class="form-actions">
                    <button type="button" class="btn btn-default" onclick="$.modal.close()">取消</button>
                    <button type="submit" class="btn btn-primary">确定保存</button>
                </div>
            </form>
        </div>
    </div>

    <th:block th:include="include :: footer" />
    <th:block th:include="include :: bootstrap-fileinput-js"/>
    <script th:inline="javascript">
        var prefix = ctx + "im/user";
        var avatarUrl = [[${user.avatar}]];

        $("#form-user-edit").validate({
            focusCleanup: true,
            rules: { nickname: { required: true, minlength: 2, maxlength: 30 }, email: { email: true }, mobile: { isPhone: true } }
        });

        if (avatarUrl) {
            var displayUrl = avatarUrl.startsWith('/') ? avatarUrl : '/' + avatarUrl;
            $('#avatarPreview').html('<img src="' + displayUrl + '">');
        }

        $("#avatarFile").fileinput({
            uploadUrl: ctx + 'common/upload', maxFileCount: 1, autoReplace: true,
            showUpload: false, showCaption: false, dropZoneEnabled: false,
            allowedFileExtensions: ["jpg", "png", "gif", "jpeg"], maxFileSize: 2048,
            showRemove: true
        }).on('fileuploaded', function(e, data) {
            if (data.response && data.response.url) {
                $("input[name='avatar']").val(data.response.url);
                $('#avatarPreview').html('<img src="' + data.response.url + '">');
            }
        });

        function submitHandler() {
            if ($.validate.form()) { $.operate.save(prefix + "/edit", $('#form-user-edit').serialize()); }
        }
    </script>
</body>
</html>
