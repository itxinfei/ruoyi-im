<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">

<head>
    <th:block th:include="include :: header('消息管理')" />
    <link th:href="@{/css/im-admin.css}" rel="stylesheet" />
</head>

<body class="gray-bg">
    <div class="container-div">
        <div class="row pt-5">
            <!-- 1. 统计概览 -->
            <div class="col-sm-12">
                <div class="im-stat-group">
                    <div class="im-stat-item">
                        <div class="stat-header">
                            <span class="stat-label">今日通行消息</span>
                            <div class="stat-icon-box"><i class="fa fa-envelope-o"></i></div>
                        </div>
                        <div class="stat-number" id="todayInflow">-</div>
                        <div class="stat-footer text-muted">24小时内系统通行量</div>
                    </div>
                    <div class="im-stat-item">
                        <div class="stat-header">
                            <span class="stat-label">敏感词命中</span>
                            <div class="stat-icon-box" style="background: #fef2f2; color: #ef4444;"><i
                                    class="fa fa-shield"></i></div>
                        </div>
                        <div class="stat-number" id="sensitiveHits">-</div>
                        <div class="stat-footer text-muted">触发拦截的风控消息</div>
                    </div>
                    <div class="im-stat-item">
                        <div class="stat-header">
                            <span class="stat-label">投递失败率</span>
                            <div class="stat-icon-box" style="background: #fff7ed; color: #f59e0b;"><i
                                    class="fa fa-warning"></i></div>
                        </div>
                        <div class="stat-number" id="failRate">-</div>
                        <div class="stat-footer text-muted">网络或逻辑导致的异常</div>
                    </div>
                </div>
            </div>

            <!-- 2. 搜索过滤 (简约) -->
            <div class="col-sm-12 search-collapse">
                <form id="message-form">
                    <div class="select-list">
                        <ul>
                            <li>
                                <label>发送人：</label><input type="text" name="senderId" placeholder="用户ID/账号" />
                            </li>
                            <li>
                                <label>会话：</label><input type="text" name="conversationId" placeholder="会话ID" />
                            </li>
                            <li>
                                <label>类型：</label>
                                <select name="messageType">
                                    <option value="">所有</option>
                                    <option value="TEXT">文本</option>
                                    <option value="IMAGE">图片</option>
                                    <option value="FILE">文件</option>
                                </select>
                            </li>
                            <li>
                                <label>时间段：</label>
                                <input type="text" class="time-input" id="startTime" placeholder="开始"
                                    name="params[beginTime]" />
                                <span>-</span>
                                <input type="text" class="time-input" id="endTime" placeholder="结束"
                                    name="params[endTime]" />
                            </li>
                            <li>
                                <a class="btn btn-primary btn-rounded btn-sm" onclick="$.table.search()"><i
                                        class="fa fa-search"></i> 搜索</a>
                                <a class="btn btn-warning btn-rounded btn-sm" onclick="$.form.reset()"><i
                                        class="fa fa-refresh"></i> 重置</a>
                            </li>
                        </ul>
                    </div>
                </form>
            </div>

            <!-- 3. 数据板块 -->
            <div class="col-sm-12 select-table table-striped">
                <div class="btn-group-sm" id="toolbar" role="group">
                    <a class="btn btn-info multiple disabled" onclick="batchRevoke()"
                        shiro:hasPermission="im:message:revoke">
                        <i class="fa fa-undo"></i> 批量撤回
                    </a>
                    <a class="btn btn-danger multiple disabled" onclick="$.operate.removeAll()"
                        shiro:hasPermission="im:message:remove">
                        <i class="fa fa-trash"></i> 彻底删除
                    </a>
                    <a class="btn btn-warning" onclick="$.table.exportExcel()" shiro:hasPermission="im:message:export">
                        <i class="fa fa-download"></i> 导出记录
                    </a>
                </div>
                <table id="bootstrap-table" data-mobile-responsive="true"></table>
            </div>
        </div>
    </div>

    <th:block th:include="include :: footer" />
    <script th:src="@{/js/im-common.js}"></script>
    <script th:inline="javascript">
        var editFlag = [[${@permission.hasPermi('im:message:edit') }]];
        var removeFlag = [[${@permission.hasPermi('im:message:remove') }]];
        var prefix = ctx + "im/message";

        $(function () {
            loadStatistics();
            var options = {
                url: prefix + "/list",
                removeUrl: prefix + "/remove/{id}",
                exportUrl: prefix + "/export",
                sortName: "createTime",
                sortOrder: "desc",
                modalName: "消息记录",
                columns: [{
                    checkbox: true
                }, {
                    field: 'senderId',
                    title: '发送人',
                    width: '120',
                    formatter: function (value, row, index) {
                        return '<span class="text-primary">#' + value + '</span>';
                    }
                }, {
                    field: 'messageType',
                    title: '类型',
                    align: 'center',
                    width: '80',
                    formatter: function (value) {
                        var map = { 'TEXT': 'text-primary', 'IMAGE': 'text-success', 'FILE': 'text-warning' };
                        return '<span class="' + (map[value] || 'text-muted') + '">' + ImCommon.formatMessageType(value) + '</span>';
                    }
                }, {
                    field: 'content',
                    title: '消息快照',
                    formatter: function (v) { return ImCommon.formatTextWithTooltip(v, 60); }
                }, {
                    field: 'sendStatus',
                    title: '通道状态',
                    align: 'center',
                    width: '100',
                    formatter: function (v) {
                        if (v === 'SENT') return '<span class="im-badge badge-blue">已送出</span>';
                        if (v === 'FAILED') return '<span class="im-badge badge-red">失败</span>';
                        return '<span class="im-badge badge-green">已送达</span>';
                    }
                }, {
                    field: 'isRevoked',
                    title: '消息状态',
                    align: 'center',
                    width: '90',
                    formatter: function (v, row) {
                        if (v == 1) return '<span class="text-muted"><i class="fa fa-undo"></i> 已撤回</span>';
                        if (row.isDeleted == 1) return '<span class="text-danger">已删除</span>';
                        return '<span class="dot dot-online"></span>活跃';
                    }
                }, {
                    field: 'createTime',
                    title: '发送时间',
                    width: '160',
                    sortable: true
                }, {
                    title: '管理',
                    align: 'center',
                    width: '140',
                    formatter: function (v, row) {
                        var actions = [];
                        if (row.isRevoked != 1) {
                            actions.push('<a class="btn btn-warning btn-xs" href="javascript:void(0)" onclick="revokeMsg(\'' + row.id + '\')"><i class="fa fa-undo"></i> 撤回</a>');
                        }
                        actions.push('<a class="btn btn-danger btn-xs ' + removeFlag + '" href="javascript:void(0)" onclick="$.operate.remove(\'' + row.id + '\')"><i class="fa fa-trash"></i> 删</a>');
                        return actions.join(' ');
                    }
                }],
                onLoadSuccess: function () {
                    // 默认调大添加/编辑弹窗
                    $.operate.add = function (id) {
                        $.modal.open("添加" + $.table._option.modalName, $.operate.addUrl(id), 800, 600);
                    };
                    $.operate.edit = function (id) {
                        $.modal.open("修改" + $.table._option.modalName, $.operate.editUrl(id), 800, 600);
                    };
                }
            };
            $.table.init(options);
        });

        function loadStatistics() {
            ImCommon.get(ctx + 'im/dashboard/statistics', function (res) {
                if (res.code === 0) {
                    $('#todayInflow').text(res.data.todayMessages || 0);
                    $('#sensitiveHits').text(res.data.sensitiveMessages || 0);
                    $('#failRate').text('0.2%'); // 模拟数据
                }
            });
        }

        function revokeMsg(id) {
            $.modal.confirm("管理操作：确定要撤回此消息吗？用户侧将同步消失。", function () {
                $.operate.post(prefix + "/revoke/" + id, {}, function (res) {
                    if (res.code == 0) $.table.refresh();
                });
            });
        }

        function batchRevoke() {
            var ids = $.table.selectColumns("id");
            if (!ImCommon.validateBatchOperation(ids, 1)) return;
            $.modal.confirm("确认要批量撤回选中的 " + ids.length + " 条消息吗？", function () {
                $.operate.post(prefix + "/batchRevoke", { "messageIds": ids.join(",") }, function (res) {
                    if (res.code == 0) $.table.refresh();
                });
            });
        }

        // 默认调大添加/编辑弹窗
        $.operate.add = function (id) {
            $.modal.open("添加" + $.table._option.modalName, $.operate.addUrl(id), 800, 600);
        };
        $.operate.edit = function (id) {
            $.modal.open("修改" + $.table._option.modalName, $.operate.editUrl(id), 800, 600);
        };
    </script>
</body>

</html>