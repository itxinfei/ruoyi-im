<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>群组成员管理</title>
    <link href="/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}" rel="stylesheet"/>
    <link href="/css/font-awesome.min.css" th:href="@{/css/font-awesome.min.css}" rel="stylesheet"/>
    <link href="/ajax/libs/bootstrap-table/bootstrap-table.min.css" th:href="@{/ajax/libs/bootstrap-table/bootstrap-table.min.css}" rel="stylesheet"/>
    <link href="/css/style.css" th:href="@{/css/style.css}" rel="stylesheet"/>
    <link href="/ruoyi/css/ry-ui.css" th:href="@{/ruoyi/css/ry-ui.css}" rel="stylesheet"/>
    <link href="/css/im-modal.css" th:href="@{/css/im-modal.css}" rel="stylesheet"/>
</head>
<body class="white-bg">
    <div class="modal-page-container">
        <!-- 头部区 -->
        <div class="modal-page-header">
            <div class="header-title">
                <i class="fa fa-users"></i>
                <span>群组成员管理</span>
            </div>
            <div class="header-actions">
                <button class="btn-im-outline" onclick="ImModal.goBack()">
                    <i class="fa fa-arrow-left"></i> 返回
                </button>
                <button class="btn-im-outline" onclick="refreshData()">
                    <i class="fa fa-refresh"></i> 刷新
                </button>
            </div>
        </div>

        <!-- 信息栏 -->
        <div class="modal-page-info">
            <span class="info-item">群组ID: <strong id="groupId">-</strong></span>
            <span class="info-divider">|</span>
            <span class="info-item">群组名称: <strong id="groupName">-</strong></span>
            <span class="info-divider">|</span>
            <span class="info-item">群主: <strong id="ownerName">-</strong></span>
            <span class="info-divider">|</span>
            <span class="info-item">创建时间: <strong id="createTime">-</strong></span>
        </div>

        <!-- 工具栏 -->
        <div class="modal-page-toolbar">
            <input type="text" class="form-im-control toolbar-input" id="searchInput" placeholder="搜索昵称或用户名"/>
            <select class="form-im-control toolbar-select" id="roleFilter">
                <option value="">全部角色</option>
                <option value="OWNER">群主</option>
                <option value="ADMIN">管理员</option>
                <option value="MEMBER">普通成员</option>
            </select>
            <select class="form-im-control toolbar-select" id="statusFilter">
                <option value="">全部状态</option>
                <option value="muted">已禁言</option>
                <option value="unread">有未读</option>
            </select>
            <button class="btn-im-default" onclick="resetData()">
                <i class="fa fa-refresh"></i> 重置
            </button>
            <div class="toolbar-stats">
                总数: <strong id="totalCount">0</strong> |
                群主: <strong id="ownerCount">0</strong> |
                管理: <strong id="adminCount">0</strong> |
                成员: <strong id="memberCount">0</strong> |
                已禁言: <strong id="mutedCount">0</strong>
            </div>
        </div>

        <!-- 表格区 -->
        <div class="modal-page-table">
            <div class="table-loading">
                <div class="table-loading-spinner"></div>
            </div>
            <table id="bootstrap-table" data-mobile-responsive="true"></table>
        </div>
    </div>

    <!-- 通用JS -->
    <script th:inline="javascript"> var ctx = [[@{/}]]; </script>
    <script th:src="@{/js/jquery.min.js}"></script>
    <script th:src="@{/js/bootstrap.min.js}"></script>
    <script th:src="@{/ajax/libs/bootstrap-table/bootstrap-table.min.js}"></script>
    <script th:src="@{/ajax/libs/bootstrap-table/locale/bootstrap-table-zh-CN.min.js}"></script>
    <script th:src="@{/ajax/libs/layer/layer.min.js}"></script>
    <script th:src="@{/ruoyi/js/common.js}"></script>
    <script th:src="@{/ruoyi/js/ry-ui.js}"></script>
    <script th:src="@{/js/im-modal.js}"></script>
    <script th:inline="javascript">
        var groupId = [[${groupId}]];
        var prefix = ctx + "im/member";
        var allMembers = [];

        $(function() {
            loadGroupInfo();
            initTable();
            initSearch();
        });

        // 加载群组基本信息
        function loadGroupInfo() {
            if (!groupId) {
                layer.msg("群组ID不能为空", {icon: 2});
                return;
            }

            ImModal.requestData({
                url: prefix + "/group/info/" + groupId,
                success: function(result) {
                    if (result.code == 0 && result.data) {
                        var data = result.data;
                        $("#groupId").text(data.id || '-');
                        $("#groupName").text(data.name || '-');
                        $("#ownerName").text(data.ownerName || '-');
                        $("#createTime").text(ImModal.formatDateTime(data.createTime, true));
                    } else {
                        layer.msg("加载群组信息失败：" + (result.msg || "未知错误"), {icon: 2});
                    }
                }
            });
        }

        // 初始化表格
        function initTable() {
            ImModal.initTable({
                columns: [{
                    field: 'userId',
                    title: '用户ID',
                    width: '80',
                    visible: false
                }, {
                    field: 'avatar',
                    title: '头像',
                    width: '60',
                    align: 'center',
                    formatter: function(value, row, index) {
                        return ImModal.formatAvatar(value);
                    }
                }, {
                    field: 'userNickname',
                    title: '昵称',
                    width: '150',
                    formatter: function(value, row, index) {
                        var nickname = value || row.userName || '-';
                        var html = '<span style="font-weight:500;">' + nickname + '</span>';
                        if (row.userName && row.userName !== value) {
                            html += '<br><span class="text-muted" style="font-size:11px">@' + row.userName + '</span>';
                        }
                        return html;
                    }
                }, {
                    field: 'nickname',
                    title: '群昵称',
                    width: '120',
                    formatter: function(value, row, index) {
                        return value || row.userNickname || row.userName || '-';
                    }
                }, {
                    field: 'role',
                    title: '角色',
                    align: 'center',
                    width: '100',
                    formatter: function(value, row, index) {
                        return ImModal.formatRole(value);
                    }
                }, {
                    field: 'isMuted',
                    title: '禁言状态',
                    align: 'center',
                    width: '100',
                    formatter: function(value, row, index) {
                        return ImModal.formatStatus(value, 'yesno')
                            .replace('是', '<span class="badge-im badge-im-warning">已禁言</span>')
                            .replace('否', '<span class="badge-im badge-im-success">正常</span>');
                    }
                }, {
                    field: 'unreadCount',
                    title: '未读数',
                    align: 'center',
                    width: '80',
                    formatter: function(value, row, index) {
                        var count = value || 0;
                        if (count > 0) {
                            return '<span class="badge-im badge-im-danger">' + count + '</span>';
                        }
                        return '<span class="text-muted">0</span>';
                    }
                }, {
                    field: 'joinTime',
                    title: '加入时间',
                    width: '160',
                    sortable: true,
                    formatter: function(value, row, index) {
                        return ImModal.formatDateTime(value, true);
                    }
                }, {
                    field: 'operate',
                    title: '操作',
                    align: 'center',
                    width: '180',
                    formatter: function(value, row, index) {
                        var actions = [];
                        actions.push('<a class="btn-im-info btn-im-xs" href="javascript:void(0)" onclick="viewDetail(' + row.userId + ', \'' + (row.userNickname || row.userName || '') + '\')" title="查看详情"><i class="fa fa-info-circle"></i></a> ');
                        actions.push('<a class="btn-im-warning btn-im-xs" href="javascript:void(0)" onclick="changeRole(' + row.id + ', \'' + row.role + '\', ' + row.userId + ')" title="修改角色"><i class="fa fa-edit"></i></a> ');
                        actions.push('<a class="btn-im-default btn-im-xs" href="javascript:void(0)" onclick="toggleMute(' + row.id + ', ' + row.isMuted + ', ' + row.userId + ')" title="' + (row.isMuted == 1 ? '解除禁言' : '禁言') + '"><i class="fa fa-ban"></i></a> ');
                        if (row.role !== 'OWNER') {
                            actions.push('<a class="btn-im-danger btn-im-xs" href="javascript:void(0)" onclick="removeMember(' + row.userId + ', \'' + (row.userNickname || row.userName || '') + '\')" title="移除成员"><i class="fa fa-remove"></i></a>');
                        }
                        return actions.join('');
                    }
                }],
                responseHandler: function(res) {
                    if (res.code === 0 || res.rows) {
                        allMembers = res.rows || res.data || [];
                        updateStats(allMembers);
                        return allMembers;
                    }
                    return [];
                }
            });

            loadMembers();
        }

        // 加载成员数据
        function loadMembers() {
            ImModal.requestData({
                url: prefix + "/group/" + groupId,
                success: function(result) {
                    if (result.code === 0 || result.rows) {
                        allMembers = result.rows || result.data || [];
                        ImModal.loadTableData(allMembers);
                        updateStats(allMembers);
                    } else {
                        layer.msg("加载成员数据失败：" + (result.msg || "未知错误"), {icon: 2});
                    }
                }
            });
        }

        // 初始化搜索
        function initSearch() {
            ImModal.initSearch(searchMembers);
            ImModal.initFilters(searchMembers);
        }

        // 搜索成员
        function searchMembers() {
            var keyword = $('#searchInput').val();
            var role = $('#roleFilter').val();
            var status = $('#statusFilter').val();

            var filtered = ImModal.filterData(allMembers, {
                keyword: keyword,
                role: role,
                status: status
            });

            ImModal.loadTableData(filtered);
        }

        // 重置数据
        function resetData() {
            ImModal.resetFilters(function() {
                searchMembers();
            });
        }

        // 刷新数据
        function refreshData() {
            ImModal.refresh(function() {
                return ImModal.requestData({
                    url: prefix + "/group/" + groupId,
                    success: function(result) {
                        if (result.code === 0) {
                            allMembers = result.rows || result.data || [];
                            ImModal.loadTableData(allMembers);
                            updateStats(allMembers);
                        }
                    }
                });
            });
        }

        // 更新统计
        function updateStats(members) {
            ImModal.updateStatistics(members, {
                groups: {
                    ownerCount: 'OWNER',
                    adminCount: 'ADMIN',
                    memberCount: 'MEMBER'
                },
                conditions: {
                    mutedCount: {isMuted: 1}
                }
            });
        }

        // 修改角色
        function changeRole(id, currentRole, userId) {
            var roles = ['OWNER', 'ADMIN', 'MEMBER'];
            var roleNames = {'OWNER': '群主', 'ADMIN': '管理员', 'MEMBER': '普通成员'};
            var html = '<select class="form-im-control" id="newRole" style="width:200px;">';
            for (var i = 0; i < roles.length; i++) {
                var selected = currentRole === roles[i] ? 'selected' : '';
                html += '<option value="' + roles[i] + '" ' + selected + '>' + roleNames[roles[i]] + '</option>';
            }
            html += '</select>';

            $.modal.confirm("选择新角色", html, function() {
                var newRole = $('#newRole').val();
                ImModal.doAction("修改角色", prefix + "/role", {
                    groupId: groupId,
                    userId: userId,
                    role: newRole
                }, function() {
                    loadMembers();
                });
            });
        }

        // 禁言/解禁
        function toggleMute(id, currentMuteStatus, userId) {
            var newMuteStatus = currentMuteStatus == 1 ? 0 : 1;
            var action = newMuteStatus == 1 ? "禁言" : "解除禁言";
            ImModal.doAction(action, prefix + "/mute", {
                id: id,
                groupId: groupId,
                userId: userId,
                isMuted: newMuteStatus
            }, function() {
                loadMembers();
            });
        }

        // 移除成员
        function removeMember(userId, nickname) {
            ImModal.doAction("移除成员 " + nickname, prefix + "/remove", {
                groupId: groupId,
                userId: userId
            }, function() {
                loadMembers();
            });
        }

        // 查看详情
        function viewDetail(userId, nickname) {
            var member = allMembers.find(m => m.userId == userId);
            if (!member) return;

            var content = '<div style="padding:20px;">' +
                '<table class="table table-im table-bordered">' +
                '<tr><td style="width:100px;"><strong>用户ID:</strong></td><td>' + (member.userId || '-') + '</td></tr>' +
                '<tr><td><strong>用户名:</strong></td><td>' + (member.userName || '-') + '</td></tr>' +
                '<tr><td><strong>昵称:</strong></td><td>' + (member.userNickname || '-') + '</td></tr>' +
                '<tr><td><strong>群昵称:</strong></td><td>' + (member.nickname || '-') + '</td></tr>' +
                '<tr><td><strong>角色:</strong></td><td>' + (member.role === 'OWNER' ? '群主' : (member.role === 'ADMIN' ? '管理员' : '普通成员')) + '</td></tr>' +
                '<tr><td><strong>禁言状态:</strong></td><td>' + (member.isMuted == 1 ? '已禁言' : '正常') + '</td></tr>' +
                '<tr><td><strong>未读数:</strong></td><td>' + (member.unreadCount || 0) + '</td></tr>' +
                '<tr><td><strong>加入时间:</strong></td><td>' + ImModal.formatDateTime(member.joinTime, true) + '</td></tr>' +
                '<tr><td><strong>操作:</strong></td><td>' +
                '<button class="btn-im-default" onclick="$.modal.close()"><i class="fa fa-close"></i> 关闭</button>' +
                '</td></tr>' +
                '</table>' +
                '</div>';

            layer.open({
                type: 1,
                title: '成员详情 - ' + nickname,
                area: ['95%', '90%'],
                content: content
            });
        }
    </script>
</body>
</html>
