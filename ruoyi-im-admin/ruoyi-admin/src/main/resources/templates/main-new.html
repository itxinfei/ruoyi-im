<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IM即时通讯管理系统 - 数据可视化控制面板</title>
    <link rel="shortcut icon" href="favicon.ico">
    <link href="../static/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}" rel="stylesheet"/>
    <link href="../static/css/font-awesome.min.css" th:href="@{/css/font-awesome.min.css}" rel="stylesheet"/>
    <link href="../static/css/style.min.css" th:href="@{/css/style.min.css}" rel="stylesheet"/>

    <!-- ECharts (本地版本) -->
    <script th:src="@{/js/echarts.min.js}"></script>

    <style>
        /* 基础样式保持不变 */
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            border: 1px solid #e8e8e8;
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-bottom: 15px;
        }

        .bg-blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .bg-green { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .bg-orange { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .bg-purple { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
            line-height: 1;
        }

        .stat-title {
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        /* 新增：图表容器样式 */
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            border: 1px solid #e8e8e8;
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
            width: 100%;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-actions {
            display: flex;
            gap: 10px;
        }

        .chart-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 5px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .chart-btn:hover {
            background: #e9ecef;
        }

        .chart-btn i {
            margin-right: 5px;
        }

        /* 时间选择器 */
        .time-selector {
            display: inline-flex;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 3px;
            margin-left: 10px;
        }

        .time-selector button {
            background: transparent;
            border: none;
            padding: 5px 15px;
            font-size: 13px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .time-selector button.active {
            background: #667eea;
            color: white;
        }

        /* 仪表盘样式 */
        .gauge-chart {
            height: 250px;
        }

        /* 响应式布局 */
        @media (max-width: 768px) {
            .chart-wrapper {
                height: 280px;
            }
        }

        /* 刷新按钮 */
        .refresh-all-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .refresh-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .refresh-all-btn i {
            margin-right: 8px;
        }

        /* 加载动画 */
        .chart-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            z-index: 100;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 12px;
            border-bottom: 2px solid #ecf0f1;
            position: relative;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
    </style>
</head>
<body class="gray-bg">
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-lg-12">
            <div class="dashboard-header">
                <h1><i class="fa fa-dashboard"></i> IM系统数据可视化控制面板</h1>
                <p style="margin-top: 10px; opacity: 0.9;">实时监控系统运行状态，掌握核心业务数据</p>
            </div>
        </div>
    </div>

    <!-- 基础统计卡片 -->
    <div class="row">
        <div class="col-lg-3 col-md-6">
            <div class="stat-card" id="userCard">
                <div class="stat-icon bg-blue">
                    <i class="fa fa-users"></i>
                </div>
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-title">总用户数</div>
                <div class="stat-trend trend-up">
                    <i class="fa fa-arrow-up"></i> 今日注册 <span id="todayRegister">0</span>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card" id="onlineCard">
                <div class="stat-icon bg-green">
                    <i class="fa fa-circle text-success"></i>
                </div>
                <div class="stat-number" id="onlineUsers">0</div>
                <div class="stat-title">在线用户</div>
                <div class="stat-trend trend-up">
                    <span class="status-indicator status-online"></span>实时在线
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card" id="messageCard">
                <div class="stat-icon bg-orange">
                    <i class="fa fa-comments"></i>
                </div>
                <div class="stat-number" id="totalMessages">0</div>
                <div class="stat-title">总消息数</div>
                <div class="stat-trend trend-up">
                    <i class="fa fa-arrow-up"></i> 今日消息 <span id="todayMessages">0</span>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6">
            <div class="stat-card" id="groupCard">
                <div class="stat-icon bg-purple">
                    <i class="fa fa-group"></i>
                </div>
                <div class="stat-number" id="totalGroups">0</div>
                <div class="stat-title">总群组数</div>
                <div class="stat-trend trend-up">
                    <i class="fa fa-arrow-up"></i> 今日创建 <span id="todayCreatedGroups">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 操作按钮 -->
    <div class="row" style="margin-bottom: 20px;">
        <div class="col-lg-12">
            <button class="refresh-all-btn" onclick="refreshAllCharts()">
                <i class="fa fa-refresh"></i> 刷新所有图表
            </button>
        </div>
    </div>

    <!-- 第一行：趋势图表（折线图） -->
    <div class="row">
        <div class="col-lg-6">
            <div class="chart-container">
                <div class="chart-title">
                    <span><i class="fa fa-line-chart" style="color: #667eea;"></i> 用户注册趋势</span>
                    <div class="time-selector">
                        <button class="active" onclick="changeTrendPeriod('user', 7, this)">7天</button>
                        <button onclick="changeTrendPeriod('user', 30, this)">30天</button>
                        <button onclick="changeTrendPeriod('user', 90, this)">90天</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <div id="userTrendChart" style="height: 100%;"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="chart-container">
                <div class="chart-title">
                    <span><i class="fa fa-line-chart" style="color: #4facfe;"></i> 消息发送趋势</span>
                    <div class="time-selector">
                        <button class="active" onclick="changeTrendPeriod('message', 7, this)">7天</button>
                        <button onclick="changeTrendPeriod('message', 30, this)">30天</button>
                        <button onclick="changeTrendPeriod('message', 90, this)">90天</button>
                    </div>
                </div>
                <div class="chart-wrapper">
                    <div id="messageTrendChart" style="height: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 第二行：分布图表（饼图） -->
    <div class="row">
        <div class="col-lg-4">
            <div class="chart-container">
                <div class="chart-title">
                    <span><i class="fa fa-pie-chart" style="color: #fa709a;"></i> 消息类型分布</span>
                </div>
                <div class="chart-wrapper">
                    <div id="msgTypeChart" style="height: 100%;"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="chart-container">
                <div class="chart-title">
                    <span><i class="fa fa-pie-chart" style="color: #a8edea;"></i> 文件类型分布</span>
                </div>
                <div class="chart-wrapper">
                    <div id="fileTypeChart" style="height: 100%;"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="chart-container">
                <div class="chart-title">
                    <span><i class="fa fa-pie-chart" style="color: #fee140;"></i> 用户活跃度分布</span>
                </div>
                <div class="chart-wrapper">
                    <div id="userActivityChart" style="height: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 第三行：对比图表（柱状图） -->
    <div class="row">
        <div class="col-lg-6">
            <div class="chart-container">
                <div class="chart-title">
                    <span><i class="fa fa-bar-chart" style="color: #667eea;"></i> 每小时活跃度对比</span>
                </div>
                <div class="chart-wrapper">
                    <div id="hourlyComparisonChart" style="height: 100%;"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="chart-container">
                <div class="chart-title">
                    <span><i class="fa fa-bar-chart" style="color: #4facfe;"></i> 周消息量对比</span>
                </div>
                <div class="chart-wrapper">
                    <div id="weeklyComparisonChart" style="height: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 第四行：排行榜（横向柱状图） -->
    <div class="row">
        <div class="col-lg-6">
            <div class="chart-container">
                <div class="chart-title">
                    <span><i class="fa fa-trophy" style="color: #fa709a;"></i> 最活跃用户 TOP10</span>
                </div>
                <div class="chart-wrapper">
                    <div id="topUsersChart" style="height: 100%;"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="chart-container">
                <div class="chart-title">
                    <span><i class="fa fa-trophy" style="color: #a8edea;"></i> 最活跃群组 TOP10</span>
                </div>
                <div class="chart-wrapper">
                    <div id="topGroupsChart" style="height: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 第五行：实时监控（仪表盘） -->
    <div class="row">
        <div class="col-lg-12">
            <div class="chart-container">
                <div class="chart-title">
                    <span><i class="fa fa-tachometer" style="color: #667eea;"></i> 实时监控面板</span>
                    <span style="font-size: 12px; color: #7f8c8d;">（自动刷新：30秒）</span>
                </div>
                <div class="row">
                    <div class="col-lg-3">
                        <div id="onlineGauge" style="height: 250px;"></div>
                    </div>
                    <div class="col-lg-9">
                        <div id="messageFlowChart" style="height: 250px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 引入JS文件 -->
<script th:src="@{/js/jquery.min.js}"></script>
<script th:src="@{/js/bootstrap.min.js}"></script>
<script th:src="@{/js/dashboard-charts.js}"></script>

<script>
    var ctx = '/';
    var autoRefreshTimer = null;

    $(document).ready(function() {
        // 加载基础统计数据
        loadStatistics();

        // 初始化所有图表
        initAllCharts();

        // 启动自动刷新（30秒）
        startAutoRefresh();

        // 响应式调整
        window.addEventListener('resize', function() {
            resizeAllCharts();
        });
    });

    /**
     * 初始化所有图表
     */
    function initAllCharts() {
        // 趋势图
        $('#userTrendChart').dashboardChart('line', {
            url: ctx + 'im/dashboard/trend?type=user&days=7',
            title: ''
        });

        $('#messageTrendChart').dashboardChart('line', {
            url: ctx + 'im/dashboard/trend?type=message&days=7',
            title: ''
        });

        // 分布图
        $('#msgTypeChart').dashboardChart('pie', {
            url: ctx + 'im/dashboard/distribution?type=msgType',
            title: ''
        });

        $('#fileTypeChart').dashboardChart('pie', {
            url: ctx + 'im/dashboard/distribution?type=fileType',
            title: ''
        });

        $('#userActivityChart').dashboardChart('pie', {
            url: ctx + 'im/dashboard/distribution?type=userActivity&days=30',
            title: ''
        });

        // 对比图
        $('#hourlyComparisonChart').dashboardChart('bar', {
            url: ctx + 'im/dashboard/comparison?type=hourly',
            title: '',
            showDataZoom: true
        });

        $('#weeklyComparisonChart').dashboardChart('bar', {
            url: ctx + 'im/dashboard/comparison?type=weekly',
            title: ''
        });

        // 排行榜
        $('#topUsersChart').dashboardChart('horizontalBar', {
            url: ctx + 'im/dashboard/ranking?type=users&days=7&limit=10',
            title: ''
        });

        $('#topGroupsChart').dashboardChart('horizontalBar', {
            url: ctx + 'im/dashboard/ranking?type=groups&days=7&limit=10',
            title: ''
        });

        // 实时监控
        initRealtimeCharts();
    }

    /**
     * 初始化实时监控图表
     */
    function initRealtimeCharts() {
        // 在线用户仪表盘
        loadOnlineGauge();

        // 消息流量趋势
        $('#messageFlowChart').dashboardChart('line', {
            url: ctx + 'im/dashboard/realtime?type=messageFlow&minutes=30',
            title: '',
            height: 250
        });
    }

    /**
     * 加载在线用户仪表盘
     */
    function loadOnlineGauge() {
        $.ajax({
            url: ctx + 'im/dashboard/realtime?type=online',
            type: 'GET',
            success: function(response) {
                if (response.code === 0 || response.code === 200) {
                    var value = response.data || 0;

                    var option = {
                        series: [{
                            type: 'gauge',
                            min: 0,
                            max: Math.max(value * 1.5, 100),
                            detail: {
                                formatter: '{value}'
                            },
                            data: [{
                                value: value,
                                name: '在线用户'
                            }],
                            title: {
                                offsetCenter: [0, '90%'],
                                fontSize: 14
                            }
                        }]
                    };

                    var chart = echarts.init(document.getElementById('onlineGauge'));
                    chart.setOption(option);
                }
            }
        });
    }

    /**
     * 加载基础统计数据
     */
    function loadStatistics() {
        $.ajax({
            url: ctx + 'im/dashboard/statistics',
            type: 'GET',
            success: function(result) {
                if (result.code === 0 && result.data) {
                    var data = result.data;

                    $('#totalUsers').text(formatNumber(data.totalUsers || 0));
                    $('#onlineUsers').text(formatNumber(data.onlineUsers || 0));
                    $('#todayRegister').text(formatNumber(data.todayRegister || 0));
                    $('#totalMessages').text(formatNumber(data.totalMessages || 0));
                    $('#todayMessages').text(formatNumber(data.todayMessages || 0));
                    $('#totalGroups').text(formatNumber(data.totalGroups || 0));
                    $('#todayCreatedGroups').text(formatNumber(data.todayCreatedGroups || 0));
                }
            },
            error: function() {
                $('#totalUsers').text('0');
                $('#onlineUsers').text('0');
                $('#todayRegister').text('0');
                $('#totalMessages').text('0');
                $('#todayMessages').text('0');
                $('#totalGroups').text('0');
                $('#todayCreatedGroups').text('0');
            }
        });
    }

    /**
     * 改变趋势图表时间范围
     */
    function changeTrendPeriod(type, days, btn) {
        // 更新按钮状态
        $(btn).siblings().removeClass('active');
        $(btn).addClass('active');

        // 刷新图表
        var chartId = type + 'TrendChart';
        $('#' + chartId).dashboardChart('loadData', { days: days });
    }

    /**
     * 刷新所有图表
     */
    function refreshAllCharts() {
        // 刷新基础统计
        loadStatistics();

        // 刷新所有图表
        $.fn.dashboardChart.refreshAll();

        // 刷新实时监控
        loadOnlineGauge();

        // 清除缓存
        $.ajax({
            url: ctx + 'im/dashboard/refresh?cacheType=all',
            type: 'POST',
            success: function(response) {
                if (response.code === 0 || response.code === 200) {
                    console.log('缓存刷新成功');
                }
            }
        });
    }

    /**
     * 启动自动刷新
     */
    function startAutoRefresh() {
        if (autoRefreshTimer) {
            clearInterval(autoRefreshTimer);
        }

        autoRefreshTimer = setInterval(function() {
            // 刷新基础统计
            loadStatistics();

            // 刷新实时监控
            loadOnlineGauge();

            // 刷新消息流量图
            $('#messageFlowChart').dashboardChart('loadData');
        }, 30000); // 30秒
    }

    /**
     * 停止自动刷新
     */
    function stopAutoRefresh() {
        if (autoRefreshTimer) {
            clearInterval(autoRefreshTimer);
            autoRefreshTimer = null;
        }
    }

    /**
     * 调整所有图表大小
     */
    function resizeAllCharts() {
        var charts = document.querySelectorAll('[id$="Chart"]');
        charts.forEach(function(element) {
            var chart = echarts.getInstanceByDom(element);
            if (chart) {
                chart.resize();
            }
        });
    }

    /**
     * 格式化数字
     */
    function formatNumber(num) {
        if (num >= 10000) {
            return (num / 10000).toFixed(1) + '万';
        } else if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'k';
        }
        return num.toString();
    }

    // 页面卸载时清理资源
    $(window).on('beforeunload', function() {
        stopAutoRefresh();
        $.fn.dashboardChart.destroyAll();
    });
</script>
</body>
</html>
