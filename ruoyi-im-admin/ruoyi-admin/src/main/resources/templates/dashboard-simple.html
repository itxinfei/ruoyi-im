<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMç³»ç»ŸDashboard - ç®€åŒ–ç‰ˆ</title>
    <link href="../static/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}" rel="stylesheet"/>
    <link href="../static/css/font-awesome.min.css" th:href="@{/css/font-awesome.min.css}" rel="stylesheet"/>
    <style>
        body {
            background: #f5f5f5;
            padding: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #333;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .data-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        .data-item {
            padding: 10px;
            background: #f9f9f9;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <h1>ğŸ“Š IMç³»ç»ŸDashboard - ç®€åŒ–ç‰ˆ</h1>

    <!-- çŠ¶æ€æç¤º -->
    <div id="status-message" class="alert alert-info">
        â³ æ­£åœ¨åŠ è½½æ•°æ®...
    </div>

    <!-- åŸºç¡€ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">-</div>
                <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number" id="onlineUsers">-</div>
                <div class="stat-label">åœ¨çº¿ç”¨æˆ·</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number" id="totalMessages">-</div>
                <div class="stat-label">æ€»æ¶ˆæ¯æ•°</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-number" id="totalGroups">-</div>
                <div class="stat-label">æ€»ç¾¤ç»„æ•°</div>
            </div>
        </div>
    </div>

    <!-- APIæµ‹è¯•åŒºåŸŸ -->
    <div class="data-section">
        <div class="section-title">ğŸ”§ APIæµ‹è¯•</div>

        <div style="margin-bottom: 15px;">
            <button class="btn btn-primary" onclick="testBasicAPI()">1. æµ‹è¯•åŸºç¡€ç»Ÿè®¡API</button>
            <button class="btn btn-success" onclick="testTrendAPI()">2. æµ‹è¯•è¶‹åŠ¿API</button>
            <button class="btn btn-info" onclick="testDistributionAPI()">3. æµ‹è¯•åˆ†å¸ƒAPI</button>
            <button class="btn btn-warning" onclick="testAllAPIs()">4. æµ‹è¯•æ‰€æœ‰API</button>
        </div>

        <div id="test-results"></div>
    </div>

    <!-- å“åº”æ•°æ®æ˜¾ç¤º -->
    <div class="data-section">
        <div class="section-title">ğŸ“¦ APIå“åº”æ•°æ®</div>
        <pre id="api-response">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æµ‹è¯•API...</pre>
    </div>

    <script th:src="@{/js/jquery.min.js}"></script>
    <script>
        var ctx = '/';

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•åŸºç¡€API
        $(document).ready(function() {
            console.log('é¡µé¢å·²åŠ è½½ï¼Œå¼€å§‹æµ‹è¯•API...');
            testBasicAPI();
        });

        /**
         * æµ‹è¯•åŸºç¡€ç»Ÿè®¡API
         */
        function testBasicAPI() {
            $('#status-message').removeClass('alert-success alert-danger').addClass('alert-info')
                .text('â³ æ­£åœ¨æµ‹è¯•åŸºç¡€ç»Ÿè®¡API...');
            $('#api-response').text('è¯·æ±‚ä¸­...');

            $.ajax({
                url: ctx + 'im/dashboard/basic',
                method: 'GET',
                timeout: 10000,
                success: function(response) {
                    console.log('åŸºç¡€ç»Ÿè®¡APIå“åº”:', response);

                    $('#status-message').removeClass('alert-info alert-danger').addClass('alert-success')
                        .text('âœ… åŸºç¡€ç»Ÿè®¡APIæµ‹è¯•æˆåŠŸï¼');

                    // æ›´æ–°å¡ç‰‡æ•°æ®
                    if (response.code === 0 || response.code === 200) {
                        $('#totalUsers').text(response.data.total_users || 0);
                        $('#onlineUsers').text(response.data.online_users || 0);
                        $('#totalMessages').text(response.data.total_messages || 0);
                        $('#totalGroups').text(response.data.total_groups || 0);

                        $('#api-response').text('åŸºç¡€ç»Ÿè®¡:\n' + JSON.stringify(response.data, null, 2));
                    } else {
                        $('#status-message').removeClass('alert-info alert-success').addClass('alert-danger')
                            .text('âŒ APIè¿”å›é”™è¯¯: ' + response.msg);
                        $('#api-response').text('é”™è¯¯å“åº”:\n' + JSON.stringify(response, null, 2));
                    }

                    addTestResult('âœ… åŸºç¡€ç»Ÿè®¡API', 'success', response.msg);
                },
                error: function(xhr, status, error) {
                    console.error('åŸºç¡€ç»Ÿè®¡APIé”™è¯¯:', error);

                    $('#status-message').removeClass('alert-info alert-success').addClass('alert-danger')
                        .text('âŒ åŸºç¡€ç»Ÿè®¡APIæµ‹è¯•å¤±è´¥: ' + error);

                    $('#api-response').text('é”™è¯¯è¯¦æƒ…:\n' +
                        'çŠ¶æ€ç : ' + xhr.status + '\n' +
                        'é”™è¯¯: ' + error + '\n' +
                        'å“åº”: ' + xhr.responseText);

                    addTestResult('âŒ åŸºç¡€ç»Ÿè®¡API', 'error', xhr.status + ' - ' + error);
                }
            });
        }

        /**
         * æµ‹è¯•è¶‹åŠ¿API
         */
        function testTrendAPI() {
            $('#status-message').removeClass('alert-success alert-danger').addClass('alert-info')
                .text('â³ æ­£åœ¨æµ‹è¯•è¶‹åŠ¿API...');

            $.ajax({
                url: ctx + 'im/dashboard/trend?type=user&days=7',
                method: 'GET',
                timeout: 10000,
                success: function(response) {
                    console.log('è¶‹åŠ¿APIå“åº”:', response);

                    if (response.code === 0 || response.code === 200) {
                        $('#status-message').removeClass('alert-info alert-danger').addClass('alert-success')
                            .text('âœ… è¶‹åŠ¿APIæµ‹è¯•æˆåŠŸï¼æ•°æ®æ¡æ•°: ' + (response.data ? response.data.length : 0));

                        $('#api-response').text('ç”¨æˆ·è¶‹åŠ¿æ•°æ®:\n' + JSON.stringify(response.data, null, 2));
                        addTestResult('âœ… è¶‹åŠ¿API', 'success', 'è¿”å› ' + (response.data ? response.data.length : 0) + ' æ¡æ•°æ®');
                    } else {
                        addTestResult('âŒ è¶‹åŠ¿API', 'error', response.msg);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('è¶‹åŠ¿APIé”™è¯¯:', error);
                    addTestResult('âŒ è¶‹åŠ¿API', 'error', xhr.status + ' - ' + error);
                }
            });
        }

        /**
         * æµ‹è¯•åˆ†å¸ƒAPI
         */
        function testDistributionAPI() {
            $('#status-message').removeClass('alert-success alert-danger').addClass('alert-info')
                .text('â³ æ­£åœ¨æµ‹è¯•åˆ†å¸ƒAPI...');

            $.ajax({
                url: ctx + 'im/dashboard/distribution?type=msgType',
                method: 'GET',
                timeout: 10000,
                success: function(response) {
                    console.log('åˆ†å¸ƒAPIå“åº”:', response);

                    if (response.code === 0 || response.code === 200) {
                        $('#status-message').removeClass('alert-info alert-danger').addClass('alert-success')
                            .text('âœ… åˆ†å¸ƒAPIæµ‹è¯•æˆåŠŸï¼æ•°æ®æ¡æ•°: ' + (response.data ? response.data.length : 0));

                        $('#api-response').text('æ¶ˆæ¯ç±»å‹åˆ†å¸ƒ:\n' + JSON.stringify(response.data, null, 2));
                        addTestResult('âœ… åˆ†å¸ƒAPI', 'success', 'è¿”å› ' + (response.data ? response.data.length : 0) + ' æ¡æ•°æ®');
                    } else {
                        addTestResult('âŒ åˆ†å¸ƒAPI', 'error', response.msg);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('åˆ†å¸ƒAPIé”™è¯¯:', error);
                    addTestResult('âŒ åˆ†å¸ƒAPI', 'error', xhr.status + ' - ' + error);
                }
            });
        }

        /**
         * æµ‹è¯•æ‰€æœ‰API
         */
        function testAllAPIs() {
            $('#test-results').empty();
            $('#status-message').removeClass('alert-success alert-danger').addClass('alert-info')
                .text('â³ æ­£åœ¨æµ‹è¯•æ‰€æœ‰API...');

            // ä¾æ¬¡æµ‹è¯•
            testBasicAPI();
            setTimeout(testTrendAPI, 1000);
            setTimeout(testDistributionAPI, 2000);
        }

        /**
         * æ·»åŠ æµ‹è¯•ç»“æœ
         */
        function addTestResult(title, status, message) {
            var className = status === 'success' ? 'alert-success' : 'alert-danger';
            var html = '<div class="data-item ' + className + '">' +
                       '<strong>' + title + '</strong><br>' +
                       message +
                       '</div>';
            $('#test-results').append(html);
        }
    </script>
</body>
</html>
