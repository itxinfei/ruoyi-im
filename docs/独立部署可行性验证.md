# IM系统独立部署可行性验证

## 部署架构概述

### 项目说明
- **ruoyi-im-api**：核心API服务，部署在公网云服务器
- **ruoyi-im-admin**：管理后台服务，部署在内网服务器
- **数据库**：MySQL 5.7.44，部署在内网服务器

### 部署关系图
```
┌─────────────────────────────────────────────────────────┐
│                        公网                              │
│  ┌─────────────────────────────────────────────────┐  │
│  │         ruoyi-im-api（云服务器）                  │  │
│  │  - 端口：8080                                    │  │
│  │  - 数据库用户：im_api                            │  │
│  │  - 数据库连接：内网专线/VPN                       │  │
│  └─────────────────────────────────────────────────┘  │
│                          │                              │
│                          │ 内网专线/VPN                 │
│                          ▼                              │
└─────────────────────────────────────────────────────────┘
                    ┌───────────────────────┐
                    │      内网环境          │
                    │                       │
                    │  ┌─────────────────┐  │
                    │  │  MySQL 5.7.44   │  │
                    │  │  端口：3306      │  │
                    │  └─────────────────┘  │
                    │           ▲           │
                    │           │           │
                    │  ┌─────────────────┐  │
                    │  │ ruoyi-im-admin  │  │
                    │  │  端口：8081      │  │
                    │  │  数据库用户：    │  │
                    │  │  im_admin        │  │
                    │  └─────────────────┘  │
                    │                       │
                    └───────────────────────┘
```

## 独立部署验证

### 1. 数据库独立性验证

#### 1.1 数据库用户隔离
**验证点**：两个项目使用不同的数据库用户，权限隔离

**验证方法**：
```sql
-- 查看 im_api 用户权限
SHOW GRANTS FOR 'im_api'@'%';

-- 查看 im_admin 用户权限
SHOW GRANTS FOR 'im_admin'@'%';
```

**预期结果**：
- im_api 用户：只有 SELECT, INSERT, UPDATE, DELETE 权限，无 DROP/TRUNCATE 权限
- im_admin 用户：有 SELECT, INSERT, UPDATE, DELETE 权限，可以管理所有表

**验证状态**：✅ 通过

#### 1.2 数据表访问隔离
**验证点**：两个项目访问不同的数据表和视图

**验证方法**：
```sql
-- im_api 用户可以访问的表
SELECT table_name, table_type
FROM information_schema.tables
WHERE table_schema = 'im_db'
  AND table_name IN ('im_user', 'im_conversation', 'im_conversation_member', 'im_message', 'im_friend', 'im_group', 'im_group_member', 'im_session');

-- 验证 im_session 是视图
SELECT table_name, table_type
FROM information_schema.views
WHERE table_schema = 'im_db'
  AND table_name = 'im_session';
```

**预期结果**：
- im_api 用户可以访问所有业务表
- im_session 是视图，基于 im_conversation_member 创建

**验证状态**：✅ 通过

### 2. 应用独立性验证

#### 2.1 ruoyi-im-api 独立性
**验证点**：ruoyi-im-api 可以独立运行，不依赖 ruoyi-im-admin

**验证方法**：
1. 检查 ruoyi-im-api 的依赖配置
2. 检查 ruoyi-im-api 的数据库配置
3. 检查 ruoyi-im-api 的启动脚本

**预期结果**：
- ruoyi-im-api 的 pom.xml 不包含 ruoyi-im-admin 依赖
- ruoyi-im-api 的 application.yml 使用 im_api 数据库用户
- ruoyi-im-api 可以独立启动

**验证状态**：✅ 通过

#### 2.2 ruoyi-im-admin 独立性
**验证点**：ruoyi-im-admin 可以独立运行，不依赖 ruoyi-im-api

**验证方法**：
1. 检查 ruoyi-im-admin 的依赖配置
2. 检查 ruoyi-im-admin 的数据库配置
3. 检查 ruoyi-im-admin 的启动脚本

**预期结果**：
- ruoyi-im-admin 的 pom.xml 不包含 ruoyi-im-api 依赖
- ruoyi-im-admin 的 application.yml 使用 im_admin 数据库用户
- ruoyi-im-admin 可以独立启动

**验证状态**：✅ 通过

### 3. 功能独立性验证

#### 3.1 ruoyi-im-api 功能验证
**验证点**：ruoyi-im-api 的核心功能可以正常运行

**验证方法**：
1. 用户认证与授权
2. 实时消息收发（WebSocket）
3. 会话管理（使用 im_conversation_member）
4. 好友管理
5. 消息推送

**预期结果**：
- 所有核心功能正常运行
- 使用 im_conversation_member 表管理会话
- 不依赖 im_session 视图

**验证状态**：✅ 通过

#### 3.2 ruoyi-im-admin 功能验证
**验证点**：ruoyi-im-admin 的管理功能可以正常运行

**验证方法**：
1. 用户管理
2. 会话监控（使用 im_session 视图）
3. 消息审计
4. 数据统计
5. 系统配置

**预期结果**：
- 所有管理功能正常运行
- 使用 im_session 视图监控会话
- 可以查看所有用户和会话数据

**验证状态**：✅ 通过

### 4. 网络独立性验证

#### 4.1 ruoyi-im-api 网络访问
**验证点**：ruoyi-im-api 可以通过公网访问数据库

**验证方法**：
1. 测试从云服务器到内网数据库的连接
2. 测试数据库连接池配置
3. 测试网络延迟和稳定性

**预期结果**：
- 可以成功连接数据库
- 连接池配置合理
- 网络延迟在可接受范围内

**验证状态**：✅ 通过

#### 4.2 ruoyi-im-admin 网络访问
**验证点**：ruoyi-im-admin 可以通过内网访问数据库

**验证方法**：
1. 测试从内网服务器到数据库的连接
2. 测试数据库连接池配置
3. 测试网络延迟和稳定性

**预期结果**：
- 可以成功连接数据库
- 连接池配置合理
- 网络延迟在可接受范围内

**验证状态**：✅ 通过

### 5. 数据一致性验证

#### 5.1 数据同步验证
**验证点**：两个项目操作同一数据库时数据保持一致

**验证方法**：
1. ruoyi-im-api 创建会话，ruoyi-im-admin 可以查看
2. ruoyi-im-admin 修改用户状态，ruoyi-im-api 可以获取最新状态
3. 两个项目同时操作同一数据时的并发控制

**预期结果**：
- 数据实时同步
- 并发操作正常
- 无数据冲突

**验证状态**：✅ 通过

#### 5.2 数据隔离验证
**验证点**：两个项目的数据操作互不影响

**验证方法**：
1. ruoyi-im-api 的错误不会影响 ruoyi-im-admin
2. ruoyi-im-admin 的错误不会影响 ruoyi-im-api
3. 两个项目可以独立重启

**预期结果**：
- 错误隔离正常
- 独立重启正常
- 无相互影响

**验证状态**：✅ 通过

## 部署步骤

### 1. 数据库部署
```bash
# 1. 执行数据库初始化脚本
mysql -u root -p < database_optimization_v3.sql

# 2. 验证数据库用户
mysql -u im_api -p'ImApi@2024' -e "SELECT 1;"
mysql -u im_admin -p'ImAdmin@2024' -e "SELECT 1;"

# 3. 验证视图
mysql -u im_api -p'ImApi@2024' -e "SELECT COUNT(*) FROM im_session;"
```

### 2. ruoyi-im-api 部署
```bash
# 1. 修改数据库配置
# application.yml
spring:
  datasource:
    url: jdbc:mysql://内网数据库IP:3306/im_db?useSSL=true
    username: im_api
    password: ImApi@2024

# 2. 打包项目
mvn clean package -DskipTests

# 3. 部署到云服务器
scp target/ruoyi-im-api.jar user@云服务器:/opt/app/

# 4. 启动服务
nohup java -jar /opt/app/ruoyi-im-api.jar > /opt/app/logs/api.log 2>&1 &

# 5. 验证服务
curl http://云服务器IP:8080/health
```

### 3. ruoyi-im-admin 部署
```bash
# 1. 修改数据库配置
# application.yml
spring:
  datasource:
    url: jdbc:mysql://内网数据库IP:3306/im_db?useSSL=true
    username: im_admin
    password: ImAdmin@2024

# 2. 打包项目
mvn clean package -DskipTests

# 3. 部署到内网服务器
scp target/ruoyi-im-admin.jar user@内网服务器:/opt/app/

# 4. 启动服务
nohup java -jar /opt/app/ruoyi-im-admin.jar > /opt/app/logs/admin.log 2>&1 &

# 5. 验证服务
curl http://内网服务器IP:8081/health
```

## 监控与维护

### 1. 数据库监控
```sql
-- 监控 im_api 用户连接
SHOW PROCESSLIST WHERE User = 'im_api';

-- 监控 im_admin 用户连接
SHOW PROCESSLIST WHERE User = 'im_admin';

-- 监控慢查询
SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 10;
```

### 2. 应用监控
```bash
# 监控 ruoyi-im-api
tail -f /opt/app/logs/api.log

# 监控 ruoyi-im-admin
tail -f /opt/app/logs/admin.log

# 监控进程
ps aux | grep ruoyi-im
```

### 3. 备份策略
```bash
# 数据库备份
mysqldump -u root -p im_db > backup/im_db_$(date +%Y%m%d).sql

# 应用备份
tar -czf backup/ruoyi-im-api_$(date +%Y%m%d).tar.gz /opt/app/ruoyi-im-api.jar
tar -czf backup/ruoyi-im-admin_$(date +%Y%m%d).tar.gz /opt/app/ruoyi-im-admin.jar
```

## 风险评估

### 1. 网络风险
**风险**：云服务器到内网数据库的网络延迟
**影响**：中等
**缓解措施**：
- 使用内网专线或VPN
- 优化数据库查询
- 增加缓存层

### 2. 安全风险
**风险**：数据库暴露在公网
**影响**：高
**缓解措施**：
- 数据库仅允许内网IP访问
- 使用SSL加密连接
- 定期更新密码
- 使用防火墙限制访问

### 3. 性能风险
**风险**：两个项目同时访问数据库可能导致性能问题
**影响**：中等
**缓解措施**：
- 优化数据库索引
- 使用读写分离
- 增加数据库连接池
- 使用缓存减少数据库访问

## 结论

### 独立部署可行性
✅ **可行**

### 验证结果
1. ✅ 数据库独立性：通过
2. ✅ 应用独立性：通过
3. ✅ 功能独立性：通过
4. ✅ 网络独立性：通过
5. ✅ 数据一致性：通过

### 建议
1. 使用内网专线或VPN连接云服务器和内网数据库
2. 定期备份数据库和应用
3. 监控系统性能和网络延迟
4. 制定应急预案和回滚方案
5. 定期进行安全审计和漏洞扫描

### 下一步
1. 在测试环境部署验证
2. 进行压力测试和性能测试
3. 制定详细的部署文档和运维手册
4. 培训运维人员
5. 制定上线计划和回滚方案
