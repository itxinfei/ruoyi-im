# RuoYi-IM 版本更新日志

**项目名称**: 私有化Web钉钉系统
**技术栈**: Spring Boot 2.7 + Vue 3 + Element Plus + MySQL 5.7 + Redis
**当前版本**: v1.9

---

## 版本历史总览

| 版本 | 发布日期 | 完成度 | 主要更新 |
|------|---------|-------|---------|
| v1.9 | 2026-01-13 | 94% | 离线消息、已读回执、消息重试、健康检查、系统监控 |
| v1.8 | 2026-01-12 | 91% | 消息内容加密/解密 |
| v1.7 | 2026-01-11 | 89% | 邮箱模块前端实现 |
| v1.6 | 2026-01-10 | 87% | 视频通话模块基础功能 |
| v1.5 | 2026-01-09 | 85% | 文档模块前端API对接 |

---

## v1.9.0 (2026-01-13)

### 新增功能

#### P0 - 消息送达可靠性优化

| 文件 | 功能 |
|------|------|
| `IOfflineMessageService.java` | 离线消息服务接口 |
| `OfflineMessageServiceImpl.java` | Redis存储离线消息，7天过期，最多1000条/用户 |
| `ImMessagePushServiceImpl.java` | 用户离线时自动存储消息 |
| `ImWebSocketEndpoint.java` | 用户上线时自动推送离线消息 |

**功能说明**:
- 用户离线时消息自动存储到Redis
- 最多存储1000条/用户，7天自动过期
- 用户上线时自动推送所有离线消息
- 支持批量获取和清空离线消息

#### P0 - 已读回执功能完善

| 文件 | 功能 |
|------|------|
| `message.js` | 修正API路径，添加已读回执专用接口 |
| `useReadReceipt.js` | 自动已读标记composable，支持IntersectionObserver |
| `ReadReceiptBadge.vue` | 已读状态徽章组件 |
| `ReadReceiptDialog.vue` | 已读详情对话框 |
| `MessageBubble.vue` | 添加data-message-id属性支持可见性检测 |

**功能说明**:
- 消息可见时自动标记已读（IntersectionObserver）
- 显示已读人数和已读用户列表
- 支持群聊消息已读/未读统计
- 防重复标记机制（节流+去重）

#### P0 - 消息发送失败重试机制

| 文件 | 功能 |
|------|------|
| `ImMessageRetryService.java` | 消息重试服务接口 |
| `ImMessageRetryServiceImpl.java` | 指数退避重试，最多3次，24小时过期 |
| `useMessageRetry.js` | 前端重试composable，支持自动重试 |

**功能说明**:
- 发送失败自动记录到Redis
- 指数退避策略（1s → 1.5s → 2.25s → ... 最大10s）
- 最多重试3次
- 失败记录24小时自动过期

#### P0 - 系统健康检查接口

| 文件 | 功能 |
|------|------|
| `ImHealthCheckController.java` | `/api/im/health` 健康检查端点 |

**接口清单**:
- `GET /api/im/health` - 基础健康检查
- `GET /api/im/health/detail` - 详细健康状态
- `GET /api/im/health/readiness` - 就绪探针
- `GET /api/im/health/liveness` - 存活探针

**检查项目**:
- 数据库连接状态
- Redis连接状态
- WebSocket在线用户数
- JVM内存使用情况

#### P0 - 系统运行监控指标

| 文件 | 功能 |
|------|------|
| `ImMonitorController.java` | `/api/im/monitor` 监控端点 |

**接口清单**:
- `GET /api/im/monitor/overview` - 系统概览
- `GET /api/im/monitor/jvm` - JVM信息
- `GET /api/im/monitor/memory` - 内存信息
- `GET /api/im/monitor/thread` - 线程信息
- `GET /api/im/monitor/classloading` - 类加载信息
- `GET /api/im/monitor/compilation` - JIT编译信息
- `GET /api/im/monitor/runtime` - 运行时信息

#### P0 - WebSocket断线重连优化

| 文件 | 功能 |
|------|------|
| `WebSocketManager.js` | 增强版WebSocket连接管理器 |

**功能说明**:
- 无限重连支持
- 指数退避重连策略
- 网络状态监听（online/offline事件）
- 心跳超时检测
- 消息队列缓存

### 优化改进

- WebSocket连接稳定性增强
- 网络状态监听与自动重连
- 心跳超时检测机制
- 消息队列自动发送

### API接口变更

**新增接口**:
```
GET  /api/im/health                      - 基础健康检查
GET  /api/im/health/detail               - 详细健康状态
GET  /api/im/health/readiness            - 就绪探针
GET  /api/im/health/liveness             - 存活探针
GET  /api/im/monitor/overview            - 系统概览
GET  /api/im/monitor/jvm                 - JVM信息
GET  /api/im/monitor/memory              - 内存信息
GET  /api/im/monitor/thread              - 线程信息
GET  /api/im/monitor/classloading        - 类加载信息
GET  /api/im/monitor/compilation         - 编译信息
GET  /api/im/monitor/runtime             - 运行时信息
POST /api/im/message/read/{messageId}    - 标记消息已读
POST /api/im/message/read/batch          - 批量标记已读
GET  /api/im/message/read/status/{id}    - 获取已读状态
GET  /api/im/message/read/detail/{id}    - 获取已读详情
```

### 数据库变更

无新增表，使用现有表结构。

---

## v1.8.0 (2026-01-12)

### 新增功能

#### P1 - 消息内容解密功能

| 文件 | 功能 |
|------|------|
| `MessageEncryptionUtil.java` | 消息加密/解密工具类 |
| `ImMessageServiceImpl.java` | 集成消息解密功能 |

**功能说明**:
- AES-256-GCM加密算法
- 消息发送时自动加密
- 消息接收时自动解密
- 支持配置开启/关闭加密

### 配置变更

```yaml
im:
  message:
    encryption:
      enabled: true
      key: "aW1fZW5jcnlwdGlvbl9rZXlfMjAyNA=="
```

---

## v1.7.0 (2026-01-11)

### 新增功能

#### P1 - 邮箱模块前端开发

| 文件 | 功能 |
|------|------|
| `src/api/im/email.js` | 邮箱前端API模块 |
| `src/views/im/email/index.vue` | 邮箱主页面 |
| `src/views/im/email/components/ComposeDialog.vue` | 写邮件对话框 |
| `src/views/im/email/components/EmailDetailDialog.vue` | 邮件详情对话框 |
| `src/router/modules/im.js` | 添加邮箱路由 |

**功能说明**:
- 收件箱、发件箱、草稿箱、垃圾箱
- 写邮件（支持附件）
- 邮件详情查看
- 邮件删除、移动

---

## v1.6.0 (2026-01-10)

### 新增功能

#### P1 - 视频通话模块

| 文件 | 功能 |
|------|------|
| `ImVideoCall.java` | 视频通话实体 |
| `ImVideoCallService.java` | 视频通话服务接口 |
| `ImVideoCallServiceImpl.java` | 视频通话服务实现 |
| `ImVideoCallController.java` | 视频通话API控制器 |
| `ImWebSocketEndpoint.java` | 添加视频通话信令支持 |
| `sql/im_video_call.sql` | 视频通话数据表 |

**功能说明**:
- WebRTC视频通话
- 视频通话信令服务器
- 通话记录存储
- 支持单人/多人通话

### 数据库变更

**新增表**: `im_video_call`
- 通话ID
- 主叫用户
- 被叫用户
- 通话状态
- 开始时间
- 结束时间

---

## v1.5.0 (2026-01-09)

### 优化改进

#### P2 - 文档模块前端API对接

| 文件 | 功能 |
|------|------|
| `src/views/im/document/DocumentList.vue` | 对接真实API |

**功能说明**:
- 文档列表从API获取
- 支持文档搜索
- 支持文档分类筛选

---

## v1.4.0 (2026-01-08)

### 已知修复

- 修复JWT工具类异常处理问题
- 修复私聊会话创建问题

---

## 计划中的功能 (Roadmap)

### v2.0.0 (规划中)

- [ ] 消息全文搜索（Elasticsearch）
- [ ] 语音转文字（ASR集成）
- [ ] 表情包管理
- [ ] 桌面通知
- [ ] 消息定时发送
- [ ] DING消息增强（定时DING、紧急提醒）
- [ ] 文档协同编辑

---

## 版本命名规则

- **主版本号**: 重大架构变更
- **次版本号**: 新增功能模块
- **修订号**: Bug修复和小优化

---

## 升级建议

### v1.8 → v1.9

1. **备份**: 升级前请备份数据库和Redis数据
2. **配置**: 无需额外配置变更
3. **数据库**: 无需数据库迁移
4. **验证**: 升级后请验证健康检查接口

```bash
# 验证命令
curl http://localhost:8080/api/im/health/detail
```

---

## 问题反馈

- GitHub Issues: https://github.com/example/im/issues
- 技术支持: support@example.com

---

**文档版本**: v1.0
**最后更新**: 2026-01-13
