# RuoYi-IM 部署运维指南

**项目版本**: v1.9
**更新日期**: 2026-01-13
**部署规模**: 企业内网部署，支持50人并发

---

## 一、系统要求

### 1.1 硬件要求

| 组件 | 最低配置 | 推荐配置 |
|------|---------|---------|
| CPU | 2核 | 4核+ |
| 内存 | 4GB | 8GB+ |
| 硬盘 | 50GB | 100GB+ SSD |
| 网络 | 100Mbps | 1Gbps |

### 1.2 软件要求

| 软件 | 版本要求 | 说明 |
|------|---------|------|
| JDK | 1.8+ | 后端运行环境 |
| MySQL | 5.7.44+ | 数据库 |
| Redis | 3.0+ | 缓存中间件 |
| Nginx | 1.18+ | 反向代理（可选） |
| Node.js | 16+ | 前端构建（开发时） |

### 1.3 端口规划

| 端口 | 服务 | 说明 |
|------|------|------|
| 8080 | 后端API | Spring Boot服务 |
| 3000 | 前端Dev | Vite开发服务器 |
| 80/443 | Nginx | 生产环境前端访问 |
| 3306 | MySQL | 数据库 |
| 6379 | Redis | 缓存服务 |

---

## 二、开发环境部署

### 2.1 后端部署

```bash
# 1. 进入后端目录
cd ruoyi-im-api

# 2. 配置数据库连接
# 编辑 src/main/resources/application.yml
# 修改数据库连接信息、Redis连接信息

# 3. 初始化数据库
# 执行 sql/ 目录下的SQL脚本

# 4. 启动服务
# 方式1: IDE直接运行 ImApplication.java
# 方式2: Maven打包后运行
mvn clean package
java -jar target/ruoyi-im-api-1.0.0.jar
```

### 2.2 前端部署

```bash
# 1. 进入前端目录
cd ruoyi-im-web

# 2. 安装依赖
npm install

# 3. 启动开发服务器
npm run dev

# 访问: http://localhost:3000
```

### 2.3 验证部署

```bash
# 检查后端健康状态
curl http://localhost:8080/api/im/health

# 检查系统监控
curl http://localhost:8080/api/im/monitor/overview

# 访问API文档
# 浏览器打开: http://localhost:8080/swagger-ui.html
```

---

## 三、生产环境部署

### 3.1 数据库初始化

```bash
# 1. 创建数据库
mysql -u root -p
CREATE DATABASE im DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'im'@'%' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON im.* TO 'im'@'%';
FLUSH PRIVILEGES;

# 2. 导入表结构
mysql -u im -p im < sql/im_schema.sql

# 3. 导入初始数据（可选）
mysql -u im -p im < sql/im_data.sql
```

### 3.2 Redis配置

```bash
# 1. 编辑redis.conf
bind 0.0.0.0
requirepass your_redis_password
maxmemory 1gb
maxmemory-policy allkeys-lru

# 2. 启动Redis
redis-server /path/to/redis.conf
```

### 3.3 后端打包部署

```bash
# 1. 修改配置文件
# 编辑 src/main/resources/application.yml
# 设置: app.env: prod
# 修改数据库和Redis连接信息

# 2. 打包
mvn clean package -DskipTests

# 3. 启动服务
nohup java -jar \
  -Xms512m \
  -Xmx2g \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  target/ruoyi-im-api-1.0.0.jar \
  > logs/im-api.log 2>&1 &

# 4. 记录进程ID
echo $! > im-api.pid
```

### 3.4 前端构建部署

```bash
# 1. 构建生产版本
cd ruoyi-im-web
npm run build

# 2. 部署到Nginx
cp -r dist/* /path/to/nginx/html/

# 3. 配置Nginx
```

### 3.5 Nginx配置示例

```nginx
server {
    listen 80;
    server_name im.example.com;

    # 前端静态文件
    location / {
        root /path/to/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # API代理
    location /api/ {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket代理
    location /ws/ {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # 文件上传
    client_max_body_size 50m;
}
```

---

## 四、系统配置说明

### 4.1 后端核心配置

```yaml
# application.yml 关键配置项

# 环境配置
app:
  env: prod              # 运行环境
  security:
    enabled: true        # 生产环境必须启用认证

# 数据源连接池
spring.datasource.druid:
  initial-size: 5        # 初始连接数
  min-idle: 5           # 最小空闲连接
  max-active: 20        # 最大活跃连接

# Redis连接池
spring.redis.lettuce.pool:
  max-active: 20        # 最大连接数
  max-idle: 10          # 最大空闲连接
  min-idle: 0           # 最小空闲连接

# IM模块配置
im:
  jwt:
    secret: "your_base64_encoded_secret"  # JWT密钥（必须修改）
  message:
    maxLength: 2000     # 消息最大长度
    expireDays: 30      # 消息保留天数
    recallWindowSeconds: 120  # 消息撤回时间窗口
    encryption:
      enabled: true     # 启用消息加密
      key: "your_base64_encoded_key"  # 加密密钥（必须修改）
  file:
    maxSizeMb: 20       # 文件最大大小
    upload:
      path: uploads/    # 文件上传路径
```

### 4.2 前端环境变量

```javascript
// .env.production
VITE_APP_API_API=/api/
VITE_APP_WS_API=your-domain.com
```

---

## 五、运维操作

### 5.1 服务管理

```bash
# 启动服务
./start.sh

# 停止服务
./stop.sh

# 重启服务
./restart.sh

# 查看状态
./status.sh
```

### 5.2 日志管理

```bash
# 日志位置
logs/im-api.log          # 后端日志
logs/im-error.log        # 错误日志

# 查看实时日志
tail -f logs/im-api.log

# 搜索错误日志
grep -i error logs/im-api.log

# 日志切割（logback配置）
# 日志按天滚动，保留30天
```

### 5.3 数据备份

```bash
# 数据库备份
mysqldump -u im -p im > backup/im_$(date +%Y%m%d).sql

# 文件备份
tar -czf backup/uploads_$(date +%Y%m%d).tar.gz uploads/

# 定时备份（crontab）
# 每天凌晨2点备份
0 2 * * * /path/to/backup.sh
```

### 5.4 健康检查

```bash
# 基础健康检查
curl http://localhost:8080/api/im/health

# 详细健康检查
curl http://localhost:8080/api/im/health/detail

# 就绪探针
curl http://localhost:8080/api/im/health/readiness

# 存活探针
curl http://localhost:8080/api/im/health/liveness
```

### 5.5 监控指标

```bash
# 系统概览
curl http://localhost:8080/api/im/monitor/overview

# JVM内存
curl http://localhost:8080/api/im/monitor/memory

# 线程状态
curl http://localhost:8080/api/im/monitor/thread

# 类加载
curl http://localhost:8080/api/im/monitor/classloading
```

---

## 六、故障排查

### 6.1 常见问题

#### 问题1: WebSocket连接失败

**症状**: 前端无法建立WebSocket连接

**排查步骤**:
```bash
# 1. 检查后端服务状态
curl http://localhost:8080/api/im/health

# 2. 检查Nginx WebSocket代理配置
# 确认 proxy_set_header Upgrade 和 Connection 配置正确

# 3. 检查防火墙
netstat -tlnp | grep 8080
```

#### 问题2: 消息发送失败

**症状**: 消息发送后显示失败状态

**排查步骤**:
```bash
# 1. 检查Redis连接
redis-cli -a your_password ping

# 2. 查看重试记录
redis-cli -a your_password keys "message:retry:*"

# 3. 检查数据库连接
mysql -u im -p -e "SELECT 1"
```

#### 问题3: 文件上传失败

**症状**: 文件上传时返回错误

**排查步骤**:
```bash
# 1. 检查上传目录权限
ls -la uploads/

# 2. 检查文件大小限制
# Nginx: client_max_body_size
# Spring: spring.servlet.multipart.max-file-size

# 3. 检查磁盘空间
df -h
```

### 6.2 性能优化

#### JVM参数优化

```bash
# 推荐JVM参数（50人并发）
java -jar \
  -Xms512m \
  -Xmx2g \
  -XX:+UseG1GC \
  -XX:MaxGCPauseMillis=200 \
  -XX:+HeapDumpOnOutOfMemoryError \
  -XX:HeapDumpPath=/logs/heapdump.hprof \
  -Dfile.encoding=UTF-8 \
  ruoyi-im-api.jar
```

#### 数据库优化

```sql
-- 添加索引
CREATE INDEX idx_msg_conversation ON im_message(conversation_id);
CREATE INDEX idx_msg_sender ON im_message(sender_id);
CREATE INDEX INDEX_IDX_CONV_USER ON im_conversation_member(conversation_id, user_id);

-- 慢查询分析
SHOW VARIABLES LIKE 'slow_query%';
```

#### Redis优化

```bash
# 设置最大内存
maxmemory 1gb
maxmemory-policy allkeys-lru
```

---

## 七、安全建议

### 7.1 密码安全

- 修改所有默认密码
- JWT密钥必须使用强随机字符串
- Redis密码必须配置
- 数据库密码必须使用强密码

### 7.2 网络安全

- 生产环境关闭Swagger文档
- 配置防火墙规则
- 使用HTTPS加密传输
- 配置CORS白名单

### 7.3 数据安全

- 定期备份数据库
- 启用消息加密
- 敏感词过滤功能
- 操作日志审计

---

## 八、版本升级

### 8.1 升级流程

```bash
# 1. 备份数据
./backup.sh

# 2. 停止服务
./stop.sh

# 3. 更新代码
git pull origin main

# 4. 更新数据库
mysql -u im -p im < sql/upgrade_v1.9.sql

# 5. 重新构建
mvn clean package -DskipTests
cd ../ruoyi-im-web && npm run build

# 6. 启动服务
./start.sh

# 7. 验证升级
curl http://localhost:8080/api/im/health
```

### 8.2 回滚流程

```bash
# 1. 停止服务
./stop.sh

# 2. 恢复代码
git checkout tags/v1.8

# 3. 恢复数据库
mysql -u im -p im < backup/im_20260112.sql

# 4. 重新构建并启动
./start.sh
```

---

## 九、监控告警

### 9.1 推荐监控指标

| 指标 | 阈值 | 告警级别 |
|------|------|---------|
| 内存使用率 | > 80% | 警告 |
| CPU使用率 | > 80% | 警告 |
| 磁盘使用率 | > 85% | 严重 |
| WebSocket连接数 | > 100 | 警告 |
| API响应时间 | > 1000ms | 警告 |
| 错误率 | > 1% | 严重 |

### 9.2 日志监控

```bash
# 错误日志统计
grep -i "error" logs/im-api.log | wc -l

# WebSocket连接统计
grep "WebSocket连接成功" logs/im-api.log | wc -l

# 消息发送统计
grep "sendMessage" logs/im-api.log | wc -l
```

---

## 十、附录

### 10.1 目录结构

```
im/
├── ruoyi-im-api/          # 后端API服务
│   ├── src/              # 源码
│   ├── target/           # 编译输出
│   └── logs/             # 日志文件
├── ruoyi-im-web/          # 前端界面
│   ├── src/              # 源码
│   ├── dist/             # 构建输出
│   └── node_modules/     # 依赖
├── sql/                   # 数据库脚本
├── docs/                  # 文档
└── uploads/               # 文件上传目录
```

### 10.2 联系方式

- 技术支持: support@example.com
- 问题反馈: https://github.com/example/im/issues

---

**文档版本**: v1.0
**最后更新**: 2026-01-13
