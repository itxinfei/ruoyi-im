# IM系统部署架构说明

## 项目概述

IM系统由两个独立项目组成，共享同一个数据库：

### 1. ruoyi-im-api（核心API）
- **部署位置**：公网云服务器
- **面向用户**：终端用户（移动端、Web端）
- **主要功能**：
  - 用户认证与授权
  - 实时消息收发（WebSocket）
  - 会话管理
  - 好友管理
  - 消息推送
- **网络访问**：公网访问，需要高可用性
- **性能要求**：高并发、低延迟

### 2. ruoyi-im-admin（管理后台）
- **部署位置**：内网服务器
- **面向用户**：系统管理员
- **主要功能**：
  - 用户管理
  - 会话监控
  - 消息审计
  - 数据统计
  - 系统配置
- **网络访问**：内网访问，安全性优先
- **性能要求**：稳定性、数据完整性

## 数据库架构

### 数据库部署
- **部署位置**：内网服务器
- **数据库类型**：MySQL 5.7.44
- **访问方式**：
  - ruoyi-im-api 通过内网专线或VPN访问数据库
  - ruoyi-im-admin 直接访问数据库
- **安全策略**：
  - 数据库仅允许内网IP访问
  - 使用SSL加密连接
  - 定期备份数据

### 数据库设计原则
1. **统一数据源**：两个项目共享同一数据库，确保数据一致性
2. **权限隔离**：使用不同的数据库用户，权限最小化
3. **数据安全**：敏感数据加密存储（如密码、消息内容）
4. **性能优化**：针对两个项目的不同查询需求优化索引

## 网络架构

```
┌─────────────────────────────────────────────────────────┐
│                        公网                              │
│  ┌─────────────────────────────────────────────────┐  │
│  │         ruoyi-im-api（云服务器）                  │  │
│  │  - 用户认证                                       │  │
│  │  - 实时消息（WebSocket）                          │  │
│  │  - 会话管理                                       │  │
│  └─────────────────────────────────────────────────┘  │
│                          │                              │
│                          │ 内网专线/VPN                 │
│                          ▼                              │
└─────────────────────────────────────────────────────────┘
                    ┌───────────────────────┐
                    │      内网环境          │
                    │                       │
                    │  ┌─────────────────┐  │
                    │  │  MySQL 5.7.44   │  │
                    │  │  （内网数据库）  │  │
                    │  └─────────────────┘  │
                    │           ▲           │
                    │           │           │
                    │  ┌─────────────────┐  │
                    │  │ ruoyi-im-admin  │  │
                    │  │  （管理后台）    │  │
                    │  └─────────────────┘  │
                    │                       │
                    └───────────────────────┘
```

## 数据库用户权限设计

### ruoyi-im-api 用户权限
- **用户名**：im_api
- **权限范围**：
  - im_user: SELECT, INSERT, UPDATE
  - im_conversation: SELECT, INSERT, UPDATE
  - im_conversation_member: SELECT, INSERT, UPDATE, DELETE
  - im_message: SELECT, INSERT, UPDATE
  - im_friend: SELECT, INSERT, UPDATE, DELETE
  - im_group: SELECT, INSERT, UPDATE
  - im_group_member: SELECT, INSERT, UPDATE, DELETE
- **限制**：无DROP、TRUNCATE、DELETE全表权限

### ruoyi-im-admin 用户权限
- **用户名**：im_admin
- **权限范围**：
  - 所有表: SELECT, INSERT, UPDATE, DELETE
  - im_session（管理视图）: SELECT, UPDATE
- **权限**：包含数据管理权限，但无DDL权限

## 数据同步策略

### 实时数据同步
- **消息数据**：通过数据库触发器或应用层逻辑同步
- **在线状态**：使用Redis缓存，定期同步到数据库
- **会话状态**：通过im_conversation_member表实时更新

### 统计数据同步
- **消息统计**：定时任务汇总，写入统计表
- **用户活跃度**：每日统计任务更新
- **系统监控**：实时监控数据写入监控表

## 安全考虑

### 网络安全
1. 数据库仅允许内网IP访问
2. 使用VPN或专线连接云服务器和内网
3. 定期更新防火墙规则

### 数据安全
1. 密码使用BCrypt加密存储
2. 敏感消息内容加密
3. 定期数据库备份
4. 操作日志审计

### 应用安全
1. API接口使用JWT认证
2. 管理后台使用Spring Security
3. SQL注入防护
4. XSS防护

## 性能优化

### 数据库优化
1. 读写分离：主库写入，从库读取
2. 分库分表：按用户ID分片
3. 索引优化：针对高频查询优化索引
4. 缓存策略：Redis缓存热点数据

### 应用优化
1. 连接池配置：合理设置连接池大小
2. 异步处理：消息推送使用异步队列
3. 负载均衡：多实例部署
4. CDN加速：静态资源使用CDN

## 监控与运维

### 监控指标
1. 数据库性能：QPS、慢查询、连接数
2. 应用性能：响应时间、错误率、并发数
3. 系统资源：CPU、内存、磁盘、网络

### 日志管理
1. 应用日志：统一收集到ELK
2. 数据库日志：慢查询日志、错误日志
3. 操作日志：用户操作、管理员操作

### 备份策略
1. 数据库备份：每日全量备份，每小时增量备份
2. 文件备份：用户上传文件定期备份
3. 配置备份：应用配置文件版本控制

## 扩展性考虑

### 水平扩展
1. 应用服务器：支持多实例部署
2. 数据库：支持分库分表
3. 缓存：支持Redis集群

### 垂直扩展
1. 服务器升级：增加CPU、内存
2. 数据库优化：增加缓存、优化查询
3. 网络优化：增加带宽

## 灾备方案

### 数据灾备
1. 异地备份：定期同步到异地服务器
2. 数据恢复：定期演练数据恢复流程
3. 故障切换：主从切换方案

### 应用灾备
1. 多机房部署：避免单点故障
2. 负载均衡：自动故障转移
3. 容灾演练：定期演练容灾流程
