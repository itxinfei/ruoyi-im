# RuoYi-IM Java API 完善计划

> 参考野火IM架构设计，逐步完善Java后端代码  
> 版本: v1.0  
> 创建时间: 2026-02-05

---

## 执行进度总览

| 阶段 | 模块 | 状态 | 预计工时 | 实际工时 |
|------|------|------|----------|----------|
| Phase 1 | 消息同步机制 | 🟡 进行中 | 4h | - |
| Phase 2 | 离线消息队列 | ⚪ 待开始 | 3h | - |
| Phase 3 | 多端设备管理 | ⚪ 待开始 | 3h | - |
| Phase 4 | WebSocket ACK | ⚪ 待开始 | 2h | - |
| Phase 5 | 会话同步 | ⚪ 待开始 | 2h | - |
| Phase 6 | 群组完善 | ⚪ 待开始 | 3h | - |
| Phase 7 | 代码审查优化 | ⚪ 待开始 | 2h | - |

---

## Phase 1: 消息同步机制（当前进行中）

### 1.1 设计目标
实现野火IM风格的消息同步协议，支持：
- 客户端断线重连后自动同步遗漏消息
- 多端消息状态同步（已读、撤回等）
- 同步点管理，避免重复推送

### 1.2 涉及文件

**后端:**
- Service: `ImMessageSyncService.java` (新建)
- ServiceImpl: `ImMessageSyncServiceImpl.java` (新建)
- Entity: `ImUserSyncPoint.java` (新建)
- Mapper: `ImUserSyncPointMapper.java` (新建)
- Controller: `ImMessageController.java` (修改 - 添加同步接口)
- WebSocket: `ImWebSocketEndpoint.java` (修改 - 连接时同步)

**数据库:**
- 新建表: `im_user_sync_point` (用户同步点表)

### 1.3 数据库设计

```sql
-- 用户消息同步点表
CREATE TABLE im_user_sync_point (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    device_id VARCHAR(64) NOT NULL COMMENT '设备ID',
    last_sync_time BIGINT NOT NULL DEFAULT 0 COMMENT '最后同步时间戳(毫秒)',
    last_message_id BIGINT DEFAULT 0 COMMENT '最后同步消息ID',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_user_device (user_id, device_id),
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户消息同步点表';
```

### 1.4 接口设计

```java
/**
 * 同步消息接口
 * GET /api/im/message/sync
 * 
 * @param lastSyncTime 上次同步时间戳（毫秒）
 * @param limit 单次同步最大条数（默认100）
 * @return 消息列表 + 新的同步点
 */
Result<SyncMessageResponse> syncMessages(
    @RequestParam Long lastSyncTime, 
    @RequestParam(defaultValue = "100") Integer limit
);
```

### 1.5 核心流程

```
1. 用户WebSocket连接成功
   ↓
2. 获取用户设备同步点
   ↓
3. 查询该同步点之后的新消息
   ↓
4. 推送消息到客户端
   ↓
5. 更新同步点
```

### 1.6 验收标准
- [ ] 用户断线重连后能自动同步遗漏消息
- [ ] 同步点正确更新，不会重复推送
- [ ] 支持分页同步，避免一次性推送过多消息
- [ ] 单元测试覆盖主要场景

---

## Phase 2: 离线消息队列

### 2.1 设计目标
- 用户离线时保存消息
- 用户上线后推送离线消息
- 支持离线消息拉取确认

### 2.2 涉及文件
- Service: `IOfflineMessageService.java` (新建)
- ServiceImpl: `OfflineMessageServiceImpl.java` (新建)
- Entity: `ImOfflineMessage.java` (新建)
- Mapper: `ImOfflineMessageMapper.java` (新建)

### 2.3 数据库设计

```sql
-- 离线消息表
CREATE TABLE im_offline_message (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '接收用户ID',
    message_id BIGINT NOT NULL COMMENT '消息ID',
    message_data JSON NOT NULL COMMENT '消息内容(JSON)',
    status TINYINT DEFAULT 0 COMMENT '0=未拉取 1=已拉取 2=已删除',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    pull_time DATETIME COMMENT '拉取时间',
    INDEX idx_user_status (user_id, status),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='离线消息表';
```

---

## Phase 3: 多端设备管理

### 3.1 设计目标
- 管理用户多设备登录
- 支持设备在线状态查询
- 消息推送到所有在线设备

### 3.2 涉及文件
- Service: `ImDeviceService.java` (新建)
- Entity: `ImUserDevice.java` (新建)
- WebSocket: 修改连接管理逻辑

---

## Phase 4: WebSocket ACK机制

### 4.1 设计目标
- 消息发送确认（Server → Client）
- 消息接收确认（Client → Server）
- 消息已读确认

### 4.2 ACK类型
- `DELIVER_ACK`: 消息已送达服务器
- `READ_ACK`: 消息已被阅读
- `RECEIVE_ACK`: 消息已送达客户端

---

## Phase 5: 会话同步

### 5.1 设计目标
- 会话列表同步
- 会话设置同步（置顶、免打扰等）
- 会话删除同步

---

## Phase 6: 群组功能完善

### 6.1 待完善功能
- 群成员权限细粒度控制
- 群设置持久化和同步
- 群公告已读状态
- 群文件管理优化

---

## Phase 7: 代码审查优化

### 7.1 规范检查
- [ ] 所有Service接口有JavaDoc
- [ ] 所有Controller方法有Swagger注解
- [ ] 无Java 9+语法
- [ ] 无硬编码密码
- [ ] MyBatis-Plus使用Lambda查询

### 7.2 性能优化
- [ ] SQL查询添加索引
- [ ] 大表分页查询优化
- [ ] Redis缓存合理使用

---

## 当前执行任务

**正在执行**: Phase 1 - 消息同步机制

**下一步**: 创建数据库表 + 编写SyncService

**预计完成**: 2026-02-05

---

## 变更记录

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| v1.0 | 2026-02-05 | 初始版本，创建完善计划 |
