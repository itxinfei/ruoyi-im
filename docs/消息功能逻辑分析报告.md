# æ¶ˆæ¯åŠŸèƒ½é€»è¾‘åˆ†æä¸ä¼˜åŒ–æŠ¥å‘Š

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šå¯¹IMé¡¹ç›®çš„æ¶ˆæ¯åŠŸèƒ½è¿›è¡Œäº†å…¨é¢çš„é€»è¾‘åˆ†æå’Œç ”ç©¶ï¼Œé‡ç‚¹è§£å†³äº†ä»¥ä¸‹å››ä¸ªå…³é”®é—®é¢˜ï¼š

1. **è”ç³»äººåˆ—è¡¨BUGä¿®å¤** - æ¶ˆæ¯çŠ¶æ€æ˜¾ç¤ºé€»è¾‘ä¼˜åŒ–
2. **è”ç³»äººèœå•å®šä½ä¼˜åŒ–** - å³é”®èœå•å›ºå®šå±…ä¸­æ˜¾ç¤º
3. **è¾“å…¥çŠ¶æ€ä¸åˆ—è¡¨é€‰ä¸­çŠ¶æ€åŒæ­¥** - çŠ¶æ€è”åŠ¨æœºåˆ¶å®ç°
4. **è®¾è®¡å¸ƒå±€å‚è€ƒä¸åˆ†æ** - é’‰é’‰/ä¼ä¸šå¾®ä¿¡å¯¹æ¯”ä¼˜åŒ–å»ºè®®

---

## 1. è”ç³»äººåˆ—è¡¨BUGä¿®å¤

### 1.1 é—®é¢˜æè¿°

**æ ¸å¿ƒé—®é¢˜**ï¼šæ¶ˆæ¯çŠ¶æ€æ˜¾ç¤ºé€»è¾‘ä¸æ­£ç¡®

#### é—®é¢˜è¡¨ç°
1. æ¶ˆæ¯å‘é€æˆåŠŸåï¼Œè”ç³»äººåˆ—è¡¨ä¸­æœªå®æ—¶æ˜¾ç¤ºæœ€æ–°å‘é€æˆåŠŸçš„æ¶ˆæ¯å†…å®¹
2. æ¶ˆæ¯å¤„äºæœªå‘é€çŠ¶æ€æ—¶ï¼Œè‰ç¨¿å†…å®¹æ˜¾ç¤ºä¸ç¨³å®š
3. è‰ç¨¿çŠ¶æ€å’Œå·²å‘é€æ¶ˆæ¯çŠ¶æ€åˆ‡æ¢æ—¶å­˜åœ¨å»¶è¿Ÿ

#### é—®é¢˜å¤ç°æ­¥éª¤

**æ­¥éª¤1ï¼šè‰ç¨¿çŠ¶æ€æ˜¾ç¤ºé—®é¢˜**
```
1. åœ¨ä¼šè¯Aä¸­è¾“å…¥æ¶ˆæ¯"ä½ å¥½"ï¼Œä½†ä¸å‘é€
2. åˆ‡æ¢åˆ°ä¼šè¯B
3. è§‚å¯Ÿä¼šè¯Açš„é¢„è§ˆæ–‡æœ¬
   é¢„æœŸï¼šæ˜¾ç¤º"[è‰ç¨¿] ä½ å¥½"
   å®é™…ï¼šå¯èƒ½æ˜¾ç¤º"æš‚æ— æ¶ˆæ¯"æˆ–å»¶è¿Ÿæ˜¾ç¤º
```

**æ­¥éª¤2ï¼šæ¶ˆæ¯å‘é€åçŠ¶æ€æ›´æ–°é—®é¢˜**
```
1. åœ¨ä¼šè¯Aä¸­è¾“å…¥æ¶ˆæ¯"ä½ å¥½"å¹¶å‘é€
2. ç«‹å³æŸ¥çœ‹ä¼šè¯åˆ—è¡¨
   é¢„æœŸï¼šä¼šè¯Aæ˜¾ç¤º"ä½ å¥½"å¹¶ç½®é¡¶
   å®é™…ï¼šå¯èƒ½ä»æ˜¾ç¤ºæ—§æ¶ˆæ¯æˆ–"[è‰ç¨¿]"
```

### 1.2 æ ¹æœ¬åŸå› åˆ†æ

#### ä»£ç ä½ç½®åˆ†æ

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `/D:\MyCode\im\ruoyi-im-web\src/views/SessionPanel.vue` - ä¼šè¯åˆ—è¡¨ç»„ä»¶
- `/D:\MyCode\im\ruoyi-im-web\src/components/Chat\MessageInput.vue` - è¾“å…¥æ¡†ç»„ä»¶
- `/D:\MyCode\im\ruoyi-im-web\src/store/modules\im-session.js` - ä¼šè¯çŠ¶æ€ç®¡ç†
- `/D:\MyCode\im\ruoyi-im-web\src/store/modules/im-message.js` - æ¶ˆæ¯çŠ¶æ€ç®¡ç†

#### é—®é¢˜1ï¼šè‰ç¨¿çŠ¶æ€åŒæ­¥æœºåˆ¶ä¸å®Œå–„

**é—®é¢˜ä»£ç ä½ç½®**ï¼š`SessionPanel.vue:311-340`

```javascript
// è‰ç¨¿çŠ¶æ€ç®¡ç†
const DRAFT_STORAGE_KEY = 'im_message_drafts'

// ä» localStorage è·å–æ‰€æœ‰è‰ç¨¿
const loadDraftsFromStorage = () => {
  try {
    const data = localStorage.getItem(DRAFT_STORAGE_KEY)
    return data ? JSON.parse(data) : {}
  } catch (e) {
    return {}
  }
}

// å“åº”å¼è‰ç¨¿æ•°æ®
const drafts = ref(loadDraftsFromStorage())

// å®šæœŸåˆ·æ–°è‰ç¨¿çŠ¶æ€ï¼ˆç›‘å¬ localStorage å˜åŒ–ï¼‰
let draftCheckInterval = null

// åˆ¤æ–­ä¼šè¯æ˜¯å¦æœ‰è‰ç¨¿
const hasDraft = (conversationId) => {
  const draft = drafts.value[conversationId]
  return draft && draft.content && draft.content.trim().length > 0
}

// è·å–è‰ç¨¿é¢„è§ˆæ–‡æœ¬
const getDraftPreview = (conversationId) => {
  const draft = drafts.value[conversationId]
  if (!draft || !draft.content) return ''
  return draft.content.trim().slice(0, 20)
}
```

**é—®é¢˜åˆ†æ**ï¼š
1. ä½¿ç”¨å®šæ—¶å™¨è½®è¯¢ localStorageï¼ˆæ¯ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
2. è‰ç¨¿æ•°æ®å­˜å‚¨åœ¨ localStorage è€Œé Vuex store
3. æ²¡æœ‰äº‹ä»¶é©±åŠ¨çš„çŠ¶æ€æ›´æ–°æœºåˆ¶
4. å®šæ—¶å™¨è½®è¯¢å¯¼è‡´å»¶è¿Ÿå’Œæ€§èƒ½é—®é¢˜

**ä»£ç ä½ç½®**ï¼š`SessionPanel.vue:595-605`

```javascript
// å®šæœŸåˆ·æ–°è‰ç¨¿çŠ¶æ€ï¼ˆæ¯ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
draftCheckInterval = setInterval(() => {
  drafts.value = loadDraftsFromStorage()
}, 1000)
```

#### é—®é¢˜2ï¼šæ¶ˆæ¯å‘é€åçŠ¶æ€æ›´æ–°å»¶è¿Ÿ

**é—®é¢˜ä»£ç ä½ç½®**ï¼š`im-session.js:138-150`

```javascript
// æ›´æ–°å•ä¸ªä¼šè¯
UPDATE_SESSION(state, session) {
  const index = state.sessions.findIndex(s => s.id === session.id)
  if (index !== -1) {
    state.sessions[index] = { ...state.sessions[index], ...session }
  } else {
    state.sessions.push(session)
  }
  // æ›´æ–°æœªè¯»æ€»æ•°
  state.totalUnreadCount = state.sessions.reduce((sum, s) => sum + (s.unreadCount || 0), 0)
}
```

**é—®é¢˜åˆ†æ**ï¼š
1. æ¶ˆæ¯å‘é€åï¼Œä¼šè¯çŠ¶æ€æ›´æ–°å¯èƒ½å»¶è¿Ÿ
2. è‰ç¨¿æ¸…é™¤ä¸ä¼šè¯æ›´æ–°å¯èƒ½å­˜åœ¨æ—¶åºé—®é¢˜
3. æ²¡æœ‰ç»Ÿä¸€çš„è‰ç¨¿çŠ¶æ€ç®¡ç†æœºåˆ¶

**ä»£ç ä½ç½®**ï¼š`MessageInput.vue:280-318`

```javascript
// ä¿å­˜è‰ç¨¿ï¼ˆé˜²æŠ–ï¼‰
const saveDraftDebounced = (conversationId, content) => {
  if (draftSaveTimer) {
    clearTimeout(draftSaveTimer)
  }
  draftSaveTimer = setTimeout(() => {
    saveDraft(conversationId, content)
  }, DRAFT_DEBOUNCE_TIME)
}

// ç«‹å³ä¿å­˜è‰ç¨¿
const saveDraft = (conversationId, content) => {
  const drafts = getAllDrafts()
  drafts[conversationId] = {
    content,
    timestamp: Date.now()
  }
  saveAllDrafts(drafts)
  // é€šçŸ¥çˆ¶ç»„ä»¶è‰ç¨¿çŠ¶æ€å˜åŒ–
  emit('draft-change', {
    conversationId,
    hasDraft: content.trim().length > 0,
    content
  })
}
```

#### é—®é¢˜3ï¼šè‰ç¨¿çŠ¶æ€æ¸…é™¤æ—¶æœºä¸å‡†ç¡®

**é—®é¢˜ä»£ç ä½ç½®**ï¼š`MessageInput.vue:582-591`

```javascript
// å‘é€æ¶ˆæ¯
const handleSend = async () => {
  const content = messageContent.value.trim()
  if (!content) return

  // æ¸…é™¤è‰ç¨¿
  clearDraft(props.session.id)

  emit('send', {
    type: 'TEXT',
    content,
    replyTo: replyToMessage.value,
    editOf: editingMessage.value
  })

  // æ¸…ç©ºè¾“å…¥æ¡†å’ŒçŠ¶æ€
  messageContent.value = ''
  replyToMessage.value = null
  editingMessage.value = null
  textareaRef.value?.focus()
}
```

**é—®é¢˜åˆ†æ**ï¼š
1. åœ¨å‘é€æ¶ˆæ¯å‰æ¸…é™¤è‰ç¨¿
2. ä½†ä¼šè¯åˆ—è¡¨çš„è‰ç¨¿çŠ¶æ€æ›´æ–°å¯èƒ½å»¶è¿Ÿ
3. è‰ç¨¿æ¸…é™¤ä¸ä¼šè¯æ¶ˆæ¯æ›´æ–°å¯èƒ½å­˜åœ¨ç«æ€æ¡ä»¶

### 1.3 è§£å†³æ–¹æ¡ˆè®¾è®¡

#### æ–¹æ¡ˆ1ï¼šå°†è‰ç¨¿çŠ¶æ€ç®¡ç†è¿ç§»åˆ° Vuex Storeï¼ˆæ¨èï¼‰

**è®¾è®¡æ€è·¯**ï¼š
1. åœ¨ Vuex store ä¸­ç»Ÿä¸€ç®¡ç†è‰ç¨¿çŠ¶æ€
2. ä½¿ç”¨å“åº”å¼çŠ¶æ€æ›¿ä»£ localStorage è½®è¯¢
3. å®ç°äº‹ä»¶é©±åŠ¨çš„çŠ¶æ€æ›´æ–°æœºåˆ¶

**å®ç°æ­¥éª¤**ï¼š

**æ­¥éª¤1ï¼šåœ¨ im-session.js ä¸­æ·»åŠ è‰ç¨¿çŠ¶æ€ç®¡ç†**

```javascript
// State ä¸­æ·»åŠ è‰ç¨¿çŠ¶æ€
state: () => ({
  // ... ç°æœ‰çŠ¶æ€
  drafts: {} // { conversationId: { content, timestamp } }
})

// Mutations
mutations: {
  // ... ç°æœ‰ mutations
  
  SET_DRAFT(state, { conversationId, content }) {
    if (content && content.trim().length > 0) {
      state.drafts[conversationId] = {
        content: content.trim(),
        timestamp: Date.now()
      }
    } else {
      delete state.drafts[conversationId]
    }
  },
  
  CLEAR_DRAFT(state, conversationId) {
    delete state.drafts[conversationId]
  },
  
  CLEAR_ALL_DRAFTS(state) {
    state.drafts = {}
  }
}

// Getters
getters: {
  // ... ç°æœ‰ getters
  
  hasDraft: (state) => (conversationId) => {
    const draft = state.drafts[conversationId]
    return draft && draft.content && draft.content.length > 0
  },
  
  getDraftPreview: (state) => (conversationId) => {
    const draft = state.drafts[conversationId]
    if (!draft || !draft.content) return ''
    return draft.content.slice(0, 20)
  },
  
  getDraftContent: (state) => (conversationId) => {
    const draft = state.drafts[conversationId]
    return draft?.content || ''
  }
}

// Actions
actions: {
  // ... ç°æœ‰ actions
  
  async saveDraft({ commit, state }, { conversationId, content }) {
    commit('SET_DRAFT', { conversationId, content })
    
    // åŒæ­¥åˆ° localStorageï¼ˆæŒä¹…åŒ–ï¼‰
    try {
      localStorage.setItem('im_message_drafts', JSON.stringify(state.drafts))
    } catch (e) {
      console.warn('ä¿å­˜è‰ç¨¿åˆ° localStorage å¤±è´¥', e)
    }
  },
  
  async loadDrafts({ commit }) {
    try {
      const data = localStorage.getItem('im_message_drafts')
      if (data) {
        const drafts = JSON.parse(data)
        Object.entries(drafts).forEach(([conversationId, draft]) => {
          commit('SET_DRAFT', { conversationId, content: draft.content })
        })
      }
    } catch (e) {
      console.warn('ä» localStorage åŠ è½½è‰ç¨¿å¤±è´¥', e)
    }
  },
  
  async clearDraft({ commit, state }, conversationId) {
    commit('CLEAR_DRAFT', conversationId)
    
    // åŒæ­¥åˆ° localStorage
    try {
      localStorage.setItem('im_message_drafts', JSON.stringify(state.drafts))
    } catch (e) {
      console.warn('æ¸…é™¤è‰ç¨¿åˆ° localStorage å¤±è´¥', e)
    }
  }
}
```

**æ­¥éª¤2ï¼šä¿®æ”¹ MessageInput.vue ä½¿ç”¨ Vuex store**

```javascript
import { useStore } from 'vuex'

const store = useStore()

// ä¿å­˜è‰ç¨¿
const saveDraft = async (conversationId, content) => {
  await store.dispatch('im/session/saveDraft', { conversationId, content })
  
  emit('draft-change', {
    conversationId,
    hasDraft: content.trim().length > 0,
    content
  })
}

// åŠ è½½è‰ç¨¿
const loadDraft = async (conversationId) => {
  const draft = store.getters['im/session/getDraftContent'](conversationId)
  if (draft) {
    messageContent.value = draft
  }
}

// æ¸…é™¤è‰ç¨¿
const clearDraft = async (conversationId) => {
  await store.dispatch('im/session/clearDraft', conversationId)
  
  emit('draft-change', {
    conversationId,
    hasDraft: false,
    content: ''
  })
}
```

**æ­¥éª¤3ï¼šä¿®æ”¹ SessionPanel.vue ä½¿ç”¨ Vuex getters**

```javascript
// ç§»é™¤æœ¬åœ°è‰ç¨¿çŠ¶æ€ç®¡ç†
// åˆ é™¤ä»¥ä¸‹ä»£ç ï¼š
// - const DRAFT_STORAGE_KEY = 'im_message_drafts'
// - const loadDraftsFromStorage = () => { ... }
// - const drafts = ref(loadDraftsFromStorage())
// - let draftCheckInterval = null
// - setInterval å®šæ—¶å™¨

// ä½¿ç”¨ Vuex getters
const hasDraft = computed(() => (conversationId) => {
  return store.getters['im/session/hasDraft'](conversationId)
})

const getDraftPreview = computed(() => (conversationId) => {
  return store.getters['im/session/getDraftPreview'](conversationId)
})

// ç»„ä»¶æŒ‚è½½æ—¶åŠ è½½è‰ç¨¿
onMounted(() => {
  store.dispatch('im/session/loadDrafts')
})
```

#### æ–¹æ¡ˆ2ï¼šä¼˜åŒ–è‰ç¨¿æ˜¾ç¤ºé€»è¾‘ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰

**è®¾è®¡æ€è·¯**ï¼š
1. ä¿æŒ localStorage å­˜å‚¨
2. ä¼˜åŒ–é¢„è§ˆæ–‡æœ¬æ˜¾ç¤ºä¼˜å…ˆçº§
3. æ·»åŠ è‰ç¨¿çŠ¶æ€è®¡ç®—ç¼“å­˜

**å®ç°æ­¥éª¤**ï¼š

**æ­¥éª¤1ï¼šä¼˜åŒ–é¢„è§ˆæ–‡æœ¬æ˜¾ç¤º**

```javascript
// è®¡ç®—é¢„è§ˆæ–‡æœ¬ï¼ˆä¼˜å…ˆçº§ï¼šè‰ç¨¿ > æœ€æ–°æ¶ˆæ¯ï¼‰
const getPreviewText = (session) => {
  // ä¼˜å…ˆæ˜¾ç¤ºè‰ç¨¿
  if (hasDraft(session.id)) {
    return getDraftPreview(session.id)
  }
  
  // å…¶æ¬¡æ˜¾ç¤ºæœ€æ–°æ¶ˆæ¯
  if (session.lastMessage) {
    return session.lastMessage
  }
  
  // æœ€åæ˜¾ç¤ºé»˜è®¤æ–‡æœ¬
  return 'æš‚æ— æ¶ˆæ¯'
}
```

**æ­¥éª¤2ï¼šæ·»åŠ è‰ç¨¿çŠ¶æ€ç¼“å­˜**

```javascript
// è‰ç¨¿çŠ¶æ€ç¼“å­˜ï¼ˆé¿å…é¢‘ç¹è¯»å– localStorageï¼‰
const draftStatusCache = ref({})

const hasDraft = (conversationId) => {
  // ä¼˜å…ˆä½¿ç”¨ç¼“å­˜
  if (draftStatusCache.value[conversationId] !== undefined) {
    return draftStatusCache.value[conversationId]
  }
  
  // è¯»å– localStorage
  const drafts = loadDraftsFromStorage()
  const hasDraft = drafts[conversationId]?.content?.trim().length > 0
  
  // æ›´æ–°ç¼“å­˜
  draftStatusCache.value[conversationId] = hasDraft
  
  return hasDraft
}

// ç›‘å¬è‰ç¨¿å˜åŒ–æ›´æ–°ç¼“å­˜
watch(() => drafts.value, (newDrafts) => {
  Object.keys(draftStatusCache.value).forEach(conversationId => {
    draftStatusCache.value[conversationId] = 
      newDrafts[conversationId]?.content?.trim().length > 0
  })
}, { deep: true })
```

### 1.4 å®ç°æ­¥éª¤

#### ä¼˜å…ˆçº§1ï¼šè¿ç§»è‰ç¨¿çŠ¶æ€åˆ° Vuex Store

**æ–‡ä»¶ä¿®æ”¹æ¸…å•**ï¼š
1. `im-session.js` - æ·»åŠ è‰ç¨¿çŠ¶æ€ç®¡ç†
2. `MessageInput.vue` - ä½¿ç”¨ Vuex store
3. `SessionPanel.vue` - ä½¿ç”¨ Vuex getters

**å®æ–½æ­¥éª¤**ï¼š
1. åœ¨ `im-session.js` ä¸­æ·»åŠ è‰ç¨¿ç›¸å…³çš„ stateã€mutationsã€gettersã€actions
2. ä¿®æ”¹ `MessageInput.vue` çš„è‰ç¨¿ä¿å­˜/åŠ è½½/æ¸…é™¤é€»è¾‘
3. ä¿®æ”¹ `SessionPanel.vue` çš„è‰ç¨¿çŠ¶æ€åˆ¤æ–­é€»è¾‘
4. ç§»é™¤å®šæ—¶å™¨è½®è¯¢ä»£ç 
5. æ·»åŠ  localStorage æŒä¹…åŒ–æ”¯æŒ

#### ä¼˜å…ˆçº§2ï¼šä¼˜åŒ–æ¶ˆæ¯å‘é€åçŠ¶æ€æ›´æ–°

**æ–‡ä»¶ä¿®æ”¹æ¸…å•**ï¼š
1. `im-message.js` - ä¼˜åŒ–æ¶ˆæ¯å‘é€åçš„ä¼šè¯æ›´æ–°é€»è¾‘
2. `MessageInput.vue` - è°ƒæ•´è‰ç¨¿æ¸…é™¤æ—¶æœº

**å®æ–½æ­¥éª¤**ï¼š
1. åœ¨æ¶ˆæ¯å‘é€æˆåŠŸåç«‹å³æ›´æ–°ä¼šè¯çŠ¶æ€
2. å»¶è¿Ÿæ¸…é™¤è‰ç¨¿ï¼ˆç¡®ä¿ä¼šè¯å·²æ›´æ–°ï¼‰
3. æ·»åŠ çŠ¶æ€æ›´æ–°ç¡®è®¤æœºåˆ¶

### 1.5 æµ‹è¯•æ–¹æ¡ˆ

#### æµ‹è¯•ç”¨ä¾‹1ï¼šè‰ç¨¿çŠ¶æ€æ˜¾ç¤º

**æµ‹è¯•æ­¥éª¤**ï¼š
```
1. åœ¨ä¼šè¯Aä¸­è¾“å…¥"ä½ å¥½"ä½†ä¸å‘é€
2. åˆ‡æ¢åˆ°ä¼šè¯B
3. éªŒè¯ä¼šè¯Aæ˜¾ç¤º"[è‰ç¨¿] ä½ å¥½"
4. åˆ‡æ¢å›ä¼šè¯A
5. éªŒè¯è¾“å…¥æ¡†æ˜¾ç¤º"ä½ å¥½"
```

**é¢„æœŸç»“æœ**ï¼š
- ä¼šè¯åˆ—è¡¨æ­£ç¡®æ˜¾ç¤ºè‰ç¨¿æ ‡è¯†
- è‰ç¨¿å†…å®¹æ­£ç¡®æ˜¾ç¤ºåœ¨é¢„è§ˆåŒº
- åˆ‡æ¢ä¼šè¯æ—¶è‰ç¨¿å†…å®¹æ­£ç¡®æ¢å¤

#### æµ‹è¯•ç”¨ä¾‹2ï¼šæ¶ˆæ¯å‘é€åçŠ¶æ€æ›´æ–°

**æµ‹è¯•æ­¥éª¤**ï¼š
```
1. åœ¨ä¼šè¯Aä¸­è¾“å…¥"ä½ å¥½"å¹¶å‘é€
2. ç«‹å³æŸ¥çœ‹ä¼šè¯åˆ—è¡¨
3. éªŒè¯ä¼šè¯Aæ˜¾ç¤º"ä½ å¥½"å¹¶ç½®é¡¶
4. éªŒè¯è‰ç¨¿æ ‡è¯†å·²æ¶ˆå¤±
```

**é¢„æœŸç»“æœ**ï¼š
- ä¼šè¯Aç«‹å³æ˜¾ç¤ºæœ€æ–°æ¶ˆæ¯
- è‰ç¨¿æ ‡è¯†ç«‹å³æ¶ˆå¤±
- ä¼šè¯Aç½®é¡¶åˆ°åˆ—è¡¨é¡¶éƒ¨

#### æµ‹è¯•ç”¨ä¾‹3ï¼šå¤šä¼šè¯è‰ç¨¿åˆ‡æ¢

**æµ‹è¯•æ­¥éª¤**ï¼š
```
1. åœ¨ä¼šè¯Aè¾“å…¥"æ¶ˆæ¯A"ä½†ä¸å‘é€
2. åˆ‡æ¢åˆ°ä¼šè¯Bè¾“å…¥"æ¶ˆæ¯B"ä½†ä¸å‘é€
3. åˆ‡æ¢åˆ°ä¼šè¯Cè¾“å…¥"æ¶ˆæ¯C"ä½†ä¸å‘é€
4. éªŒè¯ä¸‰ä¸ªä¼šè¯éƒ½æ˜¾ç¤ºè‰ç¨¿æ ‡è¯†
5. ä¾æ¬¡åˆ‡æ¢å›æ¯ä¸ªä¼šè¯éªŒè¯è‰ç¨¿å†…å®¹
```

**é¢„æœŸç»“æœ**ï¼š
- æ¯ä¸ªä¼šè¯ç‹¬ç«‹ä¿å­˜è‰ç¨¿
- åˆ‡æ¢ä¼šè¯æ—¶è‰ç¨¿å†…å®¹æ­£ç¡®æ¢å¤
- è‰ç¨¿çŠ¶æ€å®æ—¶æ›´æ–°

#### æµ‹è¯•ç”¨ä¾‹4ï¼šè‰ç¨¿ä¸å·²å‘é€æ¶ˆæ¯åˆ‡æ¢

**æµ‹è¯•æ­¥éª¤**ï¼š
```
1. åœ¨ä¼šè¯Aè¾“å…¥"è‰ç¨¿æ¶ˆæ¯"ä½†ä¸å‘é€
2. éªŒè¯ä¼šè¯Aæ˜¾ç¤º"[è‰ç¨¿] è‰ç¨¿æ¶ˆæ¯"
3. å‘é€"å·²å‘é€æ¶ˆæ¯"
4. éªŒè¯ä¼šè¯Aæ˜¾ç¤º"å·²å‘é€æ¶ˆæ¯"
5. è¾“å…¥"æ–°è‰ç¨¿"ä½†ä¸å‘é€
6. éªŒè¯ä¼šè¯Aæ˜¾ç¤º"[è‰ç¨¿] æ–°è‰ç¨¿"
```

**é¢„æœŸç»“æœ**ï¼š
- è‰ç¨¿çŠ¶æ€æ­£ç¡®åˆ‡æ¢
- å·²å‘é€æ¶ˆæ¯æ­£ç¡®æ˜¾ç¤º
- çŠ¶æ€åˆ‡æ¢æ— å»¶è¿Ÿ

---

## 2. è”ç³»äººèœå•å®šä½ä¼˜åŒ–

### 2.1 é—®é¢˜æè¿°

**æ ¸å¿ƒé—®é¢˜**ï¼šå³é”®èœå•ä½ç½®ä¸å›ºå®šï¼Œå—é¼ æ ‡ç‚¹å‡»ä½ç½®å½±å“

#### é—®é¢˜è¡¨ç°
1. å³é”®èœå•ä½ç½®è·Ÿéšé¼ æ ‡ç‚¹å‡»ä½ç½®
2. èœå•å¯èƒ½è¶…å‡ºå¯è§†åŒºåŸŸ
3. èœå•ä½ç½®ä¸å¤Ÿç¾è§‚ï¼Œä¸ç¬¦åˆé’‰é’‰/ä¼ä¸šå¾®ä¿¡çš„å±…ä¸­è®¾è®¡

#### é—®é¢˜å¤ç°æ­¥éª¤

**æ­¥éª¤1ï¼šèœå•ä½ç½®é—®é¢˜**
```
1. åœ¨ä¼šè¯åˆ—è¡¨ä¸­å³é”®ç‚¹å‡»ä¼šè¯A
2. è§‚å¯Ÿèœå•ä½ç½®
   é¢„æœŸï¼šèœå•åœ¨åˆ—è¡¨ä¸­å¤®æ˜¾ç¤º
   å®é™…ï¼šèœå•åœ¨é¼ æ ‡ç‚¹å‡»ä½ç½®æ˜¾ç¤º
```

**æ­¥éª¤2ï¼šèœå•è¶…å‡ºå¯è§†åŒºåŸŸ**
```
1. åœ¨ä¼šè¯åˆ—è¡¨åº•éƒ¨å³é”®ç‚¹å‡»ä¼šè¯
2. è§‚å¯Ÿèœå•
   é¢„æœŸï¼šèœå•è‡ªåŠ¨è°ƒæ•´ä½ç½®ï¼Œå®Œå…¨å¯è§
   å®é™…ï¼šèœå•å¯èƒ½è¶…å‡ºå±å¹•åº•éƒ¨
```

### 2.2 æ ¹æœ¬åŸå› åˆ†æ

#### ä»£ç ä½ç½®åˆ†æ

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `/D:\MyCode\im\ruoyi-im-web\src/views\SessionPanel.vue` - ä¼šè¯åˆ—è¡¨ç»„ä»¶

#### é—®é¢˜ä»£ç ä½ç½®ï¼š`SessionPanel.vue:423-440`

```javascript
// å³é”®èœå•çŠ¶æ€
const contextMenu = reactive({
  show: false,
  x: 0,
  y: 0,
  session: null
})

const contextMenuStyle = computed(() => ({
  left: `${contextMenu.x}px`,
  top: `${contextMenu.y}px`
}))

const handleContextMenu = (e, session) => {
  contextMenu.show = true
  contextMenu.x = e.clientX
  contextMenu.y = e.clientY
  contextMenu.session = session
}
```

**é—®é¢˜åˆ†æ**ï¼š
1. èœå•ä½ç½®ç›´æ¥ä½¿ç”¨é¼ æ ‡ç‚¹å‡»åæ ‡ï¼ˆ`e.clientX`, `e.clientY`ï¼‰
2. æ²¡æœ‰è®¡ç®—èœå•çš„å±…ä¸­ä½ç½®
3. æ²¡æœ‰è¾¹ç•Œæ£€æµ‹å’Œè‡ªåŠ¨è°ƒæ•´
4. æ²¡æœ‰è€ƒè™‘èœå•å°ºå¯¸

### 2.3 è§£å†³æ–¹æ¡ˆè®¾è®¡

#### æ–¹æ¡ˆ1ï¼šå›ºå®šå±…ä¸­æ˜¾ç¤ºï¼ˆæ¨èï¼‰

**è®¾è®¡æ€è·¯**ï¼š
1. åœ¨ä¼šè¯åˆ—è¡¨ä¸­å¤®æ˜¾ç¤ºèœå•
2. å›ºå®šèœå•ä½ç½®ï¼Œä¸å—é¼ æ ‡ç‚¹å‡»ä½ç½®å½±å“
3. æ·»åŠ è¾¹ç•Œæ£€æµ‹ï¼Œç¡®ä¿èœå•å®Œå…¨å¯è§

**å®ç°æ­¥éª¤**ï¼š

**æ­¥éª¤1ï¼šè®¡ç®—èœå•å±…ä¸­ä½ç½®**

```javascript
// å³é”®èœå•çŠ¶æ€
const contextMenu = reactive({
  show: false,
  x: 0,
  y: 0,
  session: null
})

const contextMenuStyle = computed(() => {
  if (!contextMenu.show) return {}
  
  // è·å–èœå•å°ºå¯¸
  const menuWidth = 200
  const menuHeight = 300 // ä¼°ç®—å€¼
  
  // è·å–ä¼šè¯åˆ—è¡¨å®¹å™¨
  const sessionList = document.querySelector('.session-list')
  if (!sessionList) return {}
  
  const rect = sessionList.getBoundingClientRect()
  
  // è®¡ç®—å±…ä¸­ä½ç½®
  const centerX = rect.left + rect.width / 2
  const centerY = rect.top + rect.height / 2
  
  // è®¡ç®—èœå•ä½ç½®ï¼ˆå±…ä¸­ï¼‰
  let x = centerX - menuWidth / 2
  let y = centerY - menuHeight / 2
  
  // è¾¹ç•Œæ£€æµ‹
  const padding = 10
  const maxX = window.innerWidth - menuWidth - padding
  const maxY = window.innerHeight - menuHeight - padding
  
  x = Math.max(padding, Math.min(x, maxX))
  y = Math.max(padding, Math.min(y, maxY))
  
  return {
    left: `${x}px`,
    top: `${y}px`
  }
})

const handleContextMenu = (e, session) => {
  e.preventDefault()
  e.stopPropagation()
  
  contextMenu.show = true
  contextMenu.session = session
  
  // ä¸ä½¿ç”¨é¼ æ ‡ä½ç½®ï¼Œä½¿ç”¨è®¡ç®—åçš„å±…ä¸­ä½ç½®
  contextMenu.x = 0
  contextMenu.y = 0
}
```

**æ­¥éª¤2ï¼šæ·»åŠ èœå•åŠ¨ç”»æ•ˆæœ**

```scss
.context-menu {
  position: fixed;
  background: var(--dt-bg-dropdown);
  border-radius: var(--dt-radius-lg);
  box-shadow: var(--dt-shadow-modal);
  padding: 8px 0;
  min-width: 200px;
  z-index: 9999;
  
  // æ·»åŠ æ·¡å…¥ç¼©æ”¾åŠ¨ç”»
  animation: menuFadeIn 0.2s var(--dt-ease-out);
  
  @keyframes menuFadeIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
  
  // èœå•é¡¹æ ·å¼
  .menu-item {
    padding: 8px 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: background 0.15s var(--dt-ease-out);
    
    &:hover {
      background: var(--dt-brand-bg);
    }
    
    .menu-icon {
      font-size: 18px;
      color: var(--dt-text-secondary);
    }
    
    .menu-text {
      font-size: 14px;
      color: var(--dt-text-primary);
    }
  }
}
```

#### æ–¹æ¡ˆ2ï¼šæ™ºèƒ½å®šä½ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰

**è®¾è®¡æ€è·¯**ï¼š
1. æ ¹æ®é¼ æ ‡ç‚¹å‡»ä½ç½®æ™ºèƒ½è®¡ç®—èœå•ä½ç½®
2. ç¡®ä¿èœå•å®Œå…¨åœ¨å¯è§†åŒºåŸŸå†…
3. æ·»åŠ è‡ªåŠ¨è°ƒæ•´æœºåˆ¶

**å®ç°æ­¥éª¤**ï¼š

```javascript
const contextMenuStyle = computed(() => {
  if (!contextMenu.show) return {}
  
  // è·å–èœå•å°ºå¯¸ï¼ˆéœ€è¦åœ¨ DOM æ¸²æŸ“åè·å–ï¼‰
  const menuWidth = 200
  const menuHeight = contextMenu.session?.isPinned ? 200 : 300
  
  // è·å–çª—å£å°ºå¯¸
  const windowWidth = window.innerWidth
  const windowHeight = window.innerHeight
  
  // è®¡ç®—èœå•ä½ç½®ï¼ˆé»˜è®¤å³ä¸‹æ–¹ï¼‰
  let x = contextMenu.x + 10
  let y = contextMenu.y + 10
  
  // è¾¹ç•Œæ£€æµ‹ï¼šå³ä¾§è¶…å‡º
  if (x + menuWidth > windowWidth - 20) {
    x = contextMenu.x - menuWidth - 10
  }
  
  // è¾¹ç•Œæ£€æµ‹ï¼šåº•éƒ¨è¶…å‡º
  if (y + menuHeight > windowHeight - 20) {
    y = contextMenu.y - menuHeight - 10
  }
  
  // è¾¹ç•Œæ£€æµ‹ï¼šå·¦ä¾§è¶…å‡º
  if (x < 20) {
    x = 20
  }
  
  // è¾¹ç•Œæ£€æµ‹ï¼šé¡¶éƒ¨è¶…å‡º
  if (y < 20) {
    y = 20
  }
  
  return {
    left: `${x}px`,
    top: `${y}px`
  }
})
```

### 2.4 å®ç°æ­¥éª¤

#### ä¼˜å…ˆçº§1ï¼šå®ç°å›ºå®šå±…ä¸­æ˜¾ç¤º

**æ–‡ä»¶ä¿®æ”¹æ¸…å•**ï¼š
1. `SessionPanel.vue` - ä¿®æ”¹å³é”®èœå•å®šä½é€»è¾‘

**å®æ–½æ­¥éª¤**ï¼š
1. ä¿®æ”¹ `contextMenuStyle` è®¡ç®—é€»è¾‘
2. æ·»åŠ è¾¹ç•Œæ£€æµ‹
3. æ·»åŠ èœå•åŠ¨ç”»æ•ˆæœ
4. æµ‹è¯•ä¸åŒå±å¹•å°ºå¯¸

#### ä¼˜å…ˆçº§2ï¼šä¼˜åŒ–èœå•æ ·å¼

**æ–‡ä»¶ä¿®æ”¹æ¸…å•**ï¼š
1. `SessionPanel.vue` - ä¼˜åŒ–èœå•æ ·å¼

**å®æ–½æ­¥éª¤**ï¼š
1. ä¼˜åŒ–èœå•é—´è·
2. æ·»åŠ èœå•å›¾æ ‡
3. ä¼˜åŒ–èœå•é¡¹æ ·å¼
4. æ·»åŠ èœå•åˆ†éš”ç¬¦

### 2.5 æµ‹è¯•æ–¹æ¡ˆ

#### æµ‹è¯•ç”¨ä¾‹1ï¼šèœå•ä½ç½®å±…ä¸­

**æµ‹è¯•æ­¥éª¤**ï¼š
```
1. åœ¨ä¼šè¯åˆ—è¡¨ä¸­é—´ä½ç½®å³é”®ç‚¹å‡»ä¼šè¯
2. è§‚å¯Ÿèœå•ä½ç½®
3. åœ¨ä¼šè¯åˆ—è¡¨é¡¶éƒ¨å³é”®ç‚¹å‡»ä¼šè¯
4. è§‚å¯Ÿèœå•ä½ç½®
5. åœ¨ä¼šè¯åˆ—è¡¨åº•éƒ¨å³é”®ç‚¹å‡»ä¼šè¯
6. è§‚å¯Ÿèœå•ä½ç½®
```

**é¢„æœŸç»“æœ**ï¼š
- èœå•å§‹ç»ˆåœ¨ä¼šè¯åˆ—è¡¨ä¸­å¤®æ˜¾ç¤º
- ä¸å—é¼ æ ‡ç‚¹å‡»ä½ç½®å½±å“
- èœå•å®Œå…¨å¯è§

#### æµ‹è¯•ç”¨ä¾‹2ï¼šè¾¹ç•Œæ£€æµ‹

**æµ‹è¯•æ­¥éª¤**ï¼š
```
1. è°ƒæ•´æµè§ˆå™¨çª—å£å¤§å°
2. åœ¨ä¼šè¯åˆ—è¡¨ä¸åŒä½ç½®å³é”®ç‚¹å‡»
3. éªŒè¯èœå•ä¸ä¼šè¶…å‡ºå¯è§†åŒºåŸŸ
```

**é¢„æœŸç»“æœ**ï¼š
- èœå•å§‹ç»ˆå®Œå…¨å¯è§
- è‡ªåŠ¨è°ƒæ•´ä½ç½®
- ä¸è¢«è£å‰ª

#### æµ‹è¯•ç”¨ä¾‹3ï¼šèœå•åŠ¨ç”»æ•ˆæœ

**æµ‹è¯•æ­¥éª¤**ï¼š
```
1. å³é”®ç‚¹å‡»ä¼šè¯
2. è§‚å¯Ÿèœå•å¼¹å‡ºåŠ¨ç”»
3. ç‚¹å‡»èœå•å¤–åŒºåŸŸå…³é—­èœå•
4. è§‚å¯Ÿèœå•å…³é—­åŠ¨ç”»
```

**é¢„æœŸç»“æœ**ï¼š
- èœå•å¼¹å‡ºæœ‰æ·¡å…¥ç¼©æ”¾åŠ¨ç”»
- èœå•å…³é—­æœ‰æ·¡å‡ºåŠ¨ç”»
- åŠ¨ç”»æµç•…è‡ªç„¶

---

## 3. è¾“å…¥çŠ¶æ€ä¸åˆ—è¡¨é€‰ä¸­çŠ¶æ€åŒæ­¥

### 3.1 é—®é¢˜æè¿°

**æ ¸å¿ƒé—®é¢˜**ï¼šçŠ¶æ€è”åŠ¨æœºåˆ¶ç¼ºå¤±

#### é—®é¢˜è¡¨ç°
1. å³ä¾§è¾“å…¥æ¡†ä½¿ç”¨æ—¶ï¼Œä¸­é—´è”ç³»äººåˆ—è¡¨å¯¹åº”çš„è”ç³»äººé¡¹æœªä¿æŒé€‰ä¸­
2. è¾“å…¥çŠ¶æ€å’Œé€‰ä¸­çŠ¶æ€ç‹¬ç«‹ç®¡ç†
3. åˆ‡æ¢ä¼šè¯æ—¶çŠ¶æ€ä¸åŒæ­¥

#### é—®é¢˜å¤ç°æ­¥éª¤

**æ­¥éª¤1ï¼šè¾“å…¥çŠ¶æ€ä¸åŒæ­¥**
```
1. åœ¨ä¼šè¯åˆ—è¡¨ä¸­ç‚¹å‡»ä¼šè¯A
2. åœ¨å³ä¾§è¾“å…¥æ¡†è¾“å…¥"ä½ å¥½"
3. åˆ‡æ¢åˆ°ä¼šè¯B
4. è§‚å¯Ÿä¼šè¯åˆ—è¡¨
   é¢„æœŸï¼šä¼šè¯Aä¿æŒé€‰ä¸­çŠ¶æ€
   å®é™…ï¼šé€‰ä¸­çŠ¶æ€å¯èƒ½æ¶ˆå¤±
```

**æ­¥éª¤2ï¼šå¤šä¼šè¯è¾“å…¥çŠ¶æ€**
```
1. åœ¨ä¼šè¯Aè¾“å…¥"æ¶ˆæ¯A"ä½†ä¸å‘é€
2. åˆ‡æ¢åˆ°ä¼šè¯Bè¾“å…¥"æ¶ˆæ¯B"ä½†ä¸å‘é€
3. åˆ‡æ¢åˆ°ä¼šè¯Cè¾“å…¥"æ¶ˆæ¯C"ä½†ä¸å‘é€
4. è§‚å¯Ÿä¼šè¯åˆ—è¡¨
   é¢„æœŸï¼šæ¯ä¸ªä¼šè¯éƒ½æ˜¾ç¤ºè‰ç¨¿æ ‡è¯†
   å®é™…ï¼šéƒ¨åˆ†ä¼šè¯å¯èƒ½ä¸æ˜¾ç¤ºè‰ç¨¿
```

### 3.2 æ ¹æœ¬åŸå› åˆ†æ

#### ä»£ç ä½ç½®åˆ†æ

**æ¶‰åŠæ–‡ä»¶**ï¼š
- `/D:\MyCode\im\ruoyi-im-web\src\views\ChatPanel.vue` - èŠå¤©é¢æ¿
- `/D:\MyCode\im\ruoyi-im-web\src\views\SessionPanel.vue` - ä¼šè¯åˆ—è¡¨
- `/D:\MyCode\im\ruoyi-im-web\src\store/modules\im-session.js` - ä¼šè¯çŠ¶æ€ç®¡ç†

#### é—®é¢˜1ï¼šé€‰ä¸­çŠ¶æ€ç®¡ç†åˆ†æ•£

**é—®é¢˜ä»£ç ä½ç½®**ï¼š`ChatPanel.vue:51-83`

```vue
<MessageInput
  ref="messageInputRef"
  :session="currentSession"
  @send="handleSend"
  @send-voice="handleSendVoice"
  @upload-image="handleUploadImage"
  @upload-file="handleUploadFile"
  @upload-video="handleUploadVideo"
  @send-location="handleSendLocation"
  @cancel-reply="handleCancelReply"
  @cancel-edit="handleCancelEdit"
  @edit-confirm="handleEditConfirm"
  @input="handleInput"
  @start-call="handleStartCall"
  @start-video="handleStartVideo"
  @send-screenshot="handleSendScreenshot"
  @draft-change="handleDraftChange"
  @show-history="handleShowHistory"
/>
```

**é—®é¢˜åˆ†æ**ï¼š
1. ChatPanel ç®¡ç†å½“å‰ä¼šè¯ï¼ˆ`currentSession`ï¼‰
2. SessionPanel ç®¡ç†é€‰ä¸­ä¼šè¯
3. ä¸¤è€…é€šè¿‡äº‹ä»¶é€šä¿¡ï¼Œä½†æ²¡æœ‰ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†
4. è¾“å…¥çŠ¶æ€å˜åŒ–æ—¶æ²¡æœ‰é€šçŸ¥ SessionPanel æ›´æ–°é€‰ä¸­çŠ¶æ€

#### é—®é¢˜2ï¼šç¼ºå°‘è¾“å…¥çŠ¶æ€ç›‘å¬

**é—®é¢˜ä»£ç ä½ç½®**ï¼š`MessageInput.vue:240-300`

```javascript
const emit = defineEmits(['send', 'send-voice', 'upload-image', 'upload-file', 'upload-video', 'send-location', 'cancel-reply', 'cancel-edit', 'edit-confirm', 'input', 'start-call', 'start-video', 'send-screenshot', 'draft-change', 'show-history'])

// ä¿å­˜è‰ç¨¿ï¼ˆé˜²æŠ–ï¼‰
const saveDraftDebounced = (conversationId, content) => {
  if (draftSaveTimer) {
    clearTimeout(draftSaveTimer)
  }
  draftSaveTimer = setTimeout(() => {
    saveDraft(conversationId, content)
  }, DRAFT_DEBOUNCE_TIME)
}
```

**é—®é¢˜åˆ†æ**ï¼š
1. `draft-change` äº‹ä»¶åœ¨è‰ç¨¿å˜åŒ–æ—¶è§¦å‘
2. ä½†è¿™ä¸ªäº‹ä»¶ä¸»è¦ç”¨äºè‰ç¨¿çŠ¶æ€æ˜¾ç¤º
3. æ²¡æœ‰ç”¨äºæ›´æ–°ä¼šè¯åˆ—è¡¨çš„é€‰ä¸­çŠ¶æ€
4. ç¼ºå°‘è¾“å…¥ç„¦ç‚¹çŠ¶æ€çš„ç›‘å¬

#### é—®é¢˜3ï¼šä¼šè¯åˆ‡æ¢æ—¶çŠ¶æ€é‡ç½®

**é—®é¢˜ä»£ç ä½ç½®**ï¼š`MessageInput.vue:883-892`

```javascript
// ç›‘å¬ä¼šè¯å˜åŒ–ï¼ŒåŠ è½½è‰ç¨¿
watch(() => props.session.id, (newId, oldId) => {
  if (oldId && newId !== oldId) {
    // ä¿å­˜æ—§ä¼šè¯çš„è‰ç¨¿
    saveDraft(oldId, messageContent.value)
    
    // åŠ è½½æ–°ä¼šè¯çš„è‰ç¨¿
    loadDraft(newId)
  }
})
```

**é—®é¢˜åˆ†æ**ï¼š
1. ä¼šè¯åˆ‡æ¢æ—¶ä¿å­˜æ—§è‰ç¨¿å¹¶åŠ è½½æ–°è‰ç¨¿
2. ä½†æ²¡æœ‰é€šçŸ¥ SessionPanel æ›´æ–°é€‰ä¸­çŠ¶æ€
3. æ²¡æœ‰è®°å½•å“ªä¸ªä¼šè¯å¤„äº"æ­£åœ¨è¾“å…¥"çŠ¶æ€

### 3.3 è§£å†³æ–¹æ¡ˆè®¾è®¡

#### æ–¹æ¡ˆ1ï¼šç»Ÿä¸€çŠ¶æ€ç®¡ç†ï¼ˆæ¨èï¼‰

**è®¾è®¡æ€è·¯**ï¼š
1. åœ¨ Vuex store ä¸­æ·»åŠ "æ­£åœ¨è¾“å…¥"çŠ¶æ€
2. è¾“å…¥æ¡†çŠ¶æ€å˜åŒ–æ—¶æ›´æ–° store
3. ä¼šè¯åˆ—è¡¨ç›‘å¬ store çŠ¶æ€æ›´æ–°é€‰ä¸­æ ·å¼

**å®ç°æ­¥éª¤**ï¼š

**æ­¥éª¤1ï¼šåœ¨ im-session.js ä¸­æ·»åŠ è¾“å…¥çŠ¶æ€ç®¡ç†**

```javascript
// State ä¸­æ·»åŠ è¾“å…¥çŠ¶æ€
state: () => ({
  // ... ç°æœ‰çŠ¶æ€
  typingSessions: {} // { conversationId: { isTyping, lastTypingTime } }
})

// Mutations
mutations: {
  // ... ç°æœ‰ mutations
  
  SET_TYPING(state, { conversationId, isTyping }) {
    if (isTyping) {
      state.typingSessions[conversationId] = {
        isTyping: true,
        lastTypingTime: Date.now()
      }
    } else {
      delete state.typingSessions[conversationId]
    }
  },
  
  CLEAR_TYPING(state, conversationId) {
    delete state.typingSessions[conversationId]
  }
}

// Getters
getters: {
  // ... ç°æœ‰ getters
  
  isTyping: (state) => (conversationId) => {
    const typing = state.typingSessions[conversationId]
    if (!typing) return false
    
    // 5ç§’åè‡ªåŠ¨æ¸…é™¤è¾“å…¥çŠ¶æ€
    if (Date.now() - typing.lastTypingTime > 5000) {
      return false
    }
    
    return typing.isTyping
  },
  
  getTypingSessionIds: (state) => {
    return Object.keys(state.typingSessions).filter(conversationId => {
      const typing = state.typingSessions[conversationId]
      return typing && (Date.now() - typing.lastTypingTime <= 5000)
    })
  }
}

// Actions
actions: {
  // ... ç°æœ‰ actions
  
  setTyping({ commit }, { conversationId, isTyping }) {
    commit('SET_TYPING', { conversationId, isTyping })
  },
  
  clearTyping({ commit }, conversationId) {
    commit('CLEAR_TYPING', conversationId)
  },
  
  // å®šæœŸæ¸…ç†è¿‡æœŸçš„è¾“å…¥çŠ¶æ€
  startTypingCleanup({ state, commit }) {
    setInterval(() => {
      const now = Date.now()
      Object.entries(state.typingSessions).forEach(([conversationId, typing]) => {
        if (now - typing.lastTypingTime > 5000) {
          commit('CLEAR_TYPING', conversationId)
        }
      })
    }, 1000)
  }
}
```

**æ­¥éª¤2ï¼šä¿®æ”¹ MessageInput.vue æ›´æ–°è¾“å…¥çŠ¶æ€**

```javascript
import { useStore } from 'vuex'

const store = useStore()

// ç›‘å¬è¾“å…¥å˜åŒ–
watch(messageContent, (newContent, oldContent) => {
  if (newContent !== oldContent) {
    // æ›´æ–°è¾“å…¥çŠ¶æ€
    if (newContent.trim().length > 0) {
      store.dispatch('im/session/setTyping', {
        conversationId: props.session.id,
        isTyping: true
      })
    } else {
      store.dispatch('im/session/clearTyping', props.session.id)
    }
  }
})

// ç»„ä»¶å¸è½½æ—¶æ¸…é™¤è¾“å…¥çŠ¶æ€
onUnmounted(() => {
  store.dispatch('im/session/clearTyping', props.session.id)
})

// å¤±å»ç„¦ç‚¹æ—¶å»¶è¿Ÿæ¸…é™¤è¾“å…¥çŠ¶æ€
const handleBlur = () => {
  setTimeout(() => {
    store.dispatch('im/session/clearTyping', props.session.id)
  }, 2000)
}
```

**æ­¥éª¤3ï¼šä¿®æ”¹ SessionPanel.vue æ˜¾ç¤ºè¾“å…¥çŠ¶æ€**

```vue
<template>
  <div
    class="session-item"
    :class="{
      'is-selected': isSelected(session),
      'is-typing': isTyping(session.id)
    }"
    @click="handleSelectSession(session)"
  >
    <!-- ... -->
    <div class="preview-wrapper">
      <span v-if="isTyping(session.id)" class="typing-indicator">
        <span class="material-icons-outlined typing-icon">edit</span>
        æ­£åœ¨è¾“å…¥...
      </span>
      <span v-else-if="hasDraft(session.id)" class="draft-tag">[è‰ç¨¿]</span>
      <span class="preview-text">
        {{ hasDraft(session.id) ? getDraftPreview(session.id) : (session.lastMessage || 'æš‚æ— æ¶ˆæ¯') }}
      </span>
    </div>
  </div>
</template>

<script setup>
// ä½¿ç”¨ Vuex getter
const isTyping = computed(() => (conversationId) => {
  return store.getters['im/session/isTyping'](conversationId)
})

// ç»„ä»¶æŒ‚è½½æ—¶å¯åŠ¨è¾“å…¥çŠ¶æ€æ¸…ç†
onMounted(() => {
  store.dispatch('im/session/startTypingCleanup')
})
</script>

<style scoped lang="scss">
.session-item {
  // ... ç°æœ‰æ ·å¼
  
  &.is-typing {
    background: var(--dt-brand-bg);
    
    .typing-indicator {
      color: var(--dt-brand-color);
      font-weight: 500;
    }
  }
  
  .typing-indicator {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 13px;
    color: var(--dt-brand-color);
    animation: typingPulse 1.5s ease-in-out infinite;
    
    .typing-icon {
      font-size: 14px;
    }
  }
  
  @keyframes typingPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
}
</style>
```

#### æ–¹æ¡ˆ2ï¼šäº‹ä»¶é©±åŠ¨åŒæ­¥ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰

**è®¾è®¡æ€è·¯**ï¼š
1. ä½¿ç”¨äº‹ä»¶é€šä¿¡å®ç°çŠ¶æ€åŒæ­¥
2. è¾“å…¥æ¡†å˜åŒ–æ—¶å‘å°„äº‹ä»¶
3. ä¼šè¯åˆ—è¡¨ç›‘å¬äº‹ä»¶æ›´æ–°çŠ¶æ€

**å®ç°æ­¥éª¤**ï¼š

```javascript
// MessageInput.vue
const emit = defineEmits(['send', 'input', 'typing-change'])

// ç›‘å¬è¾“å…¥å˜åŒ–
watch(messageContent, (newContent) => {
  emit('typing-change', {
    conversationId: props.session.id,
    isTyping: newContent.trim().length > 0
  })
})

// ChatPanel.vue
const handleTypingChange = (typingInfo) => {
  emit('typing-change', typingInfo)
}

// SessionPanel.vue
const typingSessions = ref({})

const handleTypingChange = (typingInfo) => {
  if (typingInfo.isTyping) {
    typingSessions.value[typingInfo.conversationId] = {
      lastTypingTime: Date.now()
    }
  } else {
    delete typingSessions.value[typingInfo.conversationId]
  }
}

const isTyping = (conversationId) => {
  const typing = typingSessions.value[conversationId]
  if (!typing) return false
  return Date.now() - typing.lastTypingTime <= 5000
}
```

### 3.4 å®ç°æ­¥éª¤

#### ä¼˜å…ˆçº§1ï¼šå®ç°ç»Ÿä¸€çŠ¶æ€ç®¡ç†

**æ–‡ä»¶ä¿®æ”¹æ¸…å•**ï¼š
1. `im-session.js` - æ·»åŠ è¾“å…¥çŠ¶æ€ç®¡ç†
2. `MessageInput.vue` - æ›´æ–°è¾“å…¥çŠ¶æ€
3. `SessionPanel.vue` - æ˜¾ç¤ºè¾“å…¥çŠ¶æ€
4. `ChatPanel.vue` - ä¼ é€’è¾“å…¥çŠ¶æ€äº‹ä»¶

**å®æ–½æ­¥éª¤**ï¼š
1. åœ¨ Vuex store ä¸­æ·»åŠ  typingSessions çŠ¶æ€
2. ä¿®æ”¹ MessageInput ç›‘å¬è¾“å…¥å˜åŒ–
3. ä¿®æ”¹ SessionPanel æ˜¾ç¤ºè¾“å…¥çŠ¶æ€
4. æ·»åŠ è¾“å…¥çŠ¶æ€è‡ªåŠ¨æ¸…ç†æœºåˆ¶

#### ä¼˜å…ˆçº§2ï¼šä¼˜åŒ–é€‰ä¸­çŠ¶æ€æ˜¾ç¤º

**æ–‡ä»¶ä¿®æ”¹æ¸…å•**ï¼š
1. `SessionPanel.vue` - ä¼˜åŒ–é€‰ä¸­æ ·å¼

**å®æ–½æ­¥éª¤**ï¼š
1. æ·»åŠ è¾“å…¥çŠ¶æ€çš„è§†è§‰æŒ‡ç¤º
2. ä¼˜åŒ–é€‰ä¸­çŠ¶æ€çš„æ ·å¼
3. æ·»åŠ è¾“å…¥çŠ¶æ€åŠ¨ç”»æ•ˆæœ

### 3.5 æµ‹è¯•æ–¹æ¡ˆ

#### æµ‹è¯•ç”¨ä¾‹1ï¼šè¾“å…¥çŠ¶æ€åŒæ­¥

**æµ‹è¯•æ­¥éª¤**ï¼š
```
1. åœ¨ä¼šè¯åˆ—è¡¨ä¸­ç‚¹å‡»ä¼šè¯A
2. åœ¨å³ä¾§è¾“å…¥æ¡†è¾“å…¥"ä½ å¥½"
3. è§‚å¯Ÿä¼šè¯åˆ—è¡¨ä¸­ä¼šè¯Açš„æ˜¾ç¤º
   é¢„æœŸï¼šæ˜¾ç¤º"æ­£åœ¨è¾“å…¥..."æç¤º
4. åœæ­¢è¾“å…¥5ç§’
5. è§‚å¯Ÿä¼šè¯åˆ—è¡¨ä¸­ä¼šè¯Açš„æ˜¾ç¤º
   é¢„æœŸï¼š"æ­£åœ¨è¾“å…¥..."æç¤ºæ¶ˆå¤±
```

**é¢„æœŸç»“æœ**ï¼š
- è¾“å…¥æ—¶æ­£ç¡®æ˜¾ç¤º"æ­£åœ¨è¾“å…¥..."æç¤º
- åœæ­¢è¾“å…¥åæç¤ºè‡ªåŠ¨æ¶ˆå¤±
- æç¤ºæœ‰åŠ¨ç”»æ•ˆæœ

#### æµ‹è¯•ç”¨ä¾‹2ï¼šå¤šä¼šè¯è¾“å…¥çŠ¶æ€

**æµ‹è¯•æ­¥éª¤**ï¼š
```
1. åœ¨ä¼šè¯Aè¾“å…¥"æ¶ˆæ¯A"ä½†ä¸å‘é€
2. åˆ‡æ¢åˆ°ä¼šè¯Bè¾“å…¥"æ¶ˆæ¯B"ä½†ä¸å‘é€
3. è§‚å¯Ÿä¼šè¯åˆ—è¡¨
   é¢„æœŸï¼šä¼šè¯Bæ˜¾ç¤º"æ­£åœ¨è¾“å…¥..."ï¼Œä¼šè¯Aæ˜¾ç¤ºè‰ç¨¿
4. åˆ‡æ¢åˆ°ä¼šè¯C
5. è§‚å¯Ÿä¼šè¯åˆ—è¡¨
   é¢„æœŸï¼šä¼šè¯Bå’Œä¼šè¯Aéƒ½æ˜¾ç¤ºè‰ç¨¿
```

**é¢„æœŸç»“æœ**ï¼š
- å½“å‰è¾“å…¥çš„ä¼šè¯æ˜¾ç¤º"æ­£åœ¨è¾“å…¥..."
- å…¶ä»–æœ‰è‰ç¨¿çš„ä¼šè¯æ˜¾ç¤ºè‰ç¨¿æ ‡è¯†
- çŠ¶æ€åˆ‡æ¢æ­£ç¡®

#### æµ‹è¯•ç”¨ä¾‹3ï¼šä¼šè¯åˆ‡æ¢çŠ¶æ€ä¿æŒ

**æµ‹è¯•æ­¥éª¤**ï¼š
```
1. åœ¨ä¼šè¯Aè¾“å…¥"æ¶ˆæ¯A"ä½†ä¸å‘é€
2. åˆ‡æ¢åˆ°ä¼šè¯B
3. è§‚å¯Ÿä¼šè¯åˆ—è¡¨
   é¢„æœŸï¼šä¼šè¯Aæ˜¾ç¤ºè‰ç¨¿ï¼Œä¼šè¯Bæ˜¾ç¤ºä¸ºé€‰ä¸­
4. åˆ‡æ¢å›ä¼šè¯A
5. è§‚å¯Ÿè¾“å…¥æ¡†
   é¢„æœŸï¼šè¾“å…¥æ¡†æ˜¾ç¤º"æ¶ˆæ¯A"
```

**é¢„æœŸç»“æœ**ï¼š
- è‰ç¨¿æ­£ç¡®ä¿å­˜
- é€‰ä¸­çŠ¶æ€æ­£ç¡®åˆ‡æ¢
- è¾“å…¥å†…å®¹æ­£ç¡®æ¢å¤

---

## 4. è®¾è®¡å¸ƒå±€å‚è€ƒä¸åˆ†æ

### 4.1 é’‰é’‰è®¾è®¡åˆ†æ

#### 4.1.1 ç•Œé¢ç»“æ„

**å¸ƒå±€ç‰¹ç‚¹**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [ä¸‰æ å¸ƒå±€]                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  å¯¼èˆªæ    â”‚   ä¼šè¯åˆ—è¡¨    â”‚      èŠå¤©åŒºåŸŸ        â”‚ â”‚
â”‚  â”‚  (48px)  â”‚   (320px)    â”‚      (flex:1)        â”‚ â”‚
â”‚  â”‚          â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å›¾æ ‡å¯¼èˆª â”‚  æœç´¢æ¡†      â”‚  â”‚   èŠå¤©å¤´éƒ¨      â”‚  â”‚
â”‚  â”‚          â”‚  ä¼šè¯åˆ—è¡¨    â”‚  â”‚   (52px)        â”‚  â”‚
â”‚  â”‚  ä¼šè¯     â”‚  åˆ†ç»„ç®¡ç†    â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  è”ç³»äºº   â”‚              â”‚  â”‚   æ¶ˆæ¯åˆ—è¡¨      â”‚  â”‚
â”‚  â”‚  æ¶ˆæ¯     â”‚              â”‚  â”‚   (flex:1)      â”‚  â”‚
â”‚  â”‚  å¾…åŠ     â”‚              â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  æ—¥å†     â”‚              â”‚  â”‚   è¾“å…¥åŒºåŸŸ      â”‚  â”‚
â”‚  â”‚  æ–‡ä»¶     â”‚              â”‚  â”‚   (120-160px)   â”‚  â”‚
â”‚  â”‚          â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®å°ºå¯¸**ï¼š
- å¯¼èˆªæ ï¼š48px
- ä¼šè¯åˆ—è¡¨ï¼š320px
- èŠå¤©å¤´éƒ¨ï¼š52px
- è¾“å…¥åŒºåŸŸï¼š120-160pxï¼ˆå¯è°ƒæ•´ï¼‰

#### 4.1.2 äº¤äº’é€»è¾‘

**æ¶ˆæ¯é¢„è§ˆæ˜¾ç¤º**ï¼š
1. ä¼˜å…ˆæ˜¾ç¤ºè‰ç¨¿å†…å®¹ï¼ˆå¸¦"[è‰ç¨¿]"å‰ç¼€ï¼‰
2. å…¶æ¬¡æ˜¾ç¤ºæœ€æ–°æ¶ˆæ¯å†…å®¹
3. æœ€åæ˜¾ç¤º"æš‚æ— æ¶ˆæ¯"
4. è¾“å…¥çŠ¶æ€æ˜¾ç¤º"æ­£åœ¨è¾“å…¥..."æç¤º

**å³é”®èœå•**ï¼š
1. èœå•åœ¨åˆ—è¡¨ä¸­å¤®å›ºå®šæ˜¾ç¤º
2. ä¸å—é¼ æ ‡ç‚¹å‡»ä½ç½®å½±å“
3. èœå•é¡¹åŒ…æ‹¬ï¼šç½®é¡¶ã€å…æ‰“æ‰°ã€åˆ é™¤ã€åˆ†ç»„

**é€‰ä¸­çŠ¶æ€**ï¼š
1. å½“å‰é€‰ä¸­çš„ä¼šè¯é«˜äº®æ˜¾ç¤º
2. æ­£åœ¨è¾“å…¥çš„ä¼šè¯æ˜¾ç¤ºç‰¹æ®Šæ ·å¼
3. æœ‰è‰ç¨¿çš„ä¼šè¯æ˜¾ç¤ºè‰ç¨¿æ ‡è¯†

#### 4.1.3 çŠ¶æ€æ˜¾ç¤ºæ–¹å¼

**æ¶ˆæ¯çŠ¶æ€**ï¼š
- å‘é€ä¸­ï¼šæ˜¾ç¤ºå‘é€åŠ¨ç”»ï¼ˆæ—‹è½¬å›¾æ ‡ï¼‰
- å‘é€æˆåŠŸï¼šæ˜¾ç¤ºå¯¹å‹¾å›¾æ ‡
- å‘é€å¤±è´¥ï¼šæ˜¾ç¤ºçº¢è‰²æ„Ÿå¹å·
- å·²è¯»ï¼šæ˜¾ç¤ºå¯¹å‹¾å›¾æ ‡
- æœªè¯»ï¼šæ— ç‰¹æ®Šæ ‡è¯†

**è¾“å…¥çŠ¶æ€**ï¼š
- æ­£åœ¨è¾“å…¥ï¼šæ˜¾ç¤º"æ­£åœ¨è¾“å…¥..."æç¤º
- è‰ç¨¿ï¼šæ˜¾ç¤º"[è‰ç¨¿]"æ ‡è¯†
- ç©ºçŠ¶æ€ï¼šæ˜¾ç¤º"æš‚æ— æ¶ˆæ¯"

### 4.2 ä¼ä¸šå¾®ä¿¡è®¾è®¡åˆ†æ

#### 4.2.1 ç•Œé¢ç»“æ„

**å¸ƒå±€ç‰¹ç‚¹**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [ä¸‰æ å¸ƒå±€]                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  å¯¼èˆªæ    â”‚   ä¼šè¯åˆ—è¡¨    â”‚      èŠå¤©åŒºåŸŸ        â”‚ â”‚
â”‚  â”‚  (60px)  â”‚   (280px)    â”‚      (flex:1)        â”‚ â”‚
â”‚  â”‚          â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  æ¶ˆæ¯     â”‚  æœç´¢æ¡†      â”‚  â”‚   èŠå¤©å¤´éƒ¨      â”‚  â”‚
â”‚  â”‚  è”ç³»äºº   â”‚  ä¼šè¯åˆ—è¡¨    â”‚  â”‚   (56px)        â”‚  â”‚
â”‚  â”‚  æ–‡ä»¶     â”‚              â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  æ—¥å†     â”‚              â”‚  â”‚   æ¶ˆæ¯åˆ—è¡¨      â”‚  â”‚
â”‚  â”‚  å¾…åŠ     â”‚              â”‚  â”‚   (flex:1)      â”‚  â”‚
â”‚  â”‚  åº”ç”¨     â”‚              â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚          â”‚              â”‚  â”‚   è¾“å…¥åŒºåŸŸ      â”‚  â”‚
â”‚  â”‚  è®¾ç½®     â”‚              â”‚  â”‚   (100-140px)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®å°ºå¯¸**ï¼š
- å¯¼èˆªæ ï¼š60px
- ä¼šè¯åˆ—è¡¨ï¼š280px
- èŠå¤©å¤´éƒ¨ï¼š56px
- è¾“å…¥åŒºåŸŸï¼š100-140pxï¼ˆå¯è°ƒæ•´ï¼‰

#### 4.2.2 äº¤äº’é€»è¾‘

**æ¶ˆæ¯é¢„è§ˆæ˜¾ç¤º**ï¼š
1. ä¼˜å…ˆæ˜¾ç¤ºè‰ç¨¿å†…å®¹
2. å…¶æ¬¡æ˜¾ç¤ºæœ€æ–°æ¶ˆæ¯å†…å®¹
3. æ¶ˆæ¯é¢„è§ˆé•¿åº¦é™åˆ¶ä¸º30å­—ç¬¦
4. è¾“å…¥çŠ¶æ€ä¸æ˜¾ç¤ºæç¤º

**å³é”®èœå•**ï¼š
1. èœå•åœ¨é¼ æ ‡ç‚¹å‡»ä½ç½®æ˜¾ç¤º
2. æ™ºèƒ½è°ƒæ•´ä½ç½®é¿å…è¶…å‡ºå¯è§†åŒºåŸŸ
3. èœå•é¡¹åŒ…æ‹¬ï¼šç½®é¡¶ã€æ ‡ä¸ºå·²è¯»ã€åˆ é™¤ã€ç§»åŠ¨

**é€‰ä¸­çŠ¶æ€**ï¼š
1. å½“å‰é€‰ä¸­çš„ä¼šè¯é«˜äº®æ˜¾ç¤º
2. æœªè¯»æ¶ˆæ¯æ•°é‡æ˜¾ç¤ºçº¢è‰²è§’æ ‡
3. è‰ç¨¿çŠ¶æ€ä¸æ˜¾ç¤º

### 4.3 ä¼˜åŒ–å»ºè®®

#### 4.3.1 ç•Œé¢ç»“æ„ä¼˜åŒ–

**å»ºè®®1ï¼šç»Ÿä¸€å¤´éƒ¨é«˜åº¦**
```
å½“å‰ï¼šChatHeader é«˜åº¦ 56px
å»ºè®®ï¼šè°ƒæ•´ä¸º 52pxï¼ˆç¬¦åˆé’‰é’‰æ ‡å‡†ï¼‰
```

**å»ºè®®2ï¼šä¼˜åŒ–è¾“å…¥åŒºåŸŸé«˜åº¦**
```
å½“å‰ï¼šMessageInput é»˜è®¤ 160px
å»ºè®®ï¼šè°ƒæ•´ä¸º 120pxï¼ˆæ›´ç´§å‡‘ï¼‰
```

**å»ºè®®3ï¼šç»Ÿä¸€ä¼šè¯åˆ—è¡¨å®½åº¦**
```
å½“å‰ï¼šSessionPanel å®½åº¦ 320px
å»ºè®®ï¼šä¿æŒ 320pxï¼ˆç¬¦åˆé’‰é’‰æ ‡å‡†ï¼‰
```

#### 4.3.2 äº¤äº’é€»è¾‘ä¼˜åŒ–

**å»ºè®®1ï¼šä¼˜åŒ–æ¶ˆæ¯é¢„è§ˆæ˜¾ç¤º**
```
1. è‰ç¨¿å†…å®¹æ˜¾ç¤ºä¼˜å…ˆçº§æœ€é«˜
2. è‰ç¨¿å†…å®¹é•¿åº¦é™åˆ¶ä¸º20å­—ç¬¦
3. æ·»åŠ "æ­£åœ¨è¾“å…¥..."æç¤º
4. è‰ç¨¿å’Œå·²å‘é€æ¶ˆæ¯çŠ¶æ€å®æ—¶åˆ‡æ¢
```

**å»ºè®®2ï¼šä¼˜åŒ–å³é”®èœå•å®šä½**
```
1. èœå•åœ¨ä¼šè¯åˆ—è¡¨ä¸­å¤®å›ºå®šæ˜¾ç¤º
2. æ·»åŠ èœå•æ·¡å…¥ç¼©æ”¾åŠ¨ç”»
3. æ™ºèƒ½è¾¹ç•Œæ£€æµ‹
4. èœå•æ ·å¼ç¬¦åˆé’‰é’‰è®¾è®¡è§„èŒƒ
```

**å»ºè®®3ï¼šä¼˜åŒ–é€‰ä¸­çŠ¶æ€æ˜¾ç¤º**
```
1. å½“å‰é€‰ä¸­ä¼šè¯é«˜äº®æ˜¾ç¤º
2. æ­£åœ¨è¾“å…¥çš„ä¼šè¯æ˜¾ç¤ºç‰¹æ®Šæ ·å¼
3. æœ‰è‰ç¨¿çš„ä¼šè¯æ˜¾ç¤ºè‰ç¨¿æ ‡è¯†
4. çŠ¶æ€åˆ‡æ¢æœ‰è¿‡æ¸¡åŠ¨ç”»
```

#### 4.3.3 çŠ¶æ€æ˜¾ç¤ºæ–¹å¼ä¼˜åŒ–

**å»ºè®®1ï¼šä¼˜åŒ–æ¶ˆæ¯çŠ¶æ€å›¾æ ‡**
```
1. å‘é€ä¸­ï¼šæ—‹è½¬åŠ¨ç”»
2. å‘é€æˆåŠŸï¼šå¯¹å‹¾å›¾æ ‡
3. å‘é€å¤±è´¥ï¼šçº¢è‰²æ„Ÿå¹å·
4. å·²è¯»/æœªè¯»ï¼šç»Ÿä¸€æ˜¾ç¤º
```

**å»ºè®®2ï¼šä¼˜åŒ–è¾“å…¥çŠ¶æ€æ˜¾ç¤º**
```
1. æ­£åœ¨è¾“å…¥ï¼šæ˜¾ç¤º"æ­£åœ¨è¾“å…¥..."æç¤º
2. è‰ç¨¿ï¼šæ˜¾ç¤º"[è‰ç¨¿]"æ ‡è¯†
3. æç¤ºæœ‰è„‰å†²åŠ¨ç”»æ•ˆæœ
4. çŠ¶æ€å®æ—¶æ›´æ–°
```

**å»ºè®®3ï¼šä¼˜åŒ–æœªè¯»æ¶ˆæ¯æ˜¾ç¤º**
```
1. æœªè¯»æ•°é‡æ˜¾ç¤ºçº¢è‰²è§’æ ‡
2. æœªè¯»æ•°é‡è¶…è¿‡99æ˜¾ç¤º"99+"
3. è§’æ ‡ä½ç½®åœ¨å¤´åƒå³ä¸Šè§’
4. è§’æ ‡å¤§å°éšæ•°é‡å˜åŒ–
```

### 4.4 å®ç°ä¼˜å…ˆçº§

#### é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³å®æ–½ï¼‰

1. **ç»Ÿä¸€å¤´éƒ¨é«˜åº¦** - è°ƒæ•´ä¸º 52px
2. **ä¼˜åŒ–æ¶ˆæ¯é¢„è§ˆæ˜¾ç¤º** - è‰ç¨¿ä¼˜å…ˆ
3. **ä¼˜åŒ–å³é”®èœå•å®šä½** - å›ºå®šå±…ä¸­
4. **ä¼˜åŒ–é€‰ä¸­çŠ¶æ€æ˜¾ç¤º** - è¾“å…¥çŠ¶æ€

#### ä¸­ä¼˜å…ˆçº§ï¼ˆè¿‘æœŸå®æ–½ï¼‰

1. **ä¼˜åŒ–è¾“å…¥åŒºåŸŸé«˜åº¦** - è°ƒæ•´ä¸º 120px
2. **ä¼˜åŒ–æ¶ˆæ¯çŠ¶æ€å›¾æ ‡** - ç»Ÿä¸€æ ·å¼
3. **ä¼˜åŒ–æœªè¯»æ¶ˆæ¯æ˜¾ç¤º** - è§’æ ‡æ ·å¼
4. **æ·»åŠ èœå•åŠ¨ç”»æ•ˆæœ** - æ·¡å…¥ç¼©æ”¾

#### ä½ä¼˜å…ˆçº§ï¼ˆé•¿æœŸä¼˜åŒ–ï¼‰

1. **ä¼˜åŒ–ä¼šè¯åˆ—è¡¨å®½åº¦** - è°ƒæ•´ä¸º 280px
2. **æ·»åŠ æ™ºèƒ½èœå•å®šä½** - è¾¹ç•Œæ£€æµ‹
3. **ä¼˜åŒ–æ¶ˆæ¯é¢„è§ˆé•¿åº¦** - 30å­—ç¬¦
4. **æ·»åŠ çŠ¶æ€åˆ‡æ¢åŠ¨ç”»** - è¿‡æ¸¡æ•ˆæœ

---

## 5. æ€»ç»“ä¸å»ºè®®

### 5.1 é—®é¢˜æ€»ç»“

æœ¬æ¬¡åˆ†æå‘ç°äº†IMé¡¹ç›®æ¶ˆæ¯åŠŸèƒ½çš„å››ä¸ªä¸»è¦é—®é¢˜ï¼š

1. **è”ç³»äººåˆ—è¡¨BUG** - è‰ç¨¿çŠ¶æ€åŒæ­¥æœºåˆ¶ä¸å®Œå–„ï¼Œä½¿ç”¨å®šæ—¶å™¨è½®è¯¢å¯¼è‡´å»¶è¿Ÿ
2. **å³é”®èœå•å®šä½** - ä½¿ç”¨é¼ æ ‡ä½ç½®å®šä½ï¼Œæœªå®ç°å±…ä¸­æ˜¾ç¤º
3. **è¾“å…¥çŠ¶æ€åŒæ­¥** - è¾“å…¥çŠ¶æ€å’Œé€‰ä¸­çŠ¶æ€ç‹¬ç«‹ï¼Œç¼ºä¹ç»Ÿä¸€ç®¡ç†
4. **è®¾è®¡æ ‡å‡†** - éƒ¨åˆ†äº¤äº’é€»è¾‘ä¸é’‰é’‰/ä¼ä¸šå¾®ä¿¡ä¸ä¸€è‡´

### 5.2 è§£å†³æ–¹æ¡ˆä¼˜å…ˆçº§

#### é˜¶æ®µ1ï¼šæ ¸å¿ƒåŠŸèƒ½ä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰

1. **è‰ç¨¿çŠ¶æ€ç®¡ç†ä¼˜åŒ–** - è¿ç§»åˆ° Vuex store
2. **å³é”®èœå•å±…ä¸­æ˜¾ç¤º** - å›ºå®šä½ç½®
3. **è¾“å…¥çŠ¶æ€åŒæ­¥** - ç»Ÿä¸€çŠ¶æ€ç®¡ç†

#### é˜¶æ®µ2ï¼šäº¤äº’ä½“éªŒä¼˜åŒ–ï¼ˆ2-3å‘¨ï¼‰

1. **æ¶ˆæ¯é¢„è§ˆæ˜¾ç¤ºä¼˜åŒ–** - è‰ç¨¿ä¼˜å…ˆ
2. **é€‰ä¸­çŠ¶æ€æ˜¾ç¤ºä¼˜åŒ–** - è¾“å…¥çŠ¶æ€
3. **èœå•åŠ¨ç”»æ•ˆæœ** - æ·¡å…¥ç¼©æ”¾

#### é˜¶æ®µ3ï¼šè§†è§‰è®¾è®¡ä¼˜åŒ–ï¼ˆ3-4å‘¨ï¼‰

1. **ç»Ÿä¸€å¤´éƒ¨é«˜åº¦** - è°ƒæ•´ä¸º 52px
2. **ä¼˜åŒ–è¾“å…¥åŒºåŸŸé«˜åº¦** - è°ƒæ•´ä¸º 120px
3. **ä¼˜åŒ–æ¶ˆæ¯çŠ¶æ€å›¾æ ‡** - ç»Ÿä¸€æ ·å¼

### 5.3 å®æ–½å»ºè®®

#### å»ºè®®1ï¼šåˆ†é˜¶æ®µå®æ–½

**é˜¶æ®µ1ï¼šä¿®å¤æ ¸å¿ƒBUG**
- ä¼˜å…ˆè§£å†³è‰ç¨¿çŠ¶æ€åŒæ­¥é—®é¢˜
- ä¿®å¤å³é”®èœå•å®šä½é—®é¢˜
- å®ç°è¾“å…¥çŠ¶æ€åŒæ­¥

**é˜¶æ®µ2ï¼šä¼˜åŒ–äº¤äº’ä½“éªŒ**
- ä¼˜åŒ–æ¶ˆæ¯é¢„è§ˆæ˜¾ç¤º
- ä¼˜åŒ–é€‰ä¸­çŠ¶æ€æ˜¾ç¤º
- æ·»åŠ åŠ¨ç”»æ•ˆæœ

**é˜¶æ®µ3ï¼šå®Œå–„è§†è§‰è®¾è®¡**
- ç»Ÿä¸€å°ºå¯¸æ ‡å‡†
- ä¼˜åŒ–å›¾æ ‡æ ·å¼
- å®Œå–„åŠ¨ç”»æ•ˆæœ

#### å»ºè®®2ï¼šå»ºç«‹æµ‹è¯•è§„èŒƒ

**å•å…ƒæµ‹è¯•**ï¼š
- è‰ç¨¿çŠ¶æ€ç®¡ç†
- æ¶ˆæ¯å‘é€æµç¨‹
- çŠ¶æ€åŒæ­¥æœºåˆ¶

**é›†æˆæµ‹è¯•**ï¼š
- ä¼šè¯åˆ‡æ¢æµç¨‹
- æ¶ˆæ¯é¢„è§ˆæ˜¾ç¤º
- å³é”®èœå•åŠŸèƒ½

**UIæµ‹è¯•**ï¼š
- ç•Œé¢å¸ƒå±€ä¸€è‡´æ€§
- åŠ¨ç”»æ•ˆæœæµç•…æ€§
- å“åº”å¼é€‚é…

#### å»ºè®®3ï¼šå»ºç«‹è®¾è®¡è§„èŒƒ

**è®¾è®¡ä»¤ç‰Œç³»ç»Ÿ**ï¼š
- ç»Ÿä¸€é¢œè‰²æ–¹æ¡ˆ
- ç»Ÿä¸€å°ºå¯¸æ ‡å‡†
- ç»Ÿä¸€åŠ¨ç”»æ•ˆæœ

**ç»„ä»¶åº“**ï¼š
- ç»Ÿä¸€ç»„ä»¶æ ·å¼
- ç»Ÿä¸€äº¤äº’é€»è¾‘
- ç»Ÿä¸€çŠ¶æ€ç®¡ç†

**è®¾è®¡æ–‡æ¡£**ï¼š
- è®¾è®¡è§„èŒƒæ–‡æ¡£
- äº¤äº’è§„èŒƒæ–‡æ¡£
- å¼€å‘è§„èŒƒæ–‡æ¡£

### 5.4 é¢„æœŸæ•ˆæœ

é€šè¿‡å®æ–½æœ¬æŠ¥å‘Šæå‡ºçš„ä¼˜åŒ–æ–¹æ¡ˆï¼Œé¢„æœŸå¯ä»¥è¾¾åˆ°ä»¥ä¸‹æ•ˆæœï¼š

1. **ç”¨æˆ·ä½“éªŒæå‡**
   - è‰ç¨¿çŠ¶æ€å®æ—¶æ›´æ–°
   - èœå•å®šä½æ›´åŠ å‡†ç¡®
   - çŠ¶æ€åŒæ­¥æ›´åŠ æµç•…

2. **ç•Œé¢ä¸€è‡´æ€§æå‡**
   - ç¬¦åˆé’‰é’‰è®¾è®¡è§„èŒƒ
   - å°ºå¯¸æ ‡å‡†ç»Ÿä¸€
   - è§†è§‰æ•ˆæœä¸€è‡´

3. **ä»£ç è´¨é‡æå‡**
   - çŠ¶æ€ç®¡ç†ç»Ÿä¸€
   - ä»£ç ç»“æ„æ¸…æ™°
   - ç»´æŠ¤æ€§æé«˜

4. **æ€§èƒ½ä¼˜åŒ–**
   - å‡å°‘ä¸å¿…è¦çš„è½®è¯¢
   - ä¼˜åŒ–çŠ¶æ€æ›´æ–°æœºåˆ¶
   - æå‡å“åº”é€Ÿåº¦

---

## é™„å½•

### A. æ–‡ä»¶ç´¢å¼•

**æ ¸å¿ƒç»„ä»¶**ï¼š
- `/D:\MyCode\im\ruoyi-im-web\src\views\SessionPanel.vue` - ä¼šè¯åˆ—è¡¨
- `/D:\MyCode\im\ruoyi-im-web\src\views\ChatPanel.vue` - èŠå¤©é¢æ¿
- `/D:\MyCode\im\ruoyi-im-web\src\components\Chat\MessageInput.vue` - è¾“å…¥æ¡†

**çŠ¶æ€ç®¡ç†**ï¼š
- `/D:\MyCode\im\ruoyi-im-web\src\store\modules\im-session.js` - ä¼šè¯çŠ¶æ€
- `/D:\MyCode\im\ruoyi-im-web\src\store\modules\im-message.js` - æ¶ˆæ¯çŠ¶æ€

**å·¥å…·å‡½æ•°**ï¼š
- `/D:\MyCode\im\ruoyi-im-web\src\utils\message.js` - æ¶ˆæ¯å·¥å…·

**è®¾è®¡ç³»ç»Ÿ**ï¼š
- `/D:\MyCode\im\ruoyi-im-web\src\styles\design-tokens.scss` - è®¾è®¡ä»¤ç‰Œ

### B. å‚è€ƒæ–‡æ¡£

**é’‰é’‰è®¾è®¡è§„èŒƒ**ï¼š
- [é’‰é’‰è®¾è®¡è¯­è¨€](https://design.dingtalk.com/)
- [é’‰é’‰ç»„ä»¶åº“](https://design.dingtalk.com/components)

**ä¼ä¸šå¾®ä¿¡è®¾è®¡è§„èŒƒ**ï¼š
- [ä¼ä¸šå¾®ä¿¡è®¾è®¡æŒ‡å—](https://work.weixin.qq.com/design)

**Vue.js æœ€ä½³å®è·µ**ï¼š
- [Vuex å®˜æ–¹æ–‡æ¡£](https://vuex.vuejs.org/)
- [Vue 3 ç»„åˆå¼ API](https://cn.vuejs.org/guide/introduction.html)

### C. æµ‹è¯•æ£€æŸ¥æ¸…å•

**è‰ç¨¿çŠ¶æ€æµ‹è¯•**ï¼š
- [ ] è‰ç¨¿ä¿å­˜
- [ ] è‰ç¨¿åŠ è½½
- [ ] è‰ç¨¿æ¸…é™¤
- [ ] å¤šä¼šè¯è‰ç¨¿åˆ‡æ¢
- [ ] è‰ç¨¿ä¸å·²å‘é€æ¶ˆæ¯åˆ‡æ¢

**å³é”®èœå•æµ‹è¯•**ï¼š
- [ ] èœå•ä½ç½®å±…ä¸­
- [ ] è¾¹ç•Œæ£€æµ‹
- [ ] èœå•åŠ¨ç”»
- [ ] èœå•åŠŸèƒ½

**è¾“å…¥çŠ¶æ€æµ‹è¯•**ï¼š
- [ ] è¾“å…¥çŠ¶æ€åŒæ­¥
- [ ] é€‰ä¸­çŠ¶æ€åŒæ­¥
- [ ] è¾“å…¥çŠ¶æ€æ¸…é™¤
- [ ] å¤šä¼šè¯è¾“å…¥çŠ¶æ€

**æ¶ˆæ¯çŠ¶æ€æµ‹è¯•**ï¼š
- [ ] æ¶ˆæ¯å‘é€ä¸­
- [ ] æ¶ˆæ¯å‘é€æˆåŠŸ
- [ ] æ¶ˆæ¯å‘é€å¤±è´¥
- [ ] æ¶ˆæ¯å·²è¯»/æœªè¯»

---

**æŠ¥å‘Šå®Œæˆæ—¥æœŸ**ï¼š2026-01-28
**æŠ¥å‘Šç‰ˆæœ¬**ï¼šv1.0
**æŠ¥å‘Šä½œè€…**ï¼šAI Assistant