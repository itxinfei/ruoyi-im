# ============================================
# 企业级Web钉钉系统配置文件
# 500人并发优化配置
# ============================================

server:
  port: 8081
  servlet:
    context-path: /
    encoding:
      charset: UTF-8
      enabled: true
      force: true
  tomcat:
    # 优化Tomcat线程池
    threads:
      max: 500              # 最大线程数：500人并发，建议200-500
      min-spare: 50         # 最小空闲线程数
    # 连接配置
    max-connections: 1000   # 最大连接数
    accept-count: 200       # 等待队列长度
    connection-timeout: 10000  # 连接超时时间（毫秒）
  # 压缩配置
  compression:
    enabled: true
    mime-types: text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json
    min-response-size: 1024

spring:
  profiles:
    active: dev
  application:
    name: ruoyi-im-api

  # ===============================
  # 数据源配置（支持500人并发）
  # ===============================
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/im?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
    username: root
    password: your_password_here

    # Druid连接池配置
    druid:
      # 初始化连接数
      initial-size: 20
      # 最小空闲连接数
      min-idle: 30
      # 最大活跃连接数（500人并发，建议50-100）
      max-active: 100
      # 获取连接等待超时时间（毫秒）
      max-wait: 10000

      # 配置间隔多久进行一次检测，检测需要关闭的空闲连接（毫秒）
      time-between-eviction-runs-millis: 60000
      # 配置连接在池中最小生存时间（毫秒）
      min-evictable-idle-time-millis: 300000
      # 配置连接在池中最大生存时间（毫秒）
      max-evictable-idle-time-millis: 900000

      # 验证连接有效性的SQL
      validation-query: SELECT 1
      test-while-idle: true
      test-on-borrow: false
      test-on-return: false

      # 开启PSCache并指定每个连接上PSCache的大小
      pool-prepared-statements: true
      max-pool-prepared-statement-per-connection-size: 20
      # 合并多个DruidDataSource的监控数据
      use-global-data-source-stat: true

      # 慢SQL记录
      filter:
        stat:
          enabled: true
          # 慢SQL标准（毫秒）
          log-slow-sql: true
          slow-sql-millis: 1000
        wall:
          enabled: true
          config:
            # 允许执行的SQL类型
            select-allow: true
            insert-allow: true
            update-allow: true
            delete-allow: true
            # 禁止高危操作
            drop-table-allow: false
            create-table-allow: false
            alter-table-allow: false
            # 其他配置
            multi-statement-allow: true
            none-base-statement-allow: true
        slf4j:
          enabled: true
          statement-log-enabled: false
          statement-executable-sql-log-enable: true
          statement-log-error-enabled: true

      # WebStatFilter配置
      web-stat-filter:
        enabled: true
        url-pattern: /*
        exclusions: "*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*"
        session-stat-max-count: 1000

      # StatViewServlet配置
      stat-view-servlet:
        enabled: true
        url-pattern: /druid/*
        reset-enable: false
        login-username: admin
        login-password: admin123
        allow: 127.0.0.1,192.168.1.0/24
        deny:

  # ===============================
  # Redis缓存配置（提升性能）
  # ===============================
  redis:
    # 主库配置
    host: 127.0.0.1
    port: 6379
    password:
    database: 0
    timeout: 5000ms
    # Lettuce连接池配置
    lettuce:
      pool:
        # 最大连接数（500人并发，建议100-200）
        max-active: 200
        # 最大空闲连接数
        max-idle: 50
        # 最小空闲连接数
        min-idle: 20
        # 连接等待超时时间（毫秒）
        max-wait: 3000ms
      # 命令超时配置
      shutdown-timeout: 200ms

  # ===============================
  # 数据JPA配置
  # ===============================
  jpa:
    show-sql: false
    hibernate:
      ddl-auto: none
    open-in-view: false

  # ===============================
  # 文件上传配置
  # ===============================
  servlet:
    multipart:
      enabled: true
      # 单个文件最大大小
      max-file-size: 100MB
      # 请求最大大小
      max-request-size: 200MB
      # 文件大小阈值
      file-size-threshold: 0

  # ===============================
  # Jackson配置
  # ===============================
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT+8
    serialization:
      write-dates-as-timestamps: false
      indent-output: false
    default-property-inclusion: non_null

  # ===============================
  # Kafka消息队列配置（可选，用于削峰）
  # ===============================
  kafka:
    enabled: false  # 如需使用，设置为true
    bootstrap-servers: localhost:9092
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer
      # 批量发送配置
      batch-size: 16384
      linger-ms: 10
      # 重试配置
      retries: 3
      acks: 1
    consumer:
      group-id: im-consumer-group
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      auto-offset-reset: latest
      enable-auto-commit: false

# ===============================
# MyBatis-Plus配置
# ===============================
mybatis-plus:
  # Mapper XML文件位置
  mapper-locations: classpath*:/mapper/**/*.xml
  # 实体类包路径
  type-aliases-package: com.ruoyi.im.domain
  # 配置
  configuration:
    # 驼峰命名转换
    map-underscore-to-camel-case: true
    # 日志实现
    log-impl: org.apache.ibatis.logging.slf4j.Slf4jImpl
    # 开启二级缓存
    cache-enabled: true
    # 延迟加载
    lazy-loading-enabled: true
    aggressive-lazy-loading: false
    # 多结果集
    multiple-result-sets-enabled: true
    # 使用列标签代替列名
    use-column-label: true
    # 自动映射行为
    auto-mapping-behavior: partial
    # 默认执行器类型
    default-executor-type: REUSE
    # 默认超时时间（秒）
    default-statement-timeout: 30
    # 开启下划线转驼峰
    map-underscore-to-camel-case: true
  # 全局配置
  global:
    # 主键类型（AUTO自增，INPUT输入）
    id-type: auto
    # 逻辑删除字段名
    logic-delete-field: isDeleted
    # 逻辑删除值
    logic-delete-value: 1
    # 逻辑未删除值
    logic-not-delete-value: 0
    # 批量操作
    db-column-underline: true
    # 刷新mapper
    refresh: true
    # 数据库类型
    db-type: mysql

# ===============================
# IM系统配置
# ===============================
im:
  # 认证配置
  auth:
    enabled: true
    # Token过期时间（小时）
    token-expire-hours: 720
    # 刷新Token过期时间（天）
    refresh-token-expire-days: 30

  # WebSocket配置
  websocket:
    enabled: true
    # WebSocket路径
    path: /ws
    # 允许的源
    allowed-origins: "*"
    # 心跳间隔（秒）
    heartbeat-interval: 30
    # 最大空闲时间（秒）
    max-idle-timeout: 300
    # 最大消息大小（字节）
    max-text-message-buffer-size: 8192
    max-binary-message-buffer-size: 8192

  # 消息配置
  message:
    # 消息存储策略：all=全部存储, recent=仅最近消息
    storage-policy: recent
    # 最近消息保留天数
    recent-days: 90
    # 消息撤回时间限制（分钟）
    recall-limit-minutes: 2
    # 消息编辑时间限制（分钟）
    edit-limit-minutes: 2
    # 最大编辑次数
    max-edit-count: 3
    # 消息分页大小
    page-size: 50

  # 文件配置
  file:
    # 文件存储路径
    upload-path: D:/upload/im/
    # 文件访问URL前缀
    url-prefix: /file/
    # 最大文件大小（字节）
    max-file-size: 104857600  # 100MB
    # 允许的文件类型
    allowed-types: jpg,jpeg,png,gif,doc,docx,xls,xlsx,ppt,pptx,pdf,txt,zip,rar,mp3,mp4,avi,mov
    # 分片上传配置
    chunk:
      enabled: true
      chunk-size: 5242880  # 5MB
      max-chunks: 100

  # 群组配置
  group:
    # 最大群组成员数
    max-members: 500
    # 默认最大群成员数
    default-max-members: 100
    # 用户最大群组数
    max-groups-per-user: 100

  # 会话配置
  session:
    # 最大会话数
    max-sessions: 200
    # 会话列表分页大小
    page-size: 50

  # 敏感词配置
  sensitive:
    enabled: true
    # 敏感词处理策略：replace=替换, reject=拒绝
    action: replace
    # 替换字符
    replacement: ***

# ===============================
# 线程池配置
# ===============================
thread-pool:
  # 核心线程数
  core-pool-size: 20
  # 最大线程数
  max-pool-size: 100
  # 队列容量
  queue-capacity: 500
  # 线程空闲时间（秒）
  keep-alive-seconds: 60
  # 线程名称前缀
  thread-name-prefix: async-executor-

# ===============================
# Actuator监控配置
# ===============================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,druid,httptrace
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}

# ===============================
# 日志配置
# ===============================
logging:
  level:
    root: INFO
    com.ruoyi.im: DEBUG
    com.ruoyi.im.mapper: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n"
  file:
    name: logs/im-api.log
    max-size: 100MB
    max-history: 30
    total-size-cap: 10GB

# ===============================
# Swagger文档配置
# ===============================
springdoc:
  api-docs:
    enabled: true
    path: /v3/api-docs
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    tags-sorter: alpha
    operations-sorter: alpha
  group-configs:
    - group: 用户模块
      paths-to-match: /user/**
      packages-to-scan: com.ruoyi.im.controller
    - group: 消息模块
      paths-to-match: /message/**
      packages-to-scan: com.ruoyi.im.controller
    - group: 群组模块
      paths-to-match: /group/**
      packages-to-scan: com.ruoyi.im.controller
    - group: 文件模块
      paths-to-match: /file/**
      packages-to-scan: com.ruoyi.im.controller
    - group: 审批模块
      paths-to-match: /approval/**
      packages-to-scan: com.ruoyi.im.controller
