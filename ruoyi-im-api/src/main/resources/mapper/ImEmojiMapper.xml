<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.im.mapper.ImEmojiMapper">

    <resultMap type="com.ruoyi.im.domain.ImEmoji" id="ImEmojiResult">
        <id property="id" column="id"/>
        <result property="emojiCode" column="emoji_code"/>
        <result property="emojiUrl" column="emoji_url"/>
        <result property="emojiName" column="emoji_name"/>
        <result property="category" column="category"/>
        <result property="uploaderId" column="uploader_id"/>
        <result property="width" column="width"/>
        <result property="height" column="height"/>
        <result property="isPublic" column="is_public"/>
        <result property="shareCount" column="share_count"/>
        <result property="useCount" column="use_count"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <sql id="selectImEmojiVo">
        select id, emoji_code, emoji_url, emoji_name, category, uploader_id,
               width, height, is_public, share_count, use_count, create_time, update_time
        from im_emoji
    </sql>

    <select id="selectSystemEmojis" resultMap="ImEmojiResult">
        <include refid="selectImEmojiVo"/>
        where category = 'system'
        order by id asc
    </select>

    <select id="selectUserEmojis" resultMap="ImEmojiResult">
        <include refid="selectImEmojiVo"/>
        where category = 'custom' and uploader_id = #{userId}
        order by use_count desc, create_time desc
    </select>

    <select id="selectPublicEmojis" resultMap="ImEmojiResult">
        <include refid="selectImEmojiVo"/>
        where category = 'custom' and is_public = 1
        order by share_count desc, use_count desc
    </select>

    <select id="selectMostUsedEmojis" resultMap="ImEmojiResult">
        <include refid="selectImEmojiVo"/>
        where (category = 'system')
           or (category = 'custom' and (uploader_id = #{userId} or is_public = 1))
        order by use_count desc
        limit 20
    </select>

    <update id="incrementUseCount">
        update im_emoji
        set use_count = use_count + 1,
            update_time = now()
        where id = #{emojiId}
    </update>

    <update id="incrementShareCount">
        update im_emoji
        set share_count = share_count + 1,
            update_time = now()
        where id = #{emojiId}
    </update>

</mapper>
