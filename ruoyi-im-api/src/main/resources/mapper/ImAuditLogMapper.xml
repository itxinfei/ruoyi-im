<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.im.mapper.ImAuditLogMapper">

    <resultMap type="com.ruoyi.im.domain.ImAuditLog" id="ImAuditLogResult">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="userName" column="user_name"/>
        <result property="module" column="module"/>
        <result property="operationType" column="operation_type"/>
        <result property="description" column="description"/>
        <result property="requestMethod" column="request_method"/>
        <result property="requestUrl" column="request_url"/>
        <result property="requestParams" column="request_params"/>
        <result property="responseData" column="response_data"/>
        <result property="status" column="status"/>
        <result property="errorMsg" column="error_msg"/>
        <result property="executionTime" column="execution_time"/>
        <result property="clientIp" column="client_ip"/>
        <result property="userAgent" column="user_agent"/>
        <result property="operationTime" column="operation_time"/>
    </resultMap>

    <sql id="selectImAuditLogVo">
        select id, user_id, user_name, module, operation_type, description,
               request_method, request_url, request_params, response_data,
               status, error_msg, execution_time, client_ip, user_agent, operation_time
        from im_audit_log
    </sql>

    <select id="selectImAuditLogById" parameterType="Long" resultMap="ImAuditLogResult">
        <include refid="selectImAuditLogVo"/>
        where id = #{id}
    </select>

    <select id="selectImAuditLogList" parameterType="com.ruoyi.im.domain.ImAuditLog" resultMap="ImAuditLogResult">
        <include refid="selectImAuditLogVo"/>
        <where>
            <if test="userId != null">and user_id = #{userId}</if>
            <if test="userName != null and userName != ''">and user_name like concat('%', #{userName}, '%')</if>
            <if test="module != null and module != ''">and module = #{module}</if>
            <if test="operationType != null and operationType != ''">and operation_type = #{operationType}</if>
            <if test="status != null and status != ''">and status = #{status}</if>
        </where>
        order by operation_time desc
    </select>

    <select id="selectUserLogs" resultMap="ImAuditLogResult">
        <include refid="selectImAuditLogVo"/>
        where user_id = #{userId}
        and operation_time between #{startTime} and #{endTime}
        order by operation_time desc
    </select>

    <insert id="insertImAuditLog" parameterType="com.ruoyi.im.domain.ImAuditLog" useGeneratedKeys="true" keyProperty="id">
        insert into im_audit_log
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="userId != null">user_id,</if>
            <if test="userName != null and userName != ''">user_name,</if>
            <if test="module != null and module != ''">module,</if>
            <if test="operationType != null and operationType != ''">operation_type,</if>
            <if test="description != null">description,</if>
            <if test="requestMethod != null and requestMethod != ''">request_method,</if>
            <if test="requestUrl != null and requestUrl != ''">request_url,</if>
            <if test="requestParams != null">request_params,</if>
            <if test="responseData != null">response_data,</if>
            <if test="status != null and status != ''">status,</if>
            <if test="errorMsg != null">error_msg,</if>
            <if test="executionTime != null">execution_time,</if>
            <if test="clientIp != null and clientIp != ''">client_ip,</if>
            <if test="userAgent != null and userAgent != ''">user_agent,</if>
            <if test="operationTime != null">operation_time,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="userId != null">#{userId},</if>
            <if test="userName != null and userName != ''">#{userName},</if>
            <if test="module != null and module != ''">#{module},</if>
            <if test="operationType != null and operationType != ''">#{operationType},</if>
            <if test="description != null">#{description},</if>
            <if test="requestMethod != null and requestMethod != ''">#{requestMethod},</if>
            <if test="requestUrl != null and requestUrl != ''">#{requestUrl},</if>
            <if test="requestParams != null">#{requestParams},</if>
            <if test="responseData != null">#{responseData},</if>
            <if test="status != null and status != ''">#{status},</if>
            <if test="errorMsg != null">#{errorMsg},</if>
            <if test="executionTime != null">#{executionTime},</if>
            <if test="clientIp != null and clientIp != ''">#{clientIp},</if>
            <if test="userAgent != null and userAgent != ''">#{userAgent},</if>
            <if test="operationTime != null">#{operationTime},</if>
        </trim>
    </insert>

    <delete id="deleteExpiredLogs">
        delete from im_audit_log where operation_time &lt; #{beforeDate}
    </delete>

</mapper>
