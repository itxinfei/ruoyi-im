<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.im.mapper.ImMessageMapper">
    
    <resultMap type="com.ruoyi.im.domain.ImMessage" id="ImMessageResult">
        <id property="id" column="id"/>
        <result property="sessionId" column="session_id"/>
        <result property="senderId" column="sender_id"/>
        <result property="receiverId" column="receiver_id"/>
        <result property="type" column="type"/>
        <result property="content" column="content"/>
        <result property="status" column="status"/>
        <result property="isRevoked" column="is_revoked"/>
        <result property="revokeTime" column="revoke_time"/>
        <result property="sendTime" column="send_time"/>
        <result property="createTime" column="create_time"/>
        <result property="parentId" column="parent_id"/>
    </resultMap>

    <sql id="selectImMessageVo">
        select id, session_id, sender_id, receiver_id, type, content, status, is_revoked, revoke_time, send_time, create_time, parent_id
        from im_message
    </sql>

    <select id="selectImMessageById" parameterType="Long" resultMap="ImMessageResult">
        <include refid="selectImMessageVo"/>
        where id = #{id}
    </select>
    
    <select id="selectImMessageList" parameterType="com.ruoyi.im.domain.ImMessage" resultMap="ImMessageResult">
        <include refid="selectImMessageVo"/>
        <where>
            <if test="sessionId != null"> and session_id = #{sessionId} </if>
            <if test="senderId != null"> and sender_id = #{senderId} </if>
            <if test="receiverId != null"> and receiver_id = #{receiverId} </if>
            <if test="type != null and type != ''"> and type = #{type} </if>
            <if test="status != null and status != ''"> and status = #{status} </if>
        </where>
    </select>

    <insert id="insertImMessage" parameterType="com.ruoyi.im.domain.ImMessage" useGeneratedKeys="true" keyProperty="id">
        insert into im_message
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="sessionId != null">session_id,</if>
            <if test="senderId != null">sender_id,</if>
            <if test="receiverId != null">receiver_id,</if>
            <if test="type != null">type,</if>
            <if test="content != null">content,</if>
            <if test="status != null">status,</if>
            <if test="isRevoked != null">is_revoked,</if>
            <if test="revokeTime != null">revoke_time,</if>
            <if test="sendTime != null">send_time,</if>
            <if test="createTime != null">create_time,</if>
            <if test="parentId != null">parent_id,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="sessionId != null">#{sessionId},</if>
            <if test="senderId != null">#{senderId},</if>
            <if test="receiverId != null">#{receiverId},</if>
            <if test="type != null">#{type},</if>
            <if test="content != null">#{content},</if>
            <if test="status != null">#{status},</if>
            <if test="isRevoked != null">#{isRevoked},</if>
            <if test="revokeTime != null">#{revokeTime},</if>
            <if test="sendTime != null">#{sendTime},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="parentId != null">#{parentId},</if>
        </trim>
    </insert>

    <update id="updateImMessage" parameterType="com.ruoyi.im.domain.ImMessage">
        update im_message
        <trim prefix="SET" suffixOverrides=",">
            <if test="sessionId != null">session_id = #{sessionId},</if>
            <if test="senderId != null">sender_id = #{senderId},</if>
            <if test="receiverId != null">receiver_id = #{receiverId},</if>
            <if test="type != null and type != ''">type = #{type},</if>
            <if test="content != null and content != ''">content = #{content},</if>
            <if test="status != null and status != ''">status = #{status},</if>
            <if test="isRevoked != null">is_revoked = #{isRevoked},</if>
            <if test="revokeTime != null">revoke_time = #{revokeTime},</if>
            <if test="sendTime != null">send_time = #{sendTime},</if>
            <if test="parentId != null">parent_id = #{parentId},</if>
        </trim>
        where id = #{id}
    </update>

    <delete id="deleteImMessageById" parameterType="Long">
        delete from im_message where id = #{id}
    </delete>

    <delete id="deleteImMessageByIds" parameterType="Long[]">
        delete from im_message where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
    
    <select id="selectImMessageByConversationId" parameterType="map" resultMap="ImMessageResult">
        select id, session_id, sender_id, receiver_id, type, content, status, is_revoked, revoke_time, send_time, create_time, parent_id
        from im_message
        where session_id = #{conversationId}
        order by create_time desc
        limit #{limit}
    </select>
    
    <!-- 分页查询会话消息 - 性能优化 -->
    <select id="selectImMessageByConversationIdWithPagination" parameterType="map" resultMap="ImMessageResult">
        <include refid="selectImMessageVo"/>
        <where>
            <if test="conversationId != null"> and session_id = #{conversationId} </if>
            <if test="senderId != null"> and sender_id = #{senderId} </if>
            <if test="receiverId != null"> and receiver_id = #{receiverId} </if>
            <if test="type != null and type != ''"> and type = #{type} </if>
            <if test="status != null and status != ''"> and status = #{status} </if>
        </where>
        order by create_time desc
        limit #{limit} offset #{offset}
    </select>
    
    <!-- 批量插入消息 - 性能优化 -->
    <insert id="batchInsertImMessage" parameterType="java.util.List">
        insert into im_message (session_id, sender_id, receiver_id, type, content, status, is_revoked, revoke_time, send_time, create_time, parent_id)
        values
        <foreach collection="list" item="message" separator=",">
            (#{message.sessionId}, #{message.senderId}, #{message.receiverId}, #{message.type}, #{message.content}, 
             #{message.status}, #{message.isRevoked}, #{message.revokeTime}, #{message.sendTime}, #{message.createTime}, #{message.parentId})
        </foreach>
    </insert>
    
    <!-- 批量更新消息状态 - 性能优化 -->
    <update id="batchUpdateMessageStatus">
        update im_message
        set status = #{status}
        where id in
        <foreach collection="messageIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>
    
    <!-- 批量删除消息 - 性能优化 -->
    <delete id="batchDeleteMessages">
        delete from im_message
        where id in
        <foreach collection="messageIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
    
    <!-- 统计会话消息数量 - 性能优化 -->
    <select id="countMessagesByConversationId" parameterType="Long" resultType="java.lang.Long">
        select count(*)
        from im_message
        where session_id = #{conversationId}
    </select>
    
    <!-- 检查会话是否存在消息 - 性能优化 -->
    <select id="existsByConversationId" parameterType="Long" resultType="java.lang.Boolean">
        select case when count(*) > 0 then true else false end
        from im_message
        where session_id = #{conversationId}
    </select>
</mapper>