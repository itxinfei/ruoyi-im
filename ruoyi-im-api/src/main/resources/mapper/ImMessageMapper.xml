<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.im.mapper.ImMessageMapper">
    
    <resultMap type="com.ruoyi.im.domain.ImMessage" id="ImMessageResult">
        <id property="id" column="id"/>
        <result property="conversationId" column="conversation_id"/>
        <result property="senderId" column="sender_id"/>
        <result property="type" column="message_type"/>
        <result property="content" column="content"/>
        <result property="isRevoked" column="is_revoked"/>
        <result property="revokedTime" column="revoked_time"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="replyToMessageId" column="reply_to_message_id"/>
        <result property="forwardFromMessageId" column="forward_from_message_id"/>
        <result property="sensitiveLevel" column="sensitive_level"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="deletedTime" column="deleted_time"/>
    </resultMap>

    <sql id="selectImMessageVo">
        select id, conversation_id, sender_id, message_type, content, is_revoked, revoked_time, create_time, update_time, reply_to_message_id, forward_from_message_id, sensitive_level, is_deleted, deleted_time
        from im_message
    </sql>

    <select id="selectImMessageById" parameterType="Long" resultMap="ImMessageResult">
        <include refid="selectImMessageVo"/>
        where id = #{id}
    </select>
    
    <select id="selectImMessageList" parameterType="com.ruoyi.im.domain.ImMessage" resultMap="ImMessageResult">
        <include refid="selectImMessageVo"/>
        <where>
            <if test="conversationId != null"> and conversation_id = #{conversationId} </if>
            <if test="senderId != null"> and sender_id = #{senderId} </if>
            <if test="type != null and type != ''"> and message_type = #{type} </if>
        </where>
    </select>

    <insert id="insertImMessage" parameterType="com.ruoyi.im.domain.ImMessage" useGeneratedKeys="true" keyProperty="id">
        insert into im_message
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="conversationId != null">conversation_id,</if>
            <if test="senderId != null">sender_id,</if>
            <if test="type != null">message_type,</if>
            <if test="content != null">content,</if>
            <if test="isRevoked != null">is_revoked,</if>
            <if test="revokedTime != null">revoked_time,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="replyToMessageId != null">reply_to_message_id,</if>
            <if test="forwardFromMessageId != null">forward_from_message_id,</if>
            <if test="sensitiveLevel != null">sensitive_level,</if>
            <if test="isDeleted != null">is_deleted,</if>
            <if test="deletedTime != null">deleted_time,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="conversationId != null">#{conversationId},</if>
            <if test="senderId != null">#{senderId},</if>
            <if test="type != null">#{type},</if>
            <if test="content != null">#{content},</if>
            <if test="isRevoked != null">#{isRevoked},</if>
            <if test="revokedTime != null">#{revokedTime},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="replyToMessageId != null">#{replyToMessageId},</if>
            <if test="forwardFromMessageId != null">#{forwardFromMessageId},</if>
            <if test="sensitiveLevel != null">#{sensitiveLevel},</if>
            <if test="isDeleted != null">#{isDeleted},</if>
            <if test="deletedTime != null">#{deletedTime},</if>
        </trim>
    </insert>

    <update id="updateImMessage" parameterType="com.ruoyi.im.domain.ImMessage">
        update im_message
        <trim prefix="SET" suffixOverrides=",">
            <if test="conversationId != null">conversation_id = #{conversationId},</if>
            <if test="senderId != null">sender_id = #{senderId},</if>
            <if test="type != null and type != ''">message_type = #{type},</if>
            <if test="content != null and content != ''">content = #{content},</if>
            <if test="isRevoked != null">is_revoked = #{isRevoked},</if>
            <if test="revokedTime != null">revoked_time = #{revokedTime},</if>
            <if test="replyToMessageId != null">reply_to_message_id = #{replyToMessageId},</if>
            <if test="forwardFromMessageId != null">forward_from_message_id = #{forwardFromMessageId},</if>
            <if test="sensitiveLevel != null">sensitive_level = #{sensitiveLevel},</if>
            <if test="isDeleted != null">is_deleted = #{isDeleted},</if>
            <if test="deletedTime != null">deleted_time = #{deletedTime},</if>
        </trim>
        where id = #{id}
    </update>

    <delete id="deleteImMessageById" parameterType="Long">
        delete from im_message where id = #{id}
    </delete>

    <delete id="deleteImMessageByIds" parameterType="Long[]">
        delete from im_message where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
    
    <select id="selectImMessageByConversationId" parameterType="map" resultMap="ImMessageResult">
        select id, conversation_id, sender_id, message_type, content, is_revoked, revoked_time, create_time, update_time, reply_to_message_id, forward_from_message_id, sensitive_level, is_deleted, deleted_time
        from im_message
        where conversation_id = #{conversationId}
        order by create_time desc
        limit #{limit}
    </select>
    
    <!-- 分页查询会话消息 - 性能优化 -->
    <select id="selectImMessageByConversationIdWithPagination" parameterType="map" resultMap="ImMessageResult">
        <include refid="selectImMessageVo"/>
        <where>
            <if test="conversationId != null"> and conversation_id = #{conversationId} </if>
            <if test="senderId != null"> and sender_id = #{senderId} </if>
            <if test="type != null and type != ''"> and message_type = #{type} </if>
        </where>
        order by create_time desc
        limit #{limit} offset #{offset}
    </select>
    
    <!-- 批量插入消息 - 性能优化 -->
    <insert id="batchInsertImMessage" parameterType="java.util.List">
        insert into im_message (conversation_id, sender_id, message_type, content, is_revoked, revoked_time, create_time, update_time, reply_to_message_id, forward_from_message_id, sensitive_level, is_deleted, deleted_time)
        values
        <foreach collection="list" item="message" separator=",">
            (#{message.conversationId}, #{message.senderId}, #{message.type}, #{message.content}, 
             #{message.isRevoked}, #{message.revokedTime}, #{message.createTime}, #{message.updateTime}, #{message.replyToMessageId}, #{message.forwardFromMessageId}, #{message.sensitiveLevel}, #{message.isDeleted}, #{message.deletedTime})
        </foreach>
    </insert>
    
    <!-- 批量更新消息状态 - 性能优化 -->
    <update id="batchUpdateMessageStatus">
        update im_message
        set status = #{status}
        where id in
        <foreach collection="messageIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>
    
    <!-- 批量删除消息 - 性能优化 -->
    <delete id="batchDeleteMessages">
        delete from im_message
        where id in
        <foreach collection="messageIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
    
    <!-- 统计会话消息数量 - 性能优化 -->
    <select id="countMessagesByConversationId" parameterType="Long" resultType="java.lang.Long">
        select count(*)
        from im_message
        where conversation_id = #{conversationId}
    </select>
    
    <!-- 检查会话是否存在消息 - 性能优化 -->
    <select id="existsByConversationId" parameterType="Long" resultType="java.lang.Boolean">
        select case when count(*) > 0 then true else false end
        from im_message
        where conversation_id = #{conversationId}
    </select>

    <!-- ==================== 消息搜索相关SQL ==================== -->

    <!-- 搜索消息 -->
    <select id="searchMessages" resultMap="ImMessageResult">
        <include refid="selectImMessageVo"/>
        <where>
            <if test="conversationId != null"> and conversation_id = #{conversationId} </if>
            <if test="keyword != null and keyword != ''">
                <choose>
                    <when test="exactMatch">
                        and content = #{keyword}
                    </when>
                    <otherwise>
                        and content like CONCAT('%', #{keyword}, '%')
                    </otherwise>
                </choose>
            </if>
            <if test="messageType != null and messageType != ''"> and message_type = #{messageType} </if>
            <if test="senderId != null"> and sender_id = #{senderId} </if>
            <if test="startTime != null"> and create_time &gt;= #{startTime} </if>
            <if test="endTime != null"> and create_time &lt;= #{endTime} </if>
            <if test="includeRevoked == null or includeRevoked == false"> and is_revoked = 0 </if>
            and is_deleted = 0
        </where>
        order by create_time desc
        <if test="limit != null">
            limit #{limit}
            <if test="offset != null"> offset #{offset} </if>
        </if>
    </select>

    <!-- 统计搜索结果数量 -->
    <select id="countSearchResults" resultType="java.lang.Integer">
        select count(*)
        from im_message
        <where>
            <if test="conversationId != null"> and conversation_id = #{conversationId} </if>
            <if test="keyword != null and keyword != ''">
                <choose>
                    <when test="exactMatch">
                        and content = #{keyword}
                    </when>
                    <otherwise>
                        and content like CONCAT('%', #{keyword}, '%')
                    </otherwise>
                </choose>
            </if>
            <if test="messageType != null and messageType != ''"> and message_type = #{messageType} </if>
            <if test="senderId != null"> and sender_id = #{senderId} </if>
            <if test="startTime != null"> and create_time &gt;= #{startTime} </if>
            <if test="endTime != null"> and create_time &lt;= #{endTime} </if>
            <if test="includeRevoked == null or includeRevoked == false"> and is_revoked = 0 </if>
            and is_deleted = 0
        </where>
    </select>

    <!-- 获取搜索结果的高亮上下文 -->
    <select id="getHighlightContext" resultType="java.lang.String">
        select content
        from im_message
        where id = #{messageId}
    </select>
</mapper>