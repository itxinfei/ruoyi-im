<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.im.mapper.ImAttendanceGroupMemberMapper">

    <resultMap type="com.ruoyi.im.domain.ImAttendanceGroupMember" id="ImAttendanceGroupMemberResult">
        <id property="id" column="id"/>
        <result property="groupId" column="group_id"/>
        <result property="userId" column="user_id"/>
        <result property="userName" column="user_name"/>
        <result property="role" column="role"/>
        <result property="joinTime" column="join_time"/>
        <result property="leaveTime" column="leave_time"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
    </resultMap>

    <sql id="selectImAttendanceGroupMemberVo">
        select id, group_id, user_id, user_name, role, join_time, leave_time, status, create_time
        from im_attendance_group_member
    </sql>

    <select id="selectByGroupId" resultMap="ImAttendanceGroupMemberResult">
        <include refid="selectImAttendanceGroupMemberVo"/>
        where group_id = #{groupId}
        order by join_time asc
    </select>

    <select id="selectByGroupAndUser" resultMap="ImAttendanceGroupMemberResult">
        <include refid="selectImAttendanceGroupMemberVo"/>
        where group_id = #{groupId} and user_id = #{userId}
    </select>

    <insert id="batchInsert">
        insert into im_attendance_group_member (group_id, user_id, user_name, role, status, join_time, create_time)
        values
        <foreach collection="members" item="item" separator=",">
            (#{item.groupId}, #{item.userId}, #{item.userName}, #{item.role}, #{item.status}, #{item.joinTime}, #{item.createTime})
        </foreach>
    </insert>

    <update id="batchUpdateStatus">
        update im_attendance_group_member
        set status = #{status},
            leave_time = if(#{status} = 'LEFT', now(), null),
            update_time = now()
        where group_id = #{groupId}
        and user_id in
        <foreach collection="userIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

</mapper>
