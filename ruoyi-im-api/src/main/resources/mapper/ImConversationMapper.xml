<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.im.mapper.ImConversationMapper">
    
    <resultMap type="com.ruoyi.im.domain.ImConversation" id="ImConversationResult">
        <id property="id" column="id"/>
        <result property="type" column="type"/>
        <result property="targetId" column="target_id"/>
        <result property="name" column="name"/>
        <result property="avatar" column="avatar"/>
        <result property="lastMessageId" column="last_message_id"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="deletedTime" column="deleted_time"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <sql id="selectImConversationVo">
        select id, type, target_id, name, avatar, last_message_id, is_deleted, deleted_time, create_time, update_time 
        from im_conversation
    </sql>

    <select id="selectImConversationById" parameterType="Long" resultMap="ImConversationResult">
        <include refid="selectImConversationVo"/>
        where id = #{id}
    </select>
    
    <select id="selectImConversationList" parameterType="com.ruoyi.im.domain.ImConversation" resultMap="ImConversationResult">
        <include refid="selectImConversationVo"/>
        <where>
            <if test="type != null and type != ''"> and type = #{type} </if>
            <if test="targetId != null"> and target_id = #{targetId} </if>
        </where>
    </select>

    <insert id="insertImConversation" parameterType="com.ruoyi.im.domain.ImConversation" useGeneratedKeys="true" keyProperty="id">
        insert into im_conversation
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="type != null">type,</if>
            <if test="targetId != null">target_id,</if>
            <if test="name != null">name,</if>
            <if test="avatar != null">avatar,</if>
            <if test="lastMessageId != null">last_message_id,</if>
            <if test="isDeleted != null">is_deleted,</if>
            <if test="deletedTime != null">deleted_time,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateTime != null">update_time,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="type != null">#{type},</if>
            <if test="targetId != null">#{targetId},</if>
            <if test="name != null">#{name},</if>
            <if test="avatar != null">#{avatar},</if>
            <if test="lastMessageId != null">#{lastMessageId},</if>
            <if test="isDeleted != null">#{isDeleted},</if>
            <if test="deletedTime != null">#{deletedTime},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateTime != null">#{updateTime},</if>
        </trim>
    </insert>

    <update id="updateImConversation" parameterType="com.ruoyi.im.domain.ImConversation">
        update im_conversation
        <trim prefix="SET" suffixOverrides=",">
            <if test="type != null">type = #{type},</if>
            <if test="targetId != null">target_id = #{targetId},</if>
            <if test="name != null">name = #{name},</if>
            <if test="avatar != null">avatar = #{avatar},</if>
            <if test="lastMessageId != null">last_message_id = #{lastMessageId},</if>
            <if test="isDeleted != null">is_deleted = #{isDeleted},</if>
            <if test="deletedTime != null">deleted_time = #{deletedTime},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </trim>
        where id = #{id}
    </update>

    <delete id="deleteImConversationById" parameterType="Long">
        delete from im_conversation where id = #{id}
    </delete>

    <delete id="deleteImConversationByIds" parameterType="Long[]">
        delete from im_conversation where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
    
    <select id="selectImConversationListByUserId" resultMap="ImConversationResult">
        select c.id, c.type, c.target_id, c.name, c.avatar, c.last_message_id, c.is_deleted, c.deleted_time, c.create_time, c.update_time 
        from im_conversation c
        left join im_conversation_member m on c.id = m.conversation_id
        where m.user_id = #{userId}
        <if test="type != null and type != ''"> and c.type = #{type} </if>
        order by c.update_time desc
    </select>
    
    <select id="selectImConversationByTypeAndTargetId" parameterType="map" resultMap="ImConversationResult">
        select id, type, target_id, last_message_id, create_time, update_time
        from im_conversation
        where type = #{type} and target_id = #{targetId}
    </select>
    
    <!-- 批量插入会话 - 性能优化 -->
    <insert id="batchInsertImConversation" parameterType="java.util.List">
        insert into im_conversation (type, target_id, name, avatar, last_message_id, is_deleted, deleted_time, create_time, update_time)
        values
        <foreach collection="list" item="conversation" separator=",">
            (#{conversation.type}, #{conversation.targetId}, #{conversation.name}, #{conversation.avatar}, 
             #{conversation.lastMessageId}, #{conversation.isDeleted}, #{conversation.deletedTime}, 
             #{conversation.createTime}, #{conversation.updateTime})
        </foreach>
    </insert>
    
    <!-- 批量更新会话 - 性能优化 -->
    <update id="batchUpdateImConversation" parameterType="java.util.List">
        update im_conversation
        <trim prefix="SET" suffixOverrides=",">
            <if test="list[0].name != null and list[0].name != ''">name = 
                CASE id
                    <foreach collection="list" item="conversation">
                        WHEN #{conversation.id} THEN #{conversation.name}
                    </foreach>
                END,
            </if>
            <if test="list[0].avatar != null and list[0].avatar != ''">avatar = 
                CASE id
                    <foreach collection="list" item="conversation">
                        WHEN #{conversation.id} THEN #{conversation.avatar}
                    </foreach>
                END,
            </if>
            <if test="list[0].lastMessageId != null">last_message_id = 
                CASE id
                    <foreach collection="list" item="conversation">
                        WHEN #{conversation.id} THEN #{conversation.lastMessageId}
                    </foreach>
                END,
            </if>
            <if test="list[0].updateTime != null">update_time = 
                CASE id
                    <foreach collection="list" item="conversation">
                        WHEN #{conversation.id} THEN #{conversation.updateTime}
                    </foreach>
                END,
            </if>
        </trim>
        where id in
        <foreach collection="list" item="conversation" open="(" separator="," close=")">
            #{conversation.id}
        </foreach>
    </update>
    
    <!-- 分页查询用户会话列表 - 性能优化 -->
    <select id="selectUserConversationListWithPagination" resultMap="ImConversationResult">
        select c.id, c.type, c.target_id, c.name, c.avatar, c.last_message_id, c.is_deleted, c.deleted_time, c.create_time, c.update_time
        from im_conversation c
        left join im_conversation_member m on c.id = m.conversation_id
        <where>
            m.user_id = #{userId}
            <if test="type != null and type != ''"> and c.type = #{type} </if>
        </where>
        order by c.update_time desc
        limit #{limit} offset #{offset}
    </select>
    
    <!-- 批量删除会话 - 性能优化 -->
    <delete id="batchDeleteConversations">
        delete from im_conversation
        where id in
        <foreach collection="conversationIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>
    
    <!-- 检查会话是否存在 - 性能优化 -->
    <select id="existsByTypeAndTargetId" resultType="java.lang.Boolean">
        select case when count(*) > 0 then true else false end
        from im_conversation
        where type = #{type} and target_id = #{targetId}
    </select>
    
    <!-- 统计用户会话数量 - 性能优化 -->
    <select id="countUserConversations" resultType="java.lang.Integer">
        select count(*)
        from im_conversation c
        left join im_conversation_member m on c.id = m.conversation_id
        where m.user_id = #{userId}
        <if test="type != null and type != ''"> and c.type = #{type} </if>
    </select>
</mapper>