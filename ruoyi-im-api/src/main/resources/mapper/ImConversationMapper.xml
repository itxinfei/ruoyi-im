<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.im.mapper.ImConversationMapper">

    <resultMap id="BaseResultMap" type="com.ruoyi.im.domain.ImConversation">
        <id column="id" property="id" />
        <result column="type" property="type" />
        <result column="target_id" property="targetId" />
        <result column="name" property="name" />
        <result column="avatar" property="avatar" />
        <result column="last_message_id" property="lastMessageId" />
        <result column="last_message_time" property="lastMessageTime" />
        <result column="is_deleted" property="isDeleted" />
        <result column="deleted_time" property="deletedTime" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
    </resultMap>

    <sql id="Base_Column_List">
        id, type, target_id, name, avatar, last_message_id, last_message_time, is_deleted, deleted_time, create_time, update_time
    </sql>

    <select id="selectConversationsByUserId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM im_conversation c
        JOIN im_conversation_member cm ON c.id = cm.conversation_id
        WHERE cm.user_id = #{userId} AND cm.is_deleted = 0
        ORDER BY cm.is_pinned DESC, c.last_message_time DESC
    </select>

    <select id="selectByUserId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM im_conversation c
        JOIN im_conversation_member cm ON c.id = cm.conversation_id
        WHERE cm.user_id = #{userId} AND cm.is_deleted = 0
        ORDER BY cm.is_pinned DESC, c.last_message_time DESC
    </select>

    <select id="selectConversationByUserIdAndTargetId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM im_conversation c
        JOIN im_conversation_member cm ON c.id = cm.conversation_id
        WHERE cm.user_id = #{userId} AND c.target_id = #{targetId}
    </select>

    <select id="selectByTypeAndTarget" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM im_conversation
        WHERE type = #{type}
          AND target_id = #{targetId1}
          AND is_deleted = 0
        LIMIT 1
    </select>

    <update id="updateLastMessage">
        UPDATE im_conversation
        SET last_message_id = #{lastMessageId},
            last_message_time = #{lastMessageTime},
            update_time = NOW()
        WHERE id = #{conversationId}
    </update>

    <select id="searchConversations" resultMap="BaseResultMap">
        SELECT DISTINCT c.*
        FROM im_conversation c
        JOIN im_conversation_member cm ON c.id = cm.conversation_id
        LEFT JOIN im_message m ON c.last_message_id = m.id
        WHERE cm.user_id = #{userId} AND cm.is_deleted = 0
          AND (c.name LIKE CONCAT('%', #{keyword}, '%')
               OR m.content LIKE CONCAT('%', #{keyword}, '%'))
        ORDER BY cm.is_pinned DESC, c.last_message_time DESC
    </select>

    <select id="getTotalUnreadCount" resultType="java.lang.Integer">
        SELECT COALESCE(SUM(unread_count), 0)
        FROM im_conversation_member
        WHERE user_id = #{userId} AND is_deleted = 0
    </select>

    <select id="selectImConversationList" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM im_conversation
        <where>
            is_deleted = 0
            <if test="type != null and type != ''">
                AND type = #{type}
            </if>
            <if test="targetId != null">
                AND target_id = #{targetId}
            </if>
        </where>
        ORDER BY update_time DESC
    </select>

    <!-- 优化的批量查询：一次性获取用户会话及相关数据 -->
    <resultMap id="ConversationWithMemberVO" type="com.ruoyi.im.vo.conversation.ImConversationVO">
        <id column="id" property="id" />
        <result column="type" property="type" />
        <result column="target_id" property="targetId" />
        <result column="name" property="name" />
        <result column="avatar" property="avatar" />
        <result column="last_message_id" property="lastMessageId" />
        <result column="last_message_time" property="lastMessageTime" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
        <result column="unread_count" property="unreadCount" />
        <result column="is_pinned" property="isPinned" />
        <result column="is_muted" property="isMuted" />
        <result column="last_read_message_id" property="lastReadMessageId" />
    </resultMap>

    <!-- 批量获取用户的会话（带成员信息） -->
    <select id="selectUserConversationsWithMembers" resultMap="ConversationWithMemberVO">
        SELECT
            c.id, c.type, c.target_id, c.name, c.avatar, c.last_message_id, c.last_message_time,
            c.create_time, c.update_time,
            cm.unread_count, cm.is_pinned, cm.is_muted, cm.last_read_message_id
        FROM im_conversation c
        JOIN im_conversation_member cm ON c.id = cm.conversation_id
        WHERE cm.user_id = #{userId} AND cm.is_deleted = 0 AND c.is_deleted = 0
        ORDER BY cm.is_pinned DESC, c.last_message_time DESC
    </select>

    <!-- 批量获取会话的最后消息（一次性获取所有） -->
    <select id="selectLastMessagesByConversationIds" resultMap="com.ruoyi.im.mapper.ImMessageMapper.ImMessageResult">
        SELECT id, conversation_id, sender_id, message_type, content,
               reply_to_message_id, forward_from_message_id,
               file_url, file_name, file_size,
               sensitive_level,
               client_msg_id, send_status, send_retry_count,
               send_error_code, send_error_msg, delivered_time,
               is_revoked, revoked_time, revoker_id,
               is_edited, edited_content, edit_count, edit_time,
               is_deleted, deleted_time,
               create_time, update_time
        FROM im_message
        WHERE id IN (
            SELECT MAX(id) FROM im_message
            WHERE conversation_id IN
            <foreach collection="conversationIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
            AND is_revoked = 0
            AND is_deleted = 0
            GROUP BY conversation_id
        )
    </select>

    <!-- 批量获取用户信息 -->
    <select id="selectUsersByIds" resultType="com.ruoyi.im.domain.ImUser">
        SELECT id, username, nickname, avatar, email, status
        FROM im_user
        WHERE id IN
        <foreach collection="userIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <!-- 批量获取群组信息 -->
    <select id="selectGroupsByIds" resultType="com.ruoyi.im.domain.ImGroup">
        SELECT id, name, avatar, description
        FROM im_group
        WHERE id IN
        <foreach collection="groupIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

</mapper>
