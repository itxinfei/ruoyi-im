<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.im.mapper.ImAnnouncementMapper">

    <resultMap id="BaseResultMap" type="com.ruoyi.im.domain.ImAnnouncement">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="announcement_type" property="announcementType"/>
        <result column="priority" property="priority"/>
        <result column="status" property="status"/>
        <result column="publisher_id" property="publisherId"/>
        <result column="publish_time" property="publishTime"/>
        <result column="expiry_time" property="expiryTime"/>
        <result column="department_id" property="departmentId"/>
        <result column="target_type" property="targetType"/>
        <result column="target_ids" property="targetIds"/>
        <result column="attachments" property="attachments"/>
        <result column="is_pinned" property="isPinned"/>
        <result column="allow_comment" property="allowComment"/>
        <result column="view_count" property="viewCount"/>
        <result column="like_count" property="likeCount"/>
        <result column="comment_count" property="commentCount"/>
        <result column="read_count" property="readCount"/>
        <result column="total_target_count" property="totalTargetCount"/>
        <result column="remark" property="remark"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="publisher_name" property="publisherName"/>
        <result column="publisher_avatar" property="publisherAvatar"/>
        <result column="department_name" property="departmentName"/>
    </resultMap>

    <select id="selectAnnouncementPage" resultMap="BaseResultMap">
        SELECT a.*,
               u.nickname as publisher_name,
               u.avatar as publisher_avatar,
               d.name as department_name
        FROM im_announcement a
        LEFT JOIN im_user u ON a.publisher_id = u.id
        LEFT JOIN im_department d ON a.department_id = d.id
        <where>
            <if test="req.keyword != null and req.keyword != ''">
                AND a.title LIKE CONCAT('%', #{req.keyword}, '%')
                OR a.content LIKE CONCAT('%', #{req.keyword}, '%')
            </if>
            <if test="req.announcementType != null and req.announcementType != ''">
                AND a.announcement_type = #{req.announcementType}
            </if>
            <if test="req.priority != null">
                AND a.priority = #{req.priority}
            </if>
            <if test="req.status != null and req.status != ''">
                AND a.status = #{req.status}
            </if>
            <if test="req.publisherId != null">
                AND a.publisher_id = #{req.publisherId}
            </if>
            <if test="req.departmentId != null">
                AND a.department_id = #{req.departmentId}
            </if>
            <if test="req.isPinned != null">
                AND a.is_pinned = #{req.isPinned}
            </if>
            <if test="req.startDateBegin != null">
                AND a.publish_time &gt;= #{req.startDateBegin}
            </if>
            <if test="req.startDateEnd != null">
                AND a.publish_time &lt;= #{req.startDateEnd}
            </if>
            <if test="req.expiryDateBegin != null">
                AND a.expiry_time &gt;= #{req.expiryDateBegin}
            </if>
            <if test="req.expiryDateEnd != null">
                AND a.expiry_time &lt;= #{req.expiryDateEnd}
            </if>
        </where>
        <choose>
            <when test="req.orderBy == 'publishTime'">
                ORDER BY a.publish_time ${req.orderDirection}
            </when>
            <when test="req.orderBy == 'viewCount'">
                ORDER BY a.view_count ${req.orderDirection}
            </when>
            <when test="req.orderBy == 'priority'">
                ORDER BY a.priority DESC, a.publish_time DESC
            </when>
            <otherwise>
                ORDER BY a.is_pinned DESC, a.publish_time DESC
            </otherwise>
        </choose>
    </select>

    <select id="selectPinnedAnnouncements" resultMap="BaseResultMap">
        SELECT a.*,
               u.nickname as publisher_name,
               u.avatar as publisher_avatar
        FROM im_announcement a
        LEFT JOIN im_user u ON a.publisher_id = u.id
        WHERE a.is_pinned = 1
          AND a.status = 'PUBLISHED'
          AND (a.expiry_time IS NULL OR a.expiry_time &gt; NOW())
        ORDER BY a.priority DESC, a.publish_time DESC
    </select>

    <select id="selectLatestAnnouncements" resultMap="BaseResultMap">
        SELECT a.*,
               u.nickname as publisher_name,
               u.avatar as publisher_avatar
        FROM im_announcement a
        LEFT JOIN im_user u ON a.publisher_id = u.id
        WHERE a.status = 'PUBLISHED'
          AND (a.expiry_time IS NULL OR a.expiry_time &gt; NOW())
        ORDER BY a.publish_time DESC
        LIMIT #{limit}
    </select>

    <select id="countByPublisherId" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM im_announcement
        WHERE publisher_id = #{userId}
          AND status IN ('PUBLISHED', 'EXPIRED')
    </select>

    <select id="selectExpiredAnnouncements" resultMap="BaseResultMap">
        SELECT *
        FROM im_announcement
        WHERE status = 'PUBLISHED'
          AND expiry_time IS NOT NULL
          AND expiry_time &lt; NOW()
        ORDER BY expiry_time DESC
    </select>

</mapper>
