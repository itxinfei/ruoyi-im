<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.im.mapper.ImConversationMemberMapper">

    <resultMap id="BaseResultMap" type="com.ruoyi.im.domain.ImConversationMember">
        <id column="id" property="id" />
        <result column="conversation_id" property="conversationId" />
        <result column="user_id" property="userId" />
        <result column="nickname" property="nickname" />
        <result column="role" property="role" />
        <result column="unread_count" property="unreadCount" />
        <result column="is_pinned" property="isPinned" />
        <result column="is_muted" property="isMuted" />
        <result column="last_read_message_id" property="lastReadMessageId" />
        <result column="last_read_time" property="lastReadTime" />
        <result column="is_deleted" property="isDeleted" />
        <result column="is_archived" property="isArchived" />
        <result column="deleted_time" property="deletedTime" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
    </resultMap>

    <sql id="Base_Column_List">
        id, conversation_id, user_id, nickname, role, unread_count, is_pinned, is_muted,
        last_read_message_id, last_read_time, is_deleted, is_archived, deleted_time, create_time, update_time
    </sql>

    <select id="selectByConversationIdAndUserId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM im_conversation_member
        WHERE conversation_id = #{conversationId} AND user_id = #{userId}
    </select>

    <select id="selectByUserId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM im_conversation_member
        WHERE user_id = #{userId} AND is_deleted = 0
        ORDER BY create_time DESC
    </select>

    <select id="selectByConversationId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM im_conversation_member
        WHERE conversation_id = #{conversationId} AND is_deleted = 0
    </select>

    <update id="updateUnreadCount">
        UPDATE im_conversation_member
        SET unread_count = #{unreadCount}, update_time = NOW()
        WHERE conversation_id = #{conversationId} AND user_id = #{userId}
    </update>

    <update id="incrementUnreadCount">
        UPDATE im_conversation_member
        SET unread_count = unread_count + #{count}, update_time = NOW()
        WHERE conversation_id = #{conversationId} AND user_id = #{userId}
    </update>

    <update id="decrementUnreadCount">
        UPDATE im_conversation_member
        SET unread_count = GREATEST(unread_count - #{count}, 0), update_time = NOW()
        WHERE conversation_id = #{conversationId} AND user_id = #{userId}
    </update>

    <update id="updateLastReadMessageId">
        UPDATE im_conversation_member
        SET last_read_message_id = #{lastReadMessageId},
            last_read_time = NOW(),
            update_time = NOW()
        WHERE conversation_id = #{conversationId} AND user_id = #{userId}
    </update>

    <update id="updatePinned">
        UPDATE im_conversation_member
        SET is_pinned = #{isPinned}, update_time = NOW()
        WHERE conversation_id = #{conversationId} AND user_id = #{userId}
    </update>

    <update id="updateMuted">
        UPDATE im_conversation_member
        SET is_muted = #{isMuted}, update_time = NOW()
        WHERE conversation_id = #{conversationId} AND user_id = #{userId}
    </update>

    <update id="markAsDeleted">
        UPDATE im_conversation_member
        SET is_deleted = 1, deleted_time = NOW(), update_time = NOW()
        WHERE conversation_id = #{conversationId} AND user_id = #{userId}
    </update>

    <delete id="deleteByConversationIdAndUserId">
        DELETE FROM im_conversation_member
        WHERE conversation_id = #{conversationId} AND user_id = #{userId}
    </delete>

    <insert id="insertImConversationMember" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO im_conversation_member (
            conversation_id, user_id, nickname, role, unread_count,
            is_pinned, is_muted, is_deleted, create_time, update_time
        )
        VALUES (
            #{conversationId}, #{userId}, #{nickname}, #{role}, #{unreadCount},
            #{isPinned}, #{isMuted}, #{isDeleted}, NOW(), NOW()
        )
    </insert>

    <!-- 批量统计会话成员数量 -->
    <select id="countMembersByConversationIds" resultType="java.util.HashMap">
        SELECT
            conversation_id as "conversationId",
            COUNT(*) as "memberCount"
        FROM im_conversation_member
        WHERE conversation_id IN
        <foreach collection="conversationIds" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
        AND is_deleted = 0
        GROUP BY conversation_id
    </select>

    <!-- 查询用户归档的会话列表 -->
    <select id="selectArchivedByUserId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM im_conversation_member
        WHERE user_id = #{userId} AND is_archived = 1 AND is_deleted = 0
        ORDER BY update_time DESC
    </select>

    <!-- 更新归档状态 -->
    <update id="updateArchived">
        UPDATE im_conversation_member
        SET is_archived = #{isArchived}, update_time = NOW()
        WHERE conversation_id = #{conversationId} AND user_id = #{userId}
    </update>

    <!-- 批量增加未读消息数（排除发送者）- 私有化部署优化 -->
    <update id="incrementUnreadCountExcludeSender">
        UPDATE im_conversation_member
        SET unread_count = unread_count + 1, update_time = NOW()
        WHERE conversation_id = #{conversationId}
          AND user_id != #{senderId}
          AND is_deleted = 0
    </update>

</mapper>
