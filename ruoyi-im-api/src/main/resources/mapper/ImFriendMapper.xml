<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.im.mapper.ImFriendMapper">

    <resultMap type="com.ruoyi.im.domain.ImFriend" id="ImFriendResult">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="friendId" column="friend_id"/>
        <result property="remark" column="remark"/>
        <result property="groupName" column="group_name"/>
        <result property="tags" column="tags"/>
        <result property="isDeleted" column="is_deleted"/>
        <result property="deletedTime" column="deleted_time"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <sql id="selectImFriendVo">
        select id, user_id, friend_id, remark, group_name, is_deleted, deleted_time, create_time, update_time, tags
        from im_friend
    </sql>

    <sql id="selectImFriendVoWithUndeleted">
        select id, user_id, friend_id, remark, group_name, create_time, update_time, tags
        from im_friend
        where is_deleted = 0
    </sql>

    <select id="selectImFriendById" parameterType="Long" resultMap="ImFriendResult">
        <include refid="selectImFriendVo"/>
        where id = #{id}
    </select>

    <select id="selectImFriendList" parameterType="com.ruoyi.im.domain.ImFriend" resultMap="ImFriendResult">
        -- 使用子查询确保每个好友只返回一条记录（取最早的）
        SELECT f.id, f.user_id, f.friend_id, f.remark, f.group_name, f.is_deleted, f.deleted_time, f.create_time, f.update_time, f.tags
        FROM im_friend f
        INNER JOIN (
            SELECT user_id, friend_id, MIN(id) as min_id
            FROM im_friend
            <where>
                <if test="userId != null"> user_id = #{userId} AND </if>
                <if test="friendId != null"> friend_id = #{friendId} AND </if>
                is_deleted = 0
            </where>
            GROUP BY user_id, friend_id
        ) uniq ON f.user_id = uniq.user_id AND f.friend_id = uniq.friend_id AND f.id = uniq.min_id
        <where>
            f.is_deleted = 0
        </where>
    </select>

    <select id="selectImFriendListByUserId" parameterType="Long" resultMap="ImFriendResult">
        -- 使用子查询确保每个好友只返回一条记录（取最早的）
        SELECT f.id, f.user_id, f.friend_id, f.remark, f.group_name, f.create_time, f.update_time, f.tags
        FROM im_friend f
        INNER JOIN (
            SELECT user_id, friend_id, MIN(id) as min_id
            FROM im_friend
            WHERE user_id = #{userId} AND is_deleted = 0
            GROUP BY user_id, friend_id
        ) uniq ON f.user_id = uniq.user_id AND f.friend_id = uniq.friend_id AND f.id = uniq.min_id
    </select>

    <select id="selectImFriendByUserIdAndFriendId"
            parameterType="map" resultMap="ImFriendResult">
        <include refid="selectImFriendVo"/>
        where user_id = #{userId} and friend_id = #{friendId} and is_deleted = 0
    </select>

    <insert id="insertImFriend" parameterType="com.ruoyi.im.domain.ImFriend" useGeneratedKeys="true" keyProperty="id">
        insert into im_friend
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="userId != null">user_id,</if>
            <if test="friendId != null">friend_id,</if>
            <if test="remark != null">remark,</if>
            <if test="groupName != null">group_name,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateTime != null">update_time,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="userId != null">#{userId},</if>
            <if test="friendId != null">#{friendId},</if>
            <if test="remark != null">#{remark},</if>
            <if test="groupName != null">#{groupName},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateTime != null">#{updateTime},</if>
        </trim>
    </insert>

    <update id="updateImFriend" parameterType="com.ruoyi.im.domain.ImFriend">
        update im_friend
        <trim prefix="SET" suffixOverrides=",">
            <if test="userId != null">user_id = #{userId},</if>
            <if test="friendId != null">friend_id = #{friendId},</if>
            <if test="remark != null and remark != ''">remark = #{remark},</if>
            <if test="groupName != null and groupName != ''">group_name = #{groupName},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
        </trim>
        where id = #{id}
    </update>

    <!-- 软删除：更新is_deleted字段而不是物理删除记录 -->
    <update id="deleteImFriendById" parameterType="Long">
        update im_friend set is_deleted = 1, deleted_time = now() where id = #{id}
    </update>

    <!-- 批量软删除 -->
    <update id="deleteImFriendByIds" parameterType="Long[]">
        update im_friend set is_deleted = 1, deleted_time = now() where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 根据条件软删除 -->
    <update id="deleteImFriendByCondition" parameterType="com.ruoyi.im.domain.ImFriend">
        update im_friend set is_deleted = 1, deleted_time = now()
        <where>
            <if test="userId != null"> and user_id = #{userId} </if>
            <if test="friendId != null"> and friend_id = #{friendId} </if>
        </where>
    </update>
</mapper>