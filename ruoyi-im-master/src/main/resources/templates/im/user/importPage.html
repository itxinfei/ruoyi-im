<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">

<head>
    <th:block th:include="include :: header('å¯¼å…¥ç”¨æˆ·æ•°æ®')" />
    <style>
        body {
            padding: 0 !important;
            background-color: #fff;
        }

        .import-container {
            padding: 20px 30px;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #1ab394;
            background-color: #f8f9fa;
        }

        .upload-area p {
            margin: 10px 0 0 0;
            color: #666;
        }

        .file-name {
            margin-top: 10px;
            color: #1ab394;
            font-weight: 600;
        }
    </style>
</head>

<body class="white-bg">
    <div class="import-container">
        <div class="upload-area" onclick="$('#importFile').click()">
            <span style="font-size: 40px; color: #ccc;">ğŸ“</span>
            <p>ç‚¹å‡»é€‰æ‹©Excelæ–‡ä»¶ï¼Œæˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸ</p>
            <p class="file-name" id="fileName"></p>
        </div>

        <input type="file" id="importFile" accept=".xls,.xlsx" style="display: none;" onchange="handleFileSelect(this)">

        <div class="form-group">
            <label>
                <input type="checkbox" id="updateSupport"> å¦‚æœç”¨æˆ·åå·²å­˜åœ¨ï¼Œåˆ™æ›´æ–°è¯¥ç”¨æˆ·ä¿¡æ¯
            </label>
        </div>

        <div class="text-center" style="margin-top: 15px;">
            <button type="button" class="btn btn-primary" onclick="submitImport()">å¼€å§‹å¯¼å…¥</button>
            <button type="button" class="btn btn-default" onclick="downloadTemplate()">ä¸‹è½½æ¨¡æ¿</button>
        </div>

        <div class="alert alert-info" style="margin-top: 15px;">
            <strong>æç¤ºï¼š</strong>
            <ul style="margin: 5px 0 0 0; padding-left: 20px;">
                <li>ä»…æ”¯æŒ .xls å’Œ .xlsx æ ¼å¼çš„Excelæ–‡ä»¶</li>
                <li>è¯·å…ˆä¸‹è½½æ¨¡æ¿ï¼ŒæŒ‰æ¨¡æ¿æ ¼å¼å¡«å†™æ•°æ®åå†å¯¼å…¥</li>
                <li>ç”¨æˆ·åä¸ºå¿…å¡«é¡¹ï¼Œé‡å¤çš„ç”¨æˆ·åå°†æ— æ³•å¯¼å…¥ï¼ˆé™¤éå‹¾é€‰æ›´æ–°é€‰é¡¹ï¼‰</li>
            </ul>
        </div>
    </div>

    <div style="display:none;">
        <th:block th:include="include :: footer" />
    </div>

    <script th:inline="javascript">
        var prefix = ctx + "im/user";
        var selectedFile = null;

        /* é€‰æ‹©æ–‡ä»¶ */
        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                selectedFile = input.files[0];
                $('#fileName').text('å·²é€‰æ‹©: ' + selectedFile.name);
            }
        }

        /* ä¸‹è½½å¯¼å…¥æ¨¡æ¿ */
        function downloadTemplate() {
            window.location.href = prefix + "/importTemplate";
        }

        /* æäº¤å¯¼å…¥ */
        function submitImport() {
            if (!selectedFile) {
                $.modal.alertWarning("è¯·å…ˆé€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶");
                return;
            }

            var formData = new FormData();
            formData.append("file", selectedFile);
            formData.append("updateSupported", $('#updateSupport').is(':checked'));

            $.modal.loading("æ­£åœ¨å¯¼å…¥æ•°æ®ï¼Œè¯·ç¨å€™...");

            $.ajax({
                url: prefix + "/importData",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (result) {
                    $.modal.closeLoading();
                    if (result.code == 0) {
                        var data = result.data || result;
                        var msg = "å¯¼å…¥å®Œæˆï¼";
                        if (data.successCount !== undefined) {
                            msg += " æˆåŠŸ: " + data.successCount + " æ¡";
                        }
                        if (data.failCount !== undefined && data.failCount > 0) {
                            msg += "ï¼Œå¤±è´¥: " + data.failCount + " æ¡";
                        }
                        $.modal.msgSuccess(msg);

                        // å…³é—­å¼¹çª—å¹¶åˆ·æ–°çˆ¶é¡µé¢
                        if (parent && parent.$.table) {
                            parent.$.table.refresh();
                        }
                        $.modal.close();
                    } else {
                        $.modal.alertError(result.msg || "å¯¼å…¥å¤±è´¥");
                    }
                },
                error: function () {
                    $.modal.closeLoading();
                    $.modal.alertError("å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®");
                }
            });
        }
    </script>
</body>

</html>