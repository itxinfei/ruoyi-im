<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">

<head>
    <th:block th:include="include :: header('IM用户管理')" />
    <link th:href="@{/css/im-common.css}" rel="stylesheet" />
    <style>
        /* 统计卡片精确 10px 间距 */
        .stat-container {
            margin-left: -5px;
            margin-right: -5px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .stat-col {
            padding-left: 5px;
            padding-right: 5px;
        }

        .ibox.stat-card {
            margin-bottom: 10px;
            transition: all 0.3s ease;
            border-radius: 8px;
            box-shadow: none;
            border: 1px solid #f0f0f0;
        }

        .ibox.stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .ibox-content h2 {
            font-weight: 700;
            margin-top: 5px;
        }

        .select-list ul li {
            margin-right: 20px !important;
            margin-bottom: 10px;
        }

        .select-list ul li label {
            width: 70px !important;
            font-weight: 500;
            color: #666;
        }

        .select-list ul li input,
        .select-list ul li select {
            border-radius: 4px !important;
            border: 1px solid #e5e6e7 !important;
            transition: border-color 0.2s;
        }

        .select-list ul li input:focus,
        .select-list ul li select:focus {
            border-color: #1ab394 !important;
        }
    </style>
</head>

<body class="gray-bg">
    <div class="container-div">
        <div class="row">
            <!-- 统计卡片区域 -->
            <div class="col-sm-12 stat-container">
                <div class="row">
                    <div class="col-sm-3 stat-col animated fadeInUp">
                        <div class="ibox float-e-margins stat-card stat-card-primary" onclick="filterReset()">
                            <div class="ibox-title">
                                <span class="label pull-right">总</span>
                                <h5>用户总数</h5>
                            </div>
                            <div class="ibox-content">
                                <h2 class="no-margins" id="totalCount">0</h2>
                                <small>系统注册用户总量</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-3 stat-col animated fadeInUp" style="animation-delay: 0.1s;">
                        <div class="ibox float-e-margins stat-card stat-card-success" onclick="filterByOnline('1')">
                            <div class="ibox-title">
                                <span class="label pull-right">网</span>
                                <h5>在线活跃</h5>
                            </div>
                            <div class="ibox-content">
                                <h2 class="no-margins" id="onlineCount">0</h2>
                                <small>当前实时在线连接</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-3 stat-col animated fadeInUp" style="animation-delay: 0.2s;">
                        <div class="ibox float-e-margins stat-card stat-card-warning" onclick="filterByToday()">
                            <div class="ibox-title">
                                <span class="label pull-right">新</span>
                                <h5>今日新增</h5>
                            </div>
                            <div class="ibox-content">
                                <h2 class="no-margins" id="todayCount">0</h2>
                                <small>今日新注册用户数</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-3 stat-col animated fadeInUp" style="animation-delay: 0.3s;">
                        <div class="ibox float-e-margins stat-card stat-card-danger" onclick="filterByStatus('0')">
                            <div class="ibox-title">
                                <span class="label pull-right">停</span>
                                <h5>已停用</h5>
                            </div>
                            <div class="ibox-content">
                                <h2 class="no-margins" id="disabledCount">0</h2>
                                <small>账号异常/停用数量</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 搜索表单 (若依标准布局) -->
            <div class="col-sm-12 search-collapse">
                <form id="user-form">
                    <div class="select-list">
                        <ul>
                            <li>
                                关键词：<input type="text" name="keyword" placeholder="账号/昵称" />
                            </li>
                            <li>
                                手机号码：<input type="text" name="mobile" placeholder="手机号" />
                            </li>
                            <li>
                                邮箱：<input type="text" name="email" placeholder="邮箱" />
                            </li>
                            <li>
                                状态：<select name="status">
                                    <option value="">所有</option>
                                    <option value="1">正常</option>
                                    <option value="0">停用</option>
                                </select>
                            </li>
                            <li>
                                在线：<select name="isOnline">
                                    <option value="">所有</option>
                                    <option value="1">在线</option>
                                    <option value="0">离线</option>
                                </select>
                            </li>
                            <li class="select-time">
                                <label>注册时间：</label>
                                <input type="text" class="time-input" id="startTime" placeholder="开始"
                                    name="params[beginTime]" />
                                <span>-</span>
                                <input type="text" class="time-input" id="endTime" placeholder="结束"
                                    name="params[endTime]" />
                            </li>
                            <li>
                                <a class="btn btn-primary btn-rounded btn-sm" onclick="$.table.search()"><i
                                        class="fa fa-search"></i>&nbsp;搜索</a>
                                <a class="btn btn-warning btn-rounded btn-sm" onclick="$.form.reset()"><i
                                        class="fa fa-refresh"></i>&nbsp;重置</a>
                            </li>
                        </ul>
                    </div>
                </form>
            </div>

            <!-- 工具栏 + 表格 -->
            <div class="col-sm-12 select-table table-striped">
                <div class="btn-group-sm" id="toolbar" role="group">
                    <a class="btn btn-success" onclick="$.operate.add()" shiro:hasPermission="im:user:add">新增用户</a>
                    <a class="btn btn-primary single disabled" onclick="$.operate.edit()"
                        shiro:hasPermission="im:user:edit">修改</a>
                    <a class="btn btn-danger multiple disabled" onclick="$.operate.removeAll()"
                        shiro:hasPermission="im:user:remove">删除</a>
                    <a class="btn btn-info multiple disabled" onclick="batchEnable()"
                        shiro:hasPermission="im:user:edit">批量启用</a>
                    <a class="btn btn-default multiple disabled" onclick="batchDisable()"
                        shiro:hasPermission="im:user:edit">批量停用</a>
                    <a class="btn btn-warning multiple disabled" onclick="exportSelected()"
                        shiro:hasPermission="im:user:export">导出选中</a>
                    <a class="btn btn-cyan" onclick="importData()" shiro:hasPermission="im:user:import"
                        style="background-color: #17a2b8; border-color: #17a2b8; color: #fff;">导入数据</a>
                </div>
                <table id="bootstrap-table" data-mobile-responsive="true"></table>
            </div>
        </div>
    </div>

    <th:block th:include="include :: footer" />
    <th:block th:include="include :: bootstrap-table-export-js" />
    <script th:inline="javascript">
        var editFlag = [[${@permission.hasPermi('im:user:edit') }]];
        var removeFlag = [[${@permission.hasPermi('im:user:remove') }]];
        var resetPwdFlag = [[${@permission.hasPermi('im:user:resetPwd') }]];
        var prefix = ctx + "im/user";

        $(function () {
            var options = {
                url: prefix + "/list",
                createUrl: prefix + "/add",
                updateUrl: prefix + "/edit/{id}",
                removeUrl: prefix + "/remove",
                exportUrl: prefix + "/export",
                sortName: "createTime",
                sortOrder: "desc",
                modalName: "用户",
                showColumns: true,
                showRefresh: false,
                showToggle: false,
                clickToSelect: true,
                rememberSelected: true,
                pagination: true,
                pageSize: 10,
                pageList: [10, 20, 50, 100],
                sidePagination: "server",
                columns: [{
                    checkbox: true,
                    width: 40,
                    align: 'center'
                }, {
                    field: 'id',
                    title: 'ID',
                    width: 60,
                    align: 'center',
                    sortable: true
                }, {
                    field: 'avatar',
                    title: '头像',
                    align: 'center',
                    width: 55,
                    formatter: function (value, row) {
                        var img = value ? value : ctx + 'img/profile.jpg';
                        var onlineClass = row.isOnline == 1 ? 'border: 2px solid #1ab394;' : 'border: 1px solid #ddd;';
                        return '<img src="' + img + '" class="img-circle" style="width:32px;height:32px;' + onlineClass + '" onerror="this.src=\'' + ctx + 'img/profile.jpg\'">';
                    }
                }, {
                    field: 'username',
                    title: '用户名',
                    width: 100,
                    sortable: true,
                    formatter: function (value) {
                        return '<span class="text-navy" style="font-weight:600">' + value + '</span>';
                    }
                }, {
                    field: 'nickname',
                    title: '昵称',
                    width: 100,
                    formatter: function (value) {
                        return value || '<span class="text-muted">-</span>';
                    }
                }, {
                    field: 'mobile',
                    title: '手机号',
                    width: 120,
                    formatter: function (value) {
                        if (!value) return '<span class="text-muted">-</span>';
                        return '<i class="fa fa-phone text-info" style="margin-right:3px;"></i>' + value;
                    }
                }, {
                    field: 'email',
                    title: '邮箱',
                    width: 160,
                    visible: false,
                    formatter: function (value) {
                        if (!value) return '<span class="text-muted">-</span>';
                        return '<i class="fa fa-envelope text-warning" style="margin-right:3px;"></i>' + value;
                    }
                }, {
                    field: 'gender',
                    title: '性别',
                    align: 'center',
                    width: 60,
                    formatter: function (value) {
                        if (value == 1) return '<i class="fa fa-mars text-info"></i> 男';
                        if (value == 2) return '<i class="fa fa-venus text-danger"></i> 女';
                        return '<span class="text-muted">未知</span>';
                    }
                }, {
                    field: 'status',
                    title: '状态',
                    align: 'center',
                    width: 70,
                    formatter: function (value, row) {
                        var checked = value == 1 ? 'checked' : '';
                        return '<input type="checkbox" ' + checked + ' onclick="toggleStatus(\'' + row.id + '\', this)" class="status-switch">';
                    }
                }, {
                    field: 'isOnline',
                    title: '在线',
                    align: 'center',
                    width: 60,
                    formatter: function (value) {
                        if (value == 1) {
                            return '<span class="badge" style="background:#1ab394;"><i class="fa fa-circle" style="font-size:8px;margin-right:3px;"></i>在线</span>';
                        }
                        return '<span class="badge badge-default">离线</span>';
                    }
                }, {
                    field: 'signature',
                    title: '个性签名',
                    width: 150,
                    visible: false,
                    formatter: function (value) {
                        if (!value) return '<span class="text-muted">-</span>';
                        var text = value.length > 15 ? value.substring(0, 15) + '...' : value;
                        return '<span title="' + value + '">' + text + '</span>';
                    }
                }, {
                    field: 'lastOnlineTime',
                    title: '最后在线',
                    width: 140,
                    sortable: true,
                    formatter: function (value) {
                        if (!value) return '<span class="text-muted">从未登录</span>';
                        return '<span class="text-muted"><i class="fa fa-clock-o"></i> ' + value.replace('T', ' ') + '</span>';
                    }
                }, {
                    field: 'createTime',
                    title: '注册时间',
                    width: 140,
                    sortable: true,
                    formatter: function (value) {
                        return value || '-';
                    }
                }, {
                    title: '操作',
                    align: 'center',
                    width: 280,
                    formatter: function (value, row, index) {
                        var actions = [];
                        actions.push('<a class="btn btn-info btn-xs" href="javascript:void(0)" onclick="viewDetail(\'' + row.id + '\')">查看</a> ');
                        actions.push('<a class="btn btn-success btn-xs ' + editFlag + '" href="javascript:void(0)" onclick="$.operate.edit(\'' + row.id + '\')">编辑</a> ');
                        actions.push('<a class="btn btn-warning btn-xs ' + resetPwdFlag + '" href="javascript:void(0)" onclick="resetPwd(\'' + row.id + '\')">重置密码</a> ');
                        actions.push('<a class="btn btn-danger btn-xs ' + removeFlag + '" href="javascript:void(0)" onclick="$.operate.remove(\'' + row.id + '\')">删除</a>');
                        return actions.join('');
                    }
                }]
            };
            $.table.init(options);
            loadStatistics();
        });

        /* 加载统计数据 */
        function loadStatistics() {
            $.get(prefix + "/statistics", function (result) {
                if (result.code == 0) {
                    var stats = result.data;
                    animateNumber('totalCount', stats.totalCount || 0);
                    animateNumber('onlineCount', stats.onlineCount || 0);
                    animateNumber('todayCount', stats.todayCount || 0);
                    animateNumber('disabledCount', stats.disabledCount || 0);
                }
            });
        }

        /* 数字动画效果 */
        function animateNumber(elementId, targetValue) {
            var $element = $('#' + elementId);
            var currentValue = parseInt($element.text()) || 0;
            var diff = targetValue - currentValue;
            var duration = 500;
            var steps = 20;
            var stepValue = diff / steps;
            var stepDuration = duration / steps;
            var currentStep = 0;

            var timer = setInterval(function () {
                currentStep++;
                currentValue = Math.round(currentValue + stepValue);
                if (currentStep >= steps) {
                    currentValue = targetValue;
                    clearInterval(timer);
                }
                $element.text(currentValue);
            }, stepDuration);
        }

        /* 重置筛选 */
        function filterReset() {
            $.form.reset();
            $.table.search();
        }

        /* 按状态筛选 */
        function filterByStatus(status) {
            $('select[name="status"]').val(status);
            $.table.search();
        }

        /* 按在线状态筛选 */
        function filterByOnline(online) {
            $('select[name="isOnline"]').val(online);
            $.table.search();
        }

        /* 按今日筛选 */
        function filterByToday() {
            var today = new Date();
            var todayStr = today.getFullYear() + '-' +
                String(today.getMonth() + 1).padStart(2, '0') + '-' +
                String(today.getDate()).padStart(2, '0');
            $('input[name="params[beginTime]"]').val(todayStr + ' 00:00:00');
            $('input[name="params[endTime]"]').val(todayStr + ' 23:59:59');
            $.table.search();
        }

        /* 查看详情 */
        function viewDetail(id) {
            $.get(prefix + "/info/" + id, function (result) {
                if (result.code == 0) {
                    var data = result.data;
                    var html = '<table class="table table-bordered">';
                    html += '<tr><th width="120">用户名</th><td>' + (data.username || '-') + '</td><th width="120">昵称</th><td>' + (data.nickname || '-') + '</td></tr>';
                    html += '<tr><th>手机号</th><td>' + (data.mobile || '-') + '</td><th>邮箱</th><td>' + (data.email || '-') + '</td></tr>';
                    html += '<tr><th>性别</th><td>' + (data.sex == 0 ? '男' : data.sex == 1 ? '女' : '未知') + '</td><th>状态</th><td>' + (data.status == 1 ? '正常' : '停用') + '</td></tr>';
                    html += '<tr><th>在线状态</th><td>' + (data.isOnline == 1 ? '在线' : '离线') + '</td><th>注册时间</th><td>' + (data.createTime || '-') + '</td></tr>';
                    html += '<tr><th>最后登录</th><td>' + (data.lastLoginTime || '-') + '</td><th>备注</th><td>' + (data.remark || '-') + '</td></tr>';
                    html += '</table>';
                    top.layer.open({
                        type: 1,
                        title: '用户详情',
                        area: ['700px', '450px'],
                        content: html
                    });
                }
            });
        }

        /* 重置密码 */
        function resetPwd(id) {
            var url = prefix + '/resetPassword/' + id;
            $.modal.open("重置密码", url, 600, 400);
        }

        /* 导出选中数据 */
        function exportSelected() {
            var rows = $.table.selectFirstColumns();
            if (rows.length == 0) {
                $.modal.alertWarning("请至少选择一条记录");
                return;
            }
            $.modal.confirm("确定导出选中的 " + rows.length + " 条数据吗？", function () {
                // 使用表单POST方式提交导出请求
                var form = $('<form method="post" action="' + prefix + '/export"></form>');
                form.append('<input type="hidden" name="userIds" value="' + rows.join(",") + '">');
                $('body').append(form);
                form.submit();
                form.remove();
            });
        }

        /* 切换用户状态（单行操作） */
        function toggleStatus(id, checkbox) {
            var status = checkbox.checked ? 1 : 0;
            var action = status == 1 ? '启用' : '停用';
            $.modal.confirm("确定" + action + "该用户吗？", function () {
                $.ajax({
                    url: prefix + "/batchUpdateStatus",
                    type: "POST",
                    data: { userIds: id, status: status },
                    success: function (result) {
                        if (result.code == 0) {
                            $.modal.msgSuccess(action + "成功");
                            loadStatistics();
                        } else {
                            $.modal.alertError(result.msg);
                            checkbox.checked = !checkbox.checked;
                        }
                    },
                    error: function () {
                        $.modal.alertError("操作失败");
                        checkbox.checked = !checkbox.checked;
                    }
                });
            }, function () {
                checkbox.checked = !checkbox.checked;
            });
        }

        /* 批量启用用户 */
        function batchEnable() {
            var rows = $.table.selectFirstColumns();
            if (rows.length == 0) {
                $.modal.alertWarning("请至少选择一条记录");
                return;
            }
            $.modal.confirm("确定批量启用选中的 " + rows.length + " 个用户吗？", function () {
                $.ajax({
                    url: prefix + "/batchUpdateStatus",
                    type: "POST",
                    data: { userIds: rows.join(","), status: 1 },
                    success: function (result) {
                        if (result.code == 0) {
                            $.modal.msgSuccess(result.msg);
                            $.table.refresh();
                            loadStatistics();
                        } else {
                            $.modal.alertError(result.msg);
                        }
                    }
                });
            });
        }

        /* 批量停用用户 */
        function batchDisable() {
            var rows = $.table.selectFirstColumns();
            if (rows.length == 0) {
                $.modal.alertWarning("请至少选择一条记录");
                return;
            }
            $.modal.confirm("确定批量停用选中的 " + rows.length + " 个用户吗？", function () {
                $.ajax({
                    url: prefix + "/batchUpdateStatus",
                    type: "POST",
                    data: { userIds: rows.join(","), status: 0 },
                    success: function (result) {
                        if (result.code == 0) {
                            $.modal.msgSuccess(result.msg);
                            $.table.refresh();
                            loadStatistics();
                        } else {
                            $.modal.alertError(result.msg);
                        }
                    }
                });
            });
        }

        /* 下载导入模板 */
        function downloadTemplate() {
            window.location.href = prefix + "/importTemplate";
        }

        /* 导入用户数据 */
        function importData() {
            $.modal.open("导入用户数据", prefix + "/importPage", 500, 300);
        }
    </script>
</body>

</html>