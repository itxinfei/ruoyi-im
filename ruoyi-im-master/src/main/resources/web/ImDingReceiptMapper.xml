<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.web.mapper.ImDingReceiptMapper">

    <resultMap type="com.ruoyi.web.domain.ImDingReceipt" id="ImDingReceiptResult">
        <id property="id" column="id"/>
        <result property="dingId" column="ding_id"/>
        <result property="dingTitle" column="ding_title"/>
        <result property="receiverId" column="receiver_id"/>
        <result property="receiverName" column="receiver_name"/>
        <result property="receiverNickname" column="receiver_nickname"/>
        <result property="readTime" column="read_time"/>
        <result property="confirmed" column="confirmed"/>
        <result property="confirmTime" column="confirm_time"/>
        <result property="remark" column="remark"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <sql id="selectImDingReceiptVo">
        select r.id, r.ding_id, r.receiver_id, r.read_time, r.confirmed, r.confirm_time, r.remark,
               r.create_time, r.update_time,
               d.content as ding_title,
               u.nick_name as receiver_name,
               u.nickname as receiver_nickname
        from im_ding_receipt r
        left join im_ding_message d on r.ding_id = d.id
        left join sys_user u on r.receiver_id = u.user_id
    </sql>

    <select id="selectImDingReceiptList" parameterType="com.ruoyi.web.domain.ImDingReceipt" resultMap="ImDingReceiptResult">
        <include refid="selectImDingReceiptVo"/>
        <where>
            1=1
            <if test="dingId != null">and r.ding_id = #{dingId}</if>
            <if test="receiverId != null">and r.receiver_id = #{receiverId}</if>
            <if test="confirmed != null">and r.confirmed = #{confirmed}</if>
            <if test="params.beginTime != null and params.beginTime != ''">and date_format(r.read_time,'%Y-%m-%d') &gt;= date_format(#{params.beginTime},'%Y-%m-%d')</if>
            <if test="params.endTime != null and params.endTime != ''">and date_format(r.read_time,'%Y-%m-%d') &lt;= date_format(#{params.endTime},'%Y-%m-%d')</if>
        </where>
        order by r.create_time desc
    </select>

    <select id="selectImDingReceiptById" parameterType="Long" resultMap="ImDingReceiptResult">
        <include refid="selectImDingReceiptVo"/>
        where r.id = #{id}
    </select>

    <select id="selectReceiptsByDingId" parameterType="Long" resultMap="ImDingReceiptResult">
        <include refid="selectImDingReceiptVo"/>
        where r.ding_id = #{dingId}
        order by r.read_time desc, r.confirm_time desc
    </select>

    <select id="getReceiptStatistics" parameterType="Long" resultType="java.util.Map">
        select
            count(*) as totalCount,
            sum(case when r.read_time is not null then 1 else 0 end) as readCount,
            sum(case when r.read_time is null then 1 else 0 end) as unreadCount,
            sum(case when r.confirmed = 1 then 1 else 0 end) as confirmedCount,
            sum(case when r.confirmed = 0 then 1 else 0 end) as unconfirmedCount
        from im_ding_receipt r
        <where>
            <if test="dingId != null">
                r.ding_id = #{dingId}
            </if>
        </where>
    </select>
</mapper>
