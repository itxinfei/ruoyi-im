<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.web.mapper.ImAttendanceMapper">

    <resultMap type="com.ruoyi.web.domain.ImAttendance" id="ImAttendanceResult">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="userName" column="user_name"/>
        <result property="userNickname" column="user_nickname"/>
        <result property="attendanceDate" column="attendance_date"/>
        <result property="checkInTime" column="check_in_time"/>
        <result property="checkOutTime" column="check_out_time"/>
        <result property="checkInStatus" column="check_in_status"/>
        <result property="checkOutStatus" column="check_out_status"/>
        <result property="workMinutes" column="work_minutes"/>
        <result property="attendanceType" column="attendance_type"/>
        <result property="remark" column="remark"/>
        <result property="checkInLocation" column="check_in_location"/>
        <result property="checkOutLocation" column="check_out_location"/>
        <result property="deviceInfo" column="device_info"/>
        <result property="approveStatus" column="approve_status"/>
        <result property="approverId" column="approver_id"/>
        <result property="approverName" column="approver_name"/>
        <result property="approveTime" column="approve_time"/>
        <result property="approveComment" column="approve_comment"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <sql id="selectImAttendanceVo">
        SELECT a.id, a.user_id, a.attendance_date, a.check_in_time, a.check_out_time,
               a.check_in_status, a.check_out_status, a.work_minutes, a.attendance_type,
               a.remark, a.check_in_location, a.check_out_location, a.device_info,
               a.approve_status, a.approver_id, a.approve_time, a.approve_comment,
               a.create_time, a.update_time,
               u.username AS user_name, u.nickname AS user_nickname,
               approver.username AS approver_name
        FROM im_attendance a
        LEFT JOIN im_user u ON a.user_id = u.id
        LEFT JOIN im_user approver ON a.approver_id = approver.id
    </sql>

    <select id="selectImAttendanceById" parameterType="Long" resultMap="ImAttendanceResult">
        <include refid="selectImAttendanceVo"/>
        WHERE a.id = #{id}
    </select>

    <select id="selectImAttendanceList" parameterType="com.ruoyi.web.domain.ImAttendance" resultMap="ImAttendanceResult">
        <include refid="selectImAttendanceVo"/>
        <where>
            <if test="userId != null">and a.user_id = #{userId}</if>
            <if test="userName != null and userName != ''">and u.username like concat('%', #{userName}, '%')</if>
            <if test="userNickname != null and userNickname != ''">and u.nickname like concat('%', #{userNickname}, '%')</if>
            <if test="attendanceType != null and attendanceType != ''">and a.attendance_type = #{attendanceType}</if>
            <if test="checkInStatus != null and checkInStatus != ''">and a.check_in_status = #{checkInStatus}</if>
            <if test="checkOutStatus != null and checkOutStatus != ''">and a.check_out_status = #{checkOutStatus}</if>
            <if test="approveStatus != null and approveStatus != ''">and a.approve_status = #{approveStatus}</if>
            <if test="params.beginDate != null and params.beginDate != ''">
                AND a.attendance_date &gt;= #{params.beginDate}
            </if>
            <if test="params.endDate != null and params.endDate != ''">
                AND a.attendance_date &lt;= #{params.endDate}
            </if>
        </where>
        ORDER BY a.attendance_date DESC, a.check_in_time DESC
    </select>

    <select id="selectAttendanceByUserId" parameterType="Long" resultMap="ImAttendanceResult">
        <include refid="selectImAttendanceVo"/>
        WHERE a.user_id = #{userId}
        ORDER BY a.attendance_date DESC
    </select>

    <select id="selectAttendanceByDateRange" resultMap="ImAttendanceResult">
        <include refid="selectImAttendanceVo"/>
        WHERE a.user_id = #{userId}
        AND a.attendance_date &gt;= #{startDate}
        AND a.attendance_date &lt;= #{endDate}
        ORDER BY a.attendance_date DESC
    </select>

    <select id="selectTodayAttendance" parameterType="Long" resultMap="ImAttendanceResult">
        <include refid="selectImAttendanceVo"/>
        WHERE a.user_id = #{userId}
        AND DATE(a.attendance_date) = CURDATE()
    </select>

    <select id="selectPendingApprovalList" resultMap="ImAttendanceResult">
        <include refid="selectImAttendanceVo"/>
        WHERE a.approve_status = 'PENDING'
        ORDER BY a.attendance_date DESC
    </select>

    <insert id="insertImAttendance" parameterType="com.ruoyi.web.domain.ImAttendance" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO im_attendance
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="userId != null">user_id,</if>
            <if test="attendanceDate != null">attendance_date,</if>
            <if test="checkInTime != null">check_in_time,</if>
            <if test="checkOutTime != null">check_out_time,</if>
            <if test="checkInStatus != null">check_in_status,</if>
            <if test="checkOutStatus != null">check_out_status,</if>
            <if test="workMinutes != null">work_minutes,</if>
            <if test="attendanceType != null">attendance_type,</if>
            <if test="remark != null">remark,</if>
            <if test="checkInLocation != null">check_in_location,</if>
            <if test="checkOutLocation != null">check_out_location,</if>
            <if test="deviceInfo != null">device_info,</if>
            <if test="approveStatus != null">approve_status,</if>
            <if test="approverId != null">approver_id,</if>
            <if test="approveTime != null">approve_time,</if>
            <if test="approveComment != null">approve_comment,</if>
            <if test="createTime != null">create_time,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="userId != null">#{userId},</if>
            <if test="attendanceDate != null">#{attendanceDate},</if>
            <if test="checkInTime != null">#{checkInTime},</if>
            <if test="checkOutTime != null">#{checkOutTime},</if>
            <if test="checkInStatus != null">#{checkInStatus},</if>
            <if test="checkOutStatus != null">#{checkOutStatus},</if>
            <if test="workMinutes != null">#{workMinutes},</if>
            <if test="attendanceType != null">#{attendanceType},</if>
            <if test="remark != null">#{remark},</if>
            <if test="checkInLocation != null">#{checkInLocation},</if>
            <if test="checkOutLocation != null">#{checkOutLocation},</if>
            <if test="deviceInfo != null">#{deviceInfo},</if>
            <if test="approveStatus != null">#{approveStatus},</if>
            <if test="approverId != null">#{approverId},</if>
            <if test="approveTime != null">#{approveTime},</if>
            <if test="approveComment != null">#{approveComment},</if>
            <if test="createTime != null">#{createTime},</if>
        </trim>
    </insert>

    <update id="updateImAttendance" parameterType="com.ruoyi.web.domain.ImAttendance">
        UPDATE im_attendance
        <trim prefix="SET" suffixOverrides=",">
            <if test="checkInTime != null">check_in_time = #{checkInTime},</if>
            <if test="checkOutTime != null">check_out_time = #{checkOutTime},</if>
            <if test="checkInStatus != null">check_in_status = #{checkInStatus},</if>
            <if test="checkOutStatus != null">check_out_status = #{checkOutStatus},</if>
            <if test="workMinutes != null">work_minutes = #{workMinutes},</if>
            <if test="attendanceType != null">attendance_type = #{attendanceType},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="checkInLocation != null">check_in_location = #{checkInLocation},</if>
            <if test="checkOutLocation != null">check_out_location = #{checkOutLocation},</if>
            <if test="deviceInfo != null">device_info = #{deviceInfo},</if>
            <if test="approveStatus != null">approve_status = #{approveStatus},</if>
            <if test="approverId != null">approver_id = #{approverId},</if>
            <if test="approveTime != null">approve_time = #{approveTime},</if>
            <if test="approveComment != null">approve_comment = #{approveComment},</if>
        </trim>
        WHERE id = #{id}
    </update>

    <update id="updateApproveStatus">
        UPDATE im_attendance
        SET approve_status = #{approveStatus},
            approver_id = #{approverId},
            approve_comment = #{approveComment},
            approve_time = NOW(),
            update_time = NOW()
        WHERE id = #{id}
    </update>

    <delete id="deleteImAttendanceById" parameterType="Long">
        DELETE FROM im_attendance WHERE id = #{id}
    </delete>

    <delete id="deleteImAttendanceByIds" parameterType="Long[]">
        DELETE FROM im_attendance WHERE id IN
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 获取考勤统计数据 -->
    <select id="getAttendanceStatistics" resultType="map">
        SELECT
            (SELECT COUNT(*) FROM im_attendance) AS totalCount,
            (SELECT COUNT(*) FROM im_attendance WHERE check_in_status = 'NORMAL') AS normalCheckInCount,
            (SELECT COUNT(*) FROM im_attendance WHERE check_in_status = 'LATE') AS lateCount,
            (SELECT COUNT(*) FROM im_attendance WHERE check_in_status = 'ABSENT') AS absentCheckInCount,
            (SELECT COUNT(*) FROM im_attendance WHERE check_out_status = 'EARLY') AS earlyCount,
            (SELECT COUNT(*) FROM im_attendance WHERE check_out_status = 'ABSENT') AS absentCheckOutCount,
            (SELECT COUNT(*) FROM im_attendance WHERE approve_status = 'PENDING') AS pendingApprovalCount,
            (SELECT COUNT(*) FROM im_attendance WHERE approve_status = 'APPROVED') AS approvedCount,
            (SELECT COUNT(*) FROM im_attendance WHERE approve_status = 'REJECTED') AS rejectedCount,
            (SELECT COUNT(*) FROM im_attendance WHERE DATE(attendance_date) = CURDATE()) AS todayCount,
            (SELECT COUNT(*) FROM im_attendance WHERE attendance_type = 'OVERTIME') AS overtimeCount,
            (SELECT AVG(work_minutes) FROM im_attendance WHERE work_minutes IS NOT NULL) AS avgWorkMinutes
    </select>

</mapper>
