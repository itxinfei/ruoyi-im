<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.web.mapper.ImUserSettingMapper">

    <resultMap type="com.ruoyi.web.domain.ImUserSetting" id="ImUserSettingResult">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="username" column="username"/>
        <result property="nickname" column="nickname"/>
        <result property="settingKey" column="setting_key"/>
        <result property="settingValue" column="setting_value"/>
        <result property="settingType" column="setting_type"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <sql id="selectImUserSettingVo">
        SELECT s.id, s.user_id, s.setting_key, s.setting_value, s.setting_type,
               s.create_time, s.update_time,
               u.username, u.nickname
        FROM im_user_setting s
        LEFT JOIN im_user u ON s.user_id = u.id
    </sql>

    <select id="selectImUserSettingById" parameterType="Long" resultMap="ImUserSettingResult">
        <include refid="selectImUserSettingVo"/>
        WHERE s.id = #{id}
    </select>

    <select id="selectByUserIdAndKey" resultMap="ImUserSettingResult">
        <include refid="selectImUserSettingVo"/>
        WHERE s.user_id = #{userId} AND s.setting_key = #{settingKey}
    </select>

    <select id="selectImUserSettingList" parameterType="com.ruoyi.web.domain.ImUserSetting" resultMap="ImUserSettingResult">
        <include refid="selectImUserSettingVo"/>
        <where>
            <if test="userId != null">and s.user_id = #{userId}</if>
            <if test="username != null and username != ''">and u.username like concat('%', #{username}, '%')</if>
            <if test="nickname != null and nickname != ''">and u.nickname like concat('%', #{nickname}, '%')</if>
            <if test="settingKey != null and settingKey != ''">and s.setting_key like concat('%', #{settingKey}, '%')</if>
            <if test="settingType != null and settingType != ''">and s.setting_type = #{settingType}</if>
        </where>
        ORDER BY s.user_id, s.setting_type, s.setting_key
    </select>

    <select id="selectSettingsByUserId" parameterType="Long" resultMap="ImUserSettingResult">
        <include refid="selectImUserSettingVo"/>
        WHERE s.user_id = #{userId}
        ORDER BY s.setting_type, s.setting_key
    </select>

    <select id="selectSettingsByType" resultMap="ImUserSettingResult">
        <include refid="selectImUserSettingVo"/>
        WHERE s.user_id = #{userId} AND s.setting_type = #{settingType}
        ORDER BY s.setting_key
    </select>

    <insert id="insertImUserSetting" parameterType="com.ruoyi.web.domain.ImUserSetting" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO im_user_setting
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="userId != null">user_id,</if>
            <if test="settingKey != null">setting_key,</if>
            <if test="settingValue != null">setting_value,</if>
            <if test="settingType != null">setting_type,</if>
            <if test="createTime != null">create_time,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="userId != null">#{userId},</if>
            <if test="settingKey != null">#{settingKey},</if>
            <if test="settingValue != null">#{settingValue},</if>
            <if test="settingType != null">#{settingType},</if>
            <if test="createTime != null">#{createTime},</if>
        </trim>
        ON DUPLICATE KEY UPDATE
            setting_value = VALUES(setting_value),
            update_time = NOW()
    </insert>

    <update id="updateImUserSetting" parameterType="com.ruoyi.web.domain.ImUserSetting">
        UPDATE im_user_setting
        <trim prefix="SET" suffixOverrides=",">
            <if test="settingValue != null">setting_value = #{settingValue},</if>
            <if test="settingType != null">setting_type = #{settingType},</if>
        </trim>
        WHERE id = #{id}
    </update>

    <delete id="deleteImUserSettingById" parameterType="Long">
        DELETE FROM im_user_setting WHERE id = #{id}
    </delete>

    <delete id="deleteImUserSettingByIds" parameterType="Long[]">
        DELETE FROM im_user_setting WHERE id IN
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <delete id="deleteSettingsByUserId" parameterType="Long">
        DELETE FROM im_user_setting WHERE user_id = #{userId}
    </delete>

    <!-- 获取设置统计数据 -->
    <select id="getSettingStatistics" resultType="map">
        SELECT
            (SELECT COUNT(*) FROM im_user_setting) AS totalCount,
            (SELECT COUNT(DISTINCT user_id) FROM im_user_setting) AS userCount,
            (SELECT COUNT(*) FROM im_user_setting WHERE setting_type = 'NOTIFICATION') AS notificationCount,
            (SELECT COUNT(*) FROM im_user_setting WHERE setting_type = 'PRIVACY') AS privacyCount,
            (SELECT COUNT(*) FROM im_user_setting WHERE setting_type = 'DISPLAY') AS displayCount,
            (SELECT COUNT(*) FROM im_user_setting WHERE setting_value = 'true' OR setting_value = '1') AS enabledCount
    </select>

    <!-- 重置用户设置 -->
    <delete id="resetUserSettings" parameterType="Long">
        DELETE FROM im_user_setting WHERE user_id = #{userId}
    </delete>

</mapper>
