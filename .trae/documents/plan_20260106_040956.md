# 解决循环依赖问题的实现方案

## 问题分析

当前存在的循环依赖关系：
- `SecurityConfig` 依赖 `JwtAuthenticationTokenFilter`
- `JwtAuthenticationTokenFilter` 依赖 `ImUserService`
- `ImUserServiceImpl` 依赖 `PasswordEncoder`
- `PasswordEncoder` 由 `SecurityConfig` 定义

这形成了一个循环：`SecurityConfig` → `JwtAuthenticationTokenFilter` → `ImUserService` → `PasswordEncoder` → `SecurityConfig`

## 解决方案

使用 `@Lazy` 注解延迟依赖注入，打破循环依赖。具体修改如下：

### 1. 修改 `SecurityConfig.java`

在注入 `JwtAuthenticationTokenFilter` 时添加 `@Lazy` 注解：

```java
@Autowired
@Lazy
private JwtAuthenticationTokenFilter authenticationTokenFilter;
```

### 2. 修改 `JwtAuthenticationTokenFilter.java`

在注入 `ImUserService` 时添加 `@Lazy` 注解：

```java
@Autowired
@Lazy
private ImUserService userService;
```

## 实现原理

- `@Lazy` 注解告诉 Spring 在第一次使用 bean 时才创建它，而不是在启动时立即创建
- 这样可以打破循环依赖，因为 Spring 可以先创建一个代理对象，然后在需要时再创建实际的 bean
- 当调用 `authenticationTokenFilter` 的方法时，Spring 会创建实际的 `JwtAuthenticationTokenFilter` 对象，并注入它的依赖
- 当调用 `userService` 的方法时，Spring 会创建实际的 `ImUserServiceImpl` 对象，并注入它的依赖

## 预期效果

修改后，Spring 应用启动时不会再出现循环依赖错误，所有 bean 都能正常创建和注入。

## 验证方法

1. 重新启动应用
2. 检查应用日志，确认没有循环依赖错误
3. 测试相关功能，确保认证和授权功能正常工作